<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>10.3. Enrollment over Secure Transport &mdash; Anjay 3.3.1 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="10.4. File System Data Model" href="CF-FSDM.html" />
    <link rel="prev" title="10.2. Custom Hardware Support" href="CF-CustomHardwareSupport.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #ffd500" >
            <a href="../index.html">
            <img src="../_static/avsystem_header.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                3.3.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LwM2M.html">2. OMA LwM2M - Brief description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Compiling_client_applications.html">3. Compiling client applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../BasicClient.html">4. Basic client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../AdvancedTopics.html">5. Advanced topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FirmwareUpdateTutorial.html">6. Firmware Update Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Tools.html">7. Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PortingGuideForNonPOSIXPlatforms.html">8. Porting guide for non-POSIX platforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Migrating.html">9. Migrating from older versions</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../CommercialFeatures.html">10. Commercial features</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="CF-CorePersistence.html">10.1. Core Persistence</a></li>
<li class="toctree-l2"><a class="reference internal" href="CF-CustomHardwareSupport.html">10.2. Custom Hardware Support</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">10.3. Enrollment over Secure Transport</a></li>
<li class="toctree-l2"><a class="reference internal" href="CF-FSDM.html">10.4. File System Data Model</a></li>
<li class="toctree-l2"><a class="reference internal" href="CF-HSM.html">10.5. Hardware Security Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="CF-IoTSAFE.html">10.6. IoT SAFE</a></li>
<li class="toctree-l2"><a class="reference internal" href="CF-NIDD.html">10.7. Non-IP Data Delivery</a></li>
<li class="toctree-l2"><a class="reference internal" href="CF-OSCORE.html">10.8. OSCORE</a></li>
<li class="toctree-l2"><a class="reference internal" href="CF-SMSBinding.html">10.9. SMS Binding</a></li>
<li class="toctree-l2"><a class="reference internal" href="CF-SmartCardBootstrap.html">10.10. Bootstrapper (smart card bootstrap)</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #ffd500" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Anjay</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../CommercialFeatures.html"><span class="section-number">10. </span>Commercial features</a> &raquo;</li>
      <li><span class="section-number">10.3. </span>Enrollment over Secure Transport</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="enrollment-over-secure-transport">
<h1><span class="section-number">10.3. </span>Enrollment over Secure Transport<a class="headerlink" href="#enrollment-over-secure-transport" title="Permalink to this headline"></a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#general-description" id="id1">General description</a></p></li>
<li><p><a class="reference internal" href="#supported-features" id="id2">Supported features</a></p></li>
<li><p><a class="reference internal" href="#technical-documentation" id="id3">Technical documentation</a></p>
<ul>
<li><p><a class="reference internal" href="#enabling-est-support" id="id4">Enabling EST support</a></p></li>
<li><p><a class="reference internal" href="#persisting-est-state" id="id5">Persisting EST state</a></p></li>
<li><p><a class="reference internal" href="#configuring-est-behavior" id="id6">Configuring EST behavior</a></p></li>
<li><p><a class="reference internal" href="#using-est-with-hardware-security-modules" id="id7">Using EST with hardware security modules</a></p>
<ul>
<li><p><a class="reference internal" href="#hsm-based-est-and-persistence" id="id8">HSM-based EST and persistence</a></p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<section id="general-description">
<h2><a class="toc-backref" href="#id1"><span class="section-number">10.3.1. </span>General description</a><a class="headerlink" href="#general-description" title="Permalink to this headline"></a></h2>
<p><strong>Enrollment over Secure Transport</strong> (EST, <a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc7030">RFC 7030</a>), to quote its specification,
is a certificate management protocol targeting Public Key Infrastructure (PKI)
clients that need to acquire client certificates and associated Certification
Authority (CA) certificates.  It also supports client-generated public/private
key pairs as well as key pairs generated by the CA.</p>
<p><strong>EST-coaps</strong> (<a class="reference external" href="https://datatracker.ietf.org/doc/html/draft-ietf-ace-coap-est-18">draft-ietf-ace-coap-est-18</a>, also
referenced in the LwM2M Core TS) that uses CoAP instead of HTTP for message
exchanges, which allows constrained, low-resource devices to use existing EST
functionality for provisioning certificates.</p>
<p>An implementation of the <strong>EST-coaps client</strong> is provided as a commercial
feature in Anjay. This enhances security provided by the (D)TLS Certificate
mode, by allowing the device to generate a key pair locally, with the private
key never leaving the device, as well as allowing the server to update the
device’s PKIX trust store without a full firmware update.</p>
<p>By using the EST-coaps protocol, you can:</p>
<ul class="simple">
<li><p>Achieve the highest level of security available for the LwM2M protocol,
especially when paired with Hardware Security Module support</p>
<ul>
<li><p>The chain of trust for client and server certificates can be configured in a
more robust way than with the standard Certificate mode</p></li>
<li><p>Generating client keys on the device means that they do not leak even if the
server is compromised</p></li>
</ul>
</li>
<li><p>Make key enrollment procedures in production environments streamlined, simpler
and more scalable</p>
<ul>
<li><p>Only the bootstrap credentials need to be provided at manufacture time,
while keys for the main credentials can be provisioned remotely at first use</p></li>
<li><p>Thanks to standardized means of updating the trust store, including
certificate revocation lists, there are more options for updating the
security credentials and handling cases of compromised keys</p></li>
</ul>
</li>
</ul>
</section>
<section id="supported-features">
<h2><a class="toc-backref" href="#id2"><span class="section-number">10.3.2. </span>Supported features</a><a class="headerlink" href="#supported-features" title="Permalink to this headline"></a></h2>
<p>The following features are implemented:</p>
<ul class="simple">
<li><p>Distribution of CA Certificates (<code class="docutils literal notranslate"><span class="pre">/est/crts</span></code>), supporting both a single raw
X.509 certificate and PKCS#7 cert-only as response payload formats</p></li>
<li><p>Enrollment of Clients (<code class="docutils literal notranslate"><span class="pre">/est/sen</span></code>), supporting both raw X.509 and PKCS#7
cert-only as response payload formats</p></li>
<li><p>Re-enrollment of Clients (<code class="docutils literal notranslate"><span class="pre">/est/sren</span></code>) - the client certificate validity
time is tracked and the <code class="docutils literal notranslate"><span class="pre">/est/sren</span></code> request is issued automatically when the
certificate is nearing expiration, with the exact amount of time being
configurable</p></li>
<li><p>The keys and certificates can be stored in local memory, processed in software
and persisted to local non-volatile storage, or processed and stored by the
Hardware Security Module (requires HSM integration code, some are available as
additional commercial features)</p></li>
</ul>
<p>It is assumed that the same CoAP endpoint is used as both the LwM2M Bootstrap
Server and the EST-coaps server.</p>
</section>
<section id="technical-documentation">
<h2><a class="toc-backref" href="#id3"><span class="section-number">10.3.3. </span>Technical documentation</a><a class="headerlink" href="#technical-documentation" title="Permalink to this headline"></a></h2>
<section id="enabling-est-support">
<h3><a class="toc-backref" href="#id4"><span class="section-number">10.3.3.1. </span>Enabling EST support</a><a class="headerlink" href="#enabling-est-support" title="Permalink to this headline"></a></h3>
<p>If support for EST is available in your version of Anjay, it can be enabled at
compile time by enabling the <code class="docutils literal notranslate"><span class="pre">ANJAY_WITH_EST</span></code> macro in the <code class="docutils literal notranslate"><span class="pre">anjay_config.h</span></code>
file or, if using CMake, enabling the corresponding <code class="docutils literal notranslate"><span class="pre">WITH_EST</span></code> CMake option.</p>
<p>When enabled at compile time, EST support will be automatically available.
However, for the EST requests to be made, the following conditions must be met:</p>
<ul class="simple">
<li><p>LwM2M Bootstrap Server Account must exist; EST requests (other than
<code class="docutils literal notranslate"><span class="pre">/est/sren</span></code>) are only performed after receiving the Bootstrap Finish
request over the Bootstrap interface (see also:
<a class="reference internal" href="../AdvancedTopics/AT-CustomObjects/AT_CO_BootstrapAwareness.html"><span class="doc">Bootstrap awareness</span></a>)</p></li>
<li><p>At least one LwM2M Server Account (provisioned by the Bootstrap Server) must
be configured with the Security Mode resource (<code class="docutils literal notranslate"><span class="pre">/0/*/2</span></code>) set to 4
(Certificate mode with EST).</p></li>
</ul>
<p>Please note that the EST-coaps specification requires that the connection used
for EST requests (which is the Bootstrap Server Account in case of LwM2M) is
configured to use the certificate mode as well. Anjay does not enforce this
requirement, but some LwM2M Bootstrap Servers (including Coiote DM from
AVSystem) may refuse performing EST operations over a transport that does not
use certificates. See <a class="reference internal" href="../AdvancedTopics/AT-Certificates.html"><span class="doc">DTLS connection using certificates</span></a> for more
information on configuring certificate-based security.</p>
<p>You may additionally set the Bootstrap Server Account to use the
<code class="docutils literal notranslate"><span class="pre">ANJAY_SECURITY_EST</span></code> mode instead of <code class="docutils literal notranslate"><span class="pre">ANJAY_SECURITY_CERTIFICATE</span></code>, which
will enable the use of EST-provisioned client certificate for subsequent
connections to the bootstrap server (the certificate from the data model is used
otherwise).</p>
<p>In this default configuration, the EST subsystem will use the following
configuration:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">/est/sren</span></code> requests are issued 30 days before the certificate expiration
date, or after 90% of the time between its provisioning and expiration dates
has passed, whichever is later,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/est/crts</span></code> requests are performed if there is at least one Server Account
provisioned to use the EST mode; the resulting trust store is additionally
used for subsequent connections with the Bootstrap Server as well,</p></li>
<li><p>keys and certificates provisioned using EST are stored in local memory and
processed in software.</p></li>
</ul>
<p>These settings can be changed when initializing the Anjay object, see the
<a class="reference internal" href="#cf-est-config"><span class="std std-ref">Configuring EST behavior</span></a> section for details.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>For EST logic to work properly across restarts of the client application,
persistence of EST state needs to be implemented. This is explained in the
section below.</p>
</div>
</section>
<section id="persisting-est-state">
<h3><a class="toc-backref" href="#id5"><span class="section-number">10.3.3.2. </span>Persisting EST state</a><a class="headerlink" href="#persisting-est-state" title="Permalink to this headline"></a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The full code for the following example can be found in the
<code class="docutils literal notranslate"><span class="pre">examples/commercial-features/CF-EST</span></code> directory in Anjay sources. Note that
to compile and run it, you need to have access to a commercial version of
Anjay that includes the EST feature.</p>
</div>
<p>The EST state needs to be kept in sync with the state of the Security object, so
it is usually a good idea to store those two blocks of data in the same place.
Thus, the persist and restore routines from the
<a class="reference internal" href="../AdvancedTopics/AT-Persistence.html"><span class="doc">Persistence support</span></a> tutorial can be extended as follows:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">avs_is_err</span><span class="p">(</span><span class="n">anjay_security_object_persist</span><span class="p">(</span><span class="n">anjay</span><span class="p">,</span><span class="w"> </span><span class="n">file_stream</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">avs_log</span><span class="p">(</span><span class="n">tutorial</span><span class="p">,</span><span class="w"> </span><span class="n">ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Could not persist Security Object&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">finish</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">avs_is_err</span><span class="p">(</span><span class="n">anjay_server_object_persist</span><span class="p">(</span><span class="n">anjay</span><span class="p">,</span><span class="w"> </span><span class="n">file_stream</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">avs_log</span><span class="p">(</span><span class="n">tutorial</span><span class="p">,</span><span class="w"> </span><span class="n">ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Could not persist Server Object&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">finish</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">avs_is_err</span><span class="p">(</span><span class="n">anjay_attr_storage_persist</span><span class="p">(</span><span class="n">anjay</span><span class="p">,</span><span class="w"> </span><span class="n">file_stream</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">avs_log</span><span class="p">(</span><span class="n">tutorial</span><span class="p">,</span><span class="w"> </span><span class="n">ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Could not persist LwM2M attribute storage&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">finish</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="hll"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">avs_is_err</span><span class="p">(</span><span class="n">anjay_est_state_persist</span><span class="p">(</span><span class="n">anjay</span><span class="p">,</span><span class="w"> </span><span class="n">file_stream</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="w">    </span><span class="n">avs_log</span><span class="p">(</span><span class="n">tutorial</span><span class="p">,</span><span class="w"> </span><span class="n">ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Could not persist EST state&quot;</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">finish</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="p">}</span><span class="w"></span>
</span></pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">avs_is_err</span><span class="p">(</span><span class="n">anjay_security_object_restore</span><span class="p">(</span><span class="n">anjay</span><span class="p">,</span><span class="w"> </span><span class="n">file_stream</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">avs_log</span><span class="p">(</span><span class="n">tutorial</span><span class="p">,</span><span class="w"> </span><span class="n">ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Could not restore Security Object&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">finish</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">avs_is_err</span><span class="p">(</span><span class="n">anjay_server_object_restore</span><span class="p">(</span><span class="n">anjay</span><span class="p">,</span><span class="w"> </span><span class="n">file_stream</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">avs_log</span><span class="p">(</span><span class="n">tutorial</span><span class="p">,</span><span class="w"> </span><span class="n">ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Could not restore Server Object&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">finish</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">avs_is_err</span><span class="p">(</span><span class="n">anjay_attr_storage_restore</span><span class="p">(</span><span class="n">anjay</span><span class="p">,</span><span class="w"> </span><span class="n">file_stream</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">avs_log</span><span class="p">(</span><span class="n">tutorial</span><span class="p">,</span><span class="w"> </span><span class="n">ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Could not restore LwM2M attribute storage&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">finish</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="hll"><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">avs_is_err</span><span class="p">(</span><span class="n">anjay_est_state_restore</span><span class="p">(</span><span class="n">anjay</span><span class="p">,</span><span class="w"> </span><span class="n">file_stream</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="w">    </span><span class="n">avs_log</span><span class="p">(</span><span class="n">tutorial</span><span class="p">,</span><span class="w"> </span><span class="n">ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Could not restore EST state&quot;</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">finish</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="p">}</span><span class="w"></span>
</span></pre></div>
</div>
<p>In the example, the state is persisted when exiting the application, but it
might be a good idea to do it periodically or after each change. The
<a class="reference external" href="../api/core_8h.html#a02394aecc7e6c616ced0ed6157da8ff7">anjay_est_state_is_ready_for_persistence()</a> function can be useful
for this purpose. It is intended to be used in a similar manner to functions
such as <a class="reference external" href="../api/security_8h.html#a25a9fbd4f84f05a8a2ce50f526c7bc77">anjay_security_object_is_modified()</a>, however it will
also return <code class="docutils literal notranslate"><span class="pre">false</span></code> if EST operation is in progress, because in contrast to
data model objects, the EST state cannot be rolled back.</p>
<p>The simplest way to use these functions would be to skip persisting data if
there is no new data ready to be persisted:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="o">!</span><span class="n">anjay_security_object_is_modified</span><span class="p">(</span><span class="n">anjay</span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">anjay_server_object_is_modified</span><span class="p">(</span><span class="n">anjay</span><span class="p">)</span><span class="w"></span>
<span class="w">     </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">anjay_attr_storage_is_modified</span><span class="p">(</span><span class="n">anjay</span><span class="p">))</span><span class="w"></span>
<span class="hll"><span class="w">        </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">anjay_est_state_is_ready_for_persistence</span><span class="p">(</span><span class="n">anjay</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="w">    </span><span class="n">avs_log</span><span class="p">(</span><span class="n">tutorial</span><span class="p">,</span><span class="w"> </span><span class="n">INFO</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="s">&quot;Persistence not necessary - NOT persisting objects&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>However, please take note of the following warning:</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>If <code class="docutils literal notranslate"><span class="pre">anjay_est_state_is_ready_for_persistence()</span></code> returns <code class="docutils literal notranslate"><span class="pre">false</span></code>, the
subsequent call to <code class="docutils literal notranslate"><span class="pre">anjay_est_state_persist()</span></code> will return an error. This
error needs to be handled, and to make sure that <em>some</em> valid data is
persisted, you should make sure that the original state of the persistence
file (or flash memory block, etc.) is restored in that case.</p>
<p>In the example, this is done by never calling
<code class="docutils literal notranslate"><span class="pre">anjay_est_state_is_ready_for_persistence()</span></code> in such a situation.</p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Unless <a class="reference internal" href="#cf-est-hsm"><span class="std std-ref">HSM-based security</span></a> is used, the persistence
stream <strong>will contain cryptographic credentials, including private keys</strong>.
Please consider this when choosing the storage location for this data.</p>
</div>
</section>
<section id="configuring-est-behavior">
<span id="cf-est-config"></span><h3><a class="toc-backref" href="#id6"><span class="section-number">10.3.3.3. </span>Configuring EST behavior</a><a class="headerlink" href="#configuring-est-behavior" title="Permalink to this headline"></a></h3>
<p>The EST example also contains a sample non-default configuration of the EST
subsystem:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="n">anjay_configuration_t</span><span class="w"> </span><span class="n">CONFIG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">endpoint_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">in_buffer_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4000</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">out_buffer_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4000</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">msg_cache_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4000</span><span class="p">,</span><span class="w"></span>

<span class="hll"><span class="w">    </span><span class="p">.</span><span class="n">trust_store_certs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">avs_crypto_certificate_chain_info_from_file</span><span class="p">(</span><span class="w"></span>
</span><span class="hll"><span class="w">            </span><span class="s">&quot;/etc/ssl/certs/ca-certificates.crt&quot;</span><span class="p">),</span><span class="w"></span>
</span><span class="hll"><span class="w">    </span><span class="p">.</span><span class="n">est_reenroll_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">anjay_est_reenroll_config_t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="w">        </span><span class="p">.</span><span class="n">enable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"></span>
</span><span class="hll"><span class="w">        </span><span class="p">.</span><span class="n">nominal_usage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.8</span><span class="p">,</span><span class="w"></span>
</span><span class="hll"><span class="w">        </span><span class="p">.</span><span class="n">max_margin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">avs_time_duration_from_scalar</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="n">AVS_TIME_DAY</span><span class="p">)</span><span class="w"></span>
</span><span class="hll"><span class="w">    </span><span class="p">},</span><span class="w"></span>
</span><span class="hll"><span class="w">    </span><span class="p">.</span><span class="n">est_cacerts_policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ANJAY_EST_CACERTS_FOR_EST_SECURITY</span><span class="w"></span>
</span><span class="p">};</span><span class="w"></span>

<span class="n">g_anjay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">anjay_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CONFIG</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<p>Here’s a quick description of the settings used:</p>
<ul class="simple">
<li><p><a class="reference external" href="../api/structanjay__configuration.html#a6eb46a8b375d73a4c2fb609ac17748db">trust_store_certs</a>
is not strictly related to EST, but it can be used to configure the initial
trust store for use when the <a class="reference external" href="http://www.openmobilealliance.org/release/LightweightM2M/V1_2-20201110-A/HTML-Version/OMA-TS-LightweightM2M_Transport-V1_2-20201110-A.html#5-2-9-7-0-5297-Certificate-Usage-Field">Certificate Usage field</a>
(see also: <a class="reference external" href="../api/structanjay__security__instance__t.html#ac972ac4a1d3ff7ea8501c31f08773d4c">anjay_security_instance_t::certificate_usage</a>)
is set to 0 or 1, used before a new one is obtained via <code class="docutils literal notranslate"><span class="pre">/est/crts</span></code></p>
<ul>
<li><p>See also related: <a class="reference external" href="../api/structanjay__configuration.html#a84b693c1bb9e83bbf67a0a9b304d5e88">use_system_trust_store</a>
and <a class="reference external" href="../api/structanjay__configuration.html#aa0a29edbd09fca4542ac146b39663657">trust_store_crls</a></p></li>
</ul>
</li>
<li><p><a class="reference external" href="../api/structanjay__configuration.html#af360bcadeb344ff6d1b27451920515cc">est_reenroll_config</a>
can be set to change the default schedule of performing the <code class="docutils literal notranslate"><span class="pre">/est/sren</span></code>
requests; detailed semantics of its fields are available in the
<a class="reference external" href="../api/structanjay__est__reenroll__config__t.html">anjay_est_reenroll_config_t Struct Reference</a></p>
<ul>
<li><p>The settings in the example mean that the new certificate is requested
7 days before its expiry date, or after 80% of its validity period have
passeed, whichever comes later</p></li>
</ul>
</li>
<li><p><a class="reference external" href="api/structanjay__configuration.html#aa77f9d5291f4bee4d92efaebe02f5a4c">est_cacerts_policy</a>
allows changing the details on when the <code class="docutils literal notranslate"><span class="pre">/est/crts</span></code> request is performed
and what the provisioned trust store is used for; detailed semantics of each
available mode is available in the <a class="reference external" href="../api/core_8h.html#a150879e082c4c2355393dab23bacddba">anjay_est_cacerts_policy_t Enum Reference</a></p></li>
</ul>
</section>
<section id="using-est-with-hardware-security-modules">
<span id="cf-est-hsm"></span><h3><a class="toc-backref" href="#id7"><span class="section-number">10.3.3.4. </span>Using EST with hardware security modules</a><a class="headerlink" href="#using-est-with-hardware-security-modules" title="Permalink to this headline"></a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The full code for the following example can be found in the
<code class="docutils literal notranslate"><span class="pre">examples/commercial-features/CF-EST-PKCS11</span></code> directory in Anjay sources.
Note that to compile and run it, you need to have access to a commercial
version of Anjay that includes the EST and HSM features.</p>
</div>
<p>When Anjay also has the hardware security module support (available as a
separate commercial feature) compiled in, the EST module can easily be
configured to use it for generating and storing the security credentials.</p>
<p>The variant of the example application that uses PKCS#11 hardware cryptography
engine specifies additional fields in the <code class="docutils literal notranslate"><span class="pre">anjay_configuration_t</span></code> structure:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">char</span><span class="w"> </span><span class="n">EST_CACERTS_ADDRESS_BUF</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span><span class="w"></span>

<span class="n">srand</span><span class="p">(</span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">));</span><span class="w"></span>

<span class="k">const</span><span class="w"> </span><span class="n">anjay_configuration_t</span><span class="w"> </span><span class="n">CONFIG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">endpoint_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">in_buffer_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4000</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">out_buffer_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4000</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">msg_cache_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4000</span><span class="p">,</span><span class="w"></span>

<span class="w">    </span><span class="p">.</span><span class="n">trust_store_certs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">avs_crypto_certificate_chain_info_from_file</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="s">&quot;/etc/ssl/certs/ca-certificates.crt&quot;</span><span class="p">),</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">est_reenroll_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">anjay_est_reenroll_config_t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">enable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">nominal_usage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.8</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">max_margin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">avs_time_duration_from_scalar</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="n">AVS_TIME_DAY</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="p">.</span><span class="n">est_cacerts_policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ANJAY_EST_CACERTS_FOR_EST_SECURITY</span><span class="p">,</span><span class="w"></span>

<span class="hll"><span class="w">    </span><span class="p">.</span><span class="n">est_engine_key_address</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
</span><span class="hll"><span class="w">            </span><span class="s">&quot;pkcs11:token=MyToken;object=EstClientKey;pin-value=1234&quot;</span><span class="p">,</span><span class="w"></span>
</span><span class="hll"><span class="w">    </span><span class="p">.</span><span class="n">est_engine_cert_address</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
</span><span class="hll"><span class="w">            </span><span class="s">&quot;pkcs11:token=MyToken;object=EstClientCert;pin-value=1234&quot;</span><span class="p">,</span><span class="w"></span>
</span><span class="hll"><span class="w">    </span><span class="p">.</span><span class="n">est_engine_cacerts_address_gen_cb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">est_crts_address_gen</span><span class="p">,</span><span class="w"></span>
</span><span class="hll"><span class="w">    </span><span class="p">.</span><span class="n">est_engine_cacerts_address_gen_cb_arg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EST_CACERTS_ADDRESS_BUF</span><span class="w"></span>
</span><span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The “addresses” (also sometimes referred to as “query strings”) in this
example are PKCS#11 URIs. However, the format of these strings is
dependent on the hardware security engine used. Please refer to the
documentation of the module you’re using (PKCS#11, PSA, IoT SAFE etc.), or
its implementation if you have implemented one yourself.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When the examples are compiled automatically (e.g. using
<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">commercial_feature_examples</span></code>), the Anjay library is configured to
use the PKCS#11 backend.</p>
<p>To run it, the PKCS#11 module library needs to be specified via the
<code class="docutils literal notranslate"><span class="pre">PKCS11_MODULE_PATH</span></code> environment variable, for example:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>env PKCS11_MODULE_PATH=/usr/lib/softhsm/libsofthsm2.so ./anjay-est-pkcs11 {endpoint-name}
</pre></div>
</div>
</div>
<p>Here’s a quick description of the settings used:</p>
<ul>
<li><p><a class="reference external" href="../api/structanjay__configuration.html#abbcfd5912e1138f4576509c500ed1a9a">est_engine_key_address</a>
specifies the address at which the client’s private key will be generated
during the EST enrollment process</p>
<ul class="simple">
<li><p>Note: in case of PKCS#11, two objects will be generated, separate for the
private and public keys; these will share the same label</p></li>
</ul>
</li>
<li><p><a class="reference external" href="../api/structanjay__configuration.html#aecdf44d9bd9d87fbdca6672d6f9aaf11">est_engine_cert_address</a>
specifies the address at which the client’s public certificate will be stored
after having been provisioned by the EST server</p></li>
<li><p><a class="reference external" href="../api/structanjay__configuration.html#abc4fdd9feb2cb58a47408a96308dbf6e">est_engine_cacerts_address_gen_cb</a>
is set to a pointer to the function that will be used for generating addresses
at which the trusted certificates provisioned via the <code class="docutils literal notranslate"><span class="pre">/est/crts</span></code> operation
will be stored</p>
<ul>
<li><p>This generation function is necessary because there might be multiple
trusted certificates, so a single address is not sufficient</p></li>
<li><p><a class="reference external" href="../api/structanjay__configuration.html#a695689ab4fc248793ad63f631a0c630f">est_engine_cacerts_address_gen_cb_arg</a>
can be used to specify any opaque argument that will be passed to that
function; in this example it points to a buffer that will be used to store
the generated addresses, but you are free to use this argument in any way
you wish</p></li>
<li><p>In this example application, the following function is used:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="nf">est_crts_address_gen</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">x509_der_data</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">x509_der_data_size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">x509_der_data</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">x509_der_data_size</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">buf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">arg</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;pkcs11:token=MyToken;object=CaCert%d;pin-value=1234&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">rand</span><span class="p">());</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">buf</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>The example function generates the addresses based on a random number;
however, the actual DER-encoded certificate is passed to this function as
well so that you may choose to generate the address based on the contents of
the certificate</p></li>
<li><p>The returned string is copied by the library, so reusing the same buffer for
multiple calls is OK. See <a class="reference external" href="../api/core_8h.html#ae8604feaa669414289ed99d75a03d6fb">anjay_est_engine_cacert_address_gen_t</a> for details on
this callback’s semantics.</p></li>
</ul>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You may specify only some of the above arguments, and leave others as
<code class="docutils literal notranslate"><span class="pre">NULL</span></code>. Software handling will be used for any credentials for which
hardware engine addresses are not provided.</p>
</div>
<section id="hsm-based-est-and-persistence">
<h4><a class="toc-backref" href="#id8"><span class="section-number">10.3.3.4.1. </span>HSM-based EST and persistence</a><a class="headerlink" href="#hsm-based-est-and-persistence" title="Permalink to this headline"></a></h4>
<p>When using hardware security engine for EST, the persistence stream will only
contain references (addresses) to the security credentials stored there.</p>
<p>The EST module manages the lifecycle of these credentials, so that old ones are
automatically removed when e.g. a new certificate is re-enrolled.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>To ensure that the credentials stored on the HSM and the references in the
persistence stream are kept in sync, <strong>all EST-related security credentials
stored in the HSM will be removed from it</strong> when cleaning up the Anjay
object, unless there have been no changes to them since the last call to
<code class="docutils literal notranslate"><span class="pre">anjay_est_state_persist()</span></code> or <code class="docutils literal notranslate"><span class="pre">anjay_est_state_restore()</span></code>.</p>
</div>
</section>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="CF-CustomHardwareSupport.html" class="btn btn-neutral float-left" title="10.2. Custom Hardware Support" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="CF-FSDM.html" class="btn btn-neutral float-right" title="10.4. File System Data Model" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017-2023, AVSystem.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>