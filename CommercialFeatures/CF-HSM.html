<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>10.5. Hardware Security Module &mdash; Anjay 3.8.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/theme_overrides.css?v=b9c2c5b9" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=948f11bf"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="10.6. IoT SAFE" href="CF-IoTSAFE.html" />
    <link rel="prev" title="10.4. File System Data Model" href="CF-FSDM.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #ffd500" >

          
          
          <a href="../index.html">
            
              <img src="../_static/avsystem_header.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                3.8.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LwM2M.html">2. OMA LwM2M - Brief description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Compiling_client_applications.html">3. Compiling client applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../BasicClient.html">4. Basic client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../AdvancedTopics.html">5. Advanced topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FirmwareUpdateTutorial.html">6. Firmware Update Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Tools.html">7. Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PortingGuideForNonPOSIXPlatforms.html">8. Porting guide for non-POSIX platforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Migrating.html">9. Migrating from older versions</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../CommercialFeatures.html">10. Commercial features</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="CF-CorePersistence.html">10.1. Core Persistence</a></li>
<li class="toctree-l2"><a class="reference internal" href="CF-CustomHardwareSupport.html">10.2. Custom Hardware Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="CF-EST.html">10.3. Enrollment over Secure Transport</a></li>
<li class="toctree-l2"><a class="reference internal" href="CF-FSDM.html">10.4. File System Data Model</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">10.5. Hardware Security Module</a></li>
<li class="toctree-l2"><a class="reference internal" href="CF-IoTSAFE.html">10.6. IoT SAFE</a></li>
<li class="toctree-l2"><a class="reference internal" href="CF-NIDD.html">10.7. Non-IP Data Delivery</a></li>
<li class="toctree-l2"><a class="reference internal" href="CF-OSCORE.html">10.8. OSCORE</a></li>
<li class="toctree-l2"><a class="reference internal" href="CF-SMSBinding.html">10.9. SMS Binding</a></li>
<li class="toctree-l2"><a class="reference internal" href="CF-SmartCardBootstrap.html">10.10. Bootstrapper and SIM bootstrap</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #ffd500" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Anjay</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../CommercialFeatures.html"><span class="section-number">10. </span>Commercial features</a></li>
      <li class="breadcrumb-item active"><span class="section-number">10.5. </span>Hardware Security Module</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="hardware-security-module">
<h1><span class="section-number">10.5. </span>Hardware Security Module<a class="headerlink" href="#hardware-security-module" title="Link to this heading"></a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#supported-features" id="id2">Supported features</a></p></li>
<li><p><a class="reference internal" href="#technical-documentation" id="id3">Technical documentation</a></p>
<ul>
<li><p><a class="reference internal" href="#enabling-hardware-security-module-support" id="id4">Enabling Hardware Security Module support</a></p></li>
<li><p><a class="reference internal" href="#addressing-hardware-security-module-objects" id="id5">Addressing Hardware Security Module objects</a></p></li>
<li><p><a class="reference internal" href="#using-security-objects-already-stored-in-hsm" id="id6">Using security objects already stored in HSM</a></p></li>
<li><p><a class="reference internal" href="#storing-and-removing-objects-from-hsm" id="id7">Storing and removing objects from HSM</a></p></li>
<li><p><a class="reference internal" href="#use-the-hsm-in-the-implicit-way" id="id8">Use the HSM in the implicit way</a></p></li>
</ul>
</li>
</ul>
</nav>
<p><strong>Hardware Security Module (HSM)</strong> is a piece of hardware designed to increase
security of the device by keeping the vulnerable data safe (mainly private
or secret keys, but also certificates) and performing operations like:</p>
<blockquote>
<div><ul class="simple">
<li><p>key generation,</p></li>
<li><p>signing/verification,</p></li>
<li><p>encryption/decryption,</p></li>
</ul>
</div></blockquote>
<p>while the used private and secret keys are not leaving their secure memory.
Because such idea might have a lot of various implementations, some generic APIs
were created. Commercial feature of Anjay, HSM, includes integrations with two
of them: <a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc7512">PKCS11</a> and
<a class="reference external" href="https://developer.arm.com/architectures/architecture-security-features/platform-security">PSA</a>.</p>
<p>To increase the safety of the IoT client even more
HSMs are often used to maintain credentials used in Enrollment over Security
Transport (EST). To make this easier, when Anjay is used with both HSM and
<a class="reference internal" href="CF-EST.html"><span class="doc">Enrollment over Secure Transport</span></a> commercial features it includes also an additional integration
between them, which allows to easily setup such a secure
client (see CF-EST-PKCS11 example).</p>
<section id="supported-features">
<h2><a class="toc-backref" href="#id2" role="doc-backlink"><span class="section-number">10.5.1. </span>Supported features</a><a class="headerlink" href="#supported-features" title="Link to this heading"></a></h2>
<p>The following features are implemented:</p>
<ul class="simple">
<li><p>integration with <em>PKCS11</em> API - working with both <em>OpenSSL</em> (using PKI)
and <em>mbed TLS</em> (using PKI),</p></li>
<li><p>integration with <em>Platform Security Architecure (PSA)</em> API - working with
<em>mbed TLS</em> (using PKI or PSK),</p></li>
<li><p>integration with the <em>EST</em> feature (see <a class="reference internal" href="CF-EST.html"><span class="doc">Enrollment over Secure Transport</span></a>) which allows to
keep the private keys and certificates used by EST operations.</p></li>
</ul>
</section>
<section id="technical-documentation">
<h2><a class="toc-backref" href="#id3" role="doc-backlink"><span class="section-number">10.5.2. </span>Technical documentation</a><a class="headerlink" href="#technical-documentation" title="Link to this heading"></a></h2>
<section id="enabling-hardware-security-module-support">
<h3><a class="toc-backref" href="#id4" role="doc-backlink"><span class="section-number">10.5.2.1. </span>Enabling Hardware Security Module support</a><a class="headerlink" href="#enabling-hardware-security-module-support" title="Link to this heading"></a></h3>
<p>The integrations with the HSM APIs (i.e. PKCS11 and PSA) are available as
separate commercial features and the first requirement to make it work is to use
a version of Anjay containing them.</p>
<p>From Anjay’s perspective PKCS11 and PSA engines are used in quite similar way and
are considered as backends for the APIs enabled by the corresponding macros:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">AVS_COMMONS_WITH_AVS_CRYPTO_PKI_ENGINE</span></code> - for PKI support,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AVS_COMMONS_WITH_AVS_CRYPTO_PSK_ENGINE</span></code> - for PSK support.</p></li>
</ul>
<p>To enable support for PKCS11 backend one has to enable (depending on which
cryptographic library is used):</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">AVS_COMMONS_WITH_MBEDTLS_PKCS11_ENGINE</span></code> - while using mbed TLS,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AVS_COMMONS_WITH_OPENSSL_PKCS11_ENGINE</span></code> - while using OpenSSL.</p></li>
</ul>
<p>In the case of PSA only mbed TLS support is available, so the proper macro
is <code class="docutils literal notranslate"><span class="pre">AVS_COMMONS_WITH_MBEDTLS_PSA_ENGINE</span></code>. Additionally, the used mbed TLS
version must be compiled with <code class="docutils literal notranslate"><span class="pre">MBEDTLS_USE_PSA_CRYPTO</span></code> flag. If there is
PSA Protcted Storage API available and you want Anjay to be able to use it, you
need also <code class="docutils literal notranslate"><span class="pre">AVS_COMMONS_WITH_MBEDTLS_PSA_ENGINE_PROTECTED_STORAGE</span></code> to be
defined.</p>
<p>An alternative method to enable a certain integration is enabling the proper
macro in the <code class="docutils literal notranslate"><span class="pre">avs_commons_config.h</span></code> file (where “proper” means that its name
consists of <code class="docutils literal notranslate"><span class="pre">AVS_COMMONS_</span></code> and corresponding CMake option).</p>
<p>There are also a few macros which can be defined for the support of the
HSM-stored credentials in Anjay:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ANJAY_WITH_SECURITY_STRUCTURED</span></code> - enable support for handling complex types
of security credentials in the data model using structured &lt;c&gt;avs_crypto&lt;/c&gt;
types. In particular, it allows to keep credentials in the form of their HSM
address.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ANJAY_WITH_MODULE_SECURITY_ENGINE_SUPPORT</span></code> - enables the automatic
moving to HSM the credentials stored in the built-in Anjay Security object.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ANJAY_WITH_EST_ENGINE_SUPPORT</span></code> - when the EST commercial feature is
available, it enables the support for storing on HSM the credentials used
during EST operations.</p></li>
</ul>
<p>As before, this macros might be defined directly in <code class="docutils literal notranslate"><span class="pre">anjay_config.h</span></code> file,
or set using CMake.</p>
</section>
<section id="addressing-hardware-security-module-objects">
<h3><a class="toc-backref" href="#id5" role="doc-backlink"><span class="section-number">10.5.2.2. </span>Addressing Hardware Security Module objects</a><a class="headerlink" href="#addressing-hardware-security-module-objects" title="Link to this heading"></a></h3>
<p>Objects in PSA and PKCS11 are addressed in a slightly different ways - in PSA
an object is called <em>key</em> and to access it just its identifier is required,
which is simply an integer. Thus, PSA query used by Anjay consists of a single
parameter: <code class="docutils literal notranslate"><span class="pre">kid=KEY_ID</span></code>, where <em>KEY_ID</em> is the hex-encoded key identifier.
When PSA Protected Storage API is available and enabled in Anjay (it needs the
macro <code class="docutils literal notranslate"><span class="pre">AVS_COMMONS_WITH_MBEDTLS_PSA_ENGINE_PROTECTED_STORAGE</span></code> to be defined),
it may keep raw data addressed with some <em>ID</em>. In which case query will be quite
similar: <code class="docutils literal notranslate"><span class="pre">uid=ID</span></code>.</p>
<p>Queries which are used to address the PKCS11 objects were defined in
<a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc7512">PKCS11 RFC</a> as PKCS11 URI.
They may contain a lot of various fields, but usually three of them are used in
Anjay clients: <em>token</em>, <em>pin</em> and <em>label</em> (or <em>id</em> instead of label). In such
case, the PKCS11 query looks like:
<code class="docutils literal notranslate"><span class="pre">pkcs11:token=TOKEN;object=LABEL;pin-value=PIN</span></code>.</p>
</section>
<section id="using-security-objects-already-stored-in-hsm">
<h3><a class="toc-backref" href="#id6" role="doc-backlink"><span class="section-number">10.5.2.3. </span>Using security objects already stored in HSM</a><a class="headerlink" href="#using-security-objects-already-stored-in-hsm" title="Link to this heading"></a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The full code for the following example can be found in the
<code class="docutils literal notranslate"><span class="pre">examples/commercial-features/CF-PSA-PSK</span></code>,
<code class="docutils literal notranslate"><span class="pre">examples/commercial-features/CF-PSA-PKI</span></code> and
<code class="docutils literal notranslate"><span class="pre">examples/commercial-features/CF-PKCS11</span></code> directories in Anjay sources.
Note that to compile and run it, you need to have access to
a commercial version of Anjay that includes HSM feature.</p>
</div>
<p>When using HSM to store the Security objects, they shouldn’t be stored in the
application memory, so they can’t be kept in the buffers in the security object
instances, so some other kind of structures is needed for them. For this purpose
an additional set of fields, which are able to store them, was introduced in
<a class="reference external" href="../api/structanjay__security__instance__t.html">anjay_security_instance_t</a>
(to make them available <code class="docutils literal notranslate"><span class="pre">ANJAY_WITH_SECURITY_STRUCTURED</span></code> macro must be
defined):</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/** Resource: Public Key Or Identity;</span>
<span class="cm">* This is an alternative to the @p public_cert_or_psk_identity and</span>
<span class="cm">* @p psk_identity fields that may be used only if @p security_mode is</span>
<span class="cm">* either @ref ANJAY_SECURITY_CERTIFICATE or @ref ANJAY_SECURITY_EST; it is</span>
<span class="cm">* also an error to specify non-empty values for more than one of these</span>
<span class="cm">* fields at the same time. */</span>
<span class="n">avs_crypto_certificate_chain_info_t</span><span class="w"> </span><span class="n">public_cert</span><span class="p">;</span>
<span class="cm">/** Resource: Secret Key;</span>
<span class="cm">* This is an alternative to the @p private_cert_or_psk_key and @ref psk_key</span>
<span class="cm">* fields that may be used only if @p security_mode is either</span>
<span class="cm">* @ref ANJAY_SECURITY_CERTIFICATE or @ref ANJAY_SECURITY_EST; it is also an</span>
<span class="cm">* error to specify non-empty values for more than one of these fields at</span>
<span class="cm">* the same time. */</span>
<span class="n">avs_crypto_private_key_info_t</span><span class="w"> </span><span class="n">private_key</span><span class="p">;</span>
<span class="cm">/** Resource: Public Key Or Identity;</span>
<span class="cm">* This is an alternative to the @p public_cert_or_psk_identity and</span>
<span class="cm">* @ref public_cert fields that may be used only if @p security_mode is</span>
<span class="cm">* @ref ANJAY_SECURITY_PSK; it is also an error to specify non-empty values</span>
<span class="cm">* for more than one of these fields at the same time. */</span>
<span class="n">avs_crypto_psk_identity_info_t</span><span class="w"> </span><span class="n">psk_identity</span><span class="p">;</span>
<span class="cm">/** Resource: Secret Key;</span>
<span class="cm">* This is an alternative to the @p private_cert_or_psk_key and</span>
<span class="cm">* @ref private_key fields that may be used only if @p security_mode is</span>
<span class="cm">* @ref ANJAY_SECURITY_PSK; it is also an error to specify non-empty values</span>
<span class="cm">* for more than one of these fields at the same time. */</span>
<span class="n">avs_crypto_psk_key_info_t</span><span class="w"> </span><span class="n">psk_key</span><span class="p">;</span>
</pre></div>
</div>
<p>There is also a set of functions which can turn an HSM query pointing to the
required object stored on the HSM to the struct which can be used by the
instance of the Security object:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">avs_crypto_certificate_chain_info_from_engine()</span></code> - creates certificate chain
descriptor used later on to load a certificate from the engine,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">avs_crypto_private_key_info_from_engine()</span></code> - creates private key descriptor
used later on to load private key from the engine,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">avs_crypto_psk_key_info_from_engine()</span></code> - creates pre-shared key descriptor
used later on to load pre-shared key from the engine,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">avs_crypto_psk_identity_info_from_engine()</span></code> - creates pre-shared key identity
descriptor used later on to load pre-shared key identity from the engine.</p></li>
</ul>
<p>One may notice that the first two of them (as well as first two mentioned
<a class="reference external" href="../api/structanjay__security__instance__t.html">anjay_security_instance_t</a>
fields) are used when the connection is secured using PKI, while the latter are
used with PSK. Let’s see how they work with a Security object instance in PKI
mode in the PKCS11 example:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define KEY_QUERY &quot;pkcs11:token=MyToken;object=ClientKey;pin-value=1234&quot;</span>
<span class="cp">#define CERTIFICATE_QUERY \</span>
<span class="cp">    &quot;pkcs11:token=MyToken;object=ClientCert;pin-value=1234&quot;</span>

<span class="c1">// ...</span>

<span class="k">const</span><span class="w"> </span><span class="n">anjay_security_instance_t</span><span class="w"> </span><span class="n">security_instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">ssid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">server_uri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;coaps://eu.iot.avsystem.cloud:5684&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">security_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ANJAY_SECURITY_CERTIFICATE</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">public_cert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">avs_crypto_certificate_chain_info_from_engine</span><span class="p">(</span>
<span class="w">            </span><span class="n">CERTIFICATE_QUERY</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">private_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">avs_crypto_private_key_info_from_engine</span><span class="p">(</span><span class="n">KEY_QUERY</span><span class="p">)</span>
<span class="p">};</span>
</pre></div>
</div>
<p>The only thing that must be changed to use keys and certificates on HSM which
uses PSA API are the queries for the key and the certificate:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define KEY_QUERY &quot;kid=0x00000001&quot;</span>
<span class="cp">#define CERTIFICATE_QUERY &quot;kid=0x00000002&quot;</span>

<span class="c1">// ...</span>

<span class="k">const</span><span class="w"> </span><span class="n">anjay_security_instance_t</span><span class="w"> </span><span class="n">security_instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">ssid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">server_uri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;coaps://eu.iot.avsystem.cloud:5684&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">security_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ANJAY_SECURITY_CERTIFICATE</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">public_cert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">avs_crypto_certificate_chain_info_from_engine</span><span class="p">(</span>
<span class="w">            </span><span class="n">CERTIFICATE_QUERY</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">private_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">avs_crypto_private_key_info_from_engine</span><span class="p">(</span><span class="n">KEY_QUERY</span><span class="p">),</span>
<span class="p">};</span>
</pre></div>
</div>
<p>And in the similar way, we can use PSA for keeping credentials for the PSK mode
(CF-PSA-PSK example):</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#define IDENTITY_QUERY &quot;kid=0x00000001&quot;</span>
<span class="cp">#define KEY_QUERY &quot;kid=0x00000002&quot;</span>

<span class="c1">// ...</span>

<span class="k">const</span><span class="w"> </span><span class="n">anjay_security_instance_t</span><span class="w"> </span><span class="n">security_instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">ssid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">server_uri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;coaps://eu.iot.avsystem.cloud:5684&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">security_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ANJAY_SECURITY_PSK</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">psk_identity</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">avs_crypto_psk_identity_info_from_engine</span><span class="p">(</span><span class="n">IDENTITY_QUERY</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">psk_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">avs_crypto_psk_key_info_from_engine</span><span class="p">(</span><span class="n">KEY_QUERY</span><span class="p">),</span>
<span class="p">};</span>
</pre></div>
</div>
</section>
<section id="storing-and-removing-objects-from-hsm">
<h3><a class="toc-backref" href="#id7" role="doc-backlink"><span class="section-number">10.5.2.4. </span>Storing and removing objects from HSM</a><a class="headerlink" href="#storing-and-removing-objects-from-hsm" title="Link to this heading"></a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The full code for the following example can be found in the
<code class="docutils literal notranslate"><span class="pre">examples/commercial-features/CF-PSA-management</span></code> directory in Anjay
sources. Note that to compile and run it, you need to have access to
a commercial version of Anjay that includes HSM feature.</p>
</div>
<p>The avs_commons provides following functions for storing PKI private keys and
certificates in the HSM:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">avs_crypto_pki_engine_key_store()</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">avs_crypto_pki_engine_certificate_store()</span></code></p></li>
</ul>
<p>and corresponding functions for their removal:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">avs_crypto_pki_engine_key_rm()</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">avs_crypto_pki_engine_certificate_rm()</span></code>.</p></li>
</ul>
<p>An example of how they can be used to manage PKI objects is shown in
CF-PSA-management example:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;pkey&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">avs_is_err</span><span class="p">(</span><span class="n">avs_crypto_pki_engine_key_rm</span><span class="p">(</span><span class="n">query</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">avs_log</span><span class="p">(</span><span class="n">tutorial</span><span class="p">,</span><span class="w"> </span><span class="n">ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Private key removal failed&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;certificate&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">avs_is_err</span><span class="p">(</span><span class="n">avs_crypto_pki_engine_certificate_rm</span><span class="p">(</span><span class="n">query</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">avs_log</span><span class="p">(</span><span class="n">tutorial</span><span class="p">,</span><span class="w"> </span><span class="n">ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Certificate removal failed&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;psk_key&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>

<span class="c1">// ...</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;pkey&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">avs_crypto_private_key_info_t</span><span class="w"> </span><span class="n">key_info</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">avs_crypto_private_key_info_from_file</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">avs_is_err</span><span class="p">(</span><span class="n">avs_crypto_pki_engine_key_store</span><span class="p">(</span>
<span class="w">                </span><span class="n">query</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">key_info</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">avs_log</span><span class="p">(</span><span class="n">tutorial</span><span class="p">,</span><span class="w"> </span><span class="n">ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Storing private key failed&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;certificate&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">avs_crypto_certificate_chain_info_t</span><span class="w"> </span><span class="n">cert_info</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">avs_crypto_certificate_chain_info_from_file</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">avs_is_err</span><span class="p">(</span><span class="n">avs_crypto_pki_engine_certificate_store</span><span class="p">(</span>
<span class="w">                </span><span class="n">query</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cert_info</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">avs_log</span><span class="p">(</span><span class="n">tutorial</span><span class="p">,</span><span class="w"> </span><span class="n">ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Storing certificate failed&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="s">&quot;psk_key&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</pre></div>
</div>
<p>Analogous set of functions is also available for the PSK cryptography:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">avs_crypto_psk_engine_key_store()</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">avs_crypto_psk_engine_identity_store()</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">avs_crypto_psk_engine_key_store()</span></code> and</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">avs_crypto_psk_engine_identity_store()</span></code>.</p></li>
</ul>
<p>There is also a similar example of their usage in the CF-PSA-management example.</p>
<p>In PKI engine API there are also functions for private key generation,
<code class="docutils literal notranslate"><span class="pre">avs_crypto_pki_engine_key_gen</span></code>, but to use the generated key, we need to
prepare a certificate for it. This is done typically during the EST enrollment.
Please see the EST feature documentation for more information on this topic.</p>
</section>
<section id="use-the-hsm-in-the-implicit-way">
<h3><a class="toc-backref" href="#id8" role="doc-backlink"><span class="section-number">10.5.2.5. </span>Use the HSM in the implicit way</a><a class="headerlink" href="#use-the-hsm-in-the-implicit-way" title="Link to this heading"></a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The full code for the following example can be found in the
<code class="docutils literal notranslate"><span class="pre">examples/commercial-features/CF-PSA-boostrap</span></code> directory in Anjay
sources. Note that to compile and run it, you need to have access to
a commercial version of Anjay that includes HSM feature.</p>
</div>
<p>An alternative, and probably more elegant, approach to store and use credentials
on HSM is to use the function <a class="reference external" href="../api/security_8h.html#ad7cf8eb206cabb407aad57777dc0a144">anjay_security_object_install_with_hsm</a> to install the
Security object and then use it in the same way as the standard one - it will
move the provided credentials to HSM memory. This function, comparing to default
<a class="reference external" href="../api/security_8h.html#a5fffaeedfc5c2933e58ac1446fd0401d">anjay_security_object_install</a>, needs an
additional argument - <code class="docutils literal notranslate"><span class="pre">hsm_config</span></code> which is basically a set of callbacks (and
their arguments) required to generate the HSM adresses for new HSM objects:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm">* Configuration of the callbacks for generating the query string addresses</span>
<span class="cm">* under which different kinds of security credentials will be stored on the</span>
<span class="cm">* hardware security engine.</span>
<span class="cm">*/</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/**</span>
<span class="cm">    * Callback function that will be called whenever a public client</span>
<span class="cm">    * certificate needs to be stored in an external security engine.</span>
<span class="cm">    *</span>
<span class="cm">    * If NULL, public client certificates will be stored in main system memory</span>
<span class="cm">    * unless explicitly requested via either EST or the &lt;c&gt;public_cert&lt;/c&gt;</span>
<span class="cm">    * field in @ref anjay_security_instance_t.</span>
<span class="cm">    */</span>
<span class="w">    </span><span class="n">anjay_security_hsm_query_cb_t</span><span class="w"> </span><span class="o">*</span><span class="n">public_cert_cb</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">    * Opaque argument that will be passed to the function configured in the</span>
<span class="cm">    * &lt;c&gt;public_cert_cb&lt;/c&gt; field.</span>
<span class="cm">    *</span>
<span class="cm">    * If &lt;c&gt;public_cert_cb&lt;/c&gt; is NULL, this field is ignored.</span>
<span class="cm">    */</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">public_cert_cb_arg</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">    * Callback function that will be called whenever a client private key needs</span>
<span class="cm">    * to be stored in an external security engine.</span>
<span class="cm">    *</span>
<span class="cm">    * If NULL, client private keys will be stored in main system memory unless</span>
<span class="cm">    * explicitly requested via either EST or the &lt;c&gt;private_key&lt;/c&gt; field in</span>
<span class="cm">    * @ref anjay_security_instance_t.</span>
<span class="cm">    */</span>
<span class="w">    </span><span class="n">anjay_security_hsm_query_cb_t</span><span class="w"> </span><span class="o">*</span><span class="n">private_key_cb</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">    * Opaque argument that will be passed to the function configured in the</span>
<span class="cm">    * &lt;c&gt;private_key_cb&lt;/c&gt; field.</span>
<span class="cm">    *</span>
<span class="cm">    * If &lt;c&gt;private_key_cb&lt;/c&gt; is NULL, this field is ignored.</span>
<span class="cm">    */</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">private_key_cb_arg</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">    * Callback function that will be called whenever a PSK identity for use</span>
<span class="cm">    * with the main connection needs to be stored in an external security</span>
<span class="cm">    * engine.</span>
<span class="cm">    *</span>
<span class="cm">    * If NULL, PSK identities for use with the main connection will be stored</span>
<span class="cm">    * in main system memory unless explicitly requested via the</span>
<span class="cm">    * &lt;c&gt;psk_identity&lt;/c&gt; field in @ref anjay_security_instance_t.</span>
<span class="cm">    */</span>
<span class="w">    </span><span class="n">anjay_security_hsm_query_cb_t</span><span class="w"> </span><span class="o">*</span><span class="n">psk_identity_cb</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">    * Opaque argument that will be passed to the function configured in the</span>
<span class="cm">    * &lt;c&gt;psk_identity_cb&lt;/c&gt; field.</span>
<span class="cm">    *</span>
<span class="cm">    * If &lt;c&gt;psk_identity_cb&lt;/c&gt; is NULL, this field is ignored.</span>
<span class="cm">    */</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">psk_identity_cb_arg</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">    * Callback function that will be called whenever a PSK key for use with the</span>
<span class="cm">    * main connection needs to be stored in an external security engine.</span>
<span class="cm">    *</span>
<span class="cm">    * If NULL, PSK keys for use with the main connection will be stored in main</span>
<span class="cm">    * system memory unless explicitly requested via the &lt;c&gt;psk_key&lt;/c&gt; field in</span>
<span class="cm">    * @ref anjay_security_instance_t.</span>
<span class="cm">    */</span>
<span class="w">    </span><span class="n">anjay_security_hsm_query_cb_t</span><span class="w"> </span><span class="o">*</span><span class="n">psk_key_cb</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">    * Opaque argument that will be passed to the function configured in the</span>
<span class="cm">    * &lt;c&gt;psk_key_cb&lt;/c&gt; field.</span>
<span class="cm">    *</span>
<span class="cm">    * If &lt;c&gt;psk_key_cb&lt;/c&gt; is NULL, this field is ignored.</span>
<span class="cm">    */</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">psk_key_cb_arg</span><span class="p">;</span>
<span class="cp">#    ifdef ANJAY_WITH_SMS</span>
<span class="w">    </span><span class="cm">/**</span>
<span class="cm">    * Callback function that will be called whenever a PSK identity for use</span>
<span class="cm">    * with SMS binding needs to be stored in an external security engine.</span>
<span class="cm">    *</span>
<span class="cm">    * If NULL, PSK identities for use with SMS binding will be stored in main</span>
<span class="cm">    * system memory unless explicitly requested via the &lt;c&gt;sms_psk_identity&lt;/c&gt;</span>
<span class="cm">    * field in @ref anjay_security_instance_t.</span>
<span class="cm">    */</span>
<span class="w">    </span><span class="n">anjay_security_hsm_query_cb_t</span><span class="w"> </span><span class="o">*</span><span class="n">sms_psk_identity_cb</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">    * Opaque argument that will be passed to the function configured in the</span>
<span class="cm">    * &lt;c&gt;sms_psk_identity_cb&lt;/c&gt; field.</span>
<span class="cm">    *</span>
<span class="cm">    * If &lt;c&gt;sms_psk_identity_cb&lt;/c&gt; is NULL, this field is ignored.</span>
<span class="cm">    */</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">sms_psk_identity_cb_arg</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">    * Callback function that will be called whenever a PSK key for use with SMS</span>
<span class="cm">    * binding needs to be stored in an external security engine.</span>
<span class="cm">    *</span>
<span class="cm">    * If NULL, PSK keys for use with SMS binding will be stored in main system</span>
<span class="cm">    * memory unless explicitly requested via the &lt;c&gt;sms_psk_key&lt;/c&gt; field in</span>
<span class="cm">    * @ref anjay_security_instance_t.</span>
<span class="cm">    */</span>
<span class="w">    </span><span class="n">anjay_security_hsm_query_cb_t</span><span class="w"> </span><span class="o">*</span><span class="n">sms_psk_key_cb</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">    * Opaque argument that will be passed to the function configured in the</span>
<span class="cm">    * &lt;c&gt;sms_psk_key_cb&lt;/c&gt; field.</span>
<span class="cm">    *</span>
<span class="cm">    * If &lt;c&gt;sms_psk_key_cb&lt;/c&gt; is NULL, this field is ignored.</span>
<span class="cm">    */</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">sms_psk_key_cb_arg</span><span class="p">;</span>
<span class="cp">#    endif </span><span class="c1">// ANJAY_WITH_SMS</span>
<span class="p">}</span><span class="w"> </span><span class="n">anjay_security_hsm_configuration_t</span><span class="p">;</span>
</pre></div>
</div>
<p>This approach is particularly useful when using Bootstrap server - in this case
Anjay will automatically move the credentials received from the Bootstrap server
to the HSM memory. This is what we can see in action in CF-PSA-boostrap example.
As you can see, the changes we need to make are quite subtle:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">anjay_security_hsm_configuration_t</span><span class="w"> </span><span class="n">HSM_CONFIG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">psk_identity_cb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generate_hsm_address</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">psk_key_cb</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generate_hsm_address</span>
<span class="p">};</span>

<span class="c1">// ...</span>

<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">anjay_security_object_install_with_hsm</span><span class="p">(</span><span class="n">anjay</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">HSM_CONFIG</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Where <code class="docutils literal notranslate"><span class="pre">generate_hsm_address</span></code> is a function for PSA address generation, in this
case pseudo-random:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="nf">generate_hsm_address</span><span class="p">(</span><span class="n">anjay_iid_t</span><span class="w"> </span><span class="n">iid</span><span class="p">,</span>
<span class="w">                                        </span><span class="n">anjay_ssid_t</span><span class="w"> </span><span class="n">ssid</span><span class="p">,</span>
<span class="w">                                        </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span>
<span class="w">                                        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">data_size</span><span class="p">,</span>
<span class="w">                                        </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">arg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">iid</span><span class="p">;</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">ssid</span><span class="p">;</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">data_size</span><span class="p">;</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">arg</span><span class="p">;</span>

<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0ul</span><span class="p">;</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">HSM_TEMPLATE</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">avs_log</span><span class="p">(</span><span class="n">tutorial</span><span class="p">,</span><span class="w"> </span><span class="n">ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Wrong HSM address&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="n">avs_rand_seed_t</span><span class="w"> </span><span class="n">SEED</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">SEED</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">SEED</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">avs_rand_seed_t</span><span class="p">)</span><span class="w"> </span><span class="n">time</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset</span><span class="p">;</span>
<span class="w">    </span><span class="n">offset</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">HSM_TEMPLATE</span><span class="p">);</span>
<span class="w">    </span><span class="n">strcpy</span><span class="p">(</span><span class="n">result</span><span class="p">,</span><span class="w"> </span><span class="n">HSM_TEMPLATE</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">];</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;.&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HSM_ALPHABET</span><span class="p">[(</span><span class="kt">size_t</span><span class="p">)</span><span class="w"> </span><span class="n">avs_rand_r</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SEED</span><span class="p">)</span>
<span class="w">                                    </span><span class="o">%</span><span class="w"> </span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">HSM_ALPHABET</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="CF-FSDM.html" class="btn btn-neutral float-left" title="10.4. File System Data Model" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="CF-IoTSAFE.html" class="btn btn-neutral float-right" title="10.6. IoT SAFE" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017-2024, AVSystem.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>