<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>6.4. Secure downloads &mdash; Anjay 3.9.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=86f27845" />
      <link rel="stylesheet" type="text/css" href="../_static/theme_overrides.css?v=554064f1" />

  
  
        <script src="../_static/jquery.js?v=8dae8fb0"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=e55a5be6"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="6.5. Poor network connectivity" href="FU-PoorConnectivity.html" />
    <link rel="prev" title="6.3. Download modes and protocols" href="FU-ModesAndProtocols.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #ffd500" >

          
          
          <a href="../index.html">
            
              <img src="../_static/avsystem_header.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                3.9.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LwM2M.html">2. OMA LwM2M - Brief description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Compiling_client_applications.html">3. Compiling client applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../BasicClient.html">4. Basic client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../AdvancedTopics.html">5. Advanced topics</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../FirmwareUpdateTutorial.html">6. Firmware Update Tutorial</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="FU-Introduction.html">6.1. Firmware Update</a></li>
<li class="toctree-l2"><a class="reference internal" href="FU-BasicImplementation.html">6.2. Basic implementation</a></li>
<li class="toctree-l2"><a class="reference internal" href="FU-ModesAndProtocols.html">6.3. Download modes and protocols</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">6.4. Secure downloads</a></li>
<li class="toctree-l2"><a class="reference internal" href="FU-PoorConnectivity.html">6.5. Poor network connectivity</a></li>
<li class="toctree-l2"><a class="reference internal" href="FU-DownloadResumption.html">6.6. Download resumption</a></li>
<li class="toctree-l2"><a class="reference internal" href="FU-AdvancedFirmwareUpdate.html">6.7. Advanced Firmware Update</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../LwM2MGateway.html">7. LwM2M Gateway</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Tools.html">8. Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PortingGuideForNonPOSIXPlatforms.html">9. Porting guide for non-POSIX platforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Migrating.html">10. Migrating from older versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CommercialFeatures.html">11. Commercial features</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #ffd500" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Anjay</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../FirmwareUpdateTutorial.html"><span class="section-number">6. </span>Firmware Update Tutorial</a></li>
      <li class="breadcrumb-item active"><span class="section-number">6.4. </span>Secure downloads</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="secure-downloads">
<h1><span class="section-number">6.4. </span>Secure downloads<a class="headerlink" href="#secure-downloads" title="Link to this heading"></a></h1>
<section id="introduction">
<h2><span class="section-number">6.4.1. </span>Introduction<a class="headerlink" href="#introduction" title="Link to this heading"></a></h2>
<p>Up until now, we developed a basic client application that’s capable of
downloading firmware in <strong>PUSH</strong> and <strong>PULL</strong> modes. If the Server connection
is secure, then of course any <strong>PUSH</strong> transfer is automatically secured. In
case of <strong>PULL</strong> mode, however, there remains a question about the source
of credentials required to establishing the secure connection.</p>
<p>In this chapter, we will focus on methods of credentials configuration for
<strong>PULL</strong> mode transfers.</p>
</section>
<section id="two-ways-of-security-configuration">
<h2><span class="section-number">6.4.2. </span>Two ways of security configuration<a class="headerlink" href="#two-ways-of-security-configuration" title="Link to this heading"></a></h2>
<p>When a secure firmware transfer is initiated, firmware update module implemented
in Anjay gets security configuration in one of two following ways.</p>
<ol class="arabic simple">
<li><p>If the user implements a <code class="docutils literal notranslate"><span class="pre">get_security_config</span></code> callback located in
<code class="docutils literal notranslate"><span class="pre">anjay_fw_update_handlers_t</span></code>, it is expected to provide the library with
security information.</p></li>
<li><p>Otherwise, the library looks through Security Object instances, matching
the download URI host with configured URI in Security Object Instance. When
the matching Instance is found, the security information from that instance
is used. When no match is found, the download fails.</p></li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It may seem as the described methods are mutually
exclusive. However, in <code class="docutils literal notranslate"><span class="pre">get_security_config</span></code> callback one can use
<code class="docutils literal notranslate"><span class="pre">anjay_security_config_from_dm()</span></code> to attempt URI matching with entities
already configured in Security Object Instances.</p>
</div>
</section>
<section id="supported-security-modes">
<h2><span class="section-number">6.4.3. </span>Supported security modes<a class="headerlink" href="#supported-security-modes" title="Link to this heading"></a></h2>
<p>The download can be secured by either <a class="reference external" href="https://en.wikipedia.org/wiki/Pre-shared_key">PSK</a>, or by <a class="reference external" href="https://en.wikipedia.org/wiki/Public_key_certificate">Public key
certificates</a>.</p>
<p>Security information is configured in Anjay through a structure:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * DTLS keys or certificates.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">avs_net_security_info_t</span><span class="w"> </span><span class="n">security_info</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Single DANE TLSA record to use for certificate verification, if</span>
<span class="cm">     * applicable.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">avs_net_socket_dane_tlsa_record_t</span><span class="w"> </span><span class="o">*</span><span class="n">dane_tlsa_record</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * TLS ciphersuites to use.</span>
<span class="cm">     *</span>
<span class="cm">     * A value with &lt;c&gt;num_ids == 0&lt;/c&gt; (default) will cause defaults configured</span>
<span class="cm">     * through &lt;c&gt;anjay_configuration_t::default_tls_ciphersuites&lt;/c&gt;</span>
<span class="cm">     * to be used.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">avs_net_socket_tls_ciphersuites_t</span><span class="w"> </span><span class="n">tls_ciphersuites</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Server Name Indicator to use for authenticating with the peer during</span>
<span class="cm">     * secure TLS connection. The value is passed to the underlying TLS library</span>
<span class="cm">     * that need to take this variable into account for it make any effect. This</span>
<span class="cm">     * field is optional and can be left zero-initialized. If not set the</span>
<span class="cm">     * integration layer should use the Server URI instead.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">server_name_indication</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">anjay_security_config_t</span><span class="p">;</span>
</pre></div>
</div>
<p>And specifically, it’s the <code class="docutils literal notranslate"><span class="pre">security_info</span></code> field that is of interest to
us. <code class="docutils literal notranslate"><span class="pre">avs_net_security_info_t</span></code> can be configured by:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">avs_net_security_info_from_psk()</span></code>,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">avs_net_security_info_from_certificates()</span></code>.</p></li>
</ul>
<p>We will now have a closer look at both of these methods.</p>
<section id="configuration-of-psk">
<h3><span class="section-number">6.4.3.1. </span>Configuration of PSK<a class="headerlink" href="#configuration-of-psk" title="Link to this heading"></a></h3>
<p>This is the most straightforward. The structure representing the PSK
configuration is:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * A PSK/identity pair. avs_commons will never attempt to modify these values.</span>
<span class="cm"> */</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">avs_crypto_psk_key_info_t</span><span class="w"> </span><span class="n">key</span><span class="p">;</span>
<span class="w">    </span><span class="n">avs_crypto_psk_identity_info_t</span><span class="w"> </span><span class="n">identity</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">avs_net_psk_info_t</span><span class="p">;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">avs_crypto_psk_key_info_t</span></code> and <code class="docutils literal notranslate"><span class="pre">avs_crypto_psk_identity_info_t</span></code> are
supposed to be populated using the <code class="docutils literal notranslate"><span class="pre">avs_crypto_psk_key_info_from_*</span></code> and
<code class="docutils literal notranslate"><span class="pre">avs_crypto_psk_identity_info_from_*</span></code> functions.</p>
<p><code class="docutils literal notranslate"><span class="pre">avs_crypto_psk_key_info_from_buffer()</span></code> and
<code class="docutils literal notranslate"><span class="pre">avs_crypto_psk_identity_info_from_buffer()</span></code> are most commonly used, although
other variants may be used to utilize PSK information stored on a hardware
security module.</p>
<p>After populating the <code class="docutils literal notranslate"><span class="pre">avs_net_psk_info_t</span></code> structure, we may use:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">avs_net_security_info_t</span>
<span class="nf">avs_net_security_info_from_psk</span><span class="p">(</span><span class="n">avs_net_psk_info_t</span><span class="w"> </span><span class="n">psk</span><span class="p">);</span>
</pre></div>
</div>
<p>to convert into <code class="docutils literal notranslate"><span class="pre">avs_net_security_info_t</span></code>, as in the following example:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">avs_net_psk_info_t</span><span class="w"> </span><span class="n">psk_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">avs_crypto_psk_key_info_from_buffer</span><span class="p">(</span>
<span class="w">            </span><span class="s">&quot;shared-key&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="s">&quot;shared-key&quot;</span><span class="p">)),</span>
<span class="w">    </span><span class="p">.</span><span class="n">identity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">avs_crypto_psk_identity_info_from_buffer</span><span class="p">(</span>
<span class="w">            </span><span class="s">&quot;our-identity&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="s">&quot;our-identity&quot;</span><span class="p">))</span>
<span class="p">};</span>
<span class="n">avs_net_security_info_t</span><span class="w"> </span><span class="n">psk_security</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">avs_net_security_info_from_psk</span><span class="p">(</span><span class="n">psk_info</span><span class="p">);</span>
</pre></div>
</div>
</section>
<section id="configuration-of-certificates">
<h3><span class="section-number">6.4.3.2. </span>Configuration of Certificates<a class="headerlink" href="#configuration-of-certificates" title="Link to this heading"></a></h3>
<p>That’s a bit more involving. The structure representing Certificate configuration
is:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * Configuration for certificate-mode (D)TLS connection.</span>
<span class="cm"> */</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Enables validation of peer certificate chain. If disabled,</span>
<span class="cm">     * #ignore_system_trust_store and #trusted_certs are ignored.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">server_cert_validation</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Setting this flag to true disables the usage of system-wide trust store</span>
<span class="cm">     * (e.g. &lt;c&gt;/etc/ssl/certs&lt;/c&gt; on most Unix-like systems).</span>
<span class="cm">     *</span>
<span class="cm">     * NOTE: System-wide trust store is currently supported only by the OpenSSL</span>
<span class="cm">     * backend. This field is ignored by the Mbed TLS backend.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">ignore_system_trust_store</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Enable use of DNS-based Authentication of Named Entities (DANE) if</span>
<span class="cm">     * possible.</span>
<span class="cm">     *</span>
<span class="cm">     * If this field is set to true, but #server_cert_validation is disabled,</span>
<span class="cm">     * &quot;opportunistic DANE&quot; is used.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">dane</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Store of trust anchor certificates. This field is optional and can be</span>
<span class="cm">     * left zero-initialized. If used, it shall be initialized using one of the</span>
<span class="cm">     * &lt;c&gt;avs_crypto_certificate_chain_info_from_*&lt;/c&gt; helper functions.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">avs_crypto_certificate_chain_info_t</span><span class="w"> </span><span class="n">trusted_certs</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Store of certificate revocation lists. This field is optional and can be</span>
<span class="cm">     * left zero-initialized. If used, it shall be initialized using one of the</span>
<span class="cm">     * &lt;c&gt;avs_crypto_cert_revocation_list_info_from_*&lt;/c&gt; helper functions.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">avs_crypto_cert_revocation_list_info_t</span><span class="w"> </span><span class="n">cert_revocation_lists</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Local certificate chain to use for authenticating with the peer. This</span>
<span class="cm">     * field is optional and can be left zero-initialized. If used, it shall be</span>
<span class="cm">     * initialized using one of the</span>
<span class="cm">     * &lt;c&gt;avs_crypto_certificate_chain_info_from_*&lt;/c&gt; helper functions.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">avs_crypto_certificate_chain_info_t</span><span class="w"> </span><span class="n">client_cert</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Private key matching #client_cert to use for authenticating with the</span>
<span class="cm">     * peer. This field is optional and can be left zero-initialized, unless</span>
<span class="cm">     * #client_cert is also specified. If used, it shall be initialized using</span>
<span class="cm">     * one of the &lt;c&gt;avs_crypto_private_key_info_from_*&lt;/c&gt; helper functions.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">avs_crypto_private_key_info_t</span><span class="w"> </span><span class="n">client_key</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Enable rebuilding of client certificate chain based on certificates in</span>
<span class="cm">     * the trust store.</span>
<span class="cm">     *</span>
<span class="cm">     * If this field is set to &lt;c&gt;true&lt;/c&gt;, and the last certificate in the</span>
<span class="cm">     * #client_cert chain is not self-signed, the library will attempt to find</span>
<span class="cm">     * its ancestors in #trusted_certs and append them to the chain presented</span>
<span class="cm">     * during handshake.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">rebuild_client_cert_chain</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">avs_net_certificate_info_t</span><span class="p">;</span>
</pre></div>
</div>
<p>To populate it properly, we’re gonna need at least two pieces of information
from the following list:</p>
<ul class="simple">
<li><p>Trusted Certificates, also known as CA / Root certificates (required only
if we intend to verify certificates presented to us by the Server; although
it’s optional it is <strong>highly recommended</strong>),</p></li>
<li><p>Client Certificate, which is <strong>required</strong>,</p></li>
<li><p>Client Private Key, which is also <strong>required</strong>.</p></li>
</ul>
<p>Each of them come in variety of formats (text, binary, etc.) that need to
be loaded and parsed. In most scenarios however, the API provided by <cite>avs_commons</cite>
would suffice to do the necessary work.</p>
<p>For example, to configure Certificate based security, loading all information
from files, we could do something like this:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="n">avs_net_certificate_info_t</span><span class="w"> </span><span class="n">cert_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">server_cert_validation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">trusted_certs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">avs_crypto_certificate_chain_info_from_file</span><span class="p">(</span><span class="s">&quot;./CA.crt&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="p">.</span><span class="n">client_cert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">avs_crypto_certificate_chain_info_from_file</span><span class="p">(</span><span class="s">&quot;./client.crt&quot;</span><span class="p">),</span>
<span class="w">    </span><span class="c1">// NOTE: &quot;password&quot; may be NULL if no password is required</span>
<span class="w">    </span><span class="p">.</span><span class="n">client_key</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">avs_crypto_client_key_info_from_file</span><span class="p">(</span><span class="s">&quot;./client.key&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;password&quot;</span><span class="p">)</span>
<span class="p">};</span>
<span class="n">avs_net_security_info_t</span><span class="w"> </span><span class="n">cert_security</span><span class="w"> </span><span class="o">=</span>
<span class="w">        </span><span class="n">avs_net_security_info_from_certificates</span><span class="p">(</span><span class="n">cert_info</span><span class="p">);</span>
</pre></div>
</div>
</section>
</section>
<section id="security-configuration-with-get-security-config-callback">
<h2><span class="section-number">6.4.4. </span>Security configuration with <code class="docutils literal notranslate"><span class="pre">get_security_config</span></code> callback<a class="headerlink" href="#security-configuration-with-get-security-config-callback" title="Link to this heading"></a></h2>
<p>Firmware update module provided with Anjay, lets the user implement security
configuration per download URI. The relevant API is:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">anjay_fw_update_get_security_config_t</span><span class="p">(</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">user_ptr</span><span class="p">,</span>
<span class="w">        </span><span class="n">anjay_security_config_t</span><span class="w"> </span><span class="o">*</span><span class="n">out_security_info</span><span class="p">,</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">download_uri</span><span class="p">);</span>
</pre></div>
</div>
<p>And the corresponding handler in <code class="docutils literal notranslate"><span class="pre">anjay_fw_update_handlers_t</span></code> to be implemented
by the user:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/** Opens the stream that will be used to write the firmware package to;</span>
<span class="cm">     * @ref anjay_fw_update_stream_open_t */</span>
<span class="w">    </span><span class="n">anjay_fw_update_stream_open_t</span><span class="w"> </span><span class="o">*</span><span class="n">stream_open</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/** Writes data to the download stream;</span>
<span class="cm">     * @ref anjay_fw_update_stream_write_t */</span>
<span class="w">    </span><span class="n">anjay_fw_update_stream_write_t</span><span class="w"> </span><span class="o">*</span><span class="n">stream_write</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/** Closes the download stream and prepares the firmware package to be</span>
<span class="cm">     * flashed; @ref anjay_fw_update_stream_finish_t */</span>
<span class="w">    </span><span class="n">anjay_fw_update_stream_finish_t</span><span class="w"> </span><span class="o">*</span><span class="n">stream_finish</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/** Resets the firmware update state and performs any applicable cleanup of</span>
<span class="cm">     * temporary storage if necessary; @ref anjay_fw_update_reset_t */</span>
<span class="w">    </span><span class="n">anjay_fw_update_reset_t</span><span class="w"> </span><span class="o">*</span><span class="n">reset</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/** Returns the name of downloaded firmware package;</span>
<span class="cm">     * @ref anjay_fw_update_get_name_t */</span>
<span class="w">    </span><span class="n">anjay_fw_update_get_name_t</span><span class="w"> </span><span class="o">*</span><span class="n">get_name</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/** Return the version of downloaded firmware package;</span>
<span class="cm">     * @ref anjay_fw_update_get_version_t */</span>
<span class="w">    </span><span class="n">anjay_fw_update_get_version_t</span><span class="w"> </span><span class="o">*</span><span class="n">get_version</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/** Performs the actual upgrade with previously downloaded package;</span>
<span class="cm">     * @ref anjay_fw_update_perform_upgrade_t */</span>
<span class="w">    </span><span class="n">anjay_fw_update_perform_upgrade_t</span><span class="w"> </span><span class="o">*</span><span class="n">perform_upgrade</span><span class="p">;</span>

<span class="hll"><span class="w">    </span><span class="cm">/** Queries security configuration that shall be used for an encrypted</span>
</span><span class="hll"><span class="cm">     * connection; @ref anjay_fw_update_get_security_config_t */</span>
</span><span class="hll"><span class="w">    </span><span class="n">anjay_fw_update_get_security_config_t</span><span class="w"> </span><span class="o">*</span><span class="n">get_security_config</span><span class="p">;</span>
</span>
<span class="w">    </span><span class="cm">/** Queries CoAP transmission parameters to be used during firmware</span>
<span class="cm">     * update; @ref anjay_fw_update_get_coap_tx_params_t */</span>
<span class="w">    </span><span class="n">anjay_fw_update_get_coap_tx_params_t</span><span class="w"> </span><span class="o">*</span><span class="n">get_coap_tx_params</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/** Queries request timeout to be used during firmware update over CoAP+TCP</span>
<span class="cm">     * or HTTP; @ref anjay_fw_update_get_tcp_request_timeout_t */</span>
<span class="w">    </span><span class="n">anjay_fw_update_get_tcp_request_timeout_t</span><span class="w"> </span><span class="o">*</span><span class="n">get_tcp_request_timeout</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">anjay_fw_update_handlers_t</span><span class="p">;</span>
</pre></div>
</div>
<p>Now, the <code class="docutils literal notranslate"><span class="pre">anjay_fw_update_get_security_config_t</span></code> job is to fill
<code class="docutils literal notranslate"><span class="pre">anjay_security_config_t</span></code> properly. This structure consists of four fields:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * DTLS keys or certificates.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">avs_net_security_info_t</span><span class="w"> </span><span class="n">security_info</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Single DANE TLSA record to use for certificate verification, if</span>
<span class="cm">     * applicable.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">avs_net_socket_dane_tlsa_record_t</span><span class="w"> </span><span class="o">*</span><span class="n">dane_tlsa_record</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * TLS ciphersuites to use.</span>
<span class="cm">     *</span>
<span class="cm">     * A value with &lt;c&gt;num_ids == 0&lt;/c&gt; (default) will cause defaults configured</span>
<span class="cm">     * through &lt;c&gt;anjay_configuration_t::default_tls_ciphersuites&lt;/c&gt;</span>
<span class="cm">     * to be used.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">avs_net_socket_tls_ciphersuites_t</span><span class="w"> </span><span class="n">tls_ciphersuites</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Server Name Indicator to use for authenticating with the peer during</span>
<span class="cm">     * secure TLS connection. The value is passed to the underlying TLS library</span>
<span class="cm">     * that need to take this variable into account for it make any effect. This</span>
<span class="cm">     * field is optional and can be left zero-initialized. If not set the</span>
<span class="cm">     * integration layer should use the Server URI instead.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">server_name_indication</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">anjay_security_config_t</span><span class="p">;</span>
</pre></div>
</div>
<p>We’ve already seen in previous sections how to configure
<code class="docutils literal notranslate"><span class="pre">security_info</span></code>. Also, for now there is no need to worry about
<code class="docutils literal notranslate"><span class="pre">dane_tlsa_record</span></code>, <code class="docutils literal notranslate"><span class="pre">tls_ciphersuites</span></code> and <code class="docutils literal notranslate"><span class="pre">server_name_indication</span></code> - they can be
reset to zero.</p>
</section>
<section id="implementation">
<h2><span class="section-number">6.4.5. </span>Implementation<a class="headerlink" href="#implementation" title="Link to this heading"></a></h2>
<p>Our implementation will use the following strategy:</p>
<ol class="arabic simple">
<li><p>Try loading security info from the data model first (i.e. Security Object).</p></li>
<li><p>If that failed, attempt loading certificates from predefined paths.</p></li>
</ol>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Before we jump into implementation, there’s one more important thing
to keep in mind: the lifetime of <code class="docutils literal notranslate"><span class="pre">anjay_security_config_t</span></code>
fields. Failing to satisfy lifetime requirements will be met with
undefined behavior.</p>
<p>The fields of <code class="docutils literal notranslate"><span class="pre">anjay_security_config_t</span></code> contain references to file
paths, binary security keys, and/or ciphersuite lists. After our
<code class="docutils literal notranslate"><span class="pre">get_security_config</span></code> is called, they are not immediately stored
anywhere, and for that reason we need to ensure their lifetime is as
long as necessary. The documentation describes this in more detail,
and we recommend to have a glance at it.</p>
</div>
<p>Our simplified implementation uses either <code class="docutils literal notranslate"><span class="pre">anjay_security_config_from_dm()</span></code>
which caches the buffers inside the Anjay object in a way that is compatible
with the firmware update object implementation, or when the fallback to
certificates is needed, only literal c-strings are used, thus the lifetime of
security configuration in both cases is just right.</p>
<p>The implementation is presented below. Changes made since
<a class="reference internal" href="FU-BasicImplementation.html"><span class="doc">last time</span></a> are highlighted:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;./firmware_update.h&quot;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;assert.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;errno.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sys/stat.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;unistd.h&gt;</span>

<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">fw_state_t</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">FILE</span><span class="w"> </span><span class="o">*</span><span class="n">firmware_file</span><span class="p">;</span>
<span class="hll"><span class="w">    </span><span class="c1">// anjay instance this firmware update singleton is associated with</span>
</span><span class="hll"><span class="w">    </span><span class="n">anjay_t</span><span class="w"> </span><span class="o">*</span><span class="n">anjay</span><span class="p">;</span>
</span><span class="p">}</span><span class="w"> </span><span class="n">FW_STATE</span><span class="p">;</span>

<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">FW_IMAGE_DOWNLOAD_NAME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/tmp/firmware_image.bin&quot;</span><span class="p">;</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">fw_stream_open</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">user_ptr</span><span class="p">,</span>
<span class="w">                          </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">package_uri</span><span class="p">,</span>
<span class="w">                          </span><span class="k">const</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">anjay_etag</span><span class="w"> </span><span class="o">*</span><span class="n">package_etag</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// For a moment, we don&#39;t need to care about any of the arguments passed.</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">user_ptr</span><span class="p">;</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">package_uri</span><span class="p">;</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">package_etag</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// It&#39;s worth ensuring we start with a NULL firmware_file. In the end</span>
<span class="w">    </span><span class="c1">// it would be our responsibility to manage this pointer, and we want</span>
<span class="w">    </span><span class="c1">// to make sure we never leak any memory.</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">FW_STATE</span><span class="p">.</span><span class="n">firmware_file</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// We&#39;re about to create a firmware file for writing</span>
<span class="w">    </span><span class="n">FW_STATE</span><span class="p">.</span><span class="n">firmware_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fopen</span><span class="p">(</span><span class="n">FW_IMAGE_DOWNLOAD_NAME</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;wb&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">FW_STATE</span><span class="p">.</span><span class="n">firmware_file</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Could not open %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">FW_IMAGE_DOWNLOAD_NAME</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// We&#39;ve succeeded</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">fw_stream_write</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">user_ptr</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">user_ptr</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// We only need to write to file and check if that succeeded</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fwrite</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">length</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">FW_STATE</span><span class="p">.</span><span class="n">firmware_file</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Writing to firmware image failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">fw_stream_finish</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">user_ptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">user_ptr</span><span class="p">;</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">FW_STATE</span><span class="p">.</span><span class="n">firmware_file</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">fclose</span><span class="p">(</span><span class="n">FW_STATE</span><span class="p">.</span><span class="n">firmware_file</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Closing firmware image failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">FW_STATE</span><span class="p">.</span><span class="n">firmware_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">FW_STATE</span><span class="p">.</span><span class="n">firmware_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">fw_reset</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">user_ptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Reset can be issued even if the download never started.</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">FW_STATE</span><span class="p">.</span><span class="n">firmware_file</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// We ignore the result code of fclose(), as fw_reset() can&#39;t fail.</span>
<span class="w">        </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">fclose</span><span class="p">(</span><span class="n">FW_STATE</span><span class="p">.</span><span class="n">firmware_file</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// and reset our global state to initial value.</span>
<span class="w">        </span><span class="n">FW_STATE</span><span class="p">.</span><span class="n">firmware_file</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// Finally, let&#39;s remove any downloaded payload</span>
<span class="w">    </span><span class="n">unlink</span><span class="p">(</span><span class="n">FW_IMAGE_DOWNLOAD_NAME</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// A part of a rather simple logic checking if the firmware update was</span>
<span class="c1">// successfully performed.</span>
<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">FW_UPDATED_MARKER</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;/tmp/fw-updated-marker&quot;</span><span class="p">;</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">fw_perform_upgrade</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">user_ptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">chmod</span><span class="p">(</span><span class="n">FW_IMAGE_DOWNLOAD_NAME</span><span class="p">,</span><span class="w"> </span><span class="mo">0700</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span>
<span class="w">                </span><span class="s">&quot;Could not make firmware executable: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="c1">// Create a marker file, so that the new process knows it is the &quot;upgraded&quot;</span>
<span class="w">    </span><span class="c1">// one</span>
<span class="w">    </span><span class="kt">FILE</span><span class="w"> </span><span class="o">*</span><span class="n">marker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fopen</span><span class="p">(</span><span class="n">FW_UPDATED_MARKER</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;w&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">marker</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Marker file could not be created</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">fclose</span><span class="p">(</span><span class="n">marker</span><span class="p">);</span>

<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">ENDPOINT_NAME</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// If the call below succeeds, the firmware is considered as &quot;upgraded&quot;,</span>
<span class="w">    </span><span class="c1">// and we hope the newly started client registers to the Server.</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">execl</span><span class="p">(</span><span class="n">FW_IMAGE_DOWNLOAD_NAME</span><span class="p">,</span><span class="w"> </span><span class="n">FW_IMAGE_DOWNLOAD_NAME</span><span class="p">,</span><span class="w"> </span><span class="n">ENDPOINT_NAME</span><span class="p">,</span>
<span class="w">                 </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;execl() failed: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">strerror</span><span class="p">(</span><span class="n">errno</span><span class="p">));</span>
<span class="w">    </span><span class="c1">// If we are here, it means execl() failed. Marker file MUST now be removed,</span>
<span class="w">    </span><span class="c1">// as the firmware update failed.</span>
<span class="w">    </span><span class="n">unlink</span><span class="p">(</span><span class="n">FW_UPDATED_MARKER</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="p">}</span>

<span class="hll"><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">fw_get_security_config</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">user_ptr</span><span class="p">,</span>
</span><span class="hll"><span class="w">                                  </span><span class="n">anjay_security_config_t</span><span class="w"> </span><span class="o">*</span><span class="n">out_security_info</span><span class="p">,</span>
</span><span class="hll"><span class="w">                                  </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">download_uri</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">user_ptr</span><span class="p">;</span>
</span><span class="hll"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">anjay_security_config_from_dm</span><span class="p">(</span><span class="n">FW_STATE</span><span class="p">.</span><span class="n">anjay</span><span class="p">,</span><span class="w"> </span><span class="n">out_security_info</span><span class="p">,</span>
</span><span class="hll"><span class="w">                                       </span><span class="n">download_uri</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">        </span><span class="c1">// found a match</span>
</span><span class="hll"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span class="hll"><span class="w">    </span><span class="p">}</span>
</span><span class="hll">
</span><span class="hll"><span class="w">    </span><span class="c1">// no match found, fallback to loading certificates from given paths</span>
</span><span class="hll"><span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">out_security_info</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">out_security_info</span><span class="p">));</span>
</span><span class="hll"><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">avs_net_certificate_info_t</span><span class="w"> </span><span class="n">cert_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">        </span><span class="p">.</span><span class="n">server_cert_validation</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span>
</span><span class="hll"><span class="w">        </span><span class="p">.</span><span class="n">trusted_certs</span><span class="w"> </span><span class="o">=</span>
</span><span class="hll"><span class="w">                </span><span class="n">avs_crypto_certificate_chain_info_from_file</span><span class="p">(</span><span class="s">&quot;./certs/CA.crt&quot;</span><span class="p">),</span>
</span><span class="hll"><span class="w">        </span><span class="p">.</span><span class="n">client_cert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">avs_crypto_certificate_chain_info_from_file</span><span class="p">(</span>
</span><span class="hll"><span class="w">                </span><span class="s">&quot;./certs/client.crt&quot;</span><span class="p">),</span>
</span><span class="hll"><span class="w">        </span><span class="p">.</span><span class="n">client_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">avs_crypto_private_key_info_from_file</span><span class="p">(</span>
</span><span class="hll"><span class="w">                </span><span class="s">&quot;./certs/client.key&quot;</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
</span><span class="hll"><span class="w">    </span><span class="p">};</span>
</span><span class="hll"><span class="w">    </span><span class="c1">// NOTE: this assignment is safe, because cert_info contains pointers to</span>
</span><span class="hll"><span class="w">    </span><span class="c1">// string literals only. If the configuration were to load certificate info</span>
</span><span class="hll"><span class="w">    </span><span class="c1">// from buffers they would have to be stored somewhere - e.g. on the heap.</span>
</span><span class="hll"><span class="w">    </span><span class="n">out_security_info</span><span class="o">-&gt;</span><span class="n">security_info</span><span class="w"> </span><span class="o">=</span>
</span><span class="hll"><span class="w">            </span><span class="n">avs_net_security_info_from_certificates</span><span class="p">(</span><span class="n">cert_info</span><span class="p">);</span>
</span><span class="hll"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span class="hll"><span class="p">}</span>
</span>
<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">anjay_fw_update_handlers_t</span><span class="w"> </span><span class="n">HANDLERS</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">stream_open</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fw_stream_open</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">stream_write</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fw_stream_write</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">stream_finish</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fw_stream_finish</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">reset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fw_reset</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">perform_upgrade</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fw_perform_upgrade</span><span class="p">,</span>
<span class="hll"><span class="w">    </span><span class="p">.</span><span class="n">get_security_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fw_get_security_config</span>
</span><span class="p">};</span>

<span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">ENDPOINT_NAME</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">fw_update_install</span><span class="p">(</span><span class="n">anjay_t</span><span class="w"> </span><span class="o">*</span><span class="n">anjay</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">anjay_fw_update_initial_state_t</span><span class="w"> </span><span class="n">state</span><span class="p">;</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">state</span><span class="p">));</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">FW_UPDATED_MARKER</span><span class="p">,</span><span class="w"> </span><span class="n">F_OK</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// marker file exists, it means firmware update succeded!</span>
<span class="w">        </span><span class="n">state</span><span class="p">.</span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ANJAY_FW_UPDATE_INITIAL_SUCCESS</span><span class="p">;</span>
<span class="w">        </span><span class="n">unlink</span><span class="p">(</span><span class="n">FW_UPDATED_MARKER</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="hll"><span class="w">    </span><span class="c1">// make sure this module is installed for single Anjay instance only</span>
</span><span class="hll"><span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">FW_STATE</span><span class="p">.</span><span class="n">anjay</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
</span><span class="hll"><span class="w">    </span><span class="n">FW_STATE</span><span class="p">.</span><span class="n">anjay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">anjay</span><span class="p">;</span>
</span><span class="w">    </span><span class="c1">// install the module, pass handlers that we implemented and initial state</span>
<span class="w">    </span><span class="c1">// that we discovered upon startup</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">anjay_fw_update_install</span><span class="p">(</span><span class="n">anjay</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">HANDLERS</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">state</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="FU-ModesAndProtocols.html" class="btn btn-neutral float-left" title="6.3. Download modes and protocols" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="FU-PoorConnectivity.html" class="btn btn-neutral float-right" title="6.5. Poor network connectivity" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017-2025, AVSystem.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>