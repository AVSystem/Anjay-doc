

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>4.4.4. Multi-instance writable object with dynamic number of instances &mdash; Anjay 1.1.0 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../../genindex.html"/>
        <link rel="search" title="Search" href="../../search.html"/>
    <link rel="top" title="Anjay 1.1.0 documentation" href="../../index.html"/>
        <link rel="up" title="4.4. Custom LwM2M objects" href="../BT4_CustomObject.html"/>
        <link rel="next" title="4.4.5. Objects with Multiple Instance Resources" href="BT_CO5_MultipleResourceInstances.html"/>
        <link rel="prev" title="4.4.3. Multi-instance writable object with fixed number of instances" href="BT_CO3_FixedInstanceWritable.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Anjay
          

          
          </a>

          
            
            
              <div class="version">
                1.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../Introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LwM2M.html">2. OMA LwM2M - Brief description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Compiling_client_applications.html">3. Compiling client applications</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../BasicTutorial.html">4. Basic tutorial</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../BT1.html">4.1. Getting started!</a></li>
<li class="toctree-l2"><a class="reference internal" href="../BT2.html">4.2. Registering mandatory Objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../BT3.html">4.3. Event loop</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../BT4_CustomObject.html">4.4. Custom LwM2M objects</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="BT_CO1_SingleInstanceReadOnly.html">4.4.1. Single-instance read-only object</a></li>
<li class="toctree-l3"><a class="reference internal" href="BT_CO2_MultiInstanceReadOnlyFixed.html">4.4.2. Multi-instance read-only object with fixed number of instances</a></li>
<li class="toctree-l3"><a class="reference internal" href="BT_CO3_FixedInstanceWritable.html">4.4.3. Multi-instance writable object with fixed number of instances</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">4.4.4. Multi-instance writable object with dynamic number of instances</a></li>
<li class="toctree-l3"><a class="reference internal" href="BT_CO5_MultipleResourceInstances.html">4.4.5. Objects with Multiple Instance Resources</a></li>
<li class="toctree-l3"><a class="reference internal" href="BT_CO6_BootstrapAwareness.html">4.4.6. Bootstrap awareness</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../AdvancedTutorial.html">5. Advanced tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Embedded_IP.html">6. Using Anjay with embedded UDP/IP stacks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Commercial_support.html">7. Commercial support</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">Anjay</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../../BasicTutorial.html">4. Basic tutorial</a> &raquo;</li>
      
          <li><a href="../BT4_CustomObject.html">4.4. Custom LwM2M objects</a> &raquo;</li>
      
    <li>4.4.4. Multi-instance writable object with dynamic number of instances</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/BasicTutorial/BT4_CustomObject/BT_CO4_MultiInstanceDynamic.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="multi-instance-writable-object-with-dynamic-number-of-instances">
<h1>4.4.4. Multi-instance writable object with dynamic number of instances<a class="headerlink" href="#multi-instance-writable-object-with-dynamic-number-of-instances" title="Permalink to this headline">¶</a></h1>
<p>In this tutorial you will learn:</p>
<ul class="simple">
<li>how to implement <code class="docutils literal"><span class="pre">instance_create</span></code> handler to create Instances,</li>
<li>how to implement <code class="docutils literal"><span class="pre">instance_remove</span></code> handler to remove Instances,</li>
<li>how to assign instance identifiers to a newly created Instances,</li>
<li>basics of the <code class="docutils literal"><span class="pre">AVS_LIST</span></code> utility library.</li>
</ul>
<p>Implemented object will be roughly based on <a class="reference internal" href="BT_CO3_FixedInstanceWritable.html"><span class="doc">Multi-instance writable object with fixed number of instances</span></a>.</p>
<table border="1" class="docutils">
<colgroup>
<col width="37%" />
<col width="31%" />
<col width="31%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Object ID</th>
<th class="head">Instances</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Test object</td>
<td>1234</td>
<td>Multiple</td>
</tr>
</tbody>
</table>
<p>As before, each Object Instance has two Resources:</p>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="21%" />
<col width="19%" />
<col width="17%" />
<col width="17%" />
<col width="14%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Resource ID</th>
<th class="head">Operations</th>
<th class="head">Instances</th>
<th class="head">Mandatory</th>
<th class="head">Type</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Label</td>
<td>0</td>
<td>Read/Write</td>
<td>Single</td>
<td>Mandatory</td>
<td>String</td>
</tr>
<tr class="row-odd"><td>Value</td>
<td>1</td>
<td>Read/Write</td>
<td>Single</td>
<td>Mandatory</td>
<td>Integer</td>
</tr>
</tbody>
</table>
<p>The code is based on <a class="reference internal" href="BT_CO3_FixedInstanceWritable.html"><span class="doc">previous tutorial</span></a>, yet in this
chapter all Test object related code was moved to a separate files to keep
everything clean.</p>
<div class="section" id="updating-the-object-structure">
<h2>4.4.4.1. Updating the object structure<a class="headerlink" href="#updating-the-object-structure" title="Permalink to this headline">¶</a></h2>
<p>First of all, we have to update our <code class="docutils literal"><span class="pre">test_object_t</span></code> structure to support
storing multiple object instances. For that, we need some kind of dynamically
sized container. We could choose plain-old, manually managed C arrays, but
that comes with unnecessary distraction, and as a matter of fact is a bit
error-prone.  Therefore, in this tutorial, we are going to use <code class="docutils literal"><span class="pre">AVS_LIST</span></code>,
which is an abstraction over singly linked list, and has been used in Anjay
with success since the beginning of the project.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">test_object</span> <span class="p">{</span>
    <span class="c1">// handlers</span>
    <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="n">obj_def</span><span class="p">;</span>

    <span class="c1">// object state</span>
    <span class="n">AVS_LIST</span><span class="p">(</span><span class="n">test_instance_t</span><span class="p">)</span> <span class="n">instances</span><span class="p">;</span>

    <span class="n">AVS_LIST</span><span class="p">(</span><span class="n">test_instance_t</span><span class="p">)</span> <span class="n">backup_instances</span><span class="p">;</span>
<span class="p">}</span> <span class="n">test_object_t</span><span class="p">;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">AVS_LIST(x)</span></code> is actually a macro that expands to a pointer of type <code class="docutils literal"><span class="pre">x</span></code>. It
has therefore a pointer semantics and can be treated like that (standard dereferencing
and dereferencing with assignment will work as expected). This is however, not everything
you need to know about them, as they are more complicated than that. We recommend
you to refer to the <a class="reference external" href="TODOLINK">documentation</a>.</p>
</div>
<p>In a previous tutorial, our Instances had hardcoded Instance IDs.  We no
longer have such comfort, and have to be able to uniquely identify Object
Instances. As a consequence, we will add <code class="docutils literal"><span class="pre">anjay_iid_t</span> <span class="pre">iid</span></code> field to
<code class="docutils literal"><span class="pre">test_instance_t</span></code>:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">test_instance</span> <span class="p">{</span>
    <span class="n">anjay_iid_t</span> <span class="n">iid</span><span class="p">;</span>

    <span class="kt">bool</span> <span class="n">has_label</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">label</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

    <span class="kt">bool</span> <span class="n">has_value</span><span class="p">;</span>
    <span class="kt">int32_t</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span> <span class="n">test_instance_t</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="initialization-and-cleanup">
<h2>4.4.4.2. Initialization and cleanup<a class="headerlink" href="#initialization-and-cleanup" title="Permalink to this headline">¶</a></h2>
<p>We must reconsider the way our Test object is being initialized. Up to this point
it was allocated on stack and required no cleanup. Again, times have changed, and
we won&#8217;t be able to proceed further without allocating memory on demand.</p>
<div class="topic">
<p class="topic-title first">Wait, you could still allocate objects on stack, and initialize them later!</p>
<p>Yes, but it may be considered bad coding style for at least two reasons:</p>
<ol class="arabic simple">
<li>Having partially initialized or uninitialized objects floating around is
almost always a bad idea, as it is easy to forget about initialization
and accessing uninitialized data is undefined behavior. Allocating
objects on a heap however, allows the implementation to fully initialize
an object before returning a reference to it.</li>
<li>End user of an Object should NOT be exposed to its internal representation,
i.e. notice how handles to all objects shown to you so far were returned as
pointers to <code class="docutils literal"><span class="pre">anjay_dm_object_def_t</span></code> &#8211; clearly, it indicates to the user
that they have nothing interesting to do with such reference (besides being
able to register and/or wrap it), unless some additional public API is
provided.</li>
</ol>
</div>
<p>To achieve proper control over object lifetime and initialization, we are
going to introduce two functions, namely <code class="docutils literal"><span class="pre">create_test_object</span></code>:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">**</span><span class="nf">create_test_object</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">test_object_t</span> <span class="o">*</span><span class="n">repr</span> <span class="o">=</span> <span class="p">(</span><span class="n">test_object_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">test_object_t</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">repr</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">repr</span><span class="o">-&gt;</span><span class="n">obj_def</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">OBJECT_DEF</span><span class="p">;</span>
        <span class="k">return</span> <span class="o">&amp;</span><span class="n">repr</span><span class="o">-&gt;</span><span class="n">obj_def</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="topic">
<p class="topic-title first">Shouldn&#8217;t <code class="docutils literal"><span class="pre">test_object_t::instances</span></code> and <code class="docutils literal"><span class="pre">test_object_t::backup_instances</span></code> be
   be initialized in some special way?</p>
<p>No, <code class="docutils literal"><span class="pre">NULL</span></code> is a valid (and only) representation of an empty <code class="docutils literal"><span class="pre">AVS_LIST</span></code>.</p>
</div>
<p>and <code class="docutils literal"><span class="pre">delete_test_object</span></code>:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">delete_test_object</span><span class="p">(</span><span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">**</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">test_object_t</span> <span class="o">*</span><span class="n">repr</span> <span class="o">=</span> <span class="n">get_test_object</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
    <span class="n">AVS_LIST_CLEAR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">repr</span><span class="o">-&gt;</span><span class="n">instances</span><span class="p">);</span>
    <span class="n">AVS_LIST_CLEAR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">repr</span><span class="o">-&gt;</span><span class="n">backup_instances</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">repr</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As you can see, dynamic memory management is semi-automatically handled by <code class="docutils literal"><span class="pre">AVS_LIST</span></code>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal"><span class="pre">AVS_LIST_CLEAR</span></code> iterates over the list, in the process frees memory allocated for
each element, and in the end sets list handle to <code class="docutils literal"><span class="pre">NULL</span></code>.</p>
</div>
<p>Using functions defined above to create, register and free the Test object is similar
as in previous tutorials.</p>
</div>
<div class="section" id="updating-old-already-implemented-handlers-to-use-avs-list">
<h2>4.4.4.3. Updating old, already implemented handlers to use <code class="docutils literal"><span class="pre">AVS_LIST</span></code><a class="headerlink" href="#updating-old-already-implemented-handlers-to-use-avs-list" title="Permalink to this headline">¶</a></h2>
<p>To simplify matters, we have to agree upon one contract:</p>
<ol class="arabic simple">
<li>We establish a natural Instace ordering on their Instance IDs, exploiting the
fact they MUST be unique.</li>
<li>We store Instaces of the Test object in an ordered (as above) list.</li>
</ol>
<p>OK, now that we made our assumptions, we are ready to implement utility function
<code class="docutils literal"><span class="pre">get_instance</span></code> which retrieves Test object instance with specified Instance ID.
It will happen to be very useful in the next couple of subsections:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="nf">AVS_LIST</span><span class="p">(</span><span class="n">test_instance_t</span><span class="p">)</span>
<span class="n">get_instance</span><span class="p">(</span><span class="n">test_object_t</span> <span class="o">*</span><span class="n">repr</span><span class="p">,</span> <span class="n">anjay_iid_t</span> <span class="n">iid</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">AVS_LIST</span><span class="p">(</span><span class="n">test_instance_t</span><span class="p">)</span> <span class="n">it</span><span class="p">;</span>
    <span class="n">AVS_LIST_FOREACH</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">repr</span><span class="o">-&gt;</span><span class="n">instances</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">iid</span> <span class="o">==</span> <span class="n">iid</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">it</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">iid</span> <span class="o">&gt;</span> <span class="n">iid</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Since list of instances is sorted by Instance ID,</span>
            <span class="c1">// Instance with given iid does not exist on that list</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// Instance was not found.</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Let&#8217;s reimplement <code class="docutils literal"><span class="pre">test_instance_present</span></code> in terms of just defined <code class="docutils literal"><span class="pre">get_instance</span></code>:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">test_instance_present</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                                 <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
                                 <span class="n">anjay_iid_t</span> <span class="n">iid</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">anjay</span><span class="p">;</span>   <span class="c1">// unused</span>

    <span class="k">return</span> <span class="n">get_instance</span><span class="p">(</span><span class="n">get_test_object</span><span class="p">(</span><span class="n">obj_ptr</span><span class="p">),</span> <span class="n">iid</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>And one more method, presenting another functionality of <code class="docutils literal"><span class="pre">AVS_LISTs</span></code>
before going into details of <code class="docutils literal"><span class="pre">instance_create</span></code> and <code class="docutils literal"><span class="pre">instance_remove</span></code>
and leaving the rest of the work of this kind as an exercise for the reader
(or, if they are lazy, they can always look at the code):</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">test_instance_it</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                            <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
                            <span class="n">anjay_iid_t</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span>
                            <span class="kt">void</span> <span class="o">**</span><span class="n">cookie</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">anjay</span><span class="p">;</span>   <span class="c1">// unused</span>

    <span class="n">AVS_LIST</span><span class="p">(</span><span class="n">test_instance_t</span><span class="p">)</span> <span class="n">curr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

    <span class="c1">// if `*cookie == NULL`, then the iteration has just started,</span>
    <span class="c1">// otherwise `*cookie` contains iterator value saved below</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">cookie</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">curr</span> <span class="o">=</span> <span class="p">(</span><span class="n">AVS_LIST</span><span class="p">(</span><span class="n">test_instance_t</span><span class="p">))</span> <span class="o">*</span><span class="n">cookie</span><span class="p">;</span>
        <span class="c1">// get the next element</span>
        <span class="n">curr</span> <span class="o">=</span> <span class="n">AVS_LIST_NEXT</span><span class="p">(</span><span class="n">curr</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// first instance is also a list head</span>
        <span class="n">curr</span> <span class="o">=</span> <span class="n">get_test_object</span><span class="p">(</span><span class="n">obj_ptr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">instances</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">curr</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">iid</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// when last element is reached curr is NULL</span>
        <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="n">ANJAY_IID_INVALID</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">// use `*cookie` to store the iterator</span>
    <span class="o">*</span><span class="n">cookie</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">curr</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>That&#8217;s all for this section. As noted above, implementation of other methods
is as always available in the source code provided with the tutorial. We
do however strongly recommend you to port the methods to use <code class="docutils literal"><span class="pre">AVS_LISTs</span></code>
on your own, especially <strong>remember about updating transaction handlers</strong>.</p>
</div>
<div class="section" id="assigning-instance-ids">
<h2>4.4.4.4. Assigning Instance IDs<a class="headerlink" href="#assigning-instance-ids" title="Permalink to this headline">¶</a></h2>
<p>LwM2M Create requests are not always equipped with preferred Instance ID, forcing
the LwM2M Client to assign Instance ID by itself. In Anjay, this responsibility
lies on the implementor of the Object being instantiated.</p>
<p>We are going to take an easy approach for Instance ID assignation. Our algorithm
will simply traverse Object Instance list, looking for any gaps in Instance IDs
between consecutive Instances. If no gap is found, we&#8217;d take an upper bound of
discovered Instance IDs during the iteration as a new Instance ID.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">assign_new_iid</span><span class="p">(</span><span class="n">test_object_t</span> <span class="o">*</span><span class="n">repr</span><span class="p">,</span> <span class="n">anjay_iid_t</span> <span class="o">*</span><span class="n">out_iid</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">anjay_iid_t</span> <span class="n">preferred_iid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">AVS_LIST</span><span class="p">(</span><span class="n">test_instance_t</span><span class="p">)</span> <span class="n">it</span><span class="p">;</span>
    <span class="n">AVS_LIST_FOREACH</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">repr</span><span class="o">-&gt;</span><span class="n">instances</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">iid</span> <span class="o">==</span> <span class="n">preferred_iid</span><span class="p">)</span> <span class="p">{</span>
            <span class="o">++</span><span class="n">preferred_iid</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">iid</span> <span class="o">&gt;</span> <span class="n">preferred_iid</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// found a hole</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// all valid Instance IDs are already reserved</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">preferred_iid</span> <span class="o">==</span> <span class="n">ANJAY_IID_INVALID</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">*</span><span class="n">out_iid</span> <span class="o">=</span> <span class="n">preferred_iid</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Our <code class="docutils literal"><span class="pre">assign_new_iid</span></code> is indeed simple, yet its pessimistic complexity is
<cite>O(n)</cite> (where <cite>n</cite> stands for the number of Object Instances). This means
that special care must be taken if good performance of instance creation
is required (e.g. by using some kind of hash-map or tree-map for Instance
storage).</p>
</div>
<div class="section" id="instance-create-handler">
<h2>4.4.4.5. <code class="docutils literal"><span class="pre">instance_create</span></code> handler<a class="headerlink" href="#instance-create-handler" title="Permalink to this headline">¶</a></h2>
<p>Let&#8217;s have a look on <code class="docutils literal"><span class="pre">anjay_dm_instance_create_t</span></code> handler type signature:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="kt">int</span> <span class="nf">anjay_dm_instance_create_t</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                                       <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
                                       <span class="n">anjay_iid_t</span> <span class="o">*</span><span class="n">inout_iid</span><span class="p">,</span>
                                       <span class="n">anjay_ssid_t</span> <span class="n">ssid</span><span class="p">);</span>
</pre></div>
</div>
<p>The <code class="docutils literal"><span class="pre">inout_iid</span></code> parameter is the most important for us at the moment, as
if the instantiation succeeds we MUST tell the library the id of the newly
created Instance by setting <code class="docutils literal"><span class="pre">*inout_iid</span></code> properly.</p>
<p>As we previously discussed, LwM2M Create requests do not necessairly have
to contain preferred Instance ID. However if they do, then Anjay first makes
sure no Object Instance with given Instance ID exists.</p>
<p>To sum up, we are left with the situation when either <code class="docutils literal"><span class="pre">*inout_iid</span></code> is a
valid Instance ID and we should use it, or it is unset, in which case we
are going to assign Instance ID ourselves:</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Unset Instance ID is represented by <code class="docutils literal"><span class="pre">ANJAY_IID_INVALID</span></code> constant.</p>
</div>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">test_instance_create</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                                <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
                                <span class="n">anjay_iid_t</span> <span class="o">*</span><span class="n">inout_iid</span><span class="p">,</span>
                                <span class="n">anjay_ssid_t</span> <span class="n">ssid</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">anjay</span><span class="p">;</span> <span class="c1">// unused</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">ssid</span><span class="p">;</span> <span class="c1">// unused</span>

    <span class="n">test_object_t</span> <span class="o">*</span><span class="n">repr</span> <span class="o">=</span> <span class="n">get_test_object</span><span class="p">(</span><span class="n">obj_ptr</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">inout_iid</span> <span class="o">==</span> <span class="n">ANJAY_IID_INVALID</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Create request did not contain preferred Instance ID,</span>
        <span class="c1">// therefore we assign one on our own if possible</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">assign_new_iid</span><span class="p">(</span><span class="n">repr</span><span class="p">,</span> <span class="n">inout_iid</span><span class="p">))</span> <span class="p">{</span>
            <span class="c1">// unfortunately assigning new iid failed, nothing</span>
            <span class="c1">// we can do about it</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">AVS_LIST</span><span class="p">(</span><span class="n">test_instance_t</span><span class="p">)</span> <span class="n">new_instance</span> <span class="o">=</span>
            <span class="n">AVS_LIST_NEW_ELEMENT</span><span class="p">(</span><span class="n">test_instance_t</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_instance</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// out of memory</span>
        <span class="k">return</span> <span class="n">ANJAY_ERR_INTERNAL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">new_instance</span><span class="o">-&gt;</span><span class="n">iid</span> <span class="o">=</span> <span class="o">*</span><span class="n">inout_iid</span><span class="p">;</span>

    <span class="c1">// find a place where instance should be inserted,</span>
    <span class="c1">// insert it and claim a victory</span>
    <span class="n">AVS_LIST</span><span class="p">(</span><span class="n">test_instance_t</span><span class="p">)</span> <span class="o">*</span><span class="n">insert_ptr</span><span class="p">;</span>
    <span class="n">AVS_LIST_FOREACH_PTR</span><span class="p">(</span><span class="n">insert_ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">repr</span><span class="o">-&gt;</span><span class="n">instances</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">insert_ptr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iid</span> <span class="o">&gt;</span> <span class="n">new_instance</span><span class="o">-&gt;</span><span class="n">iid</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">AVS_LIST_INSERT</span><span class="p">(</span><span class="n">insert_ptr</span><span class="p">,</span> <span class="n">new_instance</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There is a lot going on in this function, also new concepts regarding
<code class="docutils literal"><span class="pre">AVS_LIST</span></code> are being used. We advise you to look at <code class="docutils literal"><span class="pre">AVS_LIST_FOREACH_PTR</span></code>,
<code class="docutils literal"><span class="pre">AVS_LIST_NEW_ELEMENT</span></code> and <code class="docutils literal"><span class="pre">AVS_LIST_INSERT</span></code> documentation for more details.</p>
</div>
</div>
<div class="section" id="instance-remove-handler">
<h2>4.4.4.6. <code class="docutils literal"><span class="pre">instance_remove</span></code> handler<a class="headerlink" href="#instance-remove-handler" title="Permalink to this headline">¶</a></h2>
<p>Fortunately <code class="docutils literal"><span class="pre">instance_remove</span></code> handler is much easier to implement as it does not
have to perform anything other than removing the instance from our list.</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">test_instance_remove</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                                <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
                                <span class="n">anjay_iid_t</span> <span class="n">iid</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">anjay</span><span class="p">;</span> <span class="c1">// unused</span>
    <span class="n">test_object_t</span> <span class="o">*</span><span class="n">repr</span> <span class="o">=</span> <span class="n">get_test_object</span><span class="p">(</span><span class="n">obj_ptr</span><span class="p">);</span>

    <span class="n">AVS_LIST</span><span class="p">(</span><span class="n">test_instance_t</span><span class="p">)</span> <span class="o">*</span><span class="n">it</span><span class="p">;</span>
    <span class="n">AVS_LIST_FOREACH_PTR</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">repr</span><span class="o">-&gt;</span><span class="n">instances</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">it</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iid</span> <span class="o">==</span> <span class="n">iid</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">AVS_LIST_DELETE</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// should never happen as Anjay checks whether instance is present</span>
    <span class="c1">// prior to issuing instance_remove</span>
    <span class="k">return</span> <span class="n">ANJAY_ERR_INTERNAL</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="BT_CO5_MultipleResourceInstances.html" class="btn btn-neutral float-right" title="4.4.5. Objects with Multiple Instance Resources" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="BT_CO3_FixedInstanceWritable.html" class="btn btn-neutral" title="4.4.3. Multi-instance writable object with fixed number of instances" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, AVSystem.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.1.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>