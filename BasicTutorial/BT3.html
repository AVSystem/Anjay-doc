

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>4.3. Event loop &mdash; Anjay 1.15.5 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="4.4. A few notes on general usage" href="BT4.html" />
    <link rel="prev" title="4.2. Installing mandatory Objects" href="BT2.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Anjay
          

          
          </a>

          
            
            
              <div class="version">
                1.15.5
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LwM2M.html">2. OMA LwM2M - Brief description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Compiling_client_applications.html">3. Compiling client applications</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../BasicTutorial.html">4. Basic tutorial</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="BT1.html">4.1. Getting started!</a></li>
<li class="toctree-l2"><a class="reference internal" href="BT2.html">4.2. Installing mandatory Objects</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">4.3. Event loop</a></li>
<li class="toctree-l2"><a class="reference internal" href="BT4.html">4.4. A few notes on general usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="BT5_CustomObject.html">4.5. Custom LwM2M objects</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../AdvancedTutorial.html">5. Advanced tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Tools.html">6. Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PortingGuideForNonPOSIXPlatforms.html">7. Porting guide for non-POSIX platforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Commercial_support.html">8. Commercial support</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Anjay</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../BasicTutorial.html">4. Basic tutorial</a> &raquo;</li>
        
      <li>4.3. Event loop</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/BasicTutorial/BT3.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="event-loop">
<h1>4.3. Event loop<a class="headerlink" href="#event-loop" title="Permalink to this headline">¶</a></h1>
<p>The last task to complete is to write the event loop which will control the
whole application.</p>
<p>Anjay currently does not use any self-contained threads, so some manual handling
of incoming events is necessary. Those events may come from a number of sources:</p>
<ul class="simple">
<li><p>Network packets from LwM2M servers</p></li>
<li><p>Anjay’s internal task scheduler</p></li>
<li><p>External events specific to the client application</p></li>
</ul>
<p>On POSIX systems, a simple and portable way to handle all these events is to use
the <code class="docutils literal notranslate"><span class="pre">poll()</span></code> system call.</p>
<div class="section" id="incoming-network-packets">
<h2>4.3.1. Incoming network packets<a class="headerlink" href="#incoming-network-packets" title="Permalink to this headline">¶</a></h2>
<p>UDP sockets that Anjay uses to communicate with LwM2M servers are accessible
via the <code class="docutils literal notranslate"><span class="pre">anjay_get_sockets()</span></code> call. All the used sockets are returned as an
<code class="docutils literal notranslate"><span class="pre">AVS_LIST</span></code> (implemented and documented in the <a class="reference external" href="https://github.com/AVSystem/avs_commons">AVSystem Commons Library</a>).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To retrieve a low-level operating system handle (on POSIX systems it is
a file descriptor) use the <code class="docutils literal notranslate"><span class="pre">avs_net_socket_get_system()</span></code> call.</p>
</div>
<p>When there is a new incoming packet on some socket, <code class="docutils literal notranslate"><span class="pre">anjay_serve()</span></code> shall
be called to handle it.</p>
<p>Therefore our first attempt to write an event loop could look like this:</p>
<ol class="arabic simple" id="incomplete-event-loop-idea">
<li><p>Obtain all sources of incoming packets (i.e. server sockets) from the
library.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">poll()</span></code> on them to wait for some communication.</p></li>
<li><p>When the packet arrives, call <code class="docutils literal notranslate"><span class="pre">anjay_serve()</span></code> that will handle the
message.</p></li>
</ol>
<p>Before doing that though, you should also understand a very important concept
Anjay is using, i.e. <a class="reference internal" href="#task-scheduler"><span class="std std-ref">Task scheduler</span></a>.</p>
</div>
<div class="section" id="task-scheduler">
<span id="id1"></span><h2>4.3.2. Task scheduler<a class="headerlink" href="#task-scheduler" title="Permalink to this headline">¶</a></h2>
<p>Anjay uses an internal scheduler for a number of tasks, including automated
sending of Registration Updates and notifications, among others.</p>
<p>During runtime, Anjay schedules jobs with specific deadlines, and
expects them to be executed when the right time comes – it is relying on
<code class="docutils literal notranslate"><span class="pre">anjay_sched_run()</span></code> being regularly invoked.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">anjay_sched_run()</span></code> iterates over the scheduled jobs (checking if some
of them should be run at this particular moment) and executes them if
necessary.</p>
<p>The requirement of regularly invoking <code class="docutils literal notranslate"><span class="pre">anjay_sched_run()</span></code> is a direct
consequence of Anjay being a single-threaded application. It is not a problem
however, as you may call <code class="docutils literal notranslate"><span class="pre">anjay_sched_run()</span></code> repeatedly in the main program
loop that you would have to write anyway.</p>
<p>Unfortunately, a naive implementation could cause unnecessary waste of CPU
time. This problem is addressed by <code class="docutils literal notranslate"><span class="pre">anjay_sched_calculate_wait_time_ms()</span></code>
which returns the number of milliseconds before the next scheduled job -
so, unless there is a communication going on, it would be the amount of
time the CPU can sleep. In the next example we will use this value as a
<code class="docutils literal notranslate"><span class="pre">poll()</span></code> timeout.</p>
</div>
<div class="section" id="event-loop-finally">
<span id="basic-event-loop"></span><h2>4.3.3. Event loop finally<a class="headerlink" href="#event-loop-finally" title="Permalink to this headline">¶</a></h2>
<p>Taking into account previous subsections we could modify the event loop
presented <a class="reference internal" href="#incomplete-event-loop-idea"><span class="std std-ref">before</span></a> as follows:</p>
<ol class="arabic simple">
<li><p>Obtain all sources of incoming packets (i.e. server sockets) from the library.</p></li>
<li><p>Determine what is the expected time to the next job that has to be executed.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">poll()</span></code> to wait for the incoming communication (but not for too long,
to prevent missing any pending scheduler jobs).</p></li>
<li><p>Call <code class="docutils literal notranslate"><span class="pre">anjay_serve()</span></code> on packet arrival, which will handle the message.</p></li>
<li><p>Run the scheduler to execute any outstanding jobs.</p></li>
</ol>
<div class="topic">
<p class="topic-title first">Wait, why do I have to repeatedly get the sources of packets?</p>
<p>There are at least two reasons for doing that:</p>
<ol class="arabic simple">
<li><p>At some point network error might have happened, forcing the library
to reconnect the socket, possibly changing its underlying descriptor.</p></li>
<li><p>The data model might have changed (for instance due to spontaneous Bootstrap
Write) and some Server were added / removed or their credentials were
modified.</p></li>
</ol>
</div>
<p>So, it could be written like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">main_loop</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">while</span> <span class="p">(</span><span class="n">true</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">//</span> <span class="n">Obtain</span> <span class="nb">all</span> <span class="n">network</span> <span class="n">data</span> <span class="n">sources</span>
        <span class="n">AVS_LIST</span><span class="p">(</span><span class="n">avs_net_abstract_socket_t</span> <span class="o">*</span><span class="n">const</span><span class="p">)</span> <span class="n">sockets</span> <span class="o">=</span>
                <span class="n">anjay_get_sockets</span><span class="p">(</span><span class="n">anjay</span><span class="p">);</span>

        <span class="o">//</span> <span class="n">Prepare</span> <span class="n">to</span> <span class="n">poll</span><span class="p">()</span> <span class="n">on</span> <span class="n">them</span>
        <span class="n">size_t</span> <span class="n">numsocks</span> <span class="o">=</span> <span class="n">AVS_LIST_SIZE</span><span class="p">(</span><span class="n">sockets</span><span class="p">);</span>
        <span class="n">struct</span> <span class="n">pollfd</span> <span class="n">pollfds</span><span class="p">[</span><span class="n">numsocks</span><span class="p">];</span>
        <span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">AVS_LIST</span><span class="p">(</span><span class="n">avs_net_abstract_socket_t</span> <span class="o">*</span><span class="n">const</span><span class="p">)</span> <span class="n">sock</span><span class="p">;</span>
        <span class="n">AVS_LIST_FOREACH</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">sockets</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">pollfds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">fd</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">const</span> <span class="nb">int</span> <span class="o">*</span><span class="p">)</span> <span class="n">avs_net_socket_get_system</span><span class="p">(</span><span class="o">*</span><span class="n">sock</span><span class="p">);</span>
            <span class="n">pollfds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">POLLIN</span><span class="p">;</span>
            <span class="n">pollfds</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">revents</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="o">++</span><span class="n">i</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">const</span> <span class="nb">int</span> <span class="n">max_wait_time_ms</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
        <span class="o">//</span> <span class="n">Determine</span> <span class="n">the</span> <span class="n">expected</span> <span class="n">time</span> <span class="n">to</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">milliseconds</span><span class="o">.</span>
        <span class="o">//</span> <span class="n">If</span> <span class="n">there</span> <span class="ow">is</span> <span class="n">no</span> <span class="n">job</span> <span class="n">we</span> <span class="n">will</span> <span class="n">wait</span> <span class="n">till</span> <span class="n">something</span> <span class="n">arrives</span> <span class="k">for</span>
        <span class="o">//</span> <span class="n">at</span> <span class="n">most</span> <span class="mi">1</span> <span class="n">second</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">e</span><span class="o">.</span> <span class="n">max_wait_time_ms</span><span class="p">)</span><span class="o">.</span>
        <span class="nb">int</span> <span class="n">wait_ms</span> <span class="o">=</span>
                <span class="n">anjay_sched_calculate_wait_time_ms</span><span class="p">(</span><span class="n">anjay</span><span class="p">,</span> <span class="n">max_wait_time_ms</span><span class="p">);</span>

        <span class="o">//</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">the</span> <span class="n">events</span> <span class="k">if</span> <span class="n">necessary</span><span class="p">,</span> <span class="ow">and</span> <span class="n">handle</span> <span class="n">them</span><span class="o">.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">poll</span><span class="p">(</span><span class="n">pollfds</span><span class="p">,</span> <span class="n">numsocks</span><span class="p">,</span> <span class="n">wait_ms</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nb">int</span> <span class="n">socket_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">AVS_LIST</span><span class="p">(</span><span class="n">avs_net_abstract_socket_t</span> <span class="o">*</span><span class="n">const</span><span class="p">)</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">NULL</span><span class="p">;</span>
            <span class="n">AVS_LIST_FOREACH</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">sockets</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">pollfds</span><span class="p">[</span><span class="n">socket_id</span><span class="p">]</span><span class="o">.</span><span class="n">revents</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">anjay_serve</span><span class="p">(</span><span class="n">anjay</span><span class="p">,</span> <span class="o">*</span><span class="n">socket</span><span class="p">))</span> <span class="p">{</span>
                        <span class="n">avs_log</span><span class="p">(</span><span class="n">tutorial</span><span class="p">,</span> <span class="n">ERROR</span><span class="p">,</span> <span class="s2">&quot;anjay_serve failed&quot;</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                <span class="o">++</span><span class="n">socket_id</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="o">//</span> <span class="n">Finally</span> <span class="n">run</span> <span class="n">the</span> <span class="n">scheduler</span> <span class="p">(</span><span class="n">ignoring</span> <span class="n">its</span> <span class="k">return</span> <span class="n">value</span><span class="p">,</span> <span class="n">which</span>
        <span class="o">//</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">number</span> <span class="n">of</span> <span class="n">tasks</span> <span class="n">executed</span><span class="p">)</span>
        <span class="p">(</span><span class="n">void</span><span class="p">)</span> <span class="n">anjay_sched_run</span><span class="p">(</span><span class="n">anjay</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="nb">int</span> <span class="n">main</span><span class="p">(</span><span class="nb">int</span> <span class="n">argc</span><span class="p">,</span> <span class="n">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="o">//</span> <span class="o">...</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">main_loop</span><span class="p">(</span><span class="n">anjay</span><span class="p">);</span>

    <span class="o">//</span> <span class="o">...</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>That’s it! You should now be able to connect to your LwM2M Server and exchange
messages with it interactively.</p>
</div>
<div class="section" id="other-events">
<h2>4.3.4. Other events<a class="headerlink" href="#other-events" title="Permalink to this headline">¶</a></h2>
<p>As we’ve been discussing, the code above is enough to handle all events that
may happen within the Anjay library itself. Of course, the application usually
needs to handle its own activity, this is however outside of the scope of
this tutorial, but the presented code may be used as a good starting point.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="BT4.html" class="btn btn-neutral float-right" title="4.4. A few notes on general usage" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="BT2.html" class="btn btn-neutral float-left" title="4.2. Installing mandatory Objects" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2019, AVSystem

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>