

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>4.2. Installing mandatory Objects &mdash; Anjay 2.2.5 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="4.3. Event loop" href="BT3.html" />
    <link rel="prev" title="4.1. Getting started!" href="BT1.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Anjay
          

          
          </a>

          
            
            
              <div class="version">
                2.2.5
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LwM2M.html">2. OMA LwM2M - Brief description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Compiling_client_applications.html">3. Compiling client applications</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../BasicTutorial.html">4. Basic tutorial</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="BT1.html">4.1. Getting started!</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">4.2. Installing mandatory Objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="BT3.html">4.3. Event loop</a></li>
<li class="toctree-l2"><a class="reference internal" href="BT4.html">4.4. A few notes on general usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="BT5_CustomObject.html">4.5. Custom LwM2M objects</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../AdvancedTutorial.html">5. Advanced tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Tools.html">6. Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PortingGuideForNonPOSIXPlatforms.html">7. Porting guide for non-POSIX platforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Commercial_support.html">8. Commercial support</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Anjay</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../BasicTutorial.html">4. Basic tutorial</a> &raquo;</li>
        
      <li>4.2. Installing mandatory Objects</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/BasicTutorial/BT2.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="installing-mandatory-objects">
<h1>4.2. Installing mandatory Objects<a class="headerlink" href="#installing-mandatory-objects" title="Permalink to this headline">¶</a></h1>
<p>In order to be able to connect to some LwM2M Server and handle incoming
packets our client has to have at least LwM2M Security (<code class="docutils literal notranslate"><span class="pre">/0</span></code>) and LwM2M
Server (<code class="docutils literal notranslate"><span class="pre">/1</span></code>) Objects implemented.</p>
<p>Fortunately, Anjay provides both of these Objects in form of preimplemented
modules, and they can be used easily.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">That doesn’t impact on Anjay flexibility – i.e. users can still
provide their own implementation of these Objects if necessary.</p>
</div>
<p>When Anjay is first instantiated (as in our previous <a class="reference internal" href="BT1.html#anjay-hello-world"><span class="std std-ref">hello world</span></a> example) it has no knowledge about the Data Model,
i.e. no LwM2M Objects are registered within it. Security and Server objects can
be registered using installation mechanism, presented in the next subsection.</p>
<div class="section" id="installing-objects">
<span id="registering-objects"></span><h2>4.2.1. Installing Objects<a class="headerlink" href="#installing-objects" title="Permalink to this headline">¶</a></h2>
<p>Each LwM2M Object is defined by an instance of the <code class="docutils literal notranslate"><span class="pre">anjay_dm_object_def_t</span></code>
structure. To add support for a new Object, you’d need to fill that structure
and implement appropriate callback functions, linking it to actual
representation and register created objects within Anjay. However, for now, we
are going to install our preimplemented LwM2M Objects (Security, Server), so
that you don’t have to worry about initializing the structure and object
registration on your own. In case you are interested in this topic at that
moment, you may jump to <a class="reference internal" href="BT5_CustomObject.html"><span class="doc">Custom LwM2M objects</span></a> to get more information.</p>
<p>To install objects we are going to use <code class="docutils literal notranslate"><span class="pre">anjay_security_object_install()</span></code> and
<code class="docutils literal notranslate"><span class="pre">anjay_server_object_install()</span></code> functions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">anjay_security_object_install</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">int</span> <span class="n">anjay_server_object_install</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="installing-server-and-security-objects">
<h2>4.2.2. Installing Server and Security Objects<a class="headerlink" href="#installing-server-and-security-objects" title="Permalink to this headline">¶</a></h2>
<p>We are going to modify the code from the <a class="reference internal" href="BT1.html#anjay-hello-world"><span class="std std-ref">previous tutorial</span></a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#include &lt;anjay/anjay.h&gt;
#include &lt;anjay/security.h&gt;
#include &lt;anjay/server.h&gt;
#include &lt;avsystem/commons/log.h&gt;

int main(int argc, char *argv[]) {
    static const anjay_configuration_t CONFIG = {
        .endpoint_name = &quot;urn:dev:os:anjay-tutorial&quot;,
        .in_buffer_size = 4000,
        .out_buffer_size = 4000
    };

    anjay_t *anjay = anjay_new(&amp;CONFIG);
    if (!anjay) {
        avs_log(tutorial, ERROR, &quot;Could not create Anjay object&quot;);
        return -1;
    }
    int result = 0;

    // Install necessary objects
    if (anjay_security_object_install(anjay)
            || anjay_server_object_install(anjay)) {
        result = -1;
        goto cleanup;
    }

    // ...

    // Event loop will go here

cleanup:
    anjay_delete(anjay);
    return result;
}
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal notranslate"><span class="pre">anjay_delete()</span></code> will automatically delete installed modules after
destruction of Anjay instance.</p>
</div>
</div>
<div class="section" id="adding-necessary-security-and-server-entries">
<h2>4.2.3. Adding necessary Security and Server entries<a class="headerlink" href="#adding-necessary-security-and-server-entries" title="Permalink to this headline">¶</a></h2>
<p>OK, we are ready to tell Anjay what is the LwM2M Server address we would like
to connect to. In order to do this, we will create two structure instances
(<code class="docutils literal notranslate"><span class="pre">anjay_server_instance_t</span></code>, <code class="docutils literal notranslate"><span class="pre">anjay_security_instance_t</span></code>) and fill them
accordingly. After that they are going to be added as respective Object
Instances:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">anjay_security_instance_t</span> <span class="n">security_instance</span> <span class="o">=</span> <span class="p">{</span>
    <span class="o">.</span><span class="n">ssid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="o">.</span><span class="n">server_uri</span> <span class="o">=</span> <span class="s2">&quot;coap://127.0.0.1:5683&quot;</span><span class="p">,</span>
    <span class="o">.</span><span class="n">security_mode</span> <span class="o">=</span> <span class="n">ANJAY_SECURITY_NOSEC</span>
<span class="p">};</span>

<span class="n">const</span> <span class="n">anjay_server_instance_t</span> <span class="n">server_instance</span> <span class="o">=</span> <span class="p">{</span>
    <span class="o">.</span><span class="n">ssid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="o">.</span><span class="n">lifetime</span> <span class="o">=</span> <span class="mi">86400</span><span class="p">,</span>
    <span class="o">.</span><span class="n">default_min_period</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="o">.</span><span class="n">default_max_period</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="o">.</span><span class="n">disable_timeout</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="o">.</span><span class="n">binding</span> <span class="o">=</span> <span class="s2">&quot;U&quot;</span>
<span class="p">};</span>

<span class="n">anjay_iid_t</span> <span class="n">security_instance_id</span> <span class="o">=</span> <span class="n">ANJAY_ID_INVALID</span><span class="p">;</span>
<span class="n">anjay_iid_t</span> <span class="n">server_instance_id</span> <span class="o">=</span> <span class="n">ANJAY_ID_INVALID</span><span class="p">;</span>
<span class="n">anjay_security_object_add_instance</span><span class="p">(</span><span class="n">anjay</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">security_instance</span><span class="p">,</span>
                                   <span class="o">&amp;</span><span class="n">security_instance_id</span><span class="p">);</span>
<span class="n">anjay_server_object_add_instance</span><span class="p">(</span><span class="n">anjay</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">server_instance</span><span class="p">,</span>
                                 <span class="o">&amp;</span><span class="n">server_instance_id</span><span class="p">);</span>
</pre></div>
</div>
<p>Great, so far it was really easy. But our client is currently unable to
connect to the specified Server.  It is because we have not implemented
an <a class="reference internal" href="BT3.html"><span class="doc">event loop</span></a> yet. It may be a little bit more complicated, as
you’ll see in the next chapter, but the example event loop will be provided,
so that one can just copypaste it and run the Client finally.</p>
</div>
<div class="section" id="enabling-lwm2m-discover-on-objects">
<h2>4.2.4. Enabling LwM2M Discover on Objects<a class="headerlink" href="#enabling-lwm2m-discover-on-objects" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">LwM2M Specification requires support of LwM2M Discover, therefore we do
<strong>recommend</strong> to read this section and enable discovery support for all
objects by default.</p>
</div>
<p>When a LwM2M Client registers to an LwM2M Server, it is often desired by the
LwM2M Server to get an overview of the entire Data Model. While <a class="reference internal" href="../LwM2M.html#lwm2m-registration-interface"><span class="std std-ref">LwM2M
Register</span></a> brings some information about Data
Model tree (by listing registered Objects and their Instances in the payload),
it does not contain any information about <a class="reference internal" href="../LwM2M.html#lwm2m-resources"><span class="std std-ref">Resources</span></a>.</p>
<p>Server-side, the resource discovery could be implemented as <a class="reference internal" href="../LwM2M.html#lwm2m-read"><span class="std std-ref">LwM2M
Read</span></a>, or <a class="reference internal" href="../LwM2M.html#lwm2m-discover"><span class="std std-ref">LwM2M Discover</span></a>, executed for
each Object.</p>
<p>The former could be suboptimal though, if resources happen to be
long. Therefore allowing the Server to use the LwM2M Discover could be
beneficial in terms of performance as well as bandwidth consumption.</p>
<p>Anjay supports the LwM2M Discover operation, but it must be ensured
that <a class="reference internal" href="../LwM2M.html#lwm2m-attributes"><span class="std std-ref">Attributes</span></a> for a given Data Model entity
could be read. However, as you may have noticed: we did not implement any
attribute-related handlers in this tutorial, and thus an attempt to perform
an LwM2M Discover will result in <cite>Method Not Allowed</cite> response.</p>
<p>Lucky for us, this could be fixed quickly as Anjay comes with <a class="reference internal" href="../AdvancedTutorial/AT1.html"><span class="doc">Attribute
Storage</span></a> module, that contains pre-implemented
attribute handlers. Installing it is enough to enable LwM2M Discover.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Of course, one can implement all attribute-related handles on their own
(if needed), though we believe Attribute Storage should be sufficient
for most use cases.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="BT3.html" class="btn btn-neutral float-right" title="4.3. Event loop" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="BT1.html" class="btn btn-neutral float-left" title="4.1. Getting started!" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2020, AVSystem

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>