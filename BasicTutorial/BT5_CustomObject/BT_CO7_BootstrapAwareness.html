

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>4.5.7. Bootstrap awareness &mdash; Anjay 1.13.1 documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="4.5.8. Notifications for dynamically-changing Resources" href="BT_CO8_Notifications.html" />
    <link rel="prev" title="4.5.6. Objects with Multiple Instance Resources" href="BT_CO6_MultipleResourceInstances.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Anjay
          

          
          </a>

          
            
            
              <div class="version">
                1.13.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../Introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LwM2M.html">2. OMA LwM2M - Brief description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Compiling_client_applications.html">3. Compiling client applications</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../BasicTutorial.html">4. Basic tutorial</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../BT1.html">4.1. Getting started!</a></li>
<li class="toctree-l2"><a class="reference internal" href="../BT2.html">4.2. Installing mandatory Objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../BT3.html">4.3. Event loop</a></li>
<li class="toctree-l2"><a class="reference internal" href="../BT4.html">4.4. A few notes on general usage</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../BT5_CustomObject.html">4.5. Custom LwM2M objects</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="BT_CO1_SingleInstanceReadOnly.html">4.5.1. Single-instance read-only object</a></li>
<li class="toctree-l3"><a class="reference internal" href="BT_CO2_SingleInstanceExecutableAndReadOnly.html">4.5.2. Single-instance read-only object with an executable resource</a></li>
<li class="toctree-l3"><a class="reference internal" href="BT_CO3_MultiInstanceReadOnlyFixed.html">4.5.3. Multi-instance read-only object with fixed number of instances</a></li>
<li class="toctree-l3"><a class="reference internal" href="BT_CO4_FixedInstanceWritable.html">4.5.4. Multi-instance writable object with fixed number of instances</a></li>
<li class="toctree-l3"><a class="reference internal" href="BT_CO5_MultiInstanceDynamic.html">4.5.5. Multi-instance writable object with dynamic number of instances</a></li>
<li class="toctree-l3"><a class="reference internal" href="BT_CO6_MultipleResourceInstances.html">4.5.6. Objects with Multiple Instance Resources</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">4.5.7. Bootstrap awareness</a></li>
<li class="toctree-l3"><a class="reference internal" href="BT_CO8_Notifications.html">4.5.8. Notifications for dynamically-changing Resources</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../AdvancedTutorial.html">5. Advanced tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tools.html">6. Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PortingGuideForNonPOSIXPlatforms.html">7. Porting guide for non-POSIX platforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Commercial_support.html">8. Commercial support</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Anjay</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../BasicTutorial.html">4. Basic tutorial</a> &raquo;</li>
        
          <li><a href="../BT5_CustomObject.html">4.5. Custom LwM2M objects</a> &raquo;</li>
        
      <li>4.5.7. Bootstrap awareness</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/BasicTutorial/BT5_CustomObject/BT_CO7_BootstrapAwareness.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="bootstrap-awareness">
<h1>4.5.7. Bootstrap awareness<a class="headerlink" href="#bootstrap-awareness" title="Permalink to this headline">¶</a></h1>
<p>In this tutorial you will learn:</p>
<ul class="simple">
<li>how to use <code class="docutils literal notranslate"><span class="pre">resource_operations</span></code> handler to prevent Anjay from calling
some handlers in non-bootstrap context,</li>
<li>how to setup Resources writable only by the LwM2M Bootstrap Server.</li>
</ul>
<div class="section" id="handling-lwm2m-bootstrap-server">
<h2>4.5.7.1. Handling LwM2M Bootstrap Server<a class="headerlink" href="#handling-lwm2m-bootstrap-server" title="Permalink to this headline">¶</a></h2>
<p>LwM2M Bootstrap Server is an unusual entity: it is allowed to modify Instances
and Resources not accessible to “regular” LwM2M Servers. That is useful for
setting up sensitive data that servers should not change (or even read) during
normal operation of the device - DTLS keys or certificates, for example.</p>
<p>Whenever an LwM2M Bootstrap Server sends a Bootstrap Write request, Anjay uses
the same <code class="docutils literal notranslate"><span class="pre">instance_create</span></code> and <code class="docutils literal notranslate"><span class="pre">resource_write</span></code> handlers as for “regular”
LwM2M Server operations. The only difference is that Anjay <em>does not call</em>
<code class="docutils literal notranslate"><span class="pre">resource_operations</span></code> <em>handler</em> for bootstrap requests, allowing Bootstrap
Server to do anything it wants.</p>
<p>If a device has to implement a Resource that must only be writable by the LwM2M
Bootstrap Server, its handlers should be implemented like so:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">resource_write</span></code> handler must be able to set the value of a Resource,
as if it was a writable one,</li>
<li><code class="docutils literal notranslate"><span class="pre">resource_operations</span></code> handler should not set the
<code class="docutils literal notranslate"><span class="pre">ANJAY_DM_RESOURCE_OP_BIT_W</span></code> in returned access flags. That will prevent
Anjay from calling the <code class="docutils literal notranslate"><span class="pre">resource_write</span></code> handler for this particular Resource
when the request is issued by a non-bootstrap server.</li>
</ul>
</div>
<div class="section" id="example-bootstrap-writable-resource">
<h2>4.5.7.2. Example: bootstrap-writable Resource<a class="headerlink" href="#example-bootstrap-writable-resource" title="Permalink to this headline">¶</a></h2>
<p>As an example, we will modify the Test Object from
<a class="reference internal" href="BT_CO4_FixedInstanceWritable.html"><span class="doc">Multi-instance writable object with fixed number of instances</span></a> to prevent changing the value of <code class="docutils literal notranslate"><span class="pre">Label</span></code>
Resource by non-bootstrap servers:</p>
<table border="1" class="docutils">
<colgroup>
<col width="37%" />
<col width="31%" />
<col width="31%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Object ID</th>
<th class="head">Instances</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Test object</td>
<td>1234</td>
<td>Multiple</td>
</tr>
</tbody>
</table>
<p>Each Object Instance has two Resources:</p>
<table border="1" class="docutils">
<colgroup>
<col width="11%" />
<col width="21%" />
<col width="19%" />
<col width="17%" />
<col width="17%" />
<col width="14%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Name</th>
<th class="head">Resource ID</th>
<th class="head">Operations</th>
<th class="head">Instances</th>
<th class="head">Mandatory</th>
<th class="head">Type</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Label</td>
<td>0</td>
<td>Read</td>
<td>Single</td>
<td>Mandatory</td>
<td>String</td>
</tr>
<tr class="row-odd"><td>Value</td>
<td>1</td>
<td>Read/Write</td>
<td>Single</td>
<td>Mandatory</td>
<td>Integer</td>
</tr>
</tbody>
</table>
<p>To achieve that, <code class="docutils literal notranslate"><span class="pre">anjay_dm_resource_operations_t</span></code> handler is required:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="nb">int</span> <span class="n">test_resource_operations</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                                    <span class="n">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="n">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
                                    <span class="n">anjay_rid_t</span> <span class="n">rid</span><span class="p">,</span>
                                    <span class="n">anjay_dm_resource_op_mask_t</span> <span class="o">*</span><span class="n">out</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="n">void</span><span class="p">)</span> <span class="n">anjay</span><span class="p">;</span>
    <span class="p">(</span><span class="n">void</span><span class="p">)</span> <span class="n">obj_ptr</span><span class="p">;</span>
    <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="n">ANJAY_DM_RESOURCE_OP_NONE</span><span class="p">;</span>

    <span class="n">switch</span> <span class="p">(</span><span class="n">rid</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">case</span> <span class="mi">0</span><span class="p">:</span>
        <span class="o">//</span> <span class="n">only</span> <span class="n">allow</span> <span class="n">reading</span> <span class="n">Resource</span> <span class="mi">0</span> <span class="n">by</span> <span class="n">LwM2M</span> <span class="n">Servers</span>
        <span class="o">//</span> <span class="n">this</span> <span class="n">will</span> <span class="n">be</span> <span class="n">ignored</span> <span class="k">for</span> <span class="n">LwM2M</span> <span class="n">Bootstrap</span> <span class="n">Server</span>
        <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="n">ANJAY_DM_RESOURCE_OP_BIT_R</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="n">case</span> <span class="mi">1</span><span class="p">:</span>
        <span class="o">//</span> <span class="n">Value</span> <span class="n">Resource</span> <span class="n">can</span> <span class="n">be</span> <span class="n">read</span><span class="o">/</span><span class="n">written</span> <span class="n">by</span> <span class="n">LwM2M</span> <span class="n">Servers</span>
        <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="n">ANJAY_DM_RESOURCE_OP_BIT_R</span> <span class="o">|</span> <span class="n">ANJAY_DM_RESOURCE_OP_BIT_W</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="n">default</span><span class="p">:</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="o">//</span> <span class="o">...</span>

<span class="n">static</span> <span class="n">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="n">OBJECT_DEF</span> <span class="o">=</span> <span class="p">{</span>
    <span class="o">//</span> <span class="n">Object</span> <span class="n">ID</span>
    <span class="o">.</span><span class="n">oid</span> <span class="o">=</span> <span class="mi">1234</span><span class="p">,</span>
    <span class="o">//</span> <span class="o">...</span>
    <span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="o">//</span> <span class="o">...</span> <span class="n">other</span> <span class="n">handlers</span>

        <span class="o">.</span><span class="n">resource_operations</span> <span class="o">=</span> <span class="n">test_resource_operations</span><span class="p">,</span>
        <span class="o">//</span> <span class="o">...</span> <span class="n">other</span> <span class="n">handlers</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<p>That leaves one more issue with the example project: it has a pre-configured
LwM2M Server that is not a bootstrap one. Changing it to an LwM2M Bootstrap
Server is a matter of setting <code class="docutils literal notranslate"><span class="pre">bootstrap_server</span> <span class="pre">=</span> <span class="pre">true</span></code> on
<code class="docutils literal notranslate"><span class="pre">anjay_security_instance_t</span></code> struct when initializing the Security Object:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">const</span> <span class="n">anjay_security_instance_t</span> <span class="n">security_instance</span> <span class="o">=</span> <span class="p">{</span>
    <span class="o">.</span><span class="n">ssid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="o">.</span><span class="n">bootstrap_server</span> <span class="o">=</span> <span class="n">true</span><span class="p">,</span>
    <span class="o">.</span><span class="n">server_uri</span> <span class="o">=</span> <span class="s2">&quot;coap://127.0.0.1:5683&quot;</span><span class="p">,</span>
    <span class="o">.</span><span class="n">security_mode</span> <span class="o">=</span> <span class="n">ANJAY_UDP_SECURITY_NOSEC</span>
<span class="p">};</span>
</pre></div>
</div>
<p>It is worth noting that the LwM2M Bootstrap Server has only a Security Object
instance and no Server Object instances. For that reason, the example project
deliberately does not initialize any Server Object Instances.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Complete code of this example can be found in
<cite>examples/tutorial/custom-object/bootstrap-awareness</cite> subdirectory of main
Anjay project repository.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="BT_CO8_Notifications.html" class="btn btn-neutral float-right" title="4.5.8. Notifications for dynamically-changing Resources" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="BT_CO6_MultipleResourceInstances.html" class="btn btn-neutral" title="4.5.6. Objects with Multiple Instance Resources" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2018, AVSystem.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.13.1',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>