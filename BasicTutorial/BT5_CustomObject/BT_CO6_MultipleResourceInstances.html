

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>4.5.6. Objects with Multiple Instance Resources &mdash; Anjay 2.2.5 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="4.5.7. Bootstrap awareness" href="BT_CO7_BootstrapAwareness.html" />
    <link rel="prev" title="4.5.5. Multi-instance writable object with dynamic number of instances" href="BT_CO5_MultiInstanceDynamic.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Anjay
          

          
          </a>

          
            
            
              <div class="version">
                2.2.5
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../Introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LwM2M.html">2. OMA LwM2M - Brief description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Compiling_client_applications.html">3. Compiling client applications</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../BasicTutorial.html">4. Basic tutorial</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../BT1.html">4.1. Getting started!</a></li>
<li class="toctree-l2"><a class="reference internal" href="../BT2.html">4.2. Installing mandatory Objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../BT3.html">4.3. Event loop</a></li>
<li class="toctree-l2"><a class="reference internal" href="../BT4.html">4.4. A few notes on general usage</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../BT5_CustomObject.html">4.5. Custom LwM2M objects</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="BT_CO1_SingleInstanceReadOnly.html">4.5.1. Single-instance read-only object</a></li>
<li class="toctree-l3"><a class="reference internal" href="BT_CO2_SingleInstanceExecutableAndReadOnly.html">4.5.2. Single-instance read-only object with an executable resource</a></li>
<li class="toctree-l3"><a class="reference internal" href="BT_CO3_MultiInstanceReadOnlyFixed.html">4.5.3. Multi-instance read-only object with fixed number of instances</a></li>
<li class="toctree-l3"><a class="reference internal" href="BT_CO4_FixedInstanceWritable.html">4.5.4. Multi-instance writable object with fixed number of instances</a></li>
<li class="toctree-l3"><a class="reference internal" href="BT_CO5_MultiInstanceDynamic.html">4.5.5. Multi-instance writable object with dynamic number of instances</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">4.5.6. Objects with Multiple Instance Resources</a></li>
<li class="toctree-l3"><a class="reference internal" href="BT_CO7_BootstrapAwareness.html">4.5.7. Bootstrap awareness</a></li>
<li class="toctree-l3"><a class="reference internal" href="BT_CO8_Notifications.html">4.5.8. Notifications for dynamically-changing Resources</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../AdvancedTutorial.html">5. Advanced tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tools.html">6. Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PortingGuideForNonPOSIXPlatforms.html">7. Porting guide for non-POSIX platforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Commercial_support.html">8. Commercial support</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Anjay</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../BasicTutorial.html">4. Basic tutorial</a> &raquo;</li>
        
          <li><a href="../BT5_CustomObject.html">4.5. Custom LwM2M objects</a> &raquo;</li>
        
      <li>4.5.6. Objects with Multiple Instance Resources</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/BasicTutorial/BT5_CustomObject/BT_CO6_MultipleResourceInstances.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="objects-with-multiple-instance-resources">
<h1>4.5.6. Objects with Multiple Instance Resources<a class="headerlink" href="#objects-with-multiple-instance-resources" title="Permalink to this headline">¶</a></h1>
<p>In this tutorial you will learn:</p>
<ul class="simple">
<li>how to retrieve a Multiple Instance Resource using Anjay API,</li>
<li>how to send a Multiple Instance Resource using Anjay API.</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>This section explains manual implementation of custom objects. If the
object you wish to implement is a standard one, registered in <a class="reference external" href="http://www.openmobilealliance.org/wp/OMNA/LwM2M/LwM2MRegistry.html">OMA LwM2M
Object and Resource Registry</a>,
you can generate Anjay object stub from the Object Definition XML with
<a class="reference internal" href="../../Tools.html#anjay-object-stub-generator"><span class="std std-ref">Anjay Object stub generator</span></a>.</p>
<p class="last">We still encourage you to read the tutorial to have a clear understanding
on what various parts of the LwM2M object code are for.</p>
</div>
<p>We will extend the Test object from <a class="reference external" href="BT_CO4_MultiInstanceDynamic">previous tutorial</a>
by allowing <cite>Value</cite> Resource to contain multiple values.</p>
<div class="section" id="api-for-multiple-instance-resources-management">
<h2>4.5.6.1. API for Multiple Instance Resources management<a class="headerlink" href="#api-for-multiple-instance-resources-management" title="Permalink to this headline">¶</a></h2>
<p>Dealing with Multiple Instance Resources in the data model requires implementing
additional handlers. The most important in the <code class="docutils literal notranslate"><span class="pre">list_resource_instances</span></code>
handler:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">typedef</span> <span class="nb">int</span>
<span class="n">anjay_dm_list_resource_instances_t</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                                   <span class="n">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="n">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
                                   <span class="n">anjay_iid_t</span> <span class="n">iid</span><span class="p">,</span>
                                   <span class="n">anjay_rid_t</span> <span class="n">rid</span><span class="p">,</span>
                                   <span class="n">anjay_dm_list_ctx_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">);</span>
</pre></div>
</div>
<p>This handler needs to be implemented for any Object that has some Multiple
Instance Resource. It will only be called on Multiple Resources, as determined
by the <code class="docutils literal notranslate"><span class="pre">kind</span></code> argument passed to <code class="docutils literal notranslate"><span class="pre">anjay_dm_emit_res()</span></code> in the
<code class="docutils literal notranslate"><span class="pre">list_resources</span></code> handler. It shall list (via the passed
<code class="docutils literal notranslate"><span class="pre">anjay_dm_list_ctx_t</span></code>) all the currently existing instances of the resource.</p>
<p>To allow writing to Multiple Instance Resources, the <code class="docutils literal notranslate"><span class="pre">resource_reset</span></code> handler
needs to be implemented as well:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">typedef</span> <span class="nb">int</span>
<span class="n">anjay_dm_resource_reset_t</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                          <span class="n">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="n">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
                          <span class="n">anjay_iid_t</span> <span class="n">iid</span><span class="p">,</span>
                          <span class="n">anjay_rid_t</span> <span class="n">rid</span><span class="p">);</span>
</pre></div>
</div>
<p>This handler will only be called on Resources that has been determined to have
multiple instances. It shall put the Resource in a state that it is present, but
having zero instances.</p>
<p>The actual reads and writes are performed using the usual <code class="docutils literal notranslate"><span class="pre">resource_read</span></code> and
<code class="docutils literal notranslate"><span class="pre">resource_write</span></code> handler. The <code class="docutils literal notranslate"><span class="pre">riid</span></code> argument that we have previously been
ignoring, is used to determine the Resource Instance that is targeted.</p>
</div>
<div class="section" id="preparing-test-object-for-multiple-instance-resources">
<h2>4.5.6.2. Preparing Test object for Multiple Instance Resources<a class="headerlink" href="#preparing-test-object-for-multiple-instance-resources" title="Permalink to this headline">¶</a></h2>
<p>First of all, we need to update the List Resources handler so that the library
knows that Resource 1 now has multiple instances:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="nb">int</span> <span class="n">test_list_resources</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                               <span class="n">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="n">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
                               <span class="n">anjay_iid_t</span> <span class="n">iid</span><span class="p">,</span>
                               <span class="n">anjay_dm_resource_list_ctx_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">//</span> <span class="o">...</span>
    <span class="n">anjay_dm_emit_res</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ANJAY_DM_RES_RW</span><span class="p">,</span> <span class="n">ANJAY_DM_RES_PRESENT</span><span class="p">);</span>
    <span class="n">anjay_dm_emit_res</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ANJAY_DM_RES_RWM</span><span class="p">,</span> <span class="n">ANJAY_DM_RES_PRESENT</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We define following structure to represent a single Instance of our Multiple
Instance Resource:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">typedef</span> <span class="n">struct</span> <span class="n">test_value_instance</span> <span class="p">{</span>
    <span class="n">anjay_riid_t</span> <span class="n">index</span><span class="p">;</span>
    <span class="n">int32_t</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span> <span class="n">test_value_instance_t</span><span class="p">;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><code class="docutils literal notranslate"><span class="pre">anjay_riid_t</span></code> is used for the first time in the tutorial. It is a data type
able to store all valid Resource Instance IDs.</p>
</div>
<p>We also edit <code class="docutils literal notranslate"><span class="pre">test_instance_t</span></code> structure definition:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">typedef</span> <span class="n">struct</span> <span class="n">test_instance</span> <span class="p">{</span>
    <span class="n">anjay_iid_t</span> <span class="n">iid</span><span class="p">;</span>

    <span class="nb">bool</span> <span class="n">has_label</span><span class="p">;</span>
    <span class="n">char</span> <span class="n">label</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

    <span class="nb">bool</span> <span class="n">has_values</span><span class="p">;</span>
    <span class="n">AVS_LIST</span><span class="p">(</span><span class="n">test_value_instance_t</span><span class="p">)</span> <span class="n">values</span><span class="p">;</span>
<span class="p">}</span> <span class="n">test_instance_t</span><span class="p">;</span>
</pre></div>
</div>
<div class="topic">
<p class="topic-title first">Why does <code class="docutils literal notranslate"><span class="pre">test_instance_t</span></code> still contain boolean flag indicating presence of the value?</p>
<p>There is certainly a difference between lack of presence of Multiple
Instance Resource value, and Multiple Instance Resource containing
zero Instances (i.e. lack of list presence vs an empty list).</p>
</div>
</div>
<div class="section" id="implementing-the-list-resource-instances-handler">
<h2>4.5.6.3. Implementing the List Resource Instances handler<a class="headerlink" href="#implementing-the-list-resource-instances-handler" title="Permalink to this headline">¶</a></h2>
<p>Here is how the List Resource Instances is implemented for our test object:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="nb">int</span>
<span class="n">test_list_resource_instances</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                             <span class="n">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="n">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
                             <span class="n">anjay_iid_t</span> <span class="n">iid</span><span class="p">,</span>
                             <span class="n">anjay_rid_t</span> <span class="n">rid</span><span class="p">,</span>
                             <span class="n">anjay_dm_list_ctx_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="n">void</span><span class="p">)</span> <span class="n">anjay</span><span class="p">;</span> <span class="o">//</span> <span class="n">unused</span>
    <span class="n">test_instance_t</span> <span class="o">*</span><span class="n">current_instance</span> <span class="o">=</span>
            <span class="p">(</span><span class="n">test_instance_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">get_instance</span><span class="p">(</span><span class="n">get_test_object</span><span class="p">(</span><span class="n">obj_ptr</span><span class="p">),</span> <span class="n">iid</span><span class="p">);</span>

    <span class="o">//</span> <span class="n">this</span> <span class="n">handler</span> <span class="n">can</span> <span class="n">only</span> <span class="n">be</span> <span class="n">called</span> <span class="k">for</span> <span class="n">Multiple</span><span class="o">-</span><span class="n">Instance</span> <span class="n">Resources</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">rid</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>

    <span class="n">AVS_LIST</span><span class="p">(</span><span class="n">test_value_instance_t</span><span class="p">)</span> <span class="n">it</span><span class="p">;</span>
    <span class="n">AVS_LIST_FOREACH</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">current_instance</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">anjay_dm_emit</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As you can see, the <code class="docutils literal notranslate"><span class="pre">anjay_dm_emit()</span></code> function is used to pass all the
existing Resource Instances to Anjay, similar to the <code class="docutils literal notranslate"><span class="pre">list_instances</span></code> and
<code class="docutils literal notranslate"><span class="pre">list_resources</span></code> handlers.</p>
<p>Note that the resource instances MUST be returned in a strictly ascending,
sorted order. We will keep the resource instances in sorted order, so this
implementation satisfies this contract.</p>
</div>
<div class="section" id="handling-multiple-instance-resources-in-read-rpc">
<h2>4.5.6.4. Handling Multiple Instance Resources in Read RPC<a class="headerlink" href="#handling-multiple-instance-resources-in-read-rpc" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">resource_read</span></code> handler is being called by Anjay for each Resource Instance
referenced by the server, giving the control to the user. Thus, the read handler
could look like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="nb">int</span> <span class="n">test_resource_read</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                              <span class="n">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="n">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
                              <span class="n">anjay_iid_t</span> <span class="n">iid</span><span class="p">,</span>
                              <span class="n">anjay_rid_t</span> <span class="n">rid</span><span class="p">,</span>
                              <span class="n">anjay_riid_t</span> <span class="n">riid</span><span class="p">,</span>
                              <span class="n">anjay_output_ctx_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">//</span> <span class="o">...</span>
    <span class="n">switch</span> <span class="p">(</span><span class="n">rid</span><span class="p">)</span> <span class="p">{</span>
    <span class="o">//</span> <span class="o">...</span>
    <span class="n">case</span> <span class="mi">1</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">AVS_LIST</span><span class="p">(</span><span class="n">const</span> <span class="n">test_value_instance_t</span><span class="p">)</span> <span class="n">it</span><span class="p">;</span>
        <span class="n">AVS_LIST_FOREACH</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">current_instance</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="n">riid</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">anjay_ret_i32</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="o">//</span> <span class="n">Resource</span> <span class="n">Instance</span> <span class="ow">not</span> <span class="n">found</span>
        <span class="k">return</span> <span class="n">ANJAY_ERR_NOT_FOUND</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">//</span> <span class="o">...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="implementing-the-resource-reset-handler">
<h2>4.5.6.5. Implementing the Resource Reset handler<a class="headerlink" href="#implementing-the-resource-reset-handler" title="Permalink to this headline">¶</a></h2>
<div class="topic">
<p class="topic-title first">General flow of function calls when LwM2M Write operation was
       issued on Multiple Instance Resource.</p>
<ol class="arabic simple">
<li><code class="docutils literal notranslate"><span class="pre">resource_reset</span></code> handler is being called by Anjay, to clear the
Multiple Instance Resource.</li>
<li><code class="docutils literal notranslate"><span class="pre">resource_write</span></code> handler is being called by Anjay for each Resource
Instance referenced by the server, giving the control to the user. The
handler shall add or replace the Resource with the instance it is being
called for.</li>
</ol>
</div>
<p>The above means that the Resource Reset handler is rather simple to implement,
as it only needs to clear the resource:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">static</span> <span class="nb">int</span> <span class="n">test_resource_reset</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                               <span class="n">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="n">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
                               <span class="n">anjay_iid_t</span> <span class="n">iid</span><span class="p">,</span>
                               <span class="n">anjay_rid_t</span> <span class="n">rid</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="n">void</span><span class="p">)</span> <span class="n">anjay</span><span class="p">;</span> <span class="o">//</span> <span class="n">unused</span>

    <span class="n">test_instance_t</span> <span class="o">*</span><span class="n">current_instance</span> <span class="o">=</span>
            <span class="p">(</span><span class="n">test_instance_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">get_instance</span><span class="p">(</span><span class="n">get_test_object</span><span class="p">(</span><span class="n">obj_ptr</span><span class="p">),</span> <span class="n">iid</span><span class="p">);</span>

    <span class="o">//</span> <span class="n">this</span> <span class="n">handler</span> <span class="n">can</span> <span class="n">only</span> <span class="n">be</span> <span class="n">called</span> <span class="k">for</span> <span class="n">Multiple</span><span class="o">-</span><span class="n">Instance</span> <span class="n">Resources</span>
    <span class="k">assert</span><span class="p">(</span><span class="n">rid</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>

    <span class="o">//</span> <span class="n">free</span> <span class="n">memory</span> <span class="n">associated</span> <span class="k">with</span> <span class="n">old</span> <span class="n">values</span>
    <span class="n">AVS_LIST_CLEAR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current_instance</span><span class="o">-&gt;</span><span class="n">values</span><span class="p">);</span>
    <span class="n">current_instance</span><span class="o">-&gt;</span><span class="n">has_values</span> <span class="o">=</span> <span class="n">true</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="handling-multiple-instance-resources-in-write-rpc">
<h2>4.5.6.6. Handling Multiple Instance Resources in Write RPC<a class="headerlink" href="#handling-multiple-instance-resources-in-write-rpc" title="Permalink to this headline">¶</a></h2>
<p>Now we are ready to actually implement the write operation. We will create a
helper function for actually updating the Resource Instance list with a newly
written value.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>static int test_array_write(AVS_LIST(test_value_instance_t) *out_instances,
                            anjay_riid_t index,
                            anjay_input_ctx_t *input_ctx) {
    test_value_instance_t instance = {
        .index = index
    };

    if (anjay_get_i32(input_ctx, &amp;instance.value)) {
        // An error occurred during the read.
        return ANJAY_ERR_INTERNAL;
    }

    AVS_LIST(test_value_instance_t) *insert_it;

    // Searching for the place to insert;
    // note that it makes the whole function O(n).
    AVS_LIST_FOREACH_PTR(insert_it, out_instances) {
        if ((*insert_it)-&gt;index &gt;= instance.index) {
            break;
        }
    }

    if ((*insert_it)-&gt;index != instance.index) {
        AVS_LIST(test_value_instance_t) new_element =
                AVS_LIST_NEW_ELEMENT(test_value_instance_t);

        if (!new_element) {
            // out of memory
            return ANJAY_ERR_INTERNAL;
        }

        AVS_LIST_INSERT(insert_it, new_element);
    }

    assert((*insert_it)-&gt;index == instance.index);
    **insert_it = instance;

    return 0;
}
</pre></div>
</div>
<p>Last thing to do is to modify <code class="docutils literal notranslate"><span class="pre">test_resource_write</span></code> implementation to make use
of our helper function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>static int test_resource_write(anjay_t *anjay,
                               const anjay_dm_object_def_t *const *obj_ptr,
                               anjay_iid_t iid,
                               anjay_rid_t rid,
                               anjay_riid_t riid,
                               anjay_input_ctx_t *ctx) {
    // ...
    switch (rid) {
    // ...
    case 1: {
        int result = test_array_write(&amp;current_instance-&gt;values, riid, ctx);
        if (!result) {
            current_instance-&gt;has_values = true;
        }

        // either test_array_write succeeded and result is 0, or not
        // in which case result contains appropriate error code.
        return result;
    }
    // ...
    }
}
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Complete code of this example can be found in
<cite>examples/tutorial/custom-object/multi-instance-resources-dynamic</cite>
subdirectory of main Anjay project repository.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="BT_CO7_BootstrapAwareness.html" class="btn btn-neutral float-right" title="4.5.7. Bootstrap awareness" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="BT_CO5_MultiInstanceDynamic.html" class="btn btn-neutral float-left" title="4.5.5. Multi-instance writable object with dynamic number of instances" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2020, AVSystem

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>