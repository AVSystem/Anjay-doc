<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4.5. Notifications support &mdash; Anjay 3.8.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=86f27845" />
      <link rel="stylesheet" type="text/css" href="../_static/theme_overrides.css?v=b9c2c5b9" />

  
  
        <script src="../_static/jquery.js?v=8dae8fb0"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=30f795a6"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="4.6. Send method" href="BC-Send.html" />
    <link rel="prev" title="4.4. Implementing standard Object" href="BC-ObjectImplementation.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #ffd500" >

          
          
          <a href="../index.html">
            
              <img src="../_static/avsystem_header.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                3.8.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LwM2M.html">2. OMA LwM2M - Brief description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Compiling_client_applications.html">3. Compiling client applications</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../BasicClient.html">4. Basic client</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="BC-Initialization.html">4.1. Anjay initialization</a></li>
<li class="toctree-l2"><a class="reference internal" href="BC-MandatoryObjects.html">4.2. Installing mandatory Objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="BC-Security.html">4.3. Enabling secure communication</a></li>
<li class="toctree-l2"><a class="reference internal" href="BC-ObjectImplementation.html">4.4. Implementing standard Object</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">4.5. Notifications support</a></li>
<li class="toctree-l2"><a class="reference internal" href="BC-Send.html">4.6. Send method</a></li>
<li class="toctree-l2"><a class="reference internal" href="BC-ThreadSafety.html">4.7. Thread safety in Anjay</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../AdvancedTopics.html">5. Advanced topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FirmwareUpdateTutorial.html">6. Firmware Update Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Tools.html">7. Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PortingGuideForNonPOSIXPlatforms.html">8. Porting guide for non-POSIX platforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Migrating.html">9. Migrating from older versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CommercialFeatures.html">10. Commercial features</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #ffd500" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Anjay</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../BasicClient.html"><span class="section-number">4. </span>Basic client</a></li>
      <li class="breadcrumb-item active"><span class="section-number">4.5. </span>Notifications support</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="notifications-support">
<h1><span class="section-number">4.5. </span>Notifications support<a class="headerlink" href="#notifications-support" title="Link to this heading"></a></h1>
<p>Some Resources may represent values that change over time, like sensor readings.
A LwM2M Server may be interested in variance of such values and use the Observe
operation to request notifications when they change, or when their value meets
certain criteria.</p>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>More information about available notification criteria can be found under
<strong>&lt;NOTIFICATION&gt;</strong> Class Attributes description in <a class="reference internal" href="../LwM2M.html#lwm2m-attributes"><span class="std std-ref">Attributes</span></a>.</p>
</div>
<p>When some part of the data model changes by means other than LwM2M, one has to
tell the library about it by calling an appropriate function:</p>
<ul class="simple">
<li><p>if a Resource value changed - <code class="docutils literal notranslate"><span class="pre">anjay_notify_changed()</span></code>,</p></li>
<li><p>if one or more Object Instances were created or removed -
<code class="docutils literal notranslate"><span class="pre">anjay_notify_instances_changed()</span></code>.</p></li>
</ul>
<p>Anjay then decides if the notification shall be sent, based on the currently
assigned Attributes (to the part of the data model being changed) and LwM2M
Servers that are interested in seeing the change.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>One should not call <code class="docutils literal notranslate"><span class="pre">anjay_notify_changed()</span></code>/<code class="docutils literal notranslate"><span class="pre">anjay_notify_instances_changed()</span></code>
when the value change was directly caused by LwM2M (e.g. by Write or Create
request). Anjay handles these cases internally.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">See also</p>
<p>Detailed description of these functions can be found in <a class="reference external" href="../../api">API docs</a>.</p>
</div>
<p>Calling <code class="docutils literal notranslate"><span class="pre">anjay_notify_changed()</span></code>/<code class="docutils literal notranslate"><span class="pre">anjay_notify_instances_changed()</span></code> does not
send notifications immediately, but schedules a task to be run on next event
loop iteration. That way, notifications for multiple values can be handled as a
batch, for example in case where the server observes an entire Object Instance.</p>
<section id="lwm2m-attributes">
<h2><span class="section-number">4.5.1. </span>LwM2M attributes<a class="headerlink" href="#lwm2m-attributes" title="Link to this heading"></a></h2>
<p>Correct handling of LwM2M Observe requests requires being able to store
Object/Instance/Resource attributes. For that, one needs to either implement
a set of attribute handlers, or use the pre-defined
<a class="reference internal" href="../AdvancedTopics/AT-AttributeStorage.html"><span class="doc">Attribute Storage subsystem</span></a>. In
this tutorial, we use pre-defined Attribute Storage subsystem here.</p>
</section>
<section id="example">
<h2><span class="section-number">4.5.2. </span>Example<a class="headerlink" href="#example" title="Link to this heading"></a></h2>
<p>As an example we’ll add notification support for the Time Object implemented
in previous <a class="reference internal" href="BC-ObjectImplementation.html"><span class="doc">Implementing standard Object</span></a> section. It contains a Current Time
Resource, whose value changes every second. We need to periodically notify the
library about that fact and for this purpose, we create a
<code class="docutils literal notranslate"><span class="pre">time_object_notify()</span></code> function in the <code class="docutils literal notranslate"><span class="pre">time_object.c</span></code> file, but first, we
need to modify <code class="docutils literal notranslate"><span class="pre">time_instance_t</span></code> a little. This will allow to store the last
timestamp when the <code class="docutils literal notranslate"><span class="pre">anjay_notify_changed()</span></code> was successfully called, to avoid
calling it twice during one second. Although it will not result in sending two
notifications with the same Resource value, because Anjay checks it internally,
it will lead to performing some unnecessary actions (like calling read handler
for example).</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">time_instance_struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">anjay_iid_t</span><span class="w"> </span><span class="n">iid</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">application_type</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">application_type_backup</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
<span class="hll"><span class="w">    </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">last_notify_timestamp</span><span class="p">;</span>
</span><span class="p">}</span><span class="w"> </span><span class="n">time_instance_t</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">time_object_notify</span><span class="p">(</span><span class="n">anjay_t</span><span class="w"> </span><span class="o">*</span><span class="n">anjay</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">anjay_dm_object_def_t</span><span class="w"> </span><span class="o">**</span><span class="n">def</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">anjay</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">def</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">time_object_t</span><span class="w"> </span><span class="o">*</span><span class="n">obj</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_obj</span><span class="p">(</span><span class="n">def</span><span class="p">);</span>

<span class="w">    </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">current_timestamp</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">avs_time_real_to_scalar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">current_timestamp</span><span class="p">,</span><span class="w"> </span><span class="n">AVS_TIME_S</span><span class="p">,</span>
<span class="w">                                </span><span class="n">avs_time_real_now</span><span class="p">()))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">AVS_LIST</span><span class="p">(</span><span class="n">time_instance_t</span><span class="p">)</span><span class="w"> </span><span class="n">it</span><span class="p">;</span>
<span class="w">    </span><span class="n">AVS_LIST_FOREACH</span><span class="p">(</span><span class="n">it</span><span class="p">,</span><span class="w"> </span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">instances</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">last_notify_timestamp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">current_timestamp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">anjay_notify_changed</span><span class="p">(</span><span class="n">anjay</span><span class="p">,</span><span class="w"> </span><span class="mi">3333</span><span class="p">,</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">iid</span><span class="p">,</span><span class="w"> </span><span class="n">RID_CURRENT_TIME</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">last_notify_timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_timestamp</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>At last, we need to declare the function in the object’s header file.</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">time_object.h</span><a class="headerlink" href="#id1" title="Link to this code"></a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifndef TIME_OBJECT_H</span>
<span class="cp">#define TIME_OBJECT_H</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;anjay/dm.h&gt;</span>

<span class="k">const</span><span class="w"> </span><span class="n">anjay_dm_object_def_t</span><span class="w"> </span><span class="o">**</span><span class="nf">time_object_create</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">time_object_release</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">anjay_dm_object_def_t</span><span class="w"> </span><span class="o">**</span><span class="n">def</span><span class="p">);</span>
<span class="hll"><span class="kt">void</span><span class="w"> </span><span class="nf">time_object_notify</span><span class="p">(</span><span class="n">anjay_t</span><span class="w"> </span><span class="o">*</span><span class="n">anjay</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">anjay_dm_object_def_t</span><span class="w"> </span><span class="o">**</span><span class="n">def</span><span class="p">);</span>
</span>
<span class="cp">#endif </span><span class="c1">// TIME_OBJECT_H</span>
</pre></div>
</div>
</div>
<p>Now we need to somehow call this function while the Anjay main loop is running.
This may be performed in several ways - additional tasks may be handled in a
separate thread, or a <a class="reference internal" href="../AdvancedTopics/AT-CustomEventLoop.html"><span class="doc">Custom event loop</span></a> may be
implemented instead of using <code class="docutils literal notranslate"><span class="pre">anjay_event_loop_run()</span></code>. However, the simplest
solution is to utilize Anjay’s internal scheduler.</p>
<p>Before calling <code class="docutils literal notranslate"><span class="pre">anjay_event_loop_run()</span></code>, our application extracts the
scheduler object by calling <a class="reference external" href="../api/core_8h.html#abb564689d6abd23010b5782bf4967819">anjay_get_scheduler()</a> and schedules a
specially crafted <code class="docutils literal notranslate"><span class="pre">notify_job()</span></code> function to run, using <a class="reference external" href="https://github.com/AVSystem/avs_commons/blob/2998769a4314f9b609951218dec85cb53b019775/include_public/avsystem/commons/avs_sched.h#L322">AVS_SCHED_DELAYED()</a>.
To run the function periodically, this call to <code class="docutils literal notranslate"><span class="pre">AVS_SCHED_DELAYED()</span></code> is in
fact called at the end of <code class="docutils literal notranslate"><span class="pre">notify_job()</span></code>, and <code class="docutils literal notranslate"><span class="pre">notify_job()</span></code> itself is
called from the main function to schedule the first run for simplicity.</p>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">main.c</span><a class="headerlink" href="#id2" title="Link to this code"></a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;anjay/anjay.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;anjay/security.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;anjay/server.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;avsystem/commons/avs_log.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;time_object.h&quot;</span>

<span class="hll"><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">    </span><span class="n">anjay_t</span><span class="w"> </span><span class="o">*</span><span class="n">anjay</span><span class="p">;</span>
</span><span class="hll"><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">anjay_dm_object_def_t</span><span class="w"> </span><span class="o">**</span><span class="n">time_object</span><span class="p">;</span>
</span><span class="hll"><span class="p">}</span><span class="w"> </span><span class="n">notify_job_args_t</span><span class="p">;</span>
</span><span class="hll">
</span><span class="hll"><span class="c1">// Periodically notifies the library about Resource value changes</span>
</span><span class="hll"><span class="k">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">notify_job</span><span class="p">(</span><span class="n">avs_sched_t</span><span class="w"> </span><span class="o">*</span><span class="n">sched</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">args_ptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">notify_job_args_t</span><span class="w"> </span><span class="o">*</span><span class="n">args</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">notify_job_args_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">args_ptr</span><span class="p">;</span>
</span><span class="hll">
</span><span class="hll"><span class="w">    </span><span class="n">time_object_notify</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">anjay</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="o">-&gt;</span><span class="n">time_object</span><span class="p">);</span>
</span><span class="hll">
</span><span class="hll"><span class="w">    </span><span class="c1">// Schedule run of the same function after 1 second</span>
</span><span class="hll"><span class="w">    </span><span class="n">AVS_SCHED_DELAYED</span><span class="p">(</span><span class="n">sched</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">avs_time_duration_from_scalar</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">AVS_TIME_S</span><span class="p">),</span>
</span><span class="hll"><span class="w">                      </span><span class="n">notify_job</span><span class="p">,</span><span class="w"> </span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">));</span>
</span><span class="hll"><span class="p">}</span>
</span>
<span class="c1">// Installs Security Object and adds and instance of it.</span>
<span class="c1">// An instance of Security Object provides information needed to connect to</span>
<span class="c1">// LwM2M server.</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">setup_security_object</span><span class="p">(</span><span class="n">anjay_t</span><span class="w"> </span><span class="o">*</span><span class="n">anjay</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">anjay_security_object_install</span><span class="p">(</span><span class="n">anjay</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">PSK_IDENTITY</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;identity&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">PSK_KEY</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;P4s$w0rd&quot;</span><span class="p">;</span>

<span class="w">    </span><span class="n">anjay_security_instance_t</span><span class="w"> </span><span class="n">security_instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">ssid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">server_uri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;coaps://eu.iot.avsystem.cloud:5684&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">security_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ANJAY_SECURITY_PSK</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">public_cert_or_psk_identity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">PSK_IDENTITY</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">public_cert_or_psk_identity_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">PSK_IDENTITY</span><span class="p">),</span>
<span class="w">        </span><span class="p">.</span><span class="n">private_cert_or_psk_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">PSK_KEY</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">private_cert_or_psk_key_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">PSK_KEY</span><span class="p">)</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// Anjay will assign Instance ID automatically</span>
<span class="w">    </span><span class="n">anjay_iid_t</span><span class="w"> </span><span class="n">security_instance_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ANJAY_ID_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">anjay_security_object_add_instance</span><span class="p">(</span><span class="n">anjay</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">security_instance</span><span class="p">,</span>
<span class="w">                                           </span><span class="o">&amp;</span><span class="n">security_instance_id</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// Installs Server Object and adds and instance of it.</span>
<span class="c1">// An instance of Server Object provides the data related to a LwM2M Server.</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">setup_server_object</span><span class="p">(</span><span class="n">anjay_t</span><span class="w"> </span><span class="o">*</span><span class="n">anjay</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">anjay_server_object_install</span><span class="p">(</span><span class="n">anjay</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">anjay_server_instance_t</span><span class="w"> </span><span class="n">server_instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Server Short ID</span>
<span class="w">        </span><span class="p">.</span><span class="n">ssid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">        </span><span class="c1">// Client will send Update message often than every 60 seconds</span>
<span class="w">        </span><span class="p">.</span><span class="n">lifetime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">60</span><span class="p">,</span>
<span class="w">        </span><span class="c1">// Disable Default Minimum Period resource</span>
<span class="w">        </span><span class="p">.</span><span class="n">default_min_period</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span>
<span class="w">        </span><span class="c1">// Disable Default Maximum Period resource</span>
<span class="w">        </span><span class="p">.</span><span class="n">default_max_period</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span>
<span class="w">        </span><span class="c1">// Disable Disable Timeout resource</span>
<span class="w">        </span><span class="p">.</span><span class="n">disable_timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span>
<span class="w">        </span><span class="c1">// Sets preferred transport to UDP</span>
<span class="w">        </span><span class="p">.</span><span class="n">binding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;U&quot;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// Anjay will assign Instance ID automatically</span>
<span class="w">    </span><span class="n">anjay_iid_t</span><span class="w"> </span><span class="n">server_instance_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ANJAY_ID_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">anjay_server_object_add_instance</span><span class="p">(</span><span class="n">anjay</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">server_instance</span><span class="p">,</span>
<span class="w">                                         </span><span class="o">&amp;</span><span class="n">server_instance_id</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">avs_log</span><span class="p">(</span><span class="n">tutorial</span><span class="p">,</span><span class="w"> </span><span class="n">ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;usage: %s ENDPOINT_NAME&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">anjay_configuration_t</span><span class="w"> </span><span class="n">CONFIG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">endpoint_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
<span class="w">        </span><span class="p">.</span><span class="n">in_buffer_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4000</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">out_buffer_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4000</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">msg_cache_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4000</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">anjay_t</span><span class="w"> </span><span class="o">*</span><span class="n">anjay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">anjay_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CONFIG</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">anjay</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">avs_log</span><span class="p">(</span><span class="n">tutorial</span><span class="p">,</span><span class="w"> </span><span class="n">ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Could not create Anjay object&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// Setup necessary objects</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">setup_security_object</span><span class="p">(</span><span class="n">anjay</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">setup_server_object</span><span class="p">(</span><span class="n">anjay</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">anjay_dm_object_def_t</span><span class="w"> </span><span class="o">**</span><span class="n">time_object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">time_object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time_object_create</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">time_object</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">anjay_register_object</span><span class="p">(</span><span class="n">anjay</span><span class="p">,</span><span class="w"> </span><span class="n">time_object</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="hll"><span class="w">        </span><span class="c1">// Run notify_job the first time;</span>
</span><span class="hll"><span class="w">        </span><span class="c1">// this will schedule periodic calls to itself via the scheduler</span>
</span><span class="hll"><span class="w">        </span><span class="n">notify_job</span><span class="p">(</span><span class="n">anjay_get_scheduler</span><span class="p">(</span><span class="n">anjay</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">notify_job_args_t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">                                                   </span><span class="p">.</span><span class="n">anjay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">anjay</span><span class="p">,</span>
</span><span class="hll"><span class="w">                                                   </span><span class="p">.</span><span class="n">time_object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time_object</span>
</span><span class="hll"><span class="w">                                               </span><span class="p">});</span>
</span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">anjay_event_loop_run</span><span class="p">(</span>
<span class="w">                </span><span class="n">anjay</span><span class="p">,</span><span class="w"> </span><span class="n">avs_time_duration_from_scalar</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">AVS_TIME_S</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">anjay_delete</span><span class="p">(</span><span class="n">anjay</span><span class="p">);</span>
<span class="w">    </span><span class="n">time_object_release</span><span class="p">(</span><span class="n">time_object</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<p>That’s all you need to make your client support LwM2M Observe/Notify operations!</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Complete code of this example can be found in
<cite>examples/tutorial/BC-Notifications</cite> subdirectory of main Anjay project
repository.</p>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="BC-ObjectImplementation.html" class="btn btn-neutral float-left" title="4.4. Implementing standard Object" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="BC-Send.html" class="btn btn-neutral float-right" title="4.6. Send method" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017-2024, AVSystem.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>