

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>4.5. Implementing standard Object &mdash; Anjay 2.4.2 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="4.6. Notifications support" href="BC6.html" />
    <link rel="prev" title="4.4. Enabling secure communication" href="BC4.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Anjay
          

          
          </a>

          
            
            
              <div class="version">
                2.4.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LwM2M.html">2. OMA LwM2M - Brief description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Compiling_client_applications.html">3. Compiling client applications</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../BasicClient.html">4. Basic client</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="BC1.html">4.1. Anjay initialization</a></li>
<li class="toctree-l2"><a class="reference internal" href="BC2.html">4.2. Installing mandatory Objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="BC3.html">4.3. Event loop</a></li>
<li class="toctree-l2"><a class="reference internal" href="BC4.html">4.4. Enabling secure communication</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">4.5. Implementing standard Object</a></li>
<li class="toctree-l2"><a class="reference internal" href="BC6.html">4.6. Notifications support</a></li>
<li class="toctree-l2"><a class="reference internal" href="BC7.html">4.7. A few notes on general usage</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../AdvancedTopics.html">5. Advanced topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FirmwareUpdateTutorial.html">6. Firmware Update Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Tools.html">7. Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PortingGuideForNonPOSIXPlatforms.html">8. Porting guide for non-POSIX platforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Migrating.html">9. Migrating from older versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Commercial_support.html">10. Commercial support</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Anjay</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../BasicClient.html"><span class="section-number">4. </span>Basic client</a> &raquo;</li>
        
      <li><span class="section-number">4.5. </span>Implementing standard Object</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/BasicClient/BC5.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="implementing-standard-object">
<h1><span class="section-number">4.5. </span>Implementing standard Object<a class="headerlink" href="#implementing-standard-object" title="Permalink to this headline">¶</a></h1>
<p>This section describes implementation of a standard Object defined in
<a class="reference external" href="https://www.openmobilealliance.org/wp/omna/lwm2m/lwm2mregistry.html">OMA LwM2M Registry</a>.
If you are interested in implementing your own Objects, please jump to
<a class="reference internal" href="../AdvancedTopics/AT-CustomObjects.html"><span class="doc">Custom LwM2M objects</span></a> section or prepare an Object definition
in XML on your own.</p>
<p>As an example, we are going to implement
<a class="reference external" href="https://www.openmobilealliance.org/tech/profiles/lwm2m/3333.xml">Time Object with ID 3333</a>.
It is one of the simplest Objects defined in OMA LwM2M Registry, which allows to
understand basics of operations on Objects.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For conformance with the LwM2M specification, the
<a class="reference external" href="https://www.openmobilealliance.org/tech/profiles/LWM2M_Device-v1_0_3.xml">Device Object</a>
must be implemented. We are implementing Time Object instead for simplicity,
because it contains less resources.</p>
</div>
<p>This objects contains definition of three resources. They are presented in the
table below with their most important attributes.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 4%" />
<col style="width: 11%" />
<col style="width: 7%" />
<col style="width: 7%" />
<col style="width: 5%" />
<col style="width: 66%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>ID</p></th>
<th class="head"><p>Name</p></th>
<th class="head"><p>Operations</p></th>
<th class="head"><p>Mandatory</p></th>
<th class="head"><p>Type</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>5506</p></td>
<td><p>Current Time</p></td>
<td><p>RW</p></td>
<td><p>Mandatory</p></td>
<td><p>Time</p></td>
<td><p>Unix Time. A signed integer representing the number of seconds since Jan 1st, 1970 in the UTC time zone.</p></td>
</tr>
<tr class="row-odd"><td><p>5507</p></td>
<td><p>Fractional Time</p></td>
<td><p>RW</p></td>
<td><p>Optional</p></td>
<td><p>Float</p></td>
<td><p>Fractional part of the time when sub-second precision is used (e.g., 0.23 for 230 ms).</p></td>
</tr>
<tr class="row-even"><td><p>5750</p></td>
<td><p>Application Type</p></td>
<td><p>RW</p></td>
<td><p>Optional</p></td>
<td><p>String</p></td>
<td><p>The application type of the sensor or actuator as a string depending on the use case.</p></td>
</tr>
</tbody>
</table>
<ul class="simple">
<li><p>ID - number used to identify the particular Resource. Different Objects may
use the same Resource IDs for different purposes.</p></li>
<li><p>Operations - RW indicates, that Resource is Readable and Writable.</p></li>
<li><p>Mandatory - not all Resources defined for standard object must be implemented
to be compliant with specification. In this case only the Current Time
resource is mandatory.</p></li>
</ul>
<p>Although Current Time and Fractional Time resources are writable, we will not
focus on setting system time and not implement this operation for these two
resources.</p>
<div class="section" id="implementing-the-object">
<h2><span class="section-number">4.5.1. </span>Implementing the Object<a class="headerlink" href="#implementing-the-object" title="Permalink to this headline">¶</a></h2>
<p><strong>Generating base source code</strong></p>
<p>To generate layout of Object’s implementation, we will use the <code class="docutils literal notranslate"><span class="pre">anjay_codegen.py</span></code>
script, which is bundled with Anjay library. Without going into details, which
are described in <a class="reference internal" href="../Tools.html"><span class="doc">Tools</span></a> section, we may just call
<code class="docutils literal notranslate"><span class="pre">./tools/lwm2m_object_registry.py</span> <span class="pre">--get-xml</span> <span class="pre">3333</span> <span class="pre">|</span> <span class="pre">./tools/anjay_codegen.py</span> <span class="pre">-i</span> <span class="pre">-</span> <span class="pre">-o</span> <span class="pre">time_object.c</span></code>
from the Anjay root directory. This command downloads Object’s definition from
OMA LwM2M registry and converts it to source code with a lot of TODOs. Now we
are going to replace them with actual code.</p>
<p><strong>Keeping Instance and Object state</strong></p>
<p>The actual data of a LwM2M Object sits in its Instances and Resources of that
Instance, so we must have at least one Instance to operate on some real data.</p>
<p>The state of our Time Object Instance will be placed in <code class="docutils literal notranslate"><span class="pre">time_instance_t</span></code>
struct. The only thing we must keep there is Instance ID (<cite>iid</cite>) and a value of
Application Type Resource, because for Current Time Resource we will be using a
system clock source directly, whenever a read handler is called</p>
<p>Note that there is also a second array for keeping backup of Application Type -
this will be required for implementation of transactions. We will back to it
at the end of this tutorial.</p>
<p>There is also the <code class="docutils literal notranslate"><span class="pre">time_object_t</span></code> structure, but we do not need to keep
anything related to the entire Time Object, so we can leave the default
implementation, which just keeps the Object definition and the list of its
instances.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">time_instance_struct</span> <span class="p">{</span>
    <span class="n">anjay_iid_t</span> <span class="n">iid</span><span class="p">;</span>
<span class="hll">    <span class="kt">char</span> <span class="n">application_type</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
</span><span class="hll">    <span class="kt">char</span> <span class="n">application_type_backup</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
</span><span class="p">}</span> <span class="n">time_instance_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">time_object_struct</span> <span class="p">{</span>
    <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="n">def</span><span class="p">;</span>
    <span class="n">AVS_LIST</span><span class="p">(</span><span class="n">time_instance_t</span><span class="p">)</span> <span class="n">instances</span><span class="p">;</span>
<span class="p">}</span> <span class="n">time_object_t</span><span class="p">;</span>
</pre></div>
</div>
<p><strong>Initializing, releasing and resetting the instance</strong></p>
<p>Next we have to implement <code class="docutils literal notranslate"><span class="pre">init_instance()</span></code> and <code class="docutils literal notranslate"><span class="pre">release_instance()</span></code>
functions. These functions are using during creation and deletion of instances,
performed by LwM2M Server for example.</p>
<p>In this case, all we have to do is to initialize Application Type with some
value. Since it is a C-string, it is enough to set the first byte to <code class="docutils literal notranslate"><span class="pre">\0</span></code>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">init_instance</span><span class="p">(</span><span class="n">time_instance_t</span> <span class="o">*</span><span class="n">inst</span><span class="p">,</span> <span class="n">anjay_iid_t</span> <span class="n">iid</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">iid</span> <span class="o">!=</span> <span class="n">ANJAY_ID_INVALID</span><span class="p">);</span>

    <span class="n">inst</span><span class="o">-&gt;</span><span class="n">iid</span> <span class="o">=</span> <span class="n">iid</span><span class="p">;</span>
<span class="hll">    <span class="n">inst</span><span class="o">-&gt;</span><span class="n">application_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If you decide to allocate the memory for the Application Type dynamically
instead of using fixed-size buffers, then it should be freed in
<code class="docutils literal notranslate"><span class="pre">release_instance()</span></code> function. In this case, <code class="docutils literal notranslate"><span class="pre">release_instance()</span></code> may do
nothing and the default implementation can be left.</p>
<p>The next function to implement is <code class="docutils literal notranslate"><span class="pre">instance_reset()</span></code>, which should reset
the Instance to its default state, which means the empty Application Type in our
case.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">instance_reset</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                          <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
                          <span class="n">anjay_iid_t</span> <span class="n">iid</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">anjay</span><span class="p">;</span>

    <span class="n">time_object_t</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">get_obj</span><span class="p">(</span><span class="n">obj_ptr</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
    <span class="n">time_instance_t</span> <span class="o">*</span><span class="n">inst</span> <span class="o">=</span> <span class="n">find_instance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">iid</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>

<span class="hll">    <span class="n">inst</span><span class="o">-&gt;</span><span class="n">application_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We can also disable the presence of one of the Resources in the
<code class="docutils literal notranslate"><span class="pre">list_resources()</span></code> function. It is done by changing
<code class="docutils literal notranslate"><span class="pre">ANJAY_DM_RES_PRESENT</span></code> to <code class="docutils literal notranslate"><span class="pre">ANJAY_DM_RES_ABSENT</span></code> in the
<code class="docutils literal notranslate"><span class="pre">anjay_dm_emit_res()</span></code> call. This change will simplify implementation of Read
handler and Observe/Notifications support in the next section.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">list_resources</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                          <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
                          <span class="n">anjay_iid_t</span> <span class="n">iid</span><span class="p">,</span>
                          <span class="n">anjay_dm_resource_list_ctx_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">anjay</span><span class="p">;</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">obj_ptr</span><span class="p">;</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">iid</span><span class="p">;</span>

    <span class="n">anjay_dm_emit_res</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">RID_CURRENT_TIME</span><span class="p">,</span> <span class="n">ANJAY_DM_RES_RW</span><span class="p">,</span>
                      <span class="n">ANJAY_DM_RES_PRESENT</span><span class="p">);</span>
<span class="hll">    <span class="n">anjay_dm_emit_res</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">RID_FRACTIONAL_TIME</span><span class="p">,</span> <span class="n">ANJAY_DM_RES_RW</span><span class="p">,</span>
</span><span class="hll">                      <span class="n">ANJAY_DM_RES_ABSENT</span><span class="p">);</span>
</span>    <span class="n">anjay_dm_emit_res</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">RID_APPLICATION_TYPE</span><span class="p">,</span> <span class="n">ANJAY_DM_RES_RW</span><span class="p">,</span>
                      <span class="n">ANJAY_DM_RES_PRESENT</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Using <code class="docutils literal notranslate"><span class="pre">-r</span></code> command line option in <code class="docutils literal notranslate"><span class="pre">anjay_codegen.py</span></code> you can generate
Object’s stub with specified Resources only.</p>
</div>
<p><strong>Read and Write handlers</strong></p>
<p>Now we are ready to implement <code class="docutils literal notranslate"><span class="pre">resource_read()</span></code> and <code class="docutils literal notranslate"><span class="pre">resource_write()</span></code>
handlers. These handlers will be called every time LwM2M Server performs Read
or Write operation.</p>
<p>We may use <code class="docutils literal notranslate"><span class="pre">avs_time_real_now()</span></code> to get the current time.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">resource_read</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                         <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
                         <span class="n">anjay_iid_t</span> <span class="n">iid</span><span class="p">,</span>
                         <span class="n">anjay_rid_t</span> <span class="n">rid</span><span class="p">,</span>
                         <span class="n">anjay_riid_t</span> <span class="n">riid</span><span class="p">,</span>
                         <span class="n">anjay_output_ctx_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">anjay</span><span class="p">;</span>

    <span class="n">time_object_t</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">get_obj</span><span class="p">(</span><span class="n">obj_ptr</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
    <span class="n">time_instance_t</span> <span class="o">*</span><span class="n">inst</span> <span class="o">=</span> <span class="n">find_instance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">iid</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">rid</span><span class="p">)</span> <span class="p">{</span>
<span class="hll">    <span class="k">case</span> <span class="nl">RID_CURRENT_TIME</span><span class="p">:</span> <span class="p">{</span>
</span><span class="hll">        <span class="n">assert</span><span class="p">(</span><span class="n">riid</span> <span class="o">==</span> <span class="n">ANJAY_ID_INVALID</span><span class="p">);</span>
</span><span class="hll">        <span class="kt">int64_t</span> <span class="n">timestamp</span><span class="p">;</span>
</span><span class="hll">        <span class="k">if</span> <span class="p">(</span><span class="n">avs_time_real_to_scalar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">AVS_TIME_S</span><span class="p">,</span>
</span><span class="hll">                                    <span class="n">avs_time_real_now</span><span class="p">()))</span> <span class="p">{</span>
</span><span class="hll">            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class="hll">        <span class="p">}</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">anjay_ret_i64</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">);</span>
</span><span class="hll">    <span class="p">}</span>
</span><span class="hll">
</span><span class="hll">    <span class="k">case</span> <span class="nl">RID_APPLICATION_TYPE</span><span class="p">:</span>
</span><span class="hll">        <span class="n">assert</span><span class="p">(</span><span class="n">riid</span> <span class="o">==</span> <span class="n">ANJAY_ID_INVALID</span><span class="p">);</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">anjay_ret_string</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">application_type</span><span class="p">);</span>
</span>
    <span class="k">default</span><span class="o">:</span>
        <span class="k">return</span> <span class="n">ANJAY_ERR_METHOD_NOT_ALLOWED</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As you remember, we do not want to set the system time, so Write operation is
allowed only on Application Type resource.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">resource_write</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                          <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
                          <span class="n">anjay_iid_t</span> <span class="n">iid</span><span class="p">,</span>
                          <span class="n">anjay_rid_t</span> <span class="n">rid</span><span class="p">,</span>
                          <span class="n">anjay_riid_t</span> <span class="n">riid</span><span class="p">,</span>
                          <span class="n">anjay_input_ctx_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">anjay</span><span class="p">;</span>

    <span class="n">time_object_t</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">get_obj</span><span class="p">(</span><span class="n">obj_ptr</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
    <span class="n">time_instance_t</span> <span class="o">*</span><span class="n">inst</span> <span class="o">=</span> <span class="n">find_instance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">iid</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">rid</span><span class="p">)</span> <span class="p">{</span>
<span class="hll">    <span class="k">case</span> <span class="nl">RID_APPLICATION_TYPE</span><span class="p">:</span>
</span><span class="hll">        <span class="n">assert</span><span class="p">(</span><span class="n">riid</span> <span class="o">==</span> <span class="n">ANJAY_ID_INVALID</span><span class="p">);</span>
</span><span class="hll">        <span class="k">return</span> <span class="n">anjay_get_string</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">application_type</span><span class="p">,</span>
</span><span class="hll">                                <span class="k">sizeof</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">application_type</span><span class="p">));</span>
</span>
    <span class="k">default</span><span class="o">:</span>
        <span class="k">return</span> <span class="n">ANJAY_ERR_METHOD_NOT_ALLOWED</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Initialization of the Object</strong></p>
<p>There is one function left to implement to have the basic functionality:
<code class="docutils literal notranslate"><span class="pre">time_object_create()</span></code>. By default, there is no Object Instance created, so no
data could be read unless LwM2M Server creates it. However, we are able to
add an Instance right now, by calling <code class="docutils literal notranslate"><span class="pre">add_instance()</span></code>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">**</span><span class="nf">time_object_create</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">time_object_t</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="p">(</span><span class="n">time_object_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">avs_calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">time_object_t</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">obj</span><span class="o">-&gt;</span><span class="n">def</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">OBJ_DEF</span><span class="p">;</span>

<span class="hll">    <span class="n">time_instance_t</span> <span class="o">*</span><span class="n">inst</span> <span class="o">=</span> <span class="n">add_instance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="n">inst</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">        <span class="n">strcpy</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">application_type</span><span class="p">,</span> <span class="s">&quot;Clock 0&quot;</span><span class="p">);</span>
</span><span class="hll">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class="hll">        <span class="n">avs_free</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
</span><span class="hll">        <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class="hll">    <span class="p">}</span>
</span>
    <span class="k">return</span> <span class="o">&amp;</span><span class="n">obj</span><span class="o">-&gt;</span><span class="n">def</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Since we do not allocate memory for anything else during object creation, we may
leave the default implementation of <code class="docutils literal notranslate"><span class="pre">time_object_release()</span></code>, which will remove
the created instance.</p>
<p id="registering-objects"><strong>Registering the Object in Anjay</strong></p>
<p>The last things to do is to create header file for implemented object, register
it in Anjay and update <code class="docutils literal notranslate"><span class="pre">CMakeLists.txt</span></code> file.</p>
<div class="literal-block-wrapper docutils container" id="id1">
<div class="code-block-caption"><span class="caption-text">time.h</span><a class="headerlink" href="#id1" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#ifndef TIME_OBJECT_H</span>
<span class="cp">#define TIME_OBJECT_H</span>

<span class="cp">#include</span> <span class="cpf">&lt;anjay/dm.h&gt;</span><span class="cp"></span>

<span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">**</span><span class="nf">time_object_create</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span> <span class="nf">time_object_release</span><span class="p">(</span><span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">**</span><span class="n">def</span><span class="p">);</span>

<span class="cp">#endif </span><span class="c1">// TIME_OBJECT_H</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">main.c</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">avs_log</span><span class="p">(</span><span class="n">tutorial</span><span class="p">,</span> <span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;usage: %s ENDPOINT_NAME&quot;</span><span class="p">,</span> <span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">const</span> <span class="n">anjay_configuration_t</span> <span class="n">CONFIG</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">endpoint_name</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
        <span class="p">.</span><span class="n">in_buffer_size</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">,</span>
        <span class="p">.</span><span class="n">out_buffer_size</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">,</span>
        <span class="p">.</span><span class="n">msg_cache_size</span> <span class="o">=</span> <span class="mi">4000</span>
    <span class="p">};</span>

    <span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span> <span class="o">=</span> <span class="n">anjay_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CONFIG</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">anjay</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">avs_log</span><span class="p">(</span><span class="n">tutorial</span><span class="p">,</span> <span class="n">ERROR</span><span class="p">,</span> <span class="s">&quot;Could not create Anjay object&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="c1">// Install Attribute storage and setup necessary objects</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">anjay_attr_storage_install</span><span class="p">(</span><span class="n">anjay</span><span class="p">)</span> <span class="o">||</span> <span class="n">setup_security_object</span><span class="p">(</span><span class="n">anjay</span><span class="p">)</span>
            <span class="o">||</span> <span class="n">setup_server_object</span><span class="p">(</span><span class="n">anjay</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

<span class="hll">    <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">**</span><span class="n">time_object</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span><span class="hll">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">        <span class="n">time_object</span> <span class="o">=</span> <span class="n">time_object_create</span><span class="p">();</span>
</span><span class="hll">        <span class="k">if</span> <span class="p">(</span><span class="n">time_object</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">            <span class="n">result</span> <span class="o">=</span> <span class="n">anjay_register_object</span><span class="p">(</span><span class="n">anjay</span><span class="p">,</span> <span class="n">time_object</span><span class="p">);</span>
</span><span class="hll">        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span><span class="hll">            <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
</span><span class="hll">        <span class="p">}</span>
</span><span class="hll">    <span class="p">}</span>
</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">main_loop</span><span class="p">(</span><span class="n">anjay</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="n">anjay_delete</span><span class="p">(</span><span class="n">anjay</span><span class="p">);</span>
<span class="hll">    <span class="n">time_object_release</span><span class="p">(</span><span class="n">time_object</span><span class="p">);</span>
</span>    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">CMakeLists.txt</span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span> <span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span> <span class="s">3.1</span><span class="p">)</span>
 <span class="nb">project</span><span class="p">(</span><span class="s">anjay-bc5</span> <span class="s">C</span><span class="p">)</span>

 <span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_C_STANDARD</span> <span class="s">99</span><span class="p">)</span>
 <span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_C_EXTENSIONS</span> <span class="s">OFF</span><span class="p">)</span>

 <span class="nb">find_package</span><span class="p">(</span><span class="s">anjay</span> <span class="s">REQUIRED</span><span class="p">)</span>

 <span class="nb">add_executable</span><span class="p">(</span><span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span>
                <span class="s">src/main.c</span>
<span class="hll">                <span class="s">src/time_object.h</span>
</span><span class="hll">                <span class="s">src/time_object.c</span><span class="p">)</span>
</span> <span class="nb">target_link_libraries</span><span class="p">(</span><span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span> <span class="s">PRIVATE</span> <span class="s">anjay</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now the client is ready to be built and connected to LwM2M Server, allowing it
to read the Time object.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Custom objects are not automatically managed by Anjay. Remember to release
created object <strong>after</strong> deleting the Anjay object.</p>
</div>
</div>
<div class="section" id="supporting-transactional-writes">
<h2><span class="section-number">4.5.2. </span>Supporting transactional writes<a class="headerlink" href="#supporting-transactional-writes" title="Permalink to this headline">¶</a></h2>
<p>Consider the following scenario: LwM2M Server tries to write to two or more
resources at once. The write on Application Type will probably succeed, but we
are sure, that in this case write on the Current Time will fail. Without
supporting transactions, the entire Write operation will fail, but the
Application Type resource will be changed.</p>
<p>By default, transaction handlers are set to <code class="docutils literal notranslate"><span class="pre">anjay_dm_transaction_NOOP</span></code>
and do nothing. To properly support Writes on the object implemented in this
tutorial, it is enough to implement only two handlers: <code class="docutils literal notranslate"><span class="pre">transaction_begin</span></code>,
which makes a backup of Application Type value and <code class="docutils literal notranslate"><span class="pre">transaction_rollback</span></code>,
which reverts Application Type to its initial value (before Write is performed).
This is why we need <code class="docutils literal notranslate"><span class="pre">application_type_backup</span></code> array.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="kt">int</span> <span class="nf">transaction_begin</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
</span><span class="hll">                      <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">anjay</span><span class="p">;</span>
</span><span class="hll">
</span><span class="hll">    <span class="n">time_object_t</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">get_obj</span><span class="p">(</span><span class="n">obj_ptr</span><span class="p">);</span>
</span><span class="hll">
</span><span class="hll">    <span class="n">time_instance_t</span> <span class="o">*</span><span class="n">element</span><span class="p">;</span>
</span><span class="hll">    <span class="n">AVS_LIST_FOREACH</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">instances</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">        <span class="n">strcpy</span><span class="p">(</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">application_type_backup</span><span class="p">,</span> <span class="n">element</span><span class="o">-&gt;</span><span class="n">application_type</span><span class="p">);</span>
</span><span class="hll">    <span class="p">}</span>
</span><span class="hll"><span class="p">}</span>
</span><span class="hll">
</span><span class="hll"><span class="kt">int</span> <span class="nf">transaction_rollback</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
</span><span class="hll">                         <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">anjay</span><span class="p">;</span>
</span><span class="hll">
</span><span class="hll">    <span class="n">time_object_t</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">get_obj</span><span class="p">(</span><span class="n">obj_ptr</span><span class="p">);</span>
</span><span class="hll">
</span><span class="hll">    <span class="n">time_instance_t</span> <span class="o">*</span><span class="n">element</span><span class="p">;</span>
</span><span class="hll">    <span class="n">AVS_LIST_FOREACH</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">obj</span><span class="o">-&gt;</span><span class="n">instances</span><span class="p">)</span> <span class="p">{</span>
</span><span class="hll">        <span class="n">strcpy</span><span class="p">(</span><span class="n">element</span><span class="o">-&gt;</span><span class="n">application_type</span><span class="p">,</span> <span class="n">element</span><span class="o">-&gt;</span><span class="n">application_type_backup</span><span class="p">);</span>
</span><span class="hll">    <span class="p">}</span>
</span><span class="hll"><span class="p">}</span>
</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="n">OBJ_DEF</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">.</span><span class="n">oid</span> <span class="o">=</span> <span class="mi">3333</span><span class="p">,</span>
    <span class="p">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">list_instances</span> <span class="o">=</span> <span class="n">list_instances</span><span class="p">,</span>
        <span class="p">.</span><span class="n">instance_create</span> <span class="o">=</span> <span class="n">instance_create</span><span class="p">,</span>
        <span class="p">.</span><span class="n">instance_remove</span> <span class="o">=</span> <span class="n">instance_remove</span><span class="p">,</span>
        <span class="p">.</span><span class="n">instance_reset</span> <span class="o">=</span> <span class="n">instance_reset</span><span class="p">,</span>

        <span class="p">.</span><span class="n">list_resources</span> <span class="o">=</span> <span class="n">list_resources</span><span class="p">,</span>
        <span class="p">.</span><span class="n">resource_read</span> <span class="o">=</span> <span class="n">resource_read</span><span class="p">,</span>
        <span class="p">.</span><span class="n">resource_write</span> <span class="o">=</span> <span class="n">resource_write</span><span class="p">,</span>

<span class="hll">        <span class="p">.</span><span class="n">transaction_begin</span> <span class="o">=</span> <span class="n">transaction_begin</span><span class="p">,</span>
</span>        <span class="p">.</span><span class="n">transaction_validate</span> <span class="o">=</span> <span class="n">anjay_dm_transaction_NOOP</span><span class="p">,</span>
        <span class="p">.</span><span class="n">transaction_commit</span> <span class="o">=</span> <span class="n">anjay_dm_transaction_NOOP</span><span class="p">,</span>
<span class="hll">        <span class="p">.</span><span class="n">transaction_rollback</span> <span class="o">=</span> <span class="n">transaction_rollback</span>
</span>    <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="BC6.html" class="btn btn-neutral float-right" title="4.6. Notifications support" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="BC4.html" class="btn btn-neutral float-left" title="4.4. Enabling secure communication" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2020, AVSystem

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>