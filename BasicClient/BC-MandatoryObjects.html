<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4.2. Installing mandatory Objects &mdash; Anjay 3.6.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="4.3. Enabling secure communication" href="BC-Security.html" />
    <link rel="prev" title="4.1. Anjay initialization" href="BC-Initialization.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #ffd500" >
            <a href="../index.html">
            <img src="../_static/avsystem_header.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                3.6.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LwM2M.html">2. OMA LwM2M - Brief description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Compiling_client_applications.html">3. Compiling client applications</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../BasicClient.html">4. Basic client</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="BC-Initialization.html">4.1. Anjay initialization</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">4.2. Installing mandatory Objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="BC-Security.html">4.3. Enabling secure communication</a></li>
<li class="toctree-l2"><a class="reference internal" href="BC-ObjectImplementation.html">4.4. Implementing standard Object</a></li>
<li class="toctree-l2"><a class="reference internal" href="BC-Notifications.html">4.5. Notifications support</a></li>
<li class="toctree-l2"><a class="reference internal" href="BC-Send.html">4.6. Send method</a></li>
<li class="toctree-l2"><a class="reference internal" href="BC-ThreadSafety.html">4.7. Thread safety in Anjay</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../AdvancedTopics.html">5. Advanced topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FirmwareUpdateTutorial.html">6. Firmware Update Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Tools.html">7. Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PortingGuideForNonPOSIXPlatforms.html">8. Porting guide for non-POSIX platforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Migrating.html">9. Migrating from older versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../CommercialFeatures.html">10. Commercial features</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #ffd500" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Anjay</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../BasicClient.html"><span class="section-number">4. </span>Basic client</a> &raquo;</li>
      <li><span class="section-number">4.2. </span>Installing mandatory Objects</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="installing-mandatory-objects">
<h1><span class="section-number">4.2. </span>Installing mandatory Objects<a class="headerlink" href="#installing-mandatory-objects" title="Permalink to this headline"></a></h1>
<p>In order to be able to connect to some LwM2M Server and handle incoming
packets our client has to have at least <a class="reference external" href="https://www.openmobilealliance.org/tech/profiles/LWM2M_Security-v1_0.xml">LwM2M Security</a>
(<code class="docutils literal notranslate"><span class="pre">/0</span></code>) and <a class="reference external" href="https://www.openmobilealliance.org/tech/profiles/LWM2M_Server-v1_0.xml">LwM2M Server</a>
(<code class="docutils literal notranslate"><span class="pre">/1</span></code>) Objects implemented.</p>
<p>Fortunately, Anjay provides both of these Objects in the form of pre-implemented
modules, and they can be used easily.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It doesn’t impact on Anjay flexibility – i.e., users can still provide
their own implementation of these Objects if necessary.</p>
</div>
<p>When Anjay is first instantiated (as in our previous <a class="reference internal" href="BC-Initialization.html#anjay-hello-world"><span class="std std-ref">hello world</span></a> example), it has no knowledge about the Data Model,
i.e., no LwM2M Objects are registered within it. Security and Server objects can
be registered using installation mechanism, presented in the next subsection.</p>
<section id="installing-objects">
<h2><span class="section-number">4.2.1. </span>Installing Objects<a class="headerlink" href="#installing-objects" title="Permalink to this headline"></a></h2>
<p>Each LwM2M Object is defined by an instance of the <code class="docutils literal notranslate"><span class="pre">anjay_dm_object_def_t</span></code>
structure. To add support for a new Object, you’d need to:</p>
<blockquote>
<div><ul class="simple">
<li><p>fill the <code class="docutils literal notranslate"><span class="pre">anjay_dm_object_def_t</span></code> structure,</p></li>
<li><p>implement appropriate callback functions,</p></li>
<li><p>register created object in Anjay.</p></li>
</ul>
</div></blockquote>
<p>However, for now, we are going to install our pre-implemented LwM2M Objects
(Security, Server), so that you don’t have to worry about initializing the
structure and object registration on your own. In case you are interested in
this topic, <a class="reference internal" href="BC-ObjectImplementation.html"><span class="doc">Implementing standard Object</span></a> section provides more information on
this subject.</p>
<p>To install the Objects we are going to use <code class="docutils literal notranslate"><span class="pre">anjay_security_object_install()</span></code>
and <code class="docutils literal notranslate"><span class="pre">anjay_server_object_install()</span></code> functions.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Remember to include <code class="docutils literal notranslate"><span class="pre">anjay/security.h</span></code> and <code class="docutils literal notranslate"><span class="pre">anjay/server.h</span></code> headers to
use the functions mentioned above.</p>
</div>
</section>
<section id="setting-up-server-and-security-objects">
<h2><span class="section-number">4.2.2. </span>Setting up Server and Security Objects<a class="headerlink" href="#setting-up-server-and-security-objects" title="Permalink to this headline"></a></h2>
<p>Now we are going to create functions which install Server and Security Objects
and add instances of them. We modify the code from the
<a class="reference internal" href="BC-Initialization.html#anjay-hello-world"><span class="std std-ref">previous tutorial</span></a>.</p>
<p>The first one will be <code class="docutils literal notranslate"><span class="pre">setup_security_object()</span></code>. In this tutorial, we will use
the Coiote IoT Device Management platform as the hard-coded server URI. You can
go to <a class="reference external" href="https://www.avsystem.com/products/coiote-iot-device-management-platform/">https://www.avsystem.com/products/coiote-iot-device-management-platform/</a>
to create an account, and after logging in, add the device entry for your
application. If you wish to use another server, then you must replace
<code class="docutils literal notranslate"><span class="pre">coap://eu.iot.avsystem.cloud:5683</span></code> with a valid value.</p>
<p>For now, we will establish non-secure connection, a secure one will be described
later.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// Installs Security Object and adds and instance of it.</span>
<span class="c1">// An instance of Security Object provides information needed to connect to</span>
<span class="c1">// LwM2M server.</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">setup_security_object</span><span class="p">(</span><span class="n">anjay_t</span><span class="w"> </span><span class="o">*</span><span class="n">anjay</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">anjay_security_object_install</span><span class="p">(</span><span class="n">anjay</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">anjay_security_instance_t</span><span class="w"> </span><span class="n">security_instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">ssid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">server_uri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;coap://eu.iot.avsystem.cloud:5683&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">security_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ANJAY_SECURITY_NOSEC</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// Anjay will assign Instance ID automatically</span>
<span class="w">    </span><span class="n">anjay_iid_t</span><span class="w"> </span><span class="n">security_instance_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ANJAY_ID_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">anjay_security_object_add_instance</span><span class="p">(</span><span class="n">anjay</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">security_instance</span><span class="p">,</span>
<span class="w">                                           </span><span class="o">&amp;</span><span class="n">security_instance_id</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Both Security and Server instances are linked together by the Short Server ID
Resource (<code class="docutils literal notranslate"><span class="pre">ssid</span></code>). That is why we keep SSID matched in both
<code class="docutils literal notranslate"><span class="pre">setup_server_object()</span></code> and <code class="docutils literal notranslate"><span class="pre">setup_security_object()</span></code>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// Installs Server Object and adds and instance of it.</span>
<span class="c1">// An instance of Server Object provides the data related to a LwM2M Server.</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">setup_server_object</span><span class="p">(</span><span class="n">anjay_t</span><span class="w"> </span><span class="o">*</span><span class="n">anjay</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">anjay_server_object_install</span><span class="p">(</span><span class="n">anjay</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">anjay_server_instance_t</span><span class="w"> </span><span class="n">server_instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// Server Short ID</span>
<span class="w">        </span><span class="p">.</span><span class="n">ssid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">        </span><span class="c1">// Client will send Update message often than every 60 seconds</span>
<span class="w">        </span><span class="p">.</span><span class="n">lifetime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">60</span><span class="p">,</span>
<span class="w">        </span><span class="c1">// Disable Default Minimum Period resource</span>
<span class="w">        </span><span class="p">.</span><span class="n">default_min_period</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span>
<span class="w">        </span><span class="c1">// Disable Default Maximum Period resource</span>
<span class="w">        </span><span class="p">.</span><span class="n">default_max_period</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span>
<span class="w">        </span><span class="c1">// Disable Disable Timeout resource</span>
<span class="w">        </span><span class="p">.</span><span class="n">disable_timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span>
<span class="w">        </span><span class="c1">// Sets preferred transport to UDP</span>
<span class="w">        </span><span class="p">.</span><span class="n">binding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;U&quot;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// Anjay will assign Instance ID automatically</span>
<span class="w">    </span><span class="n">anjay_iid_t</span><span class="w"> </span><span class="n">server_instance_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ANJAY_ID_INVALID</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">anjay_server_object_add_instance</span><span class="p">(</span><span class="n">anjay</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">server_instance</span><span class="p">,</span>
<span class="w">                                         </span><span class="o">&amp;</span><span class="n">server_instance_id</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now we are ready to call these functions from <code class="docutils literal notranslate"><span class="pre">main()</span></code>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">avs_log</span><span class="p">(</span><span class="n">tutorial</span><span class="p">,</span><span class="w"> </span><span class="n">ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;usage: %s ENDPOINT_NAME&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">anjay_configuration_t</span><span class="w"> </span><span class="n">CONFIG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">endpoint_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
<span class="w">        </span><span class="p">.</span><span class="n">in_buffer_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4000</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">out_buffer_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4000</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">msg_cache_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4000</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">anjay_t</span><span class="w"> </span><span class="o">*</span><span class="n">anjay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">anjay_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CONFIG</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">anjay</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">avs_log</span><span class="p">(</span><span class="n">tutorial</span><span class="p">,</span><span class="w"> </span><span class="n">ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Could not create Anjay object&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="hll"><span class="w">    </span><span class="c1">// Setup necessary objects</span>
</span><span class="hll"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">setup_security_object</span><span class="p">(</span><span class="n">anjay</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">setup_server_object</span><span class="p">(</span><span class="n">anjay</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
</span><span class="hll"><span class="w">    </span><span class="p">}</span>
</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">anjay_event_loop_run</span><span class="p">(</span>
<span class="w">                </span><span class="n">anjay</span><span class="p">,</span><span class="w"> </span><span class="n">avs_time_duration_from_scalar</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">AVS_TIME_S</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">anjay_delete</span><span class="p">(</span><span class="n">anjay</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">anjay_delete()</span></code> will automatically delete installed modules after
destruction of Anjay instance.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Complete code of this example can be found in
<cite>examples/tutorial/BC-MandatoryObjects</cite> subdirectory of main Anjay project
repository.</p>
</div>
<p>After running the client, you should see <code class="docutils literal notranslate"><span class="pre">registration</span> <span class="pre">successful,</span> <span class="pre">location</span> <span class="pre">=</span>
<span class="pre">/rd/&lt;server-dependent</span> <span class="pre">identifier&gt;</span></code> once and <code class="docutils literal notranslate"><span class="pre">registration</span> <span class="pre">successfully</span>
<span class="pre">updated</span></code> every 30 seconds in logs. It means, that the client has connected to
the server and successfully sends Update messages. Now you can perform some
Reads for example from the LwM2M Server side.</p>
</section>
<section id="application-events">
<h2><span class="section-number">4.2.3. </span>Application events<a class="headerlink" href="#application-events" title="Permalink to this headline"></a></h2>
<p>The code above handles all events that may happen within the Anjay library
itself. Of course, the application usually needs to handle its own
functionality. Some ways to do this will be handled later in the
<a class="reference internal" href="BC-Notifications.html"><span class="doc">Notifications support</span></a> tutorial.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="BC-Initialization.html" class="btn btn-neutral float-left" title="4.1. Anjay initialization" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="BC-Security.html" class="btn btn-neutral float-right" title="4.3. Enabling secure communication" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017-2023, AVSystem.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>