

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>8. Porting guide for non-POSIX platforms &mdash; Anjay 2.4.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="9. Migrating from older versions" href="Migrating.html" />
    <link rel="prev" title="7. Tools" href="Tools.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Anjay
          

          
          </a>

          
            
            
              <div class="version">
                2.4.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="Introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="LwM2M.html">2. OMA LwM2M - Brief description</a></li>
<li class="toctree-l1"><a class="reference internal" href="Compiling_client_applications.html">3. Compiling client applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="BasicClient.html">4. Basic client</a></li>
<li class="toctree-l1"><a class="reference internal" href="AdvancedTopics.html">5. Advanced topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="FirmwareUpdateTutorial.html">6. Firmware Update Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="Tools.html">7. Tools</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">8. Porting guide for non-POSIX platforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="Migrating.html">9. Migrating from older versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="Commercial_support.html">10. Commercial support</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Anjay</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html">Docs</a> &raquo;</li>
        
      <li>8. Porting guide for non-POSIX platforms</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/PortingGuideForNonPOSIXPlatforms.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="porting-guide-for-non-posix-platforms">
<h1>8. Porting guide for non-POSIX platforms<a class="headerlink" href="#porting-guide-for-non-posix-platforms" title="Permalink to this headline">¶</a></h1>
<p>By default, Anjay makes use of POSIX-specific interfaces for retrieving time
and handling network traffic. If no such interfaces are provided by the
toolchain, the user needs to provide custom implementations.</p>
<div class="section" id="time-api">
<h2>8.1. Time API<a class="headerlink" href="#time-api" title="Permalink to this headline">¶</a></h2>
<p>If POSIX <code class="docutils literal notranslate"><span class="pre">clock_gettime</span></code> function is not available:</p>
<ul class="simple">
<li>Use <code class="docutils literal notranslate"><span class="pre">WITH_POSIX_AVS_TIME=OFF</span></code> when running CMake on Anjay,</li>
<li>Provide an implementation for:<ul>
<li><code class="docutils literal notranslate"><span class="pre">avs_time_real_now</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">avs_time_monotonic_now</span></code></li>
</ul>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For signatures and detailed description of listed functions, see
<a class="reference external" href="https://github.com/AVSystem/avs_commons/blob/master/include_public/avsystem/commons/avs_time.h">avs_time.h</a></p>
</div>
</div>
<div class="section" id="networking-api">
<h2>8.2. Networking API<a class="headerlink" href="#networking-api" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>If LwIP 2.0 is used as a network stack, you may set:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">-DWITH_POSIX_AVS_SOCKET=ON</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">-DWITH_IPV6=OFF</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">-DPOSIX_COMPAT_HEADER=deps/avs_commons/compat/lwip-posix-compat.h</span></code></li>
</ul>
</div></blockquote>
<p class="last">CMake options for an out-of-the-box socket compatibility layer implementation.</p>
</div>
<p>If POSIX socket API is not available:</p>
<ul>
<li><p class="first">Use <code class="docutils literal notranslate"><span class="pre">WITH_POSIX_AVS_SOCKET=OFF</span></code> when running CMake on Anjay,</p>
</li>
<li><p class="first">Provide an implementation for:</p>
<ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">_avs_net_create_udp_socket</span></code> - a function with following signature:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">avs_error_t</span> <span class="nf">_avs_net_create_udp_socket</span><span class="p">(</span><span class="n">avs_net_socket_t</span> <span class="o">**</span><span class="n">socket</span><span class="p">,</span>
                                       <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">socket_configuration</span><span class="p">);</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">socket_configuration</span></code> argument is a pointer to
<code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">avs_net_socket_configuration_t</span></code> struct cast to <code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">*</span></code>.</p>
<p>The function should return <code class="docutils literal notranslate"><span class="pre">AVS_OK</span></code> on success and an error code on error.
It should create a socket object, and return its pointer cast to
<code class="docutils literal notranslate"><span class="pre">avs_net_socket_t</span> <span class="pre">*</span></code> through the <code class="docutils literal notranslate"><span class="pre">*socket</span></code> argument. The socket object
should be a struct, whose first field is <code class="docutils literal notranslate"><span class="pre">avs_net_socket_v_table_t</span> <span class="pre">*</span></code>
filled with pointers to method handlers.</p>
<p>Minimal set of socket methods that have to be implemented:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">bind</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">cleanup</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">close</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">connect</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">create</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">get_local_port</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">get_opt</span></code> able to read following options:<ul>
<li><code class="docutils literal notranslate"><span class="pre">AVS_NET_SOCKET_OPT_STATE</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">AVS_NET_SOCKET_OPT_MTU</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">AVS_NET_SOCKET_OPT_INNER_MTU</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">AVS_NET_SOCKET_OPT_RECV_TIMEOUT</span></code></li>
</ul>
</li>
<li><code class="docutils literal notranslate"><span class="pre">get_remote_host</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">get_remote_hostname</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">get_remote_port</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">get_system</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">receive</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">send</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">set_opt</span></code> able to set the <code class="docutils literal notranslate"><span class="pre">AVS_NET_SOCKET_OPT_RECV_TIMEOUT</span></code> option</li>
</ul>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">_avs_net_create_tcp_socket</span></code> - only required if the <code class="docutils literal notranslate"><span class="pre">fw_update</span></code> module
should support HTTP/HTTPS transfers. Otherwise, can be safely implemented as
<code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">avs_errno(AVS_ENOTSUP);</span></code>.</p>
<p>Function signature:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">avs_error_t</span> <span class="nf">_avs_net_create_tcp_socket</span><span class="p">(</span><span class="n">avs_net_socket_t</span> <span class="o">**</span><span class="n">socket</span><span class="p">,</span>
                                       <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">socket_configuration</span><span class="p">);</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">socket_configuration</span></code> argument is a pointer to
<code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">avs_net_socket_configuration_t</span></code> struct cast to <code class="docutils literal notranslate"><span class="pre">void</span> <span class="pre">*</span></code>.</p>
<p>The function should return <code class="docutils literal notranslate"><span class="pre">AVS_OK</span></code> on success and an error code on error.
It should create a socket object, and return its pointer cast to
<code class="docutils literal notranslate"><span class="pre">avs_net_socket_t</span> <span class="pre">*</span></code> through the <code class="docutils literal notranslate"><span class="pre">*socket</span></code> argument. The socket object
should be a struct, whose first field is <code class="docutils literal notranslate"><span class="pre">avs_net_socket_v_table_t</span> <span class="pre">*</span></code>
filled with pointers to method handlers.</p>
<p>Minimal set of socket methods that have to be implemented:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">cleanup</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">close</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">connect</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">create</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">receive</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">send</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">set_opt</span></code> able to set the <code class="docutils literal notranslate"><span class="pre">AVS_NET_SOCKET_OPT_RECV_TIMEOUT</span></code> option</li>
<li><code class="docutils literal notranslate"><span class="pre">shutdown</span></code></li>
</ul>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">_avs_net_initialize_global_compat_state</span></code> - a function with following
signature:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">avs_error_t</span> <span class="nf">_avs_net_initialize_global_compat_state</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</pre></div>
</div>
<p>The function should return <code class="docutils literal notranslate"><span class="pre">AVS_OK</span></code> on success and an error code on error.
It should initialize any global state that needs to be kept by the network
stack. If there is no such global state or it is initialized elsewhere, it
is safe to implement this function as a no-op (<code class="docutils literal notranslate"><span class="pre">return</span> <span class="pre">AVS_OK;</span></code>).</p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">_avs_net_cleanup_global_compat_state</span></code> - a function with following
signature:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">_avs_net_cleanup_global_compat_state</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</pre></div>
</div>
<p>The function should clean up any global state that is kept by the network
stack. If there is no such global state or it is managed elsewhere, it is
safe to implement this function as a no-op.</p>
</li>
</ul>
</li>
</ul>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Anjay may attempt to call socket methods other than listed above, even
though they are not essential for correct operation of the application.
Make sure that all members of <code class="docutils literal notranslate"><span class="pre">avs_net_socket_v_table_t</span></code> are not NULL
- if required, provide a stub that always fails.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For signatures and detailed description of listed methods, see
<a class="reference external" href="https://github.com/AVSystem/avs_commons/blob/master/include_public/avsystem/commons/avs_net.h">avs_net.h</a></p>
</div>
</div>
<div class="section" id="threading-api">
<h2>8.3. Threading API<a class="headerlink" href="#threading-api" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">avs_net</span></code> and <code class="docutils literal notranslate"><span class="pre">avs_log</span></code> modules require threading primitives
to operate reliably in multi-threaded environments, specifically:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">avs_net</span></code> requires <code class="docutils literal notranslate"><span class="pre">avs_init_once()</span></code>,</li>
<li><code class="docutils literal notranslate"><span class="pre">avs_log</span></code> requires <code class="docutils literal notranslate"><span class="pre">avs_mutex_create()</span></code>, <code class="docutils literal notranslate"><span class="pre">avs_mutex_cleanup()</span></code>,
<code class="docutils literal notranslate"><span class="pre">avs_mutex_lock()</span></code>, <code class="docutils literal notranslate"><span class="pre">avs_mutex_unlock()</span></code>, and
<code class="docutils literal notranslate"><span class="pre">avs_init_once()</span></code>.</li>
</ul>
<p>In addition, <code class="docutils literal notranslate"><span class="pre">avs_sched</span></code> optionally depends on <code class="docutils literal notranslate"><span class="pre">avs_condvar_create()</span></code>,
<code class="docutils literal notranslate"><span class="pre">avs_condvar_cleanup()</span></code>, <code class="docutils literal notranslate"><span class="pre">avs_condvar_notify_all()</span></code> as well as
<code class="docutils literal notranslate"><span class="pre">avs_mutex_*</span></code> APIs. The dependency can be controlled with
<code class="docutils literal notranslate"><span class="pre">WITH_SCHEDULER_THREAD_SAFE</span></code> CMake option.</p>
<p>There are two independent implementations of the threading API for compatibility
with most platforms:</p>
<ul class="simple">
<li>based on <a class="reference external" href="https://en.wikipedia.org/wiki/POSIX_Threads">pthreads</a>,</li>
<li>based on C11 atomic operations.</li>
</ul>
<p>If, for some reason none of the defaults is suitable:</p>
<ul class="simple">
<li>Use <code class="docutils literal notranslate"><span class="pre">WITH_CUSTOM_AVS_THREADING=ON</span></code> when running CMake on Anjay,</li>
<li>Provide an implementation of:<ul>
<li><code class="docutils literal notranslate"><span class="pre">avs_mutex_create()</span></code>,</li>
<li><code class="docutils literal notranslate"><span class="pre">avs_mutex_cleanup()</span></code>,</li>
<li><code class="docutils literal notranslate"><span class="pre">avs_init_once()</span></code>,</li>
<li><code class="docutils literal notranslate"><span class="pre">avs_mutex_lock()</span></code>,</li>
<li><code class="docutils literal notranslate"><span class="pre">avs_mutex_unlock()</span></code>.</li>
</ul>
</li>
<li>And if you use thread-safe scheduler, also provide implementation for:<ul>
<li><code class="docutils literal notranslate"><span class="pre">avs_condvar_create()</span></code>,</li>
<li><code class="docutils literal notranslate"><span class="pre">avs_condvar_cleanup()</span></code>,</li>
<li><code class="docutils literal notranslate"><span class="pre">avs_condvar_notify_all()</span></code>.</li>
</ul>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>For signatures and detailed description of listed functions, see</p>
<ul class="last simple">
<li><a class="reference external" href="https://github.com/AVSystem/avs_commons/blob/master/include_public/avsystem/commons/avs_mutex.h">avs_mutex.h</a></li>
<li><a class="reference external" href="https://github.com/AVSystem/avs_commons/blob/master/include_public/avsystem/commons/avs_init_once.h">avs_init_once.h</a></li>
<li><a class="reference external" href="https://github.com/AVSystem/avs_commons/blob/master/include_public/avsystem/commons/avs_condvar.h">avs_condvar.h</a></li>
</ul>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you intend to operate the library in a single-threaded fashion, you may
provide no-op stubs (returning success) of all mentioned primitives.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="Migrating.html" class="btn btn-neutral float-right" title="9. Migrating from older versions" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="Tools.html" class="btn btn-neutral float-left" title="7. Tools" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017-2020, AVSystem

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>