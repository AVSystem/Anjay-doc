<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>5.4.4. Multi-instance writable object with fixed number of instances &mdash; Anjay 3.8.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/theme_overrides.css?v=b9c2c5b9" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=948f11bf"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="5.4.5. Multi-instance writable object with dynamic number of instances" href="AT_CO_MultiInstanceDynamic.html" />
    <link rel="prev" title="5.4.3. Multi-instance read-only object with fixed number of instances" href="AT_CO_MultiInstanceReadOnlyFixed.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #ffd500" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/avsystem_header.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                3.8.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../Introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LwM2M.html">2. OMA LwM2M - Brief description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Compiling_client_applications.html">3. Compiling client applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../BasicClient.html">4. Basic client</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../AdvancedTopics.html">5. Advanced topics</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../AT-AccessControl.html">5.1. Access Control in multi-server environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../AT-AttributeStorage.html">5.2. Attribute storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../AT-Certificates.html">5.3. DTLS connection using certificates</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../AT-CustomObjects.html">5.4. Custom LwM2M objects</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="AT_CO_SingleInstanceReadOnly.html">5.4.1. Single-instance read-only object</a></li>
<li class="toctree-l3"><a class="reference internal" href="AT_CO_SingleInstanceExecutableAndReadOnly.html">5.4.2. Single-instance read-only object with an executable resource</a></li>
<li class="toctree-l3"><a class="reference internal" href="AT_CO_MultiInstanceReadOnlyFixed.html">5.4.3. Multi-instance read-only object with fixed number of instances</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">5.4.4. Multi-instance writable object with fixed number of instances</a></li>
<li class="toctree-l3"><a class="reference internal" href="AT_CO_MultiInstanceDynamic.html">5.4.5. Multi-instance writable object with dynamic number of instances</a></li>
<li class="toctree-l3"><a class="reference internal" href="AT_CO_MultipleResourceInstances.html">5.4.6. Objects with Multiple Instance Resources</a></li>
<li class="toctree-l3"><a class="reference internal" href="AT_CO_BootstrapAwareness.html">5.4.7. Bootstrap awareness</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../AT-NetworkErrorHandling.html">5.5. Network error handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../AT-OtherFeatures.html">5.6. Other library features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../AT-Persistence.html">5.7. Persistence support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../AT-RetransmissionsTimeoutsCaching.html">5.8. Retransmissions, timeouts &amp; response caching</a></li>
<li class="toctree-l2"><a class="reference internal" href="../AT-CustomEventLoop.html">5.9. Custom event loop</a></li>
<li class="toctree-l2"><a class="reference internal" href="../AT-EventLoopNotes.html">5.10. Notes on event loop APIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../AT-IpsoObjects.html">5.11. IPSO objects implementation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../FirmwareUpdateTutorial.html">6. Firmware Update Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tools.html">7. Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PortingGuideForNonPOSIXPlatforms.html">8. Porting guide for non-POSIX platforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Migrating.html">9. Migrating from older versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CommercialFeatures.html">10. Commercial features</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #ffd500" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Anjay</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../AdvancedTopics.html"><span class="section-number">5. </span>Advanced topics</a></li>
          <li class="breadcrumb-item"><a href="../AT-CustomObjects.html"><span class="section-number">5.4. </span>Custom LwM2M objects</a></li>
      <li class="breadcrumb-item active"><span class="section-number">5.4.4. </span>Multi-instance writable object with fixed number of instances</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="multi-instance-writable-object-with-fixed-number-of-instances">
<h1><span class="section-number">5.4.4. </span>Multi-instance writable object with fixed number of instances<a class="headerlink" href="#multi-instance-writable-object-with-fixed-number-of-instances" title="Link to this heading"></a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This section describes in details the implementation of custom Objects in
Anjay, either defined in <a class="reference external" href="https://technical.openmobilealliance.org/OMNA/LwM2M/LwM2MRegistry.html">OMA LwM2M Object and Resource Registry</a>
or designed by user.</p>
<p>Although most of the Object’s code can be generated using
<a class="reference internal" href="../../Tools/StubGenerator.html#anjay-object-stub-generator"><span class="std std-ref">Anjay Object stub generator</span></a> if you have Object’s definition in XML,
it is recommended to read this section to have a clear understanding on what
various parts of the LwM2M Object code are for.</p>
</div>
<p>In this tutorial you will learn:</p>
<ul class="simple">
<li><p>how to implement <code class="docutils literal notranslate"><span class="pre">resource_write</span></code> to create a writeable Resource,</p></li>
<li><p>what are Partial Update and Replace variants of the LwM2M Write request,</p></li>
<li><p>how to setup <code class="docutils literal notranslate"><span class="pre">instance_reset</span></code> handler to handle LwM2M Write (Replace),</p></li>
<li><p>basics of transaction handling in Anjay.</p></li>
</ul>
<p>Implemented object is based on <a class="reference internal" href="AT_CO_MultiInstanceReadOnlyFixed.html"><span class="doc">Multi-instance read-only object with fixed number of instances</span></a>,
but this time accepts Write requests.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Object ID</p></th>
<th class="head"><p>Instances</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Test object</p></td>
<td><p>1234</p></td>
<td><p>Multiple</p></td>
</tr>
</tbody>
</table>
<p>Each Object Instance has two Resources:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Resource ID</p></th>
<th class="head"><p>Operations</p></th>
<th class="head"><p>Instances</p></th>
<th class="head"><p>Mandatory</p></th>
<th class="head"><p>Type</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Label</p></td>
<td><p>0</p></td>
<td><p>Read/Write</p></td>
<td><p>Single</p></td>
<td><p>Mandatory</p></td>
<td><p>String</p></td>
</tr>
<tr class="row-odd"><td><p>Value</p></td>
<td><p>1</p></td>
<td><p>Read/Write</p></td>
<td><p>Single</p></td>
<td><p>Mandatory</p></td>
<td><p>Integer</p></td>
</tr>
</tbody>
</table>
<section id="simple-variant">
<h2><span class="section-number">5.4.4.1. </span>Simple variant<a class="headerlink" href="#simple-variant" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">test_instance_t</span></code> needs to be able to store arbitrary data. Let us set
an arbitrary limit of 32 characters in length (including terminating nullbyte):</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">test_instance</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">label</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="w">    </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">test_instance_t</span><span class="p">;</span>
</pre></div>
</div>
<p>Now the <code class="docutils literal notranslate"><span class="pre">anjay_dm_resource_write_t</span></code> handler implementation:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">test_resource_write</span><span class="p">(</span><span class="n">anjay_t</span><span class="w"> </span><span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
<span class="w">                               </span><span class="k">const</span><span class="w"> </span><span class="n">anjay_dm_object_def_t</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
<span class="w">                               </span><span class="n">anjay_iid_t</span><span class="w"> </span><span class="n">iid</span><span class="p">,</span>
<span class="w">                               </span><span class="n">anjay_rid_t</span><span class="w"> </span><span class="n">rid</span><span class="p">,</span>
<span class="w">                               </span><span class="n">anjay_riid_t</span><span class="w"> </span><span class="n">riid</span><span class="p">,</span>
<span class="w">                               </span><span class="n">anjay_input_ctx_t</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">anjay</span><span class="p">;</span><span class="w"> </span><span class="c1">// unused</span>

<span class="w">    </span><span class="n">test_object_t</span><span class="w"> </span><span class="o">*</span><span class="n">test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_test_object</span><span class="p">(</span><span class="n">obj_ptr</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// IID validity was checked by the `anjay_dm_list_instances_t` handler.</span>
<span class="w">    </span><span class="c1">// If the Object Instance set does not change, or can only be modified</span>
<span class="w">    </span><span class="c1">// via LwM2M Create/Delete requests, it is safe to assume IID is correct.</span>
<span class="w">    </span><span class="n">assert</span><span class="p">((</span><span class="kt">size_t</span><span class="p">)</span><span class="w"> </span><span class="n">iid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NUM_INSTANCES</span><span class="p">);</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">test_instance</span><span class="w"> </span><span class="o">*</span><span class="n">current_instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">instances</span><span class="p">[</span><span class="n">iid</span><span class="p">];</span>

<span class="w">    </span><span class="c1">// We have no Multiple-Instance Resources, so it is safe to assume</span>
<span class="w">    </span><span class="c1">// that RIID is never set.</span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">riid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ANJAY_ID_INVALID</span><span class="p">);</span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">rid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// `anjay_get_string` may return a chunk of data instead of the</span>
<span class="w">        </span><span class="c1">// whole value - we need to make sure the client is able to hold</span>
<span class="w">        </span><span class="c1">// the entire value</span>
<span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="n">buffer</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">current_instance</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">)];</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">anjay_get_string</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// value OK - save it</span>
<span class="w">            </span><span class="n">memcpy</span><span class="p">(</span><span class="n">current_instance</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">ANJAY_BUFFER_TOO_SHORT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// the value is too long to store in the buffer</span>
<span class="w">            </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ANJAY_ERR_BAD_REQUEST</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span>
<span class="w">        </span><span class="c1">// reading primitive values can be done directly - the value will only</span>
<span class="w">        </span><span class="c1">// be written to the output variable if everything went fine</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">anjay_get_i32</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">current_instance</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>

<span class="w">    </span><span class="k">default</span><span class="o">:</span>
<span class="w">        </span><span class="c1">// control will never reach this part due to test_list_resources</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ANJAY_ERR_INTERNAL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We also need to update the <code class="docutils literal notranslate"><span class="pre">test_list_resources</span></code> handler with the information
that the resources are writable:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">test_list_resources</span><span class="p">(</span><span class="n">anjay_t</span><span class="w"> </span><span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
<span class="w">                               </span><span class="k">const</span><span class="w"> </span><span class="n">anjay_dm_object_def_t</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
<span class="w">                               </span><span class="n">anjay_iid_t</span><span class="w"> </span><span class="n">iid</span><span class="p">,</span>
<span class="w">                               </span><span class="n">anjay_dm_resource_list_ctx_t</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="n">anjay_dm_emit_res</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ANJAY_DM_RES_RW</span><span class="p">,</span><span class="w"> </span><span class="n">ANJAY_DM_RES_PRESENT</span><span class="p">);</span>
<span class="w">    </span><span class="n">anjay_dm_emit_res</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ANJAY_DM_RES_RW</span><span class="p">,</span><span class="w"> </span><span class="n">ANJAY_DM_RES_PRESENT</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Everything that was left to do is plugging in handlers. There is a catch though:
any modifying operation (writing a value, creating or deleting an Object
Instance) requires explicitly defined transaction handlers.
<code class="docutils literal notranslate"><span class="pre">anjay_dm_transaction_NOOP</span></code> placeholder will be used for now, see
<a class="reference internal" href="#fixedinstancewritable-transactional"><span class="std std-ref">Transactional variant</span></a> for an actual implementation of
these.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">anjay_dm_object_def_t</span><span class="w"> </span><span class="n">OBJECT_DEF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">     </span><span class="c1">// ...</span>
<span class="w">     </span><span class="p">.</span><span class="n">handlers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="c1">// ...</span>

<span class="w">         </span><span class="p">.</span><span class="n">resource_write</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">test_resource_write</span><span class="p">,</span>

<span class="w">         </span><span class="p">.</span><span class="n">transaction_begin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">anjay_dm_transaction_NOOP</span><span class="p">,</span>
<span class="w">         </span><span class="p">.</span><span class="n">transaction_validate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">anjay_dm_transaction_NOOP</span><span class="p">,</span>
<span class="w">         </span><span class="p">.</span><span class="n">transaction_commit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">anjay_dm_transaction_NOOP</span><span class="p">,</span>
<span class="w">         </span><span class="p">.</span><span class="n">transaction_rollback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">anjay_dm_transaction_NOOP</span>
<span class="w">     </span><span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Complete code of this example can be found in
<cite>examples/tutorial/AT-CustomObjects/writable-multiple-fixed</cite> subdirectory of
main Anjay project repository.</p>
</div>
<section id="lwm2m-write-operation-modes">
<h3><span class="section-number">5.4.4.1.1. </span>LwM2M Write operation modes<a class="headerlink" href="#lwm2m-write-operation-modes" title="Link to this heading"></a></h3>
<p>A LwM2M Server may perform a Write on the <em>entire Object Instance</em>. Two
variants of such requests are available - both replace values of Instance
Resources with received values, but they differ in what happens to Resources
not present in the request:</p>
<ul>
<li><p>Partial Update - they are leaved unchanged,</p></li>
<li><p>Replace - Optional Resources are reset to “missing” state. All mandatory
Resources MUST be specified in the request, otherwise it MUST be considered
invalid.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Anjay does not distinguish Mandatory and Optional Resources - the user
is responsible for ensuring the state of an Object is still valid after
handling a request. This topic is covered in detail in
<a class="reference internal" href="#fixedinstancewritable-transactional"><span class="std std-ref">Transactional variant</span></a>; we will ignore it in this
particular example.</p>
</div>
</li>
</ul>
<p>Anjay implements Partial Update as a series of <code class="docutils literal notranslate"><span class="pre">resource_write</span></code> calls and
Replace one as <code class="docutils literal notranslate"><span class="pre">instance_reset</span></code> + series of <code class="docutils literal notranslate"><span class="pre">resource_write</span></code> calls.
To properly support both Write variants, <code class="docutils literal notranslate"><span class="pre">instance_reset</span></code> needs to be
implemented too.</p>
</section>
<section id="anjay-transaction-handlers">
<h3><span class="section-number">5.4.4.1.2. </span>Anjay transaction handlers<a class="headerlink" href="#anjay-transaction-handlers" title="Link to this heading"></a></h3>
<p>In some cases, like LwM2M Write requests targeting an Object Instance, Anjay
calls multiple handlers modifying the data model to perform a single atomic
operation. In such case, transactions ensure that data model is not left
in an inconsistent state when one of handler calls fails. To achieve correct
behavior, used-defined handlers should behave as described below:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">anjay_dm_resource_write_t</span></code> - needs to ensure that the value being written
is correct and store new value in such a way that rolling back to the previous
one is still possible. It must not check constraints that depend on values
of other Resources, as these Resources may also change during the same
transaction.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">anjay_dm_transaction_begin_t</span></code> - always called before any operation that
changes the data model (LwM2M Write, Create, Delete). It should do whatever
actions are necessary for correct transaction handling - in the simplest
possible case, it could save a snapshot of the current state of the Object
to restore it when rollback is required.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">anjay_dm_transaction_validate_t</span></code> - called after all write/create/remove
handlers succeed. It should verify cross-Resource or cross-Instance
constraints and fail if the data model state is not consistent.
<strong>Example</strong>: LwM2M requires that at most one Security (/0) object instance
has Bootstrap Server Resource set to 1. If a LwM2M Create operation adds
an instance with this Bootstrap Server = 1 when there already was one, this
handler needs to fail.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">anjay_dm_transaction_commit_t</span></code> - called after the transaction was
successfully validated by the <code class="docutils literal notranslate"><span class="pre">anjay_dm_transaction_validate_t</span></code> handler.
It should atomically apply all changes performed since last call to
<code class="docutils literal notranslate"><span class="pre">anjay_dm_transaction_begin_t</span></code> for the same object.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This handler must not fail, unless a critical and unrecoverable error
(e.g. hardware failure) occurs.</p>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">anjay_dm_transaction_rollback_t</span></code> - called after one of
write/create/remove/validate handlers fails. It should atomically restore
the object to a state it was at the last <code class="docutils literal notranslate"><span class="pre">anjay_dm_transaction_begin_t</span></code>
call.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This handler must not fail, unless a critical and unrecoverable error
(e.g. hardware failure) occurs.</p>
</div>
</li>
</ul>
<p>This tutorial shows an example of implementing transactions by storing
a snapshot of the entire state of a LwM2M Object.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Such implementation, while simple, effectively doubles amount of RAM used
by the Object.</p>
</div>
</section>
</section>
<section id="transactional-variant">
<span id="fixedinstancewritable-transactional"></span><h2><span class="section-number">5.4.4.2. </span>Transactional variant<a class="headerlink" href="#transactional-variant" title="Link to this heading"></a></h2>
<p>Knowing all about different LwM2M Write variants and Anjay transaction handlers,
we can start implementing a transaction-aware client capable of handling
all LwM2M Write requests.</p>
<p>Let’s start by implementing the <code class="docutils literal notranslate"><span class="pre">instance_reset</span></code> handler. Two boolean flags
need to be added to <code class="docutils literal notranslate"><span class="pre">test_instance_t</span></code> to detect a situation where a value
is considered “unset”:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">test_instance</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">has_label</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">label</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">has_value</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int32_t</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">test_instance_t</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">instance_reset</span></code> and <code class="docutils literal notranslate"><span class="pre">resource_write</span></code> should then use these to appropriately
mark Resources as set/unset:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">test_instance_reset</span><span class="p">(</span><span class="n">anjay_t</span><span class="w"> </span><span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
<span class="w">                               </span><span class="k">const</span><span class="w"> </span><span class="n">anjay_dm_object_def_t</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
<span class="w">                               </span><span class="n">anjay_iid_t</span><span class="w"> </span><span class="n">iid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">anjay</span><span class="p">;</span><span class="w"> </span><span class="c1">// unused</span>

<span class="w">    </span><span class="n">test_object_t</span><span class="w"> </span><span class="o">*</span><span class="n">test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_test_object</span><span class="p">(</span><span class="n">obj_ptr</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// IID validity was checked by the `anjay_dm_list_instances_t` handler.</span>
<span class="w">    </span><span class="c1">// If the Object Instance set does not change, or can only be modified</span>
<span class="w">    </span><span class="c1">// via LwM2M Create/Delete requests, it is safe to assume IID is correct.</span>
<span class="w">    </span><span class="n">assert</span><span class="p">((</span><span class="kt">size_t</span><span class="p">)</span><span class="w"> </span><span class="n">iid</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NUM_INSTANCES</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// mark all Resource values for Object Instance `iid` as unset</span>
<span class="w">    </span><span class="n">test</span><span class="o">-&gt;</span><span class="n">instances</span><span class="p">[</span><span class="n">iid</span><span class="p">].</span><span class="n">has_label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="n">test</span><span class="o">-&gt;</span><span class="n">instances</span><span class="p">[</span><span class="n">iid</span><span class="p">].</span><span class="n">has_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// ...</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">test_resource_write</span><span class="p">(</span><span class="n">anjay_t</span><span class="w"> </span><span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
<span class="w">                               </span><span class="k">const</span><span class="w"> </span><span class="n">anjay_dm_object_def_t</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
<span class="w">                               </span><span class="n">anjay_iid_t</span><span class="w"> </span><span class="n">iid</span><span class="p">,</span>
<span class="w">                               </span><span class="n">anjay_rid_t</span><span class="w"> </span><span class="n">rid</span><span class="p">,</span>
<span class="w">                               </span><span class="n">anjay_riid_t</span><span class="w"> </span><span class="n">riid</span><span class="p">,</span>
<span class="w">                               </span><span class="n">anjay_input_ctx_t</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ...</span>

<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">rid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// ...</span>

<span class="w">            </span><span class="c1">// value OK - save it</span>
<span class="w">            </span><span class="n">memcpy</span><span class="p">(</span><span class="n">current_instance</span><span class="o">-&gt;</span><span class="n">label</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
<span class="w">            </span><span class="n">current_instance</span><span class="o">-&gt;</span><span class="n">has_label</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// ...</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// reading primitive values can be done directly - the value will only</span>
<span class="w">        </span><span class="c1">// be written to the output variable if everything went fine</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">anjay_get_i32</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">current_instance</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">current_instance</span><span class="o">-&gt;</span><span class="n">has_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Having <code class="docutils literal notranslate"><span class="pre">has_label</span></code>/<code class="docutils literal notranslate"><span class="pre">has_value</span></code> flags ready, we can finally implement
transaction handlers:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">test_transaction_begin</span><span class="p">(</span><span class="n">anjay_t</span><span class="w"> </span><span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
<span class="w">                                  </span><span class="k">const</span><span class="w"> </span><span class="n">anjay_dm_object_def_t</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">obj_ptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">anjay</span><span class="p">;</span><span class="w"> </span><span class="c1">// unused</span>

<span class="w">    </span><span class="n">test_object_t</span><span class="w"> </span><span class="o">*</span><span class="n">test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_test_object</span><span class="p">(</span><span class="n">obj_ptr</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// store a snapshot of object state</span>
<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">backup_instances</span><span class="p">,</span><span class="w"> </span><span class="n">test</span><span class="o">-&gt;</span><span class="n">instances</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">instances</span><span class="p">));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span>
<span class="nf">test_transaction_validate</span><span class="p">(</span><span class="n">anjay_t</span><span class="w"> </span><span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
<span class="w">                          </span><span class="k">const</span><span class="w"> </span><span class="n">anjay_dm_object_def_t</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">obj_ptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">anjay</span><span class="p">;</span><span class="w"> </span><span class="c1">// unused</span>

<span class="w">    </span><span class="n">test_object_t</span><span class="w"> </span><span class="o">*</span><span class="n">test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_test_object</span><span class="p">(</span><span class="n">obj_ptr</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// ensure all Object Instances contain all Mandatory Resources</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NUM_INSTANCES</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">instances</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">has_label</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">instances</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">has_value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// validation failed: Object state invalid, rollback required</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">ANJAY_ERR_BAD_REQUEST</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// validation successful, can commit</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span>
<span class="nf">test_transaction_commit</span><span class="p">(</span><span class="n">anjay_t</span><span class="w"> </span><span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
<span class="w">                        </span><span class="k">const</span><span class="w"> </span><span class="n">anjay_dm_object_def_t</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">obj_ptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">anjay</span><span class="p">;</span><span class="w">   </span><span class="c1">// unused</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">obj_ptr</span><span class="p">;</span><span class="w"> </span><span class="c1">// unused</span>

<span class="w">    </span><span class="c1">// no action required in this implementation; if object state snapshot was</span>
<span class="w">    </span><span class="c1">// dynamically allocated, this would be the place for releasing it</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="kt">int</span>
<span class="nf">test_transaction_rollback</span><span class="p">(</span><span class="n">anjay_t</span><span class="w"> </span><span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
<span class="w">                          </span><span class="k">const</span><span class="w"> </span><span class="n">anjay_dm_object_def_t</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">obj_ptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">anjay</span><span class="p">;</span><span class="w"> </span><span class="c1">// unused</span>

<span class="w">    </span><span class="n">test_object_t</span><span class="w"> </span><span class="o">*</span><span class="n">test</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_test_object</span><span class="p">(</span><span class="n">obj_ptr</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// restore saved object state</span>
<span class="w">    </span><span class="n">memcpy</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">instances</span><span class="p">,</span><span class="w"> </span><span class="n">test</span><span class="o">-&gt;</span><span class="n">backup_instances</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">test</span><span class="o">-&gt;</span><span class="n">instances</span><span class="p">));</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// ...</span>

<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">anjay_dm_object_def_t</span><span class="w"> </span><span class="n">OBJECT_DEF</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="w">    </span><span class="p">.</span><span class="n">handlers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ...</span>

<span class="w">        </span><span class="p">.</span><span class="n">instance_reset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">test_instance_reset</span><span class="p">,</span>

<span class="w">        </span><span class="c1">// ...</span>

<span class="w">        </span><span class="p">.</span><span class="n">transaction_begin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">test_transaction_begin</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">transaction_validate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">test_transaction_validate</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">transaction_commit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">test_transaction_commit</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">transaction_rollback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">test_transaction_rollback</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<p>That is everything one needs to set up a complete, transaction-aware writable
Resource.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Complete code of this example can be found in
<cite>examples/tutorial/AT-CustomObjects/writable-multiple-fixed-transactional</cite>
subdirectory of main Anjay project repository.</p>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="AT_CO_MultiInstanceReadOnlyFixed.html" class="btn btn-neutral float-left" title="5.4.3. Multi-instance read-only object with fixed number of instances" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="AT_CO_MultiInstanceDynamic.html" class="btn btn-neutral float-right" title="5.4.5. Multi-instance writable object with dynamic number of instances" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017-2024, AVSystem.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>