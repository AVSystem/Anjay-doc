

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>5.4.5. Multi-instance writable object with dynamic number of instances &mdash; Anjay 2.15.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />

  
  

  
  

  

  
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="5.4.6. Objects with Multiple Instance Resources" href="AT_CO_MultipleResourceInstances.html" />
    <link rel="prev" title="5.4.4. Multi-instance writable object with fixed number of instances" href="AT_CO_FixedInstanceWritable.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #ffd500" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/avsystem_header.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                2.15.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../Introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LwM2M.html">2. OMA LwM2M - Brief description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Compiling_client_applications.html">3. Compiling client applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../BasicClient.html">4. Basic client</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../AdvancedTopics.html">5. Advanced topics</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../AT-AccessControl.html">5.1. Access Control in multi-server environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../AT-AttributeStorage.html">5.2. Attribute storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../AT-Certificates.html">5.3. DTLS connection using certificates</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../AT-CustomObjects.html">5.4. Custom LwM2M objects</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="AT_CO_SingleInstanceReadOnly.html">5.4.1. Single-instance read-only object</a></li>
<li class="toctree-l3"><a class="reference internal" href="AT_CO_SingleInstanceExecutableAndReadOnly.html">5.4.2. Single-instance read-only object with an executable resource</a></li>
<li class="toctree-l3"><a class="reference internal" href="AT_CO_MultiInstanceReadOnlyFixed.html">5.4.3. Multi-instance read-only object with fixed number of instances</a></li>
<li class="toctree-l3"><a class="reference internal" href="AT_CO_FixedInstanceWritable.html">5.4.4. Multi-instance writable object with fixed number of instances</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">5.4.5. Multi-instance writable object with dynamic number of instances</a></li>
<li class="toctree-l3"><a class="reference internal" href="AT_CO_MultipleResourceInstances.html">5.4.6. Objects with Multiple Instance Resources</a></li>
<li class="toctree-l3"><a class="reference internal" href="AT_CO_BootstrapAwareness.html">5.4.7. Bootstrap awareness</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../AT-NetworkErrorHandling.html">5.5. Network error handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../AT-OtherFeatures.html">5.6. Other library features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../AT-Persistence.html">5.7. Persistence support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../AT-RetransmissionsTimeoutsCaching.html">5.8. Retransmissions, timeouts &amp; response caching</a></li>
<li class="toctree-l2"><a class="reference internal" href="../AT-CustomEventLoop.html">5.9. Custom event loop</a></li>
<li class="toctree-l2"><a class="reference internal" href="../AT-EventLoopNotes.html">5.10. Notes on event loop APIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../AT-IpsoObjects.html">5.11. Anjay IPSO Objects implementation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../FirmwareUpdateTutorial.html">6. Firmware Update Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tools.html">7. Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PortingGuideForNonPOSIXPlatforms.html">8. Porting guide for non-POSIX platforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Migrating.html">9. Migrating from older versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Commercial_support.html">10. Commercial support</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Anjay</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../AdvancedTopics.html"><span class="section-number">5. </span>Advanced topics</a> &raquo;</li>
        
          <li><a href="../AT-CustomObjects.html"><span class="section-number">5.4. </span>Custom LwM2M objects</a> &raquo;</li>
        
      <li><span class="section-number">5.4.5. </span>Multi-instance writable object with dynamic number of instances</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="multi-instance-writable-object-with-dynamic-number-of-instances">
<h1><span class="section-number">5.4.5. </span>Multi-instance writable object with dynamic number of instances<a class="headerlink" href="#multi-instance-writable-object-with-dynamic-number-of-instances" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This section describes in details the implementation of custom Objects in
Anjay, either defined in <a class="reference external" href="https://technical.openmobilealliance.org/OMNA/LwM2M/LwM2MRegistry.html">OMA LwM2M Object and Resource Registry</a>
or designed by user.</p>
<p>Although most of the Object’s code can be generated using
<a class="reference internal" href="../../Tools/StubGenerator.html#anjay-object-stub-generator"><span class="std std-ref">Anjay Object stub generator</span></a> if you have Object’s definition in XML,
it is recommended to read this section to have a clear understanding on what
various parts of the LwM2M Object code are for.</p>
</div>
<p>In this tutorial you will learn:</p>
<ul class="simple">
<li><p>how to implement <code class="docutils literal notranslate"><span class="pre">instance_create</span></code> handler to create Instances,</p></li>
<li><p>how to implement <code class="docutils literal notranslate"><span class="pre">instance_remove</span></code> handler to remove Instances,</p></li>
<li><p>how to assign instance identifiers to a newly created Instances,</p></li>
<li><p>basics of the <code class="docutils literal notranslate"><span class="pre">AVS_LIST</span></code> utility library.</p></li>
</ul>
<p>Implemented object will be roughly based on <a class="reference internal" href="AT_CO_FixedInstanceWritable.html"><span class="doc">Multi-instance writable object with fixed number of instances</span></a>.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 37%" />
<col style="width: 31%" />
<col style="width: 31%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Object ID</p></th>
<th class="head"><p>Instances</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Test object</p></td>
<td><p>1234</p></td>
<td><p>Multiple</p></td>
</tr>
</tbody>
</table>
<p>As before, each Object Instance has two Resources:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 11%" />
<col style="width: 21%" />
<col style="width: 19%" />
<col style="width: 17%" />
<col style="width: 17%" />
<col style="width: 14%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Resource ID</p></th>
<th class="head"><p>Operations</p></th>
<th class="head"><p>Instances</p></th>
<th class="head"><p>Mandatory</p></th>
<th class="head"><p>Type</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Label</p></td>
<td><p>0</p></td>
<td><p>Read/Write</p></td>
<td><p>Single</p></td>
<td><p>Mandatory</p></td>
<td><p>String</p></td>
</tr>
<tr class="row-odd"><td><p>Value</p></td>
<td><p>1</p></td>
<td><p>Read/Write</p></td>
<td><p>Single</p></td>
<td><p>Mandatory</p></td>
<td><p>Integer</p></td>
</tr>
</tbody>
</table>
<p>The code is based on <a class="reference internal" href="AT_CO_FixedInstanceWritable.html"><span class="doc">previous tutorial</span></a>,
yet in this chapter all Test object related code was moved to separate files to
keep everything clean.</p>
<div class="section" id="updating-the-object-structure">
<h2><span class="section-number">5.4.5.1. </span>Updating the object structure<a class="headerlink" href="#updating-the-object-structure" title="Permalink to this headline">¶</a></h2>
<p>First of all, we have to update our <code class="docutils literal notranslate"><span class="pre">test_object_t</span></code> structure to support
storing multiple object instances. For that, we need some kind of dynamically
sized container. We could choose plain-old, manually managed C arrays, but
that comes with unnecessary distraction, and as a matter of fact is a bit
error-prone.  Therefore, in this tutorial, we are going to use <code class="docutils literal notranslate"><span class="pre">AVS_LIST</span></code>,
which is an abstraction over singly linked list, and has been used in Anjay
with success since the beginning of the project.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">test_object</span> <span class="p">{</span>
    <span class="c1">// handlers</span>
    <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="n">obj_def</span><span class="p">;</span>

    <span class="c1">// object state</span>
    <span class="n">AVS_LIST</span><span class="p">(</span><span class="n">test_instance_t</span><span class="p">)</span> <span class="n">instances</span><span class="p">;</span>

    <span class="n">AVS_LIST</span><span class="p">(</span><span class="n">test_instance_t</span><span class="p">)</span> <span class="n">backup_instances</span><span class="p">;</span>
<span class="p">}</span> <span class="n">test_object_t</span><span class="p">;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">AVS_LIST(x)</span></code> is actually a macro that expands to a pointer of type <code class="docutils literal notranslate"><span class="pre">x</span></code>.
It therefore has pointer semantics and can be treated like that (standard
dereferencing and dereferencing with assignment will work as expected). This
is however, not everything you need to know about them, as they are more
complicated than that. We recommend you to refer to the <a class="reference external" href="https://github.com/AVSystem/avs_commons/blob/master/include_public/avsystem/commons/avs_list.h">documentation</a>.</p>
</div>
<p>In the previous tutorial, our Instances had hardcoded Instance IDs.  We no
longer have such comfort, and have to be able to uniquely identify Object
Instances. As a consequence, we will add <code class="docutils literal notranslate"><span class="pre">anjay_iid_t</span> <span class="pre">iid</span></code> field to
<code class="docutils literal notranslate"><span class="pre">test_instance_t</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">test_instance</span> <span class="p">{</span>
    <span class="n">anjay_iid_t</span> <span class="n">iid</span><span class="p">;</span>

    <span class="kt">bool</span> <span class="n">has_label</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">label</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

    <span class="kt">bool</span> <span class="n">has_value</span><span class="p">;</span>
    <span class="kt">int32_t</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span> <span class="n">test_instance_t</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="initialization-and-cleanup">
<h2><span class="section-number">5.4.5.2. </span>Initialization and cleanup<a class="headerlink" href="#initialization-and-cleanup" title="Permalink to this headline">¶</a></h2>
<p>We must reconsider the way our Test object is being initialized. Up to this point
it was allocated on stack and required no cleanup. Again, times have changed, and
we won’t be able to proceed further without allocating memory on demand.</p>
<div class="topic">
<p class="topic-title">Wait, you could still allocate objects on stack, and initialize them later!</p>
<p>Yes, but it may be considered bad coding style for at least two reasons:</p>
<ol class="arabic simple">
<li><p>Having partially initialized or uninitialized objects floating around is
almost always a bad idea, as it is easy to forget about initialization
and accessing uninitialized data is undefined behavior. Allocating
objects on a heap however, allows the implementation to fully initialize
an object before returning a reference to it.</p></li>
<li><p>End user of an Object should NOT be exposed to its internal representation,
i.e. notice how handles to all objects shown to you so far were returned as
pointers to <code class="docutils literal notranslate"><span class="pre">anjay_dm_object_def_t</span></code> – clearly, it indicates to the user
that they have nothing interesting to do with such reference (besides being
able to register it), unless some additional public API is provided.</p></li>
</ol>
</div>
<p>To achieve proper control over object lifetime and initialization, we are
going to introduce two functions, namely <code class="docutils literal notranslate"><span class="pre">create_test_object</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">**</span><span class="n">create_test_object</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">test_object_t</span> <span class="o">*</span><span class="n">repr</span> <span class="o">=</span>
            <span class="p">(</span><span class="n">test_object_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">avs_calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">test_object_t</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">repr</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">repr</span><span class="o">-&gt;</span><span class="n">obj_def</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">OBJECT_DEF</span><span class="p">;</span>
        <span class="k">return</span> <span class="o">&amp;</span><span class="n">repr</span><span class="o">-&gt;</span><span class="n">obj_def</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="topic">
<p class="topic-title">Shouldn’t <code class="docutils literal notranslate"><span class="pre">test_object_t::instances</span></code> and <code class="docutils literal notranslate"><span class="pre">test_object_t::backup_instances</span></code> be
   be initialized in some special way?</p>
<p>No, <code class="docutils literal notranslate"><span class="pre">NULL</span></code> is a valid (and only) representation of an empty <code class="docutils literal notranslate"><span class="pre">AVS_LIST</span></code>.</p>
</div>
<p>and <code class="docutils literal notranslate"><span class="pre">delete_test_object</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">delete_test_object</span><span class="p">(</span><span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">**</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">test_object_t</span> <span class="o">*</span><span class="n">repr</span> <span class="o">=</span> <span class="n">get_test_object</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
    <span class="n">AVS_LIST_CLEAR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">repr</span><span class="o">-&gt;</span><span class="n">instances</span><span class="p">);</span>
    <span class="n">AVS_LIST_CLEAR</span><span class="p">(</span><span class="o">&amp;</span><span class="n">repr</span><span class="o">-&gt;</span><span class="n">backup_instances</span><span class="p">);</span>
    <span class="n">avs_free</span><span class="p">(</span><span class="n">repr</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As you can see, dynamic memory management is semi-automatically handled by <code class="docutils literal notranslate"><span class="pre">AVS_LIST</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">AVS_LIST_CLEAR</span></code> iterates over the list, in the process frees memory allocated for
each element, and in the end sets list handle to <code class="docutils literal notranslate"><span class="pre">NULL</span></code>.</p>
</div>
<p>Using functions defined above to create, register and free the Test object is similar
as in previous tutorials.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Before calling <code class="docutils literal notranslate"><span class="pre">delete_test_object()</span></code> the object must be unregistered. You
can do this by calling <code class="docutils literal notranslate"><span class="pre">anjay_unregister_object()</span></code>. Also <code class="docutils literal notranslate"><span class="pre">anjay_delete()</span></code>
will deregister (but not delete) all of registered objects before destruction
of Anjay instance.</p>
</div>
</div>
<div class="section" id="updating-old-already-implemented-handlers-to-use-avs-list">
<h2><span class="section-number">5.4.5.3. </span>Updating old, already implemented handlers to use <code class="docutils literal notranslate"><span class="pre">AVS_LIST</span></code><a class="headerlink" href="#updating-old-already-implemented-handlers-to-use-avs-list" title="Permalink to this headline">¶</a></h2>
<p>To simplify matters, we have to agree upon one contract:</p>
<ol class="arabic simple">
<li><p>We establish a natural Instance ordering on their Instance IDs, exploiting
the fact they MUST be unique.</p></li>
<li><p>We store Instances of the Test object in an ordered (as above) list.</p></li>
</ol>
<p>OK, now that we made our assumptions, we are ready to implement utility function
<code class="docutils literal notranslate"><span class="pre">get_instance</span></code> which retrieves Test object instance with specified Instance ID.
It will happen to be very useful in the next couple of subsections:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="nf">AVS_LIST</span><span class="p">(</span><span class="n">test_instance_t</span><span class="p">)</span> <span class="n">get_instance</span><span class="p">(</span><span class="n">test_object_t</span> <span class="o">*</span><span class="n">repr</span><span class="p">,</span>
                                              <span class="n">anjay_iid_t</span> <span class="n">iid</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">AVS_LIST</span><span class="p">(</span><span class="n">test_instance_t</span><span class="p">)</span> <span class="n">it</span><span class="p">;</span>
    <span class="n">AVS_LIST_FOREACH</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">repr</span><span class="o">-&gt;</span><span class="n">instances</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">iid</span> <span class="o">==</span> <span class="n">iid</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">it</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">it</span><span class="o">-&gt;</span><span class="n">iid</span> <span class="o">&gt;</span> <span class="n">iid</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Since list of instances is sorted by Instance ID,</span>
            <span class="c1">// Instance with given iid does not exist on that list</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// Instance was not found.</span>
    <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>And one more method, presenting another functionality of <code class="docutils literal notranslate"><span class="pre">AVS_LISTs</span></code>
before going into details of <code class="docutils literal notranslate"><span class="pre">instance_create</span></code> and <code class="docutils literal notranslate"><span class="pre">instance_remove</span></code>
and leaving the rest of the work of this kind as an exercise for the reader
(or, if they are lazy, they can always look at the code):</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="n">test_list_instances</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                               <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
                               <span class="n">anjay_dm_list_ctx_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">anjay</span><span class="p">;</span> <span class="c1">// unused</span>

    <span class="c1">// iterate over all instances and return their IDs</span>
    <span class="n">AVS_LIST</span><span class="p">(</span><span class="n">test_instance_t</span><span class="p">)</span> <span class="n">it</span><span class="p">;</span>
    <span class="n">AVS_LIST_FOREACH</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">get_test_object</span><span class="p">(</span><span class="n">obj_ptr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">instances</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">anjay_dm_emit</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">iid</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that as we keep the Instances in sorted order, this implementation
satisfies the contract for this handler.</p>
<p>That’s all for this section. As noted above, implementation of other methods
is as always available in the source code provided with the tutorial. We
do however strongly recommend you to port the methods to use <code class="docutils literal notranslate"><span class="pre">AVS_LISTs</span></code>
on your own, especially <strong>remember about updating transaction handlers</strong>.</p>
</div>
<div class="section" id="instance-create-handler">
<h2><span class="section-number">5.4.5.4. </span><code class="docutils literal notranslate"><span class="pre">instance_create</span></code> handler<a class="headerlink" href="#instance-create-handler" title="Permalink to this headline">¶</a></h2>
<p>Let’s have a look on <code class="docutils literal notranslate"><span class="pre">anjay_dm_instance_create_t</span></code> handler type signature:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="kt">int</span>
<span class="n">anjay_dm_instance_create_t</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                           <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
                           <span class="n">anjay_iid_t</span> <span class="n">iid</span><span class="p">);</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">iid</span></code> parameter is the most important for us at the moment, as this is the
ID of the Instance we need to create.</p>
<p>LwM2M Create requests do not necessarily have to contain preferred Instance ID.
However, Anjay makes it transparent to the application - if the Instance ID is
not specified by the server, it will iterate over existing instances using the
<code class="docutils literal notranslate"><span class="pre">anjay_dm_list_instances_t</span></code> handler, and find the lowest ID that is not
already occupied. If the Instance ID is specified by the server, Anjay will call
the <code class="docutils literal notranslate"><span class="pre">anjay_dm_list_instances_t</span></code> handler and ensure that there is no such
Instance ID already existing.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="n">test_instance_create</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                                <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
                                <span class="n">anjay_iid_t</span> <span class="n">iid</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">anjay</span><span class="p">;</span> <span class="c1">// unused</span>

    <span class="n">test_object_t</span> <span class="o">*</span><span class="n">repr</span> <span class="o">=</span> <span class="n">get_test_object</span><span class="p">(</span><span class="n">obj_ptr</span><span class="p">);</span>

    <span class="n">AVS_LIST</span><span class="p">(</span><span class="n">test_instance_t</span><span class="p">)</span> <span class="n">new_instance</span> <span class="o">=</span>
            <span class="n">AVS_LIST_NEW_ELEMENT</span><span class="p">(</span><span class="n">test_instance_t</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_instance</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// out of memory</span>
        <span class="k">return</span> <span class="n">ANJAY_ERR_INTERNAL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">new_instance</span><span class="o">-&gt;</span><span class="n">iid</span> <span class="o">=</span> <span class="n">iid</span><span class="p">;</span>

    <span class="c1">// find a place where instance should be inserted,</span>
    <span class="c1">// insert it and claim a victory</span>
    <span class="n">AVS_LIST</span><span class="p">(</span><span class="n">test_instance_t</span><span class="p">)</span> <span class="o">*</span><span class="n">insert_ptr</span><span class="p">;</span>
    <span class="n">AVS_LIST_FOREACH_PTR</span><span class="p">(</span><span class="n">insert_ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">repr</span><span class="o">-&gt;</span><span class="n">instances</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">insert_ptr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iid</span> <span class="o">&gt;</span> <span class="n">new_instance</span><span class="o">-&gt;</span><span class="n">iid</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">AVS_LIST_INSERT</span><span class="p">(</span><span class="n">insert_ptr</span><span class="p">,</span> <span class="n">new_instance</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There is a lot going on in this function, also new concepts regarding
<code class="docutils literal notranslate"><span class="pre">AVS_LIST</span></code> are being used. We advise you to look at <code class="docutils literal notranslate"><span class="pre">AVS_LIST_FOREACH_PTR</span></code>,
<code class="docutils literal notranslate"><span class="pre">AVS_LIST_NEW_ELEMENT</span></code> and <code class="docutils literal notranslate"><span class="pre">AVS_LIST_INSERT</span></code> documentation for more details.</p>
</div>
</div>
<div class="section" id="instance-remove-handler">
<h2><span class="section-number">5.4.5.5. </span><code class="docutils literal notranslate"><span class="pre">instance_remove</span></code> handler<a class="headerlink" href="#instance-remove-handler" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">instance_remove</span></code> handler does not have to perform anything other than
removing the instance from our list.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="n">test_instance_remove</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                                <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
                                <span class="n">anjay_iid_t</span> <span class="n">iid</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">anjay</span><span class="p">;</span> <span class="c1">// unused</span>
    <span class="n">test_object_t</span> <span class="o">*</span><span class="n">repr</span> <span class="o">=</span> <span class="n">get_test_object</span><span class="p">(</span><span class="n">obj_ptr</span><span class="p">);</span>

    <span class="n">AVS_LIST</span><span class="p">(</span><span class="n">test_instance_t</span><span class="p">)</span> <span class="o">*</span><span class="n">it</span><span class="p">;</span>
    <span class="n">AVS_LIST_FOREACH_PTR</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">repr</span><span class="o">-&gt;</span><span class="n">instances</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">it</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">iid</span> <span class="o">==</span> <span class="n">iid</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">AVS_LIST_DELETE</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// should never happen as Anjay checks whether instance is present</span>
    <span class="c1">// prior to issuing instance_remove</span>
    <span class="k">return</span> <span class="n">ANJAY_ERR_INTERNAL</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Complete code of this example can be found in
<cite>examples/tutorial/AT-CustomObjects/multi-instance-dynamic</cite> subdirectory
of main Anjay project repository.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="AT_CO_MultipleResourceInstances.html" class="btn btn-neutral float-right" title="5.4.6. Objects with Multiple Instance Resources" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="AT_CO_FixedInstanceWritable.html" class="btn btn-neutral float-left" title="5.4.4. Multi-instance writable object with fixed number of instances" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2017-2022, AVSystem.

    </p>
  </div> 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>