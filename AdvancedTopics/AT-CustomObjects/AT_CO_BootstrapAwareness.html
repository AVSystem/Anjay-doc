<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>5.4.7. Bootstrap awareness &mdash; Anjay 3.5.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="5.5. Network error handling" href="../AT-NetworkErrorHandling.html" />
    <link rel="prev" title="5.4.6. Objects with Multiple Instance Resources" href="AT_CO_MultipleResourceInstances.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #ffd500" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/avsystem_header.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                3.5.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../Introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LwM2M.html">2. OMA LwM2M - Brief description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Compiling_client_applications.html">3. Compiling client applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../BasicClient.html">4. Basic client</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../AdvancedTopics.html">5. Advanced topics</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../AT-AccessControl.html">5.1. Access Control in multi-server environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../AT-AttributeStorage.html">5.2. Attribute storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="../AT-Certificates.html">5.3. DTLS connection using certificates</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../AT-CustomObjects.html">5.4. Custom LwM2M objects</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="AT_CO_SingleInstanceReadOnly.html">5.4.1. Single-instance read-only object</a></li>
<li class="toctree-l3"><a class="reference internal" href="AT_CO_SingleInstanceExecutableAndReadOnly.html">5.4.2. Single-instance read-only object with an executable resource</a></li>
<li class="toctree-l3"><a class="reference internal" href="AT_CO_MultiInstanceReadOnlyFixed.html">5.4.3. Multi-instance read-only object with fixed number of instances</a></li>
<li class="toctree-l3"><a class="reference internal" href="AT_CO_FixedInstanceWritable.html">5.4.4. Multi-instance writable object with fixed number of instances</a></li>
<li class="toctree-l3"><a class="reference internal" href="AT_CO_MultiInstanceDynamic.html">5.4.5. Multi-instance writable object with dynamic number of instances</a></li>
<li class="toctree-l3"><a class="reference internal" href="AT_CO_MultipleResourceInstances.html">5.4.6. Objects with Multiple Instance Resources</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">5.4.7. Bootstrap awareness</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../AT-NetworkErrorHandling.html">5.5. Network error handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../AT-OtherFeatures.html">5.6. Other library features</a></li>
<li class="toctree-l2"><a class="reference internal" href="../AT-Persistence.html">5.7. Persistence support</a></li>
<li class="toctree-l2"><a class="reference internal" href="../AT-RetransmissionsTimeoutsCaching.html">5.8. Retransmissions, timeouts &amp; response caching</a></li>
<li class="toctree-l2"><a class="reference internal" href="../AT-CustomEventLoop.html">5.9. Custom event loop</a></li>
<li class="toctree-l2"><a class="reference internal" href="../AT-EventLoopNotes.html">5.10. Notes on event loop APIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../AT-IpsoObjects.html">5.11. Anjay IPSO Objects implementation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../FirmwareUpdateTutorial.html">6. Firmware Update Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tools.html">7. Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PortingGuideForNonPOSIXPlatforms.html">8. Porting guide for non-POSIX platforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Migrating.html">9. Migrating from older versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CommercialFeatures.html">10. Commercial features</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #ffd500" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Anjay</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../AdvancedTopics.html"><span class="section-number">5. </span>Advanced topics</a></li>
          <li class="breadcrumb-item"><a href="../AT-CustomObjects.html"><span class="section-number">5.4. </span>Custom LwM2M objects</a></li>
      <li class="breadcrumb-item active"><span class="section-number">5.4.7. </span>Bootstrap awareness</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="bootstrap-awareness">
<h1><span class="section-number">5.4.7. </span>Bootstrap awareness<a class="headerlink" href="#bootstrap-awareness" title="Permalink to this heading"></a></h1>
<p>In this tutorial you will learn how to setup Resources writable only by the
LwM2M Bootstrap Server.</p>
<section id="handling-lwm2m-bootstrap-server">
<h2><span class="section-number">5.4.7.1. </span>Handling LwM2M Bootstrap Server<a class="headerlink" href="#handling-lwm2m-bootstrap-server" title="Permalink to this heading"></a></h2>
<p>LwM2M Bootstrap Server is an unusual entity: it is allowed to modify Instances
and Resources not accessible to “regular” LwM2M Servers. That is useful for
setting up sensitive data that servers should not change (or even read) during
normal operation of the device - DTLS keys or certificates, for example.</p>
<p>Whenever a LwM2M Bootstrap Server sends a Bootstrap Write request, Anjay uses
the same <code class="docutils literal notranslate"><span class="pre">instance_create</span></code> and <code class="docutils literal notranslate"><span class="pre">resource_write</span></code> handlers as for “regular”
LwM2M Server operations. The only difference is that Anjay <em>ignores the
operations declared through the</em> <code class="docutils literal notranslate"><span class="pre">kind</span></code> <em>argument to</em> <code class="docutils literal notranslate"><span class="pre">anjay_dm_emit_res()</span></code>
<em>calls inside the</em> <code class="docutils literal notranslate"><span class="pre">list_resources</span></code> <em>handler</em> for bootstrap requests, allowing
Bootstrap Server to do anything it wants.</p>
<p>If a device has to implement a Resource that must only be writable by the LwM2M
Bootstrap Server, its handlers should be implemented like so:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">resource_write</span></code> handler must be able to set the value of a Resource,
as if it was a writable one,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">list_resources</span></code> handler should pass a <code class="docutils literal notranslate"><span class="pre">kind</span></code> argument that does not allow
writing to <code class="docutils literal notranslate"><span class="pre">anjay_dm_emit_res()</span></code>. That will prevent Anjay from calling the
<code class="docutils literal notranslate"><span class="pre">resource_write</span></code> handler for this particular Resource when the request is
issued by a non-bootstrap server.</p></li>
</ul>
</section>
<section id="example-bootstrap-writable-resource">
<h2><span class="section-number">5.4.7.2. </span>Example: bootstrap-writable Resource<a class="headerlink" href="#example-bootstrap-writable-resource" title="Permalink to this heading"></a></h2>
<p>As an example, we will modify the Test Object from
<a class="reference internal" href="AT_CO_FixedInstanceWritable.html"><span class="doc">Multi-instance writable object with fixed number of instances</span></a> to prevent changing the value of <code class="docutils literal notranslate"><span class="pre">Label</span></code>
Resource by non-bootstrap servers:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Object ID</p></th>
<th class="head"><p>Instances</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Test object</p></td>
<td><p>1234</p></td>
<td><p>Multiple</p></td>
</tr>
</tbody>
</table>
<p>Each Object Instance has two Resources:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Resource ID</p></th>
<th class="head"><p>Operations</p></th>
<th class="head"><p>Instances</p></th>
<th class="head"><p>Mandatory</p></th>
<th class="head"><p>Type</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Label</p></td>
<td><p>0</p></td>
<td><p>Read</p></td>
<td><p>Single</p></td>
<td><p>Mandatory</p></td>
<td><p>String</p></td>
</tr>
<tr class="row-odd"><td><p>Value</p></td>
<td><p>1</p></td>
<td><p>Read/Write</p></td>
<td><p>Single</p></td>
<td><p>Mandatory</p></td>
<td><p>Integer</p></td>
</tr>
</tbody>
</table>
<p>To achieve that, we need to update the <code class="docutils literal notranslate"><span class="pre">test_list_resources</span></code> handler so that
it disallows writing to Resource 0:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">test_list_resources</span><span class="p">(</span><span class="n">anjay_t</span><span class="w"> </span><span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
<span class="w">                               </span><span class="k">const</span><span class="w"> </span><span class="n">anjay_dm_object_def_t</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="w"> </span><span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
<span class="w">                               </span><span class="n">anjay_iid_t</span><span class="w"> </span><span class="n">iid</span><span class="p">,</span>
<span class="w">                               </span><span class="n">anjay_dm_resource_list_ctx_t</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ...</span>

<span class="w">    </span><span class="c1">// only allow reading Resource 0 by LwM2M Servers</span>
<span class="w">    </span><span class="c1">// this will be ignored for LwM2M Bootstrap Server</span>
<span class="w">    </span><span class="n">anjay_dm_emit_res</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">ANJAY_DM_RES_R</span><span class="p">,</span><span class="w"> </span><span class="n">ANJAY_DM_RES_PRESENT</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// Value Resource can be read/written by LwM2M Servers</span>
<span class="w">    </span><span class="n">anjay_dm_emit_res</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">ANJAY_DM_RES_RW</span><span class="p">,</span><span class="w"> </span><span class="n">ANJAY_DM_RES_PRESENT</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>That leaves one more issue with the example project: it has a pre-configured
LwM2M Server that is not a bootstrap one. Changing it to a LwM2M Bootstrap
Server is a matter of setting <code class="docutils literal notranslate"><span class="pre">bootstrap_server</span> <span class="pre">=</span> <span class="pre">true</span></code> on
<code class="docutils literal notranslate"><span class="pre">anjay_security_instance_t</span></code> struct when initializing the Security Object:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">const</span><span class="w"> </span><span class="n">anjay_security_instance_t</span><span class="w"> </span><span class="n">security_instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">ssid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">bootstrap_server</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">server_uri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;coap://eu.iot.avsystem.cloud:5693&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">security_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ANJAY_SECURITY_NOSEC</span>
<span class="p">};</span>
</pre></div>
</div>
<p>It is worth noting that the LwM2M Bootstrap Server has only a Security Object
instance and no Server Object instances. For that reason, the example project
deliberately does not initialize any Server Object Instances.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Complete code of this example can be found in
<cite>examples/tutorial/AT-CustomObjects/bootstrap-awareness</cite> subdirectory of main
Anjay project repository.</p>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="AT_CO_MultipleResourceInstances.html" class="btn btn-neutral float-left" title="5.4.6. Objects with Multiple Instance Resources" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../AT-NetworkErrorHandling.html" class="btn btn-neutral float-right" title="5.5. Network error handling" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017-2023, AVSystem.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>