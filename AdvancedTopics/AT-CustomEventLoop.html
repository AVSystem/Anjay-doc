<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>5.9. Custom event loop &mdash; Anjay 2.14.1 documentation</title><link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="5.10. Notes on event loop APIs" href="AT-EventLoopNotes.html" />
    <link rel="prev" title="5.8. Retransmissions, timeouts &amp; response caching" href="AT-RetransmissionsTimeoutsCaching.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #ffd500" >
            <a href="../index.html"><img src="../_static/avsystem_header.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                2.14.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LwM2M.html">2. OMA LwM2M - Brief description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Compiling_client_applications.html">3. Compiling client applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../BasicClient.html">4. Basic client</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../AdvancedTopics.html">5. Advanced topics</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="AT-AccessControl.html">5.1. Access Control in multi-server environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="AT-AttributeStorage.html">5.2. Attribute storage</a></li>
<li class="toctree-l2"><a class="reference internal" href="AT-Certificates.html">5.3. DTLS connection using certificates</a></li>
<li class="toctree-l2"><a class="reference internal" href="AT-CustomObjects.html">5.4. Custom LwM2M objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="AT-NetworkErrorHandling.html">5.5. Network error handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="AT-OtherFeatures.html">5.6. Other library features</a></li>
<li class="toctree-l2"><a class="reference internal" href="AT-Persistence.html">5.7. Persistence support</a></li>
<li class="toctree-l2"><a class="reference internal" href="AT-RetransmissionsTimeoutsCaching.html">5.8. Retransmissions, timeouts &amp; response caching</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">5.9. Custom event loop</a></li>
<li class="toctree-l2"><a class="reference internal" href="AT-EventLoopNotes.html">5.10. Notes on event loop APIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="AT-IpsoObjects.html">5.11. Anjay IPSO Objects implementation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../FirmwareUpdateTutorial.html">6. Firmware Update Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Tools.html">7. Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PortingGuideForNonPOSIXPlatforms.html">8. Porting guide for non-POSIX platforms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Migrating.html">9. Migrating from older versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Commercial_support.html">10. Commercial support</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #ffd500" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Anjay</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../AdvancedTopics.html"><span class="section-number">5. </span>Advanced topics</a> &raquo;</li>
      <li><span class="section-number">5.9. </span>Custom event loop</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="custom-event-loop">
<h1><span class="section-number">5.9. </span>Custom event loop<a class="headerlink" href="#custom-event-loop" title="Permalink to this headline">¶</a></h1>
<p>The <code class="docutils literal notranslate"><span class="pre">anjay_event_loop_run()</span></code> function that is used in other examples carries
out all the tasks necessary to handle events related to LwM2M. However, there
are scenarios in which you might not want to use this function, including:</p>
<ul class="simple">
<li><p>A strictly single-threaded application that needs to handle external input
other than LwM2M sockets</p></li>
<li><p>Use of a non-standard network socket layer that does not support <code class="docutils literal notranslate"><span class="pre">poll()</span></code>
or <code class="docutils literal notranslate"><span class="pre">select()</span></code> - the event loop API will not be available in that case</p></li>
<li><p>A need to perform other tasks within the LwM2M thread that cannot be modelled
using the scheduler API</p></li>
</ul>
<p>Anjay includes lower-level APIs that allow implementing the event loop by the
application programmer. In fact, that was the only way before Anjay 2.14.</p>
<p>The events that need to be handled in the event loop may come from a number of
sources:</p>
<ul class="simple">
<li><p>network packets from LwM2M Servers,</p></li>
<li><p>Anjay’s internal task scheduler,</p></li>
<li><p>external events specific to the client application.</p></li>
</ul>
<p>On POSIX compliant systems, a simple and portable way to handle all these events
is to use the <code class="docutils literal notranslate"><span class="pre">poll()</span></code> system call.</p>
<div class="section" id="incoming-network-packets">
<h2><span class="section-number">5.9.1. </span>Incoming network packets<a class="headerlink" href="#incoming-network-packets" title="Permalink to this headline">¶</a></h2>
<p>UDP sockets that Anjay uses to communicate with LwM2M Servers are accessible
via the <code class="docutils literal notranslate"><span class="pre">anjay_get_sockets()</span></code> call. All the used sockets are returned as an
<code class="docutils literal notranslate"><span class="pre">AVS_LIST</span></code> (implemented and documented in the <a class="reference external" href="https://github.com/AVSystem/avs_commons">AVSystem Commons Library</a>).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To retrieve a low-level operating system handle (on POSIX systems it is
a file descriptor) use the <code class="docutils literal notranslate"><span class="pre">avs_net_socket_get_system()</span></code> call.</p>
</div>
<p>When there is a new incoming packet on some socket, <code class="docutils literal notranslate"><span class="pre">anjay_serve()</span></code> shall
be called to handle it.</p>
<p>Therefore our first version of the event loop could look like this:</p>
<ol class="arabic simple" id="incomplete-event-loop-idea">
<li><p>Obtain all sources of incoming packets (i.e. server sockets) from the
library.</p></li>
<li><p>Call <code class="docutils literal notranslate"><span class="pre">poll()</span></code> on them and wait for an event to arrive.</p></li>
<li><p>When an event occurs, call <code class="docutils literal notranslate"><span class="pre">anjay_serve()</span></code> that will handle the message.</p></li>
</ol>
<p>Before doing that though, you should also understand a very important concept
Anjay is using, the task scheduler.</p>
</div>
<div class="section" id="task-scheduler">
<span id="id1"></span><h2><span class="section-number">5.9.2. </span>Task scheduler<a class="headerlink" href="#task-scheduler" title="Permalink to this headline">¶</a></h2>
<p>Anjay uses an internal scheduler for executing a number of tasks, including
automated sending of Registration Updates and notifications, among others.</p>
<p>During runtime, Anjay schedules jobs with specific deadlines, and
expects them to be executed when the right time comes – it is relying on
<code class="docutils literal notranslate"><span class="pre">anjay_sched_run()</span></code> being regularly invoked.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">anjay_sched_run()</span></code> iterates over the scheduled jobs (checking if some
of them should be run at this particular moment) and executes them if
necessary.</p>
<p>The requirement of regularly invoking <code class="docutils literal notranslate"><span class="pre">anjay_sched_run()</span></code> is a direct
consequence of Anjay being a single-threaded application. It is not a problem
however, as you may call <code class="docutils literal notranslate"><span class="pre">anjay_sched_run()</span></code> repeatedly in the main program
loop that you would have to write anyway.</p>
<p>A naive implementation could cause unnecessary waste of CPU time. This problem
is addressed by <code class="docutils literal notranslate"><span class="pre">anjay_sched_calculate_wait_time_ms()</span></code> which returns the
number of milliseconds before the next scheduled job - so, unless there is a
communication going on, it would be the amount of time the CPU can sleep. In the
next example we will use this value as a <code class="docutils literal notranslate"><span class="pre">poll()</span></code> timeout.</p>
</div>
<div class="section" id="event-loop-implementation">
<span id="basic-event-loop"></span><h2><span class="section-number">5.9.3. </span>Event loop implementation<a class="headerlink" href="#event-loop-implementation" title="Permalink to this headline">¶</a></h2>
<p>Taking into account previous subsections we could modify the event loop
presented <a class="reference internal" href="#incomplete-event-loop-idea"><span class="std std-ref">before</span></a> as follows:</p>
<ol class="arabic simple">
<li><p>Obtain all sources of incoming packets (i.e. server sockets) from the library.</p></li>
<li><p>Determine what is the expected time to the next job that has to be executed.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">poll()</span></code> to wait for the incoming communication event (but not for too
long, to prevent missing any pending scheduler jobs).</p></li>
<li><p>Call <code class="docutils literal notranslate"><span class="pre">anjay_serve()</span></code> on packet arrival, which will handle the message.</p></li>
<li><p>Run the scheduler by calling <code class="docutils literal notranslate"><span class="pre">anjay_sched_run()</span></code> to execute any outstanding
jobs.</p></li>
</ol>
<div class="topic">
<p class="topic-title">Wait, why do I have to repeatedly get the sources of packets?</p>
<p>There are at least two reasons for doing that:</p>
<ol class="arabic simple">
<li><p>At some point network error might have happened, forcing the library
to reconnect the socket, possibly changing its underlying descriptor.</p></li>
<li><p>The data model might have changed (for instance due to spontaneous Bootstrap
Write) and some Server were added / removed or their credentials were
modified.</p></li>
</ol>
</div>
<p>So, it could be written like this:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;anjay/anjay.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;anjay/attr_storage.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;anjay/security.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;anjay/server.h&gt;</span><span class="cp"></span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;avsystem/commons/avs_log.h&gt;</span><span class="cp"></span>

<span class="hll"><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;poll.h&gt;</span><span class="cp"></span>
</span><span class="hll">
</span><span class="hll"><span class="kt">int</span><span class="w"> </span><span class="nf">main_loop</span><span class="p">(</span><span class="n">anjay_t</span><span class="w"> </span><span class="o">*</span><span class="n">anjay</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="w">        </span><span class="c1">// Obtain all network data sources</span>
</span><span class="hll"><span class="w">        </span><span class="n">AVS_LIST</span><span class="p">(</span><span class="n">avs_net_socket_t</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="p">)</span><span class="w"> </span><span class="n">sockets</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">anjay_get_sockets</span><span class="p">(</span><span class="n">anjay</span><span class="p">);</span><span class="w"></span>
</span><span class="hll">
</span><span class="hll"><span class="w">        </span><span class="c1">// Prepare to poll() on them</span>
</span><span class="hll"><span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">numsocks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AVS_LIST_SIZE</span><span class="p">(</span><span class="n">sockets</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="w">        </span><span class="k">struct</span> <span class="nc">pollfd</span><span class="w"> </span><span class="n">pollfds</span><span class="p">[</span><span class="n">numsocks</span><span class="p">];</span><span class="w"></span>
</span><span class="hll"><span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="w">        </span><span class="n">AVS_LIST</span><span class="p">(</span><span class="n">avs_net_socket_t</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="p">)</span><span class="w"> </span><span class="n">sock</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="w">        </span><span class="n">AVS_LIST_FOREACH</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span><span class="w"> </span><span class="n">sockets</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="w">            </span><span class="n">pollfds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">avs_net_socket_get_system</span><span class="p">(</span><span class="o">*</span><span class="n">sock</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="w">            </span><span class="n">pollfds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">events</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">POLLIN</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="w">            </span><span class="n">pollfds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">revents</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="w">            </span><span class="o">++</span><span class="n">i</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="w">        </span><span class="p">}</span><span class="w"></span>
</span><span class="hll">
</span><span class="hll"><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">max_wait_time_ms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="w">        </span><span class="c1">// Determine the expected time to the next job in milliseconds.</span>
</span><span class="hll"><span class="w">        </span><span class="c1">// If there is no job we will wait till something arrives for</span>
</span><span class="hll"><span class="w">        </span><span class="c1">// at most 1 second (i.e. max_wait_time_ms).</span>
</span><span class="hll"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">wait_ms</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
</span><span class="hll"><span class="w">                </span><span class="n">anjay_sched_calculate_wait_time_ms</span><span class="p">(</span><span class="n">anjay</span><span class="p">,</span><span class="w"> </span><span class="n">max_wait_time_ms</span><span class="p">);</span><span class="w"></span>
</span><span class="hll">
</span><span class="hll"><span class="w">        </span><span class="c1">// Wait for the events if necessary, and handle them.</span>
</span><span class="hll"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">poll</span><span class="p">(</span><span class="n">pollfds</span><span class="p">,</span><span class="w"> </span><span class="n">numsocks</span><span class="p">,</span><span class="w"> </span><span class="n">wait_ms</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">socket_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="w">            </span><span class="n">AVS_LIST</span><span class="p">(</span><span class="n">avs_net_socket_t</span><span class="w"> </span><span class="o">*</span><span class="k">const</span><span class="p">)</span><span class="w"> </span><span class="n">socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="w">            </span><span class="n">AVS_LIST_FOREACH</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="n">sockets</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pollfds</span><span class="p">[</span><span class="n">socket_id</span><span class="p">].</span><span class="n">revents</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">anjay_serve</span><span class="p">(</span><span class="n">anjay</span><span class="p">,</span><span class="w"> </span><span class="o">*</span><span class="n">socket</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="w">                        </span><span class="n">avs_log</span><span class="p">(</span><span class="n">tutorial</span><span class="p">,</span><span class="w"> </span><span class="n">ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;anjay_serve failed&quot;</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="w">                    </span><span class="p">}</span><span class="w"></span>
</span><span class="hll"><span class="w">                </span><span class="p">}</span><span class="w"></span>
</span><span class="hll"><span class="w">                </span><span class="o">++</span><span class="n">socket_id</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="w">            </span><span class="p">}</span><span class="w"></span>
</span><span class="hll"><span class="w">        </span><span class="p">}</span><span class="w"></span>
</span><span class="hll">
</span><span class="hll"><span class="w">        </span><span class="c1">// Finally run the scheduler</span>
</span><span class="hll"><span class="w">        </span><span class="n">anjay_sched_run</span><span class="p">(</span><span class="n">anjay</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span class="hll"><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="p">}</span><span class="w"></span>
</span>
<span class="c1">// Installs Security Object and adds and instance of it.</span>
<span class="c1">// An instance of Security Object provides information needed to connect to</span>
<span class="c1">// LwM2M server.</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">setup_security_object</span><span class="p">(</span><span class="n">anjay_t</span><span class="w"> </span><span class="o">*</span><span class="n">anjay</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">anjay_security_object_install</span><span class="p">(</span><span class="n">anjay</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">PSK_IDENTITY</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;identity&quot;</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">PSK_KEY</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;P4s$w0rd&quot;</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">anjay_security_instance_t</span><span class="w"> </span><span class="n">security_instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">ssid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">server_uri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;coaps://try-anjay.avsystem.com:5684&quot;</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">security_mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ANJAY_SECURITY_PSK</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">public_cert_or_psk_identity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">PSK_IDENTITY</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">public_cert_or_psk_identity_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">PSK_IDENTITY</span><span class="p">),</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">private_cert_or_psk_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">PSK_KEY</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">private_cert_or_psk_key_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">PSK_KEY</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Anjay will assign Instance ID automatically</span>
<span class="w">    </span><span class="n">anjay_iid_t</span><span class="w"> </span><span class="n">security_instance_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ANJAY_ID_INVALID</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">anjay_security_object_add_instance</span><span class="p">(</span><span class="n">anjay</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">security_instance</span><span class="p">,</span><span class="w"></span>
<span class="w">                                           </span><span class="o">&amp;</span><span class="n">security_instance_id</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="c1">// Installs Server Object and adds and instance of it.</span>
<span class="c1">// An instance of Server Object provides the data related to a LwM2M Server.</span>
<span class="k">static</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">setup_server_object</span><span class="p">(</span><span class="n">anjay_t</span><span class="w"> </span><span class="o">*</span><span class="n">anjay</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">anjay_server_object_install</span><span class="p">(</span><span class="n">anjay</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">anjay_server_instance_t</span><span class="w"> </span><span class="n">server_instance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Server Short ID</span>
<span class="w">        </span><span class="p">.</span><span class="n">ssid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Client will send Update message often than every 60 seconds</span>
<span class="w">        </span><span class="p">.</span><span class="n">lifetime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">60</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Disable Default Minimum Period resource</span>
<span class="w">        </span><span class="p">.</span><span class="n">default_min_period</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Disable Default Maximum Period resource</span>
<span class="w">        </span><span class="p">.</span><span class="n">default_max_period</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Disable Disable Timeout resource</span>
<span class="w">        </span><span class="p">.</span><span class="n">disable_timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="c1">// Sets preferred transport to UDP</span>
<span class="w">        </span><span class="p">.</span><span class="n">binding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;U&quot;</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="c1">// Anjay will assign Instance ID automatically</span>
<span class="w">    </span><span class="n">anjay_iid_t</span><span class="w"> </span><span class="n">server_instance_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ANJAY_ID_INVALID</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">anjay_server_object_add_instance</span><span class="p">(</span><span class="n">anjay</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">server_instance</span><span class="p">,</span><span class="w"></span>
<span class="w">                                         </span><span class="o">&amp;</span><span class="n">server_instance_id</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">argc</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">avs_log</span><span class="p">(</span><span class="n">tutorial</span><span class="p">,</span><span class="w"> </span><span class="n">ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;usage: %s ENDPOINT_NAME&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">anjay_configuration_t</span><span class="w"> </span><span class="n">CONFIG</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">endpoint_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">in_buffer_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4000</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">out_buffer_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4000</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="p">.</span><span class="n">msg_cache_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">4000</span><span class="w"></span>
<span class="w">    </span><span class="p">};</span><span class="w"></span>

<span class="w">    </span><span class="n">anjay_t</span><span class="w"> </span><span class="o">*</span><span class="n">anjay</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">anjay_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">CONFIG</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">anjay</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">avs_log</span><span class="p">(</span><span class="n">tutorial</span><span class="p">,</span><span class="w"> </span><span class="n">ERROR</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Could not create Anjay object&quot;</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="c1">// Install Attribute storage and setup necessary objects</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">anjay_attr_storage_install</span><span class="p">(</span><span class="n">anjay</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">setup_security_object</span><span class="p">(</span><span class="n">anjay</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="o">||</span><span class="w"> </span><span class="n">setup_server_object</span><span class="p">(</span><span class="n">anjay</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="w">        </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">main_loop</span><span class="p">(</span><span class="n">anjay</span><span class="p">);</span><span class="w"></span>
</span><span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">anjay_delete</span><span class="p">(</span><span class="n">anjay</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Complete code of this example can be found in
<cite>examples/tutorial/AT-CustomEventLoop</cite> subdirectory of main Anjay project
repository.</p>
</div>
<p>As we’ve been discussing, the code above is enough to handle all events that
may happen within the Anjay library itself. Of course, the application usually
needs to handle its own functionality, this is however outside of the scope of
this tutorial, but the presented code may be used as a good starting point.</p>
</div>
<div class="section" id="anjay-serve-any">
<h2><span class="section-number">5.9.4. </span>anjay_serve_any()<a class="headerlink" href="#anjay-serve-any" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="../api/core_8h.html#ac436ac24095cb10ef008c8fd91126b31">anjay_serve_any()</a> is
a simplified API that allows writing a simple event loop that the user retains
control of.</p>
<p>As mentioned in the API documentation, any
<code class="docutils literal notranslate"><span class="pre">anjay_event_loop_run(anjay,</span> <span class="pre">max_wait_time)</span></code> call may be translated into:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="nb">true</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">anjay_serve_any</span><span class="p">(</span><span class="n">anjay</span><span class="p">,</span><span class="w"> </span><span class="n">max_wait_time</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">anjay_sched_run</span><span class="p">(</span><span class="n">anjay</span><span class="p">);</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>The above is true as long as <code class="docutils literal notranslate"><span class="pre">anjay_event_loop_interrupt()</span></code> is never called -
in this variant, <code class="docutils literal notranslate"><span class="pre">anjay_event_loop_interrupt()</span></code> is not handled at all and the
user is fully responsible for introducing exit mechanisms if needed.</p>
<p>Please note that <code class="docutils literal notranslate"><span class="pre">anjay_serve_any()</span></code> depends on at least one of the <code class="docutils literal notranslate"><span class="pre">poll()</span></code>
or <code class="docutils literal notranslate"><span class="pre">select()</span></code> functions being available, so this is not a feasible solution
for non-standard network socket layers.</p>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="AT-RetransmissionsTimeoutsCaching.html" class="btn btn-neutral float-left" title="5.8. Retransmissions, timeouts &amp; response caching" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="AT-EventLoopNotes.html" class="btn btn-neutral float-right" title="5.10. Notes on event loop APIs" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017-2021, AVSystem.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>