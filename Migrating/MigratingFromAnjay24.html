<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>9.3. Migrating from Anjay 2.3.x or 2.4.x &mdash; Anjay 3.8.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=86f27845" />
      <link rel="stylesheet" type="text/css" href="../_static/theme_overrides.css?v=b9c2c5b9" />

  
  
        <script src="../_static/jquery.js?v=8dae8fb0"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=30f795a6"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="9.4. Migrating from Anjay 2.5.x or 2.6.x" href="MigratingFromAnjay26.html" />
    <link rel="prev" title="9.2. Migrating mbed TLS custom entropy initializers" href="MigratingCustomEntropy.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #ffd500" >

          
          
          <a href="../index.html">
            
              <img src="../_static/avsystem_header.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                3.8.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LwM2M.html">2. OMA LwM2M - Brief description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Compiling_client_applications.html">3. Compiling client applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../BasicClient.html">4. Basic client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../AdvancedTopics.html">5. Advanced topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FirmwareUpdateTutorial.html">6. Firmware Update Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Tools.html">7. Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PortingGuideForNonPOSIXPlatforms.html">8. Porting guide for non-POSIX platforms</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../Migrating.html">9. Migrating from older versions</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="MigratingFromAnjay225.html">9.1. Migrating from Anjay 2.2.5</a></li>
<li class="toctree-l2"><a class="reference internal" href="MigratingCustomEntropy.html">9.2. Migrating mbed TLS custom entropy initializers</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">9.3. Migrating from Anjay 2.3.x or 2.4.x</a></li>
<li class="toctree-l2"><a class="reference internal" href="MigratingFromAnjay26.html">9.4. Migrating from Anjay 2.5.x or 2.6.x</a></li>
<li class="toctree-l2"><a class="reference internal" href="MigratingFromAnjay27.html">9.5. Migrating from Anjay 2.7.x</a></li>
<li class="toctree-l2"><a class="reference internal" href="MigratingFromAnjay28.html">9.6. Migrating from Anjay 2.8.x</a></li>
<li class="toctree-l2"><a class="reference internal" href="MigratingFromAnjay214.html">9.7. Migrating from Anjay 2.9.x-2.14.x</a></li>
<li class="toctree-l2"><a class="reference internal" href="MigratingFromAnjay215.html">9.8. Migrating from Anjay 2.15.x</a></li>
<li class="toctree-l2"><a class="reference internal" href="MigratingFromAnjay30.html">9.9. Migrating from Anjay 3.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="MigratingFromAnjay32.html">9.10. Migrating from Anjay 3.1 or 3.2</a></li>
<li class="toctree-l2"><a class="reference internal" href="MigratingFromAnjay33.html">9.11. Migrating from Anjay 3.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="MigratingFromAnjay34.html">9.12. Migrating from Anjay 3.4</a></li>
<li class="toctree-l2"><a class="reference internal" href="MigratingFromAnjay37.html">9.13. Migrating from Anjay 3.7</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../CommercialFeatures.html">10. Commercial features</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #ffd500" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Anjay</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../Migrating.html"><span class="section-number">9. </span>Migrating from older versions</a></li>
      <li class="breadcrumb-item active"><span class="section-number">9.3. </span>Migrating from Anjay 2.3.x or 2.4.x</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="migrating-from-anjay-2-3-x-or-2-4-x">
<h1><span class="section-number">9.3. </span>Migrating from Anjay 2.3.x or 2.4.x<a class="headerlink" href="#migrating-from-anjay-2-3-x-or-2-4-x" title="Link to this heading"></a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#introduction" id="id1">Introduction</a></p></li>
<li><p><a class="reference internal" href="#change-to-minimum-cmake-version" id="id2">Change to minimum CMake version</a></p></li>
<li><p><a class="reference internal" href="#changes-in-anjay-proper" id="id3">Changes in Anjay proper</a></p>
<ul>
<li><p><a class="reference internal" href="#change-of-security-configuration-lifetime" id="id4">Change of security configuration lifetime</a></p></li>
<li><p><a class="reference internal" href="#refactor-of-the-attribute-storage-module" id="id5">Refactor of the Attribute Storage module</a></p></li>
<li><p><a class="reference internal" href="#refactor-of-offline-mode-control-api" id="id6">Refactor of offline mode control API</a></p></li>
<li><p><a class="reference internal" href="#addition-of-the-con-attribute-to-public-api" id="id7">Addition of the con attribute to public API</a></p></li>
<li><p><a class="reference internal" href="#default-d-tls-version" id="id8">Default (D)TLS version</a></p></li>
<li><p><a class="reference internal" href="#persistence-of-disabled-servers" id="id9">Persistence of disabled servers</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#changes-in-avs-coap" id="id10">Changes in avs_coap</a></p>
<ul>
<li><p><a class="reference internal" href="#changed-flow-of-cancelling-observations-in-case-of-errors" id="id11">Changed flow of cancelling observations in case of errors</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#changes-in-avs-commons" id="id12">Changes in avs_commons</a></p>
<ul>
<li><p><a class="reference internal" href="#move-of-public-key-cryptography-apis-from-avs-net-to-avs-crypto" id="id13">Move of public-key cryptography APIs from avs_net to avs_crypto</a></p>
<ul>
<li><p><a class="reference internal" href="#renamed-cmake-configuration-options" id="id14">Renamed CMake configuration options</a></p></li>
<li><p><a class="reference internal" href="#renamed-configuration-macros-in-avs-commons-config-h" id="id15">Renamed configuration macros in avs_commons_config.h</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#introduction-of-new-socket-option" id="id16">Introduction of new socket option</a></p></li>
<li><p><a class="reference internal" href="#refactor-of-psk-credential-handling" id="id17">Refactor of PSK credential handling</a></p></li>
<li><p><a class="reference internal" href="#separation-of-avs-url-module" id="id18">Separation of avs_url module</a></p></li>
<li><p><a class="reference internal" href="#refactor-of-avs-net-validate-ip-address-and-avs-net-local-address-for-target-host" id="id19">Refactor of avs_net_validate_ip_address() and avs_net_local_address_for_target_host()</a></p></li>
<li><p><a class="reference internal" href="#refactor-of-time-handling-in-avs-sched-and-avs-coap" id="id20">Refactor of time handling in avs_sched and avs_coap</a></p></li>
<li><p><a class="reference internal" href="#removal-of-avs-unit-memstream" id="id21">Removal of avs_unit_memstream</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="introduction">
<h2><a class="toc-backref" href="#id1" role="doc-backlink"><span class="section-number">9.3.1. </span>Introduction</a><a class="headerlink" href="#introduction" title="Link to this heading"></a></h2>
<p>While most changes since Anjay 2.4 are minor, some of them (changes to commonly
used APIs such as Attribute Storage and offline mode control) are breaking.
Additionally, <code class="docutils literal notranslate"><span class="pre">avs_commons</span></code> cryptography support libraries have undergone a
significant redesign and there are some changes which might prove to be breaking
if old APIs have been used directly.</p>
<p>Additional slight updates might be necessary if you are using any alternative
build system instead of CMake to compile your project, of if you maintain your
own implementation of the socket layer.</p>
</section>
<section id="change-to-minimum-cmake-version">
<h2><a class="toc-backref" href="#id2" role="doc-backlink"><span class="section-number">9.3.2. </span>Change to minimum CMake version</a><a class="headerlink" href="#change-to-minimum-cmake-version" title="Link to this heading"></a></h2>
<p>Declared minimum CMake version necessary for CMake-based compilation, as well as
for importing the installed library through <code class="docutils literal notranslate"><span class="pre">find_package()</span></code>, is now 3.6. If
you’re using some Linux distribution that only has an older version in its
repositories (notably, Ubuntu 16.04), we recommend using one of the following
install methods instead:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://apt.kitware.com/">Kitware APT Repository for Debian and Ubuntu</a></p></li>
<li><p><a class="reference external" href="https://snapcraft.io/cmake">Snap Store</a> (<code class="docutils literal notranslate"><span class="pre">snap</span> <span class="pre">install</span> <span class="pre">cmake</span></code>)</p></li>
<li><p><a class="reference external" href="https://pypi.org/project/cmake/">Python Package Index</a>
(<code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">cmake</span></code>)</p></li>
</ul>
<p>This change does not affect users who compile the library using some alternative
approach, without using the provided CMake scripts.</p>
</section>
<section id="changes-in-anjay-proper">
<h2><a class="toc-backref" href="#id3" role="doc-backlink"><span class="section-number">9.3.3. </span>Changes in Anjay proper</a><a class="headerlink" href="#changes-in-anjay-proper" title="Link to this heading"></a></h2>
<section id="change-of-security-configuration-lifetime">
<h3><a class="toc-backref" href="#id4" role="doc-backlink"><span class="section-number">9.3.3.1. </span>Change of security configuration lifetime</a><a class="headerlink" href="#change-of-security-configuration-lifetime" title="Link to this heading"></a></h3>
<ul>
<li><p><strong>Getter function for retrieving security information from data model</strong></p>
<ul>
<li><p><strong>Old API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">anjay_security_config_t</span><span class="w"> </span><span class="o">*</span><span class="nf">anjay_security_config_from_dm</span><span class="p">(</span><span class="n">anjay_t</span><span class="w"> </span><span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
<span class="w">                                                       </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">uri</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p><strong>New API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">anjay_security_config_from_dm</span><span class="p">(</span><span class="n">anjay_t</span><span class="w"> </span><span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
<span class="w">                                  </span><span class="n">anjay_security_config_t</span><span class="w"> </span><span class="o">*</span><span class="n">out_config</span><span class="p">,</span>
<span class="w">                                  </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">uri</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>The security configuration is now returned through an output argument with
any necessary internal buffers cached inside the Anjay object instead of
using heap allocation. Please refer to the Doxygen-based documentation of
this function for details.</p>
<p>Due to the change in lifetime requirements, no compatibility variant is
provided.</p>
</li>
</ul>
</li>
</ul>
</section>
<section id="refactor-of-the-attribute-storage-module">
<h3><a class="toc-backref" href="#id5" role="doc-backlink"><span class="section-number">9.3.3.2. </span>Refactor of the Attribute Storage module</a><a class="headerlink" href="#refactor-of-the-attribute-storage-module" title="Link to this heading"></a></h3>
<p>The Attribute Storage feature is no longer a standalone module and has been
moved to the library core. From the user perspective, this has the following
consequences:</p>
<ul class="simple">
<li><p>Explicit installation of this module in runtime is no longer necessary. The
<code class="docutils literal notranslate"><span class="pre">anjay_attr_storage_install()</span></code> method has been removed.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">ANJAY_WITH_MODULE_ATTR_STORAGE</span></code> configuration macro in
<code class="docutils literal notranslate"><span class="pre">anjay_config.h</span></code> has been renamed to <code class="docutils literal notranslate"><span class="pre">ANJAY_WITH_ATTR_STORAGE</span></code>.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">WITH_MODULE_attr_storage</span></code> CMake option (equivalent to the macro
mentioned above) has been renamed to <code class="docutils literal notranslate"><span class="pre">WITH_ATTR_STORAGE</span></code>.</p></li>
</ul>
<p>Additionally, the behavior of <code class="docutils literal notranslate"><span class="pre">anjay_attr_storage_restore()</span></code> has been
changed - from now on, this function fails if supplied source stream is
invalid and the Attribute Storage remains untouched. This change makes the
function consistent with other <code class="docutils literal notranslate"><span class="pre">anjay_*_restore()</span></code> APIs.</p>
</section>
<section id="refactor-of-offline-mode-control-api">
<h3><a class="toc-backref" href="#id6" role="doc-backlink"><span class="section-number">9.3.3.3. </span>Refactor of offline mode control API</a><a class="headerlink" href="#refactor-of-offline-mode-control-api" title="Link to this heading"></a></h3>
<p>Since Anjay 2.4, offline mode is configurable independently per every
transport. Below is a list of removed functions and counterparts that should
be used:</p>
<table class="docutils align-default">
<tbody>
<tr class="row-odd"><td><p>Removed function</p></td>
<td><p>Counterpart</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">anjay_is_offline()</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">anjay_transport_is_offline()</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">anjay_enter_offline()</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">anjay_transport_enter_offline()</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">anjay_exit_offline()</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">anjay_transport_exit_offline()</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">anjay_schedule_reconnect()</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">anjay_transport_schedule_reconnect()</span></code></p></td>
</tr>
</tbody>
</table>
<p>New functions should be called with <code class="docutils literal notranslate"><span class="pre">transport_set</span></code> argument set to
<code class="docutils literal notranslate"><span class="pre">ANJAY_TRANSPORT_SET_ALL</span></code> to achieve the same behavior.</p>
</section>
<section id="addition-of-the-con-attribute-to-public-api">
<h3><a class="toc-backref" href="#id7" role="doc-backlink"><span class="section-number">9.3.3.4. </span>Addition of the con attribute to public API</a><a class="headerlink" href="#addition-of-the-con-attribute-to-public-api" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">con</span></code> attribute, enabled via the <code class="docutils literal notranslate"><span class="pre">ANJAY_WITH_CON_ATTR</span></code> compile-time
option, has been previously supported as a custom extension. Since an identical
flag has been standardized as part of LwM2M TS 1.2, it has been included in the
public API as part of preparations to support the new protocol version.</p>
<p>If you initialize <code class="docutils literal notranslate"><span class="pre">anjay_dm_oi_attributes_t</span></code> or <code class="docutils literal notranslate"><span class="pre">anjay_dm_r_attributes_t</span></code>
objects manually, you may need to initialize the new <code class="docutils literal notranslate"><span class="pre">con</span></code> field as well,
since the empty <code class="docutils literal notranslate"><span class="pre">ANJAY_DM_CON_ATTR_NONE</span></code> value is <strong>NOT</strong> the default
zero-initialized value.</p>
<p>As more new attributes may be added in future versions of Anjay, it is
recommended to initialize such structures with <code class="docutils literal notranslate"><span class="pre">ANJAY_DM_OI_ATTRIBUTES_EMPTY</span></code>
or <code class="docutils literal notranslate"><span class="pre">ANJAY_DM_R_ATTRIBUTES_EMPTY</span></code> constants, and then fill in the attributes
you actually intend to set.</p>
</section>
<section id="default-d-tls-version">
<h3><a class="toc-backref" href="#id8" role="doc-backlink"><span class="section-number">9.3.3.5. </span>Default (D)TLS version</a><a class="headerlink" href="#default-d-tls-version" title="Link to this heading"></a></h3>
<p>When the <a class="reference external" href="../api/structanjay__configuration.html#ab32477e7370a36e02db5b7e7ccbdd89d">anjay_configuration_t::dtls_version</a>
field is set to <code class="docutils literal notranslate"><span class="pre">AVS_NET_SSL_VERSION_DEFAULT</span></code> (which includes the case of
zero-initialization), Anjay 3.0 and earlier automatically mapped this setting to
<code class="docutils literal notranslate"><span class="pre">AVS_NET_SSL_VERSION_TLSv1_2</span></code> to ensure that (D)TLS 1.2 is used as mandated by
the LwM2M specification.</p>
<p>This mapping has been removed in Anjay 3.1, which means that the default version
configuration of the underlying (D)TLS library will be used. This has been done
to automatically allow the use of newer protocols and deprecate old versions
when the backend library is updated, without the need to update Anjay code.
However, depending on the (D)TLS backend library used, this may lead to (D)TLS
1.1 or earlier being used if the server does not properly negotiate a higher
version. Please explicitly set <code class="docutils literal notranslate"><span class="pre">dtls_version</span></code> to
<code class="docutils literal notranslate"><span class="pre">AVS_NET_SSL_VERSION_TLSv1_2</span></code> if you want to disallow this.</p>
<p>Please note that Mbed TLS 3.0 has dropped support for TLS 1.1 and earlier, so
this change will not affect behavior with that library.</p>
</section>
<section id="persistence-of-disabled-servers">
<h3><a class="toc-backref" href="#id9" role="doc-backlink"><span class="section-number">9.3.3.6. </span>Persistence of disabled servers</a><a class="headerlink" href="#persistence-of-disabled-servers" title="Link to this heading"></a></h3>
<p>Core Persistence API (<code class="docutils literal notranslate"><span class="pre">anjay_new_from_core_persistence()</span></code>,
<code class="docutils literal notranslate"><span class="pre">anjay_delete_with_core_persistence()</span></code>) now also persists disabled servers
(either by execution of /1/x/4 or call to function from
<code class="docutils literal notranslate"><span class="pre">anjay_disable_server*()</span></code> family) and the time at which the client shall
reconnect them. Previously those disabled servers weren’t persisted at all and
freshly initialized client was automatically connecting to them without any
regard for specified timeout.</p>
</section>
</section>
<section id="changes-in-avs-coap">
<h2><a class="toc-backref" href="#id10" role="doc-backlink"><span class="section-number">9.3.4. </span>Changes in avs_coap</a><a class="headerlink" href="#changes-in-avs-coap" title="Link to this heading"></a></h2>
<section id="changed-flow-of-cancelling-observations-in-case-of-errors">
<h3><a class="toc-backref" href="#id11" role="doc-backlink"><span class="section-number">9.3.4.1. </span>Changed flow of cancelling observations in case of errors</a><a class="headerlink" href="#changed-flow-of-cancelling-observations-in-case-of-errors" title="Link to this heading"></a></h3>
<p>CoAP observations are implicitly cancelled if a notification bearing a 4.xx or
5.xx error code is delivered.</p>
<p>In Anjay 3.4.x and earlier, this cancellation (which involves calling the
<code class="docutils literal notranslate"><span class="pre">avs_coap_observe_cancel_handler_t</span></code> callback) was performed <em>before</em> calling
the <code class="docutils literal notranslate"><span class="pre">avs_coap_delivery_status_handler_t</span></code> callback for the specific
notification. Since Anjay 3.5.0, this order is reversed, so any code that relies
on this logic may break.</p>
<p>This change is only relevant if you are using <code class="docutils literal notranslate"><span class="pre">avs_coap</span></code> APIs directly (e.g.
when communicating over raw CoAP protocol) and in case of notifications intended
to be delivered as confirmable. The LwM2M Observe/Notify implementation in Anjay
has been updated accordingly.</p>
</section>
</section>
<section id="changes-in-avs-commons">
<h2><a class="toc-backref" href="#id12" role="doc-backlink"><span class="section-number">9.3.5. </span>Changes in avs_commons</a><a class="headerlink" href="#changes-in-avs-commons" title="Link to this heading"></a></h2>
<section id="move-of-public-key-cryptography-apis-from-avs-net-to-avs-crypto">
<h3><a class="toc-backref" href="#id13" role="doc-backlink"><span class="section-number">9.3.5.1. </span>Move of public-key cryptography APIs from avs_net to avs_crypto</a><a class="headerlink" href="#move-of-public-key-cryptography-apis-from-avs-net-to-avs-crypto" title="Link to this heading"></a></h3>
<p>Public key cryptography APIs, previously defined in
<code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_socket.h</span></code>, have been moved into a new header called
<code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_crypto_pki.h</span></code>.</p>
<p>Additionally, client-side and server-side certificate info structures are no
longer separate, and both have been merged into a single type.</p>
<p>Here is a summary of renames:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Old symbol name</p></th>
<th class="head"><p>New symbol name</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">avs_net_trusted_cert_info_t</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">avs_net_client_cert_info_t</span></code></div>
</div>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">avs_crypto_certificate_chain_info_t</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">avs_net_client_key_info_t</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avs_crypto_private_key_info_t</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">avs_net_security_info_union_t</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avs_crypto_security_info_union_t</span></code></p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">avs_net_trusted_cert_info_from_buffer()</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">avs_net_client_cert_info_from_buffer()</span></code></div>
</div>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">avs_crypto_certificate_chain_info_from_buffer()</span></code></p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">avs_net_trusted_cert_info_from_file()</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">avs_net_client_cert_info_from_file()</span></code></div>
</div>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">avs_crypto_certificate_chain_info_from_file()</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">avs_net_client_key_info_from_buffer()</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avs_crypto_private_key_info_from_buffer()</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">avs_net_client_key_info_from_file()</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avs_crypto_private_key_info_from_file()</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">avs_net_trusted_cert_info_from_path()</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avs_crypto_certificate_chain_info_from_path()</span></code></p></td>
</tr>
</tbody>
</table>
<section id="renamed-cmake-configuration-options">
<h4><a class="toc-backref" href="#id14" role="doc-backlink"><span class="section-number">9.3.5.1.1. </span>Renamed CMake configuration options</a><a class="headerlink" href="#renamed-cmake-configuration-options" title="Link to this heading"></a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">WITH_X509</span></code> CMake configuration option has been removed; the new
equivalent option is <code class="docutils literal notranslate"><span class="pre">WITH_PKI</span></code>. Please update CMake invocations in your
configuration scripts.</p>
</section>
<section id="renamed-configuration-macros-in-avs-commons-config-h">
<h4><a class="toc-backref" href="#id15" role="doc-backlink"><span class="section-number">9.3.5.1.2. </span>Renamed configuration macros in avs_commons_config.h</a><a class="headerlink" href="#renamed-configuration-macros-in-avs-commons-config-h" title="Link to this heading"></a></h4>
<p>The following configuration macros in <code class="docutils literal notranslate"><span class="pre">avs_commons_config.h</span></code> has been renamed.
You may need to update your configuration files if you are not using CMake, or
your preprocessor directives if you check these macros in your code:</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Old macro name</p></th>
<th class="head"><p>New macro name</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">AVS_COMMONS_NET_WITH_PSK</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">AVS_COMMONS_WITH_AVS_CRYPTO_PSK</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">AVS_COMMONS_NET_WITH_X509</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">AVS_COMMONS_WITH_AVS_CRYPTO_PKI</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">AVS_COMMONS_NET_WITH_VALGRIND</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">AVS_COMMONS_WITH_AVS_CRYPTO_VALGRIND</span></code></p></td>
</tr>
</tbody>
</table>
</section>
</section>
<section id="introduction-of-new-socket-option">
<h3><a class="toc-backref" href="#id16" role="doc-backlink"><span class="section-number">9.3.5.2. </span>Introduction of new socket option</a><a class="headerlink" href="#introduction-of-new-socket-option" title="Link to this heading"></a></h3>
<p>avs_commons 4.10.1 bundled with Anjay 2.15.1 adds a new socket option key:
<code class="docutils literal notranslate"><span class="pre">AVS_NET_SOCKET_HAS_BUFFERED_DATA</span></code>. This is used to make sure that when
control is returned to the event loop, the <code class="docutils literal notranslate"><span class="pre">poll()</span></code> call will not stall
waiting for new data that in reality has been already buffered and could be
retrieved using the avs_commons APIs.</p>
<p>This is usually meaningful for (D)TLS connections, but for almost all simple
unencrypted socket implementations, this should always return <code class="docutils literal notranslate"><span class="pre">false</span></code>.</p>
<p>This was previously achieved by always trying to receive more packets with
timeout set to zero. However, it has been determined that such logic could lead
to heavy blocking of the event loop in case communication with the network stack
is relatively slow, e.g. on devices which implement TCP/IP sockets through modem
AT commands.</p>
<p>If you maintain your own socket integration layer or (D)TLS integration layer,
it is recommended that you add support for this option. This is not, however, a
breaking change - if the option is not supported, the library will continue to
use the old behavior.</p>
</section>
<section id="refactor-of-psk-credential-handling">
<h3><a class="toc-backref" href="#id17" role="doc-backlink"><span class="section-number">9.3.5.3. </span>Refactor of PSK credential handling</a><a class="headerlink" href="#refactor-of-psk-credential-handling" title="Link to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">avs_net_psk_info_t</span></code> structure has been changed to use new types based on
<code class="docutils literal notranslate"><span class="pre">avs_crypto_security_info_union_t</span></code> instead of raw buffers. This change also
affects <code class="docutils literal notranslate"><span class="pre">avs_net_security_info_t</span></code> structure which contains the former.</p>
<ul>
<li><p><strong>Old API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * A PSK/identity pair with borrowed pointers. avs_commons will never attempt</span>
<span class="cm"> * to modify these values.</span>
<span class="cm"> */</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">psk</span><span class="p">;</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">psk_size</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">identity</span><span class="p">;</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">identity_size</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">avs_net_psk_info_t</span><span class="p">;</span>

<span class="c1">// ...</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">avs_net_security_mode_t</span><span class="w"> </span><span class="n">mode</span><span class="p">;</span>
<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">avs_net_psk_info_t</span><span class="w"> </span><span class="n">psk</span><span class="p">;</span>
<span class="w">        </span><span class="n">avs_net_certificate_info_t</span><span class="w"> </span><span class="n">cert</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">avs_net_security_info_t</span><span class="p">;</span>

<span class="n">avs_net_security_info_t</span><span class="w"> </span><span class="nf">avs_net_security_info_from_psk</span><span class="p">(</span><span class="n">avs_net_psk_info_t</span><span class="w"> </span><span class="n">psk</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p><strong>New API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">avs_crypto_security_info_union_t</span><span class="w"> </span><span class="n">desc</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">avs_crypto_psk_identity_info_t</span><span class="p">;</span>

<span class="c1">// ...</span>

<span class="n">avs_crypto_psk_identity_info_t</span>
<span class="nf">avs_crypto_psk_identity_info_from_buffer</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
<span class="w">                                         </span><span class="kt">size_t</span><span class="w"> </span><span class="n">buffer_size</span><span class="p">);</span>

<span class="c1">// ...</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">avs_crypto_security_info_union_t</span><span class="w"> </span><span class="n">desc</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">avs_crypto_psk_key_info_t</span><span class="p">;</span>

<span class="c1">// ...</span>

<span class="n">avs_crypto_psk_key_info_t</span>
<span class="nf">avs_crypto_psk_key_info_from_buffer</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">buffer_size</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * A PSK/identity pair. avs_commons will never attempt to modify these values.</span>
<span class="cm"> */</span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">avs_crypto_psk_key_info_t</span><span class="w"> </span><span class="n">key</span><span class="p">;</span>
<span class="w">    </span><span class="n">avs_crypto_psk_identity_info_t</span><span class="w"> </span><span class="n">identity</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">avs_net_psk_info_t</span><span class="p">;</span>

<span class="c1">// ...</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">avs_net_security_mode_t</span><span class="w"> </span><span class="n">mode</span><span class="p">;</span>
<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">avs_net_psk_info_t</span><span class="w"> </span><span class="n">psk</span><span class="p">;</span>
<span class="w">        </span><span class="n">avs_net_certificate_info_t</span><span class="w"> </span><span class="n">cert</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">avs_net_security_info_t</span><span class="p">;</span>

<span class="n">avs_net_security_info_t</span>
<span class="nf">avs_net_security_info_from_psk</span><span class="p">(</span><span class="n">avs_net_psk_info_t</span><span class="w"> </span><span class="n">psk</span><span class="p">);</span>
</pre></div>
</div>
</li>
</ul>
<p>This change is breaking for code that accesses the <code class="docutils literal notranslate"><span class="pre">data.psk</span></code> field
of <code class="docutils literal notranslate"><span class="pre">avs_net_security_info_t</span></code> directly.</p>
</section>
<section id="separation-of-avs-url-module">
<h3><a class="toc-backref" href="#id18" role="doc-backlink"><span class="section-number">9.3.5.4. </span>Separation of avs_url module</a><a class="headerlink" href="#separation-of-avs-url-module" title="Link to this heading"></a></h3>
<p>URL handling routines, previously a part of <code class="docutils literal notranslate"><span class="pre">avs_net</span></code>, are now a separate
component of <code class="docutils literal notranslate"><span class="pre">avs_commons</span></code>. The specific consequences of that may vary
depending on your build process, e.g.:</p>
<ul class="simple">
<li><p>You will need to add <code class="docutils literal notranslate"><span class="pre">#define</span> <span class="pre">AVS_COMMONS_WITH_AVS_URL</span></code> to your
<code class="docutils literal notranslate"><span class="pre">avs_commons_config.h</span></code> if you specify it manually</p></li>
<li><p>You may need to add <code class="docutils literal notranslate"><span class="pre">-lavs_url</span></code> to your link command if you’re using
<code class="docutils literal notranslate"><span class="pre">avs_commons</span></code> that has been manually compiled separately using CMake</p></li>
</ul>
</section>
<section id="refactor-of-avs-net-validate-ip-address-and-avs-net-local-address-for-target-host">
<h3><a class="toc-backref" href="#id19" role="doc-backlink"><span class="section-number">9.3.5.5. </span>Refactor of avs_net_validate_ip_address() and avs_net_local_address_for_target_host()</a><a class="headerlink" href="#refactor-of-avs-net-validate-ip-address-and-avs-net-local-address-for-target-host" title="Link to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">avs_net_validate_ip_address()</span></code> is now no longer used by Anjay or
<code class="docutils literal notranslate"><span class="pre">avs_commons</span></code>. It was previously necessary to implement it as part of the
socket implementation. This is no longer required. For compatibility, the
function has been reimplemented as a <code class="docutils literal notranslate"><span class="pre">static</span> <span class="pre">inline</span></code> function that wraps
<code class="docutils literal notranslate"><span class="pre">avs_net_addrinfo_*()</span></code> APIs. Please remove your version of
<code class="docutils literal notranslate"><span class="pre">avs_net_validate_ip_address()</span></code> from your socket implementation if you have
one, as having two alternative variants may lead to conflicts.</p>
<p>Since Anjay 2.9 and <code class="docutils literal notranslate"><span class="pre">avs_commons</span></code> 4.6,
<code class="docutils literal notranslate"><span class="pre">avs_net_local_address_for_target_host()</span></code> underwent a similar refactor. It was
previously a function to be optionally implemented as part of the socket
implementation, but now it is a <code class="docutils literal notranslate"><span class="pre">static</span> <span class="pre">inline</span></code> function that wraps
<code class="docutils literal notranslate"><span class="pre">avs_net_socket_*()</span></code> APIs. Please remove your version of
<code class="docutils literal notranslate"><span class="pre">avs_net_local_address_for_target_host()</span></code> from your socket implementation if
you have one, as having two alternative variants may lead to conflicts.</p>
</section>
<section id="refactor-of-time-handling-in-avs-sched-and-avs-coap">
<h3><a class="toc-backref" href="#id20" role="doc-backlink"><span class="section-number">9.3.5.6. </span>Refactor of time handling in avs_sched and avs_coap</a><a class="headerlink" href="#refactor-of-time-handling-in-avs-sched-and-avs-coap" title="Link to this heading"></a></h3>
<p>It is now enforced more strictly that time-based events shall happen when the
clock reaches <em>at least</em> the expected value. Previously, the tasks scheduled via
avs_sched were executed only when the clock reached a value <em>later</em> than the
scheduled job execution time.</p>
<p>This change will have no impact on your code if your platform has enough clock
resolution so that two subsequent calls to <code class="docutils literal notranslate"><span class="pre">avs_time_real_now()</span></code> or
<code class="docutils literal notranslate"><span class="pre">avs_time_monotonic_now()</span></code> will <em>always</em> return different values. As a rule of
thumb, this should be the case if your clock has a resolution no worse than
about 1-2 orders of magnitude smaller than the CPU clock. For example, for a
100 MHz CPU, a clock resolution of around 100-1000 ns (i.e., 1-10 MHz) should be
sufficient, depending on the specific architecture.</p>
<p>If your clock has a lower resolution, you may observe the following changes:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">anjay_sched_run()</span></code> is now properly guaranteed to execute at least one job
if the time reported by <code class="docutils literal notranslate"><span class="pre">anjay_sched_time_to_next()</span></code> passed. Previously this
could require waiting for another change of the numerical value of the clock,
which could cause undesirable active waiting in the event loop. This is the
motivating factor in introducing these changes.</p></li>
<li><p>Jobs scheduled using <code class="docutils literal notranslate"><span class="pre">AVS_SCHED_NOW()</span></code> during an execution of
<code class="docutils literal notranslate"><span class="pre">anjay_sched_run()</span></code> before the numerical value of the clock changes, <em>will</em>
be executed during the same run. The previous behavior more strictly enforced
the policy to not execute such jobs in the same run.</p></li>
</ul>
<p>If you are scheduling custom jobs through the avs_sched module, you may want or
need to modify their logic accordingly to accommodate for these changes. In most
typical use cases, no changes are expected to be necessary.</p>
</section>
<section id="removal-of-avs-unit-memstream">
<h3><a class="toc-backref" href="#id21" role="doc-backlink"><span class="section-number">9.3.5.7. </span>Removal of avs_unit_memstream</a><a class="headerlink" href="#removal-of-avs-unit-memstream" title="Link to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">avs_unit_memstream</span></code> was a specific implementation of <code class="docutils literal notranslate"><span class="pre">avs_stream_t</span></code> within
the avs_unit module that implemented a simple FIFO stream in a fixed-size memory
area.</p>
<p>This feature has been removed. Instead, you can use an
<code class="docutils literal notranslate"><span class="pre">avs_stream_inbuf</span></code>/<code class="docutils literal notranslate"><span class="pre">avs_stream_outbuf</span></code> pair, or an <code class="docutils literal notranslate"><span class="pre">avs_stream_membuf</span></code>
object.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="MigratingCustomEntropy.html" class="btn btn-neutral float-left" title="9.2. Migrating mbed TLS custom entropy initializers" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="MigratingFromAnjay26.html" class="btn btn-neutral float-right" title="9.4. Migrating from Anjay 2.5.x or 2.6.x" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017-2024, AVSystem.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>