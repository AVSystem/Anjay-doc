

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>9.1.1. Changes in Anjay proper &mdash; Anjay 2.13.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="9.1.2. Replacement of CoAP implementation" href="MigratingFromAnjay116Coap.html" />
    <link rel="prev" title="9.1. Migrating from Anjay 1.16" href="../MigratingFromAnjay116.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #ffd500" >
          

          
            <a href="../../index.html">
          

          
            
            <img src="../../_static/avsystem_header.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                2.13.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../Introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LwM2M.html">2. OMA LwM2M - Brief description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Compiling_client_applications.html">3. Compiling client applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../BasicClient.html">4. Basic client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../AdvancedTopics.html">5. Advanced topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../FirmwareUpdateTutorial.html">6. Firmware Update Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tools.html">7. Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../PortingGuideForNonPOSIXPlatforms.html">8. Porting guide for non-POSIX platforms</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../Migrating.html">9. Migrating from older versions</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="../MigratingFromAnjay116.html">9.1. Migrating from Anjay 1.16</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">9.1.1. Changes in Anjay proper</a></li>
<li class="toctree-l3"><a class="reference internal" href="MigratingFromAnjay116Coap.html">9.1.2. Replacement of CoAP implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="MigratingFromAnjay116Commons.html">9.1.3. Changes in avs_commons</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../MigratingFromAnjay225.html">9.2. Migrating from Anjay 2.2.5</a></li>
<li class="toctree-l2"><a class="reference internal" href="../MigratingCustomEntropy.html">9.3. Migrating mbed TLS custom entropy initializers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../MigratingFromAnjay24.html">9.4. Migrating from Anjay 2.3.x or 2.4.x</a></li>
<li class="toctree-l2"><a class="reference internal" href="../MigratingFromAnjay26.html">9.5. Migrating from Anjay 2.5.x or 2.6.x</a></li>
<li class="toctree-l2"><a class="reference internal" href="../MigratingFromAnjay27.html">9.6. Migrating from Anjay 2.7.x</a></li>
<li class="toctree-l2"><a class="reference internal" href="../MigratingFromAnjay28.html">9.7. Migrating from Anjay 2.8.x</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../Commercial_support.html">10. Commercial support</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Anjay</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../Migrating.html"><span class="section-number">9. </span>Migrating from older versions</a> &raquo;</li>
        
          <li><a href="../MigratingFromAnjay116.html"><span class="section-number">9.1. </span>Migrating from Anjay 1.16</a> &raquo;</li>
        
      <li><span class="section-number">9.1.1. </span>Changes in Anjay proper</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="changes-in-anjay-proper">
<h1><span class="section-number">9.1.1. </span>Changes in Anjay proper<a class="headerlink" href="#changes-in-anjay-proper" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#generic-renames" id="id1">Generic renames</a></p></li>
<li><p><a class="reference internal" href="#removed-apis" id="id2">Removed APIs</a></p></li>
<li><p><a class="reference internal" href="#changes-to-data-model-api" id="id3">Changes to data model API</a></p>
<ul>
<li><p><a class="reference internal" href="#enumerating-object-instances" id="id4">Enumerating Object Instances</a></p></li>
<li><p><a class="reference internal" href="#enumerating-resources" id="id5">Enumerating Resources</a></p></li>
<li><p><a class="reference internal" href="#multiple-instance-resource-handling" id="id6">Multiple-instance Resource handling</a></p></li>
<li><p><a class="reference internal" href="#simplified-instance-create-handler" id="id7">Simplified Instance Create handler</a></p></li>
<li><p><a class="reference internal" href="#refactored-execute-argument-value-getter" id="id8">Refactored execute argument value getter</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#new-error-handling-scheme" id="id9">New error handling scheme</a></p></li>
<li><p><a class="reference internal" href="#updated-security-configuration-for-downloads" id="id10">Updated security configuration for downloads</a></p></li>
<li><p><a class="reference internal" href="#changes-to-cmake-option-variables" id="id11">Changes to CMake option variables</a></p></li>
<li><p><a class="reference internal" href="#other-changes" id="id12">Other changes</a></p></li>
</ul>
</div>
<div class="section" id="generic-renames">
<h2><a class="toc-backref" href="#id1"><span class="section-number">9.1.1.1. </span>Generic renames</a><a class="headerlink" href="#generic-renames" title="Permalink to this headline">¶</a></h2>
<p>Some objects (functions, type names, constants) have been renamed with little to
no significant semantic changes:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Old identifiers</p></th>
<th class="head"><p>New identifiers and notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">udp_socket_config</span></code></div>
<div class="line">(field in <code class="docutils literal notranslate"><span class="pre">anjay_configuration_t</span></code>)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">socket_config</span></code></div>
<div class="line">Now also used for TCP (in commercial version only)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">disable_server_initiated_bootstrap</span></code></div>
<div class="line">(field in <code class="docutils literal notranslate"><span class="pre">anjay_configuration_t</span></code>)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">disable_legacy_server_initiated_bootstrap</span></code></div>
<div class="line">Does not affect LwM2M 1.1-style Server-Initiated Bootstrap (in
commercial version only)</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">anjay_new_from_registration_and_observe_persistence()</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">anjay_delete_with_registration_and_observe_persistence()</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">anjay_new_from_core_persistence()</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">anjay_delete_with_core_persistence()</span></code></div>
<div class="line">Available in commercial version only.</div>
<div class="line">Includes additional data, such as last queue mode preference.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ANJAY_IID_INVALID</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ANJAY_ID_INVALID</span></code></div>
<div class="line">Now also relevant for OIDs, RIDs and RIIDs, according to changes
introduced in LwM2M TS 1.1.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">anjay_dm_attributes_t</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">anjay_dm_oi_attributes_t</span></code></div>
<div class="line">Introduced additional fields: <code class="docutils literal notranslate"><span class="pre">min_eval_period</span></code> and
<code class="docutils literal notranslate"><span class="pre">max_eval_period</span></code></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ANJAY_DM_ATTRIBS_EMPTY</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ANJAY_DM_OI_ATTRIBUTES_EMPTY</span></code></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">anjay_dm_resource_attributes_t</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">anjay_dm_r_attributes_t</span></code></div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ANJAY_RES_ATTRIBS_EMPTY</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ANJAY_DM_R_ATTRIBUTES_EMPTY</span></code></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">anjay_udp_security_mode_t</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">anjay_security_mode_t</span></code></div>
<div class="line">Now also used for TCP and NIDD (in commercial version only)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ANJAY_UDP_SECURITY_PSK</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">ANJAY_UDP_SECURITY_RPK</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">ANJAY_UDP_SECURITY_CERTIFICATE</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">ANJAY_UDP_SECURITY_NOSEC</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ANJAY_SECURITY_PSK</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">ANJAY_SECURITY_RPK</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">ANJAY_SECURITY_CERTIFICATE</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">ANJAY_SECURITY_NOSEC</span></code></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="removed-apis">
<h2><a class="toc-backref" href="#id2"><span class="section-number">9.1.1.2. </span>Removed APIs</a><a class="headerlink" href="#removed-apis" title="Permalink to this headline">¶</a></h2>
<p>The following APIs have been completely removed:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ANJAY_SUPPORTED_ENABLER_VERSION</span></code> - previously a constant string hardcoded
to <code class="docutils literal notranslate"><span class="pre">&quot;1.0&quot;</span></code>. Currently (in the commercial version), the enabler version used
may differ depending on the library’s compile-time configuration, and runtime
negotiation with any specific server, so it is pointless to declare it as a
constant.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">anjay/persistence.h</span></code> header - the <code class="docutils literal notranslate"><span class="pre">persistence</span></code> module has been
refactored and moved into <code class="docutils literal notranslate"><span class="pre">avs_commons</span></code> beginning with Anjay 1.9, but Anjay
retained this header that aliased new APIs to their old names. This has been
completely removed in Anjay 2.x. Please use the <code class="docutils literal notranslate"><span class="pre">avs_commons</span></code> APIs directly.
See also: <a class="reference internal" href="MigratingFromAnjay116Commons.html#avs-commons-persistence-changes"><span class="std std-ref">Changes in public avs_persistence APIs</span></a>.</p></li>
</ul>
</div>
<div class="section" id="changes-to-data-model-api">
<h2><a class="toc-backref" href="#id3"><span class="section-number">9.1.1.3. </span>Changes to data model API</a><a class="headerlink" href="#changes-to-data-model-api" title="Permalink to this headline">¶</a></h2>
<p>Anjay 2.x introduced some major changes to the public data model API. Some of
them have been introduced to allow direct addressing of Resource Instances, as
required by LwM2M TS 1.1. Other changes have been introduced to simplify
handling of Object Instances and Resources, unifying them with the paradigm
introduced for Resource Instances.</p>
<div class="section" id="enumerating-object-instances">
<h3><a class="toc-backref" href="#id4"><span class="section-number">9.1.1.3.1. </span>Enumerating Object Instances</a><a class="headerlink" href="#enumerating-object-instances" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">instance_it</span></code> and <code class="docutils literal notranslate"><span class="pre">instance_present</span></code> data model handlers (
<code class="docutils literal notranslate"><span class="pre">anjay_dm_instance_it_t</span></code> and <code class="docutils literal notranslate"><span class="pre">anjay_dm_instance_present_t</span></code> function types)
have been replaced with the new <code class="docutils literal notranslate"><span class="pre">list_instances</span></code> handler
(<code class="docutils literal notranslate"><span class="pre">anjay_dm_list_instances_t</span></code> type).</p>
<p><code class="docutils literal notranslate"><span class="pre">anjay_dm_emit()</span></code> function is used in the new handler to return existing
instances. It shall be called once for each of the Object Instances existing
in the Object at the time of calling.</p>
<p>Example of old code, taken from the Portfolio object implementation in the demo
application:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// NOTE: Code compatible with Anjay 1.16</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">instance_present</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                            <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
                            <span class="n">anjay_iid_t</span> <span class="n">iid</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">anjay</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">find_instance</span><span class="p">(</span><span class="n">get_obj</span><span class="p">(</span><span class="n">obj_ptr</span><span class="p">),</span> <span class="n">iid</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">instance_it</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                       <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
                       <span class="n">anjay_iid_t</span> <span class="o">*</span><span class="n">out</span><span class="p">,</span>
                       <span class="kt">void</span> <span class="o">**</span><span class="n">cookie</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">anjay</span><span class="p">;</span>

    <span class="n">AVS_LIST</span><span class="p">(</span><span class="n">portfolio_instance_t</span><span class="p">)</span> <span class="n">curr</span> <span class="o">=</span>
            <span class="p">(</span><span class="n">AVS_LIST</span><span class="p">(</span><span class="n">portfolio_instance_t</span><span class="p">))</span> <span class="o">*</span><span class="n">cookie</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">curr</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">curr</span> <span class="o">=</span> <span class="n">get_obj</span><span class="p">(</span><span class="n">obj_ptr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">instances</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="n">curr</span> <span class="o">=</span> <span class="n">AVS_LIST_NEXT</span><span class="p">(</span><span class="n">curr</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="n">curr</span> <span class="o">?</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="nl">iid</span> <span class="p">:</span> <span class="n">ANJAY_IID_INVALID</span><span class="p">;</span>
    <span class="o">*</span><span class="n">cookie</span> <span class="o">=</span> <span class="n">curr</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// ...</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="n">OBJ_DEF</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="p">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">instance_it</span> <span class="o">=</span> <span class="n">instance_it</span><span class="p">,</span>
        <span class="p">.</span><span class="n">instance_present</span> <span class="o">=</span> <span class="n">instance_present</span><span class="p">,</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Equivalent new code:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">list_instances</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                          <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
                          <span class="n">anjay_dm_list_ctx_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">anjay</span><span class="p">;</span>

    <span class="n">AVS_LIST</span><span class="p">(</span><span class="n">portfolio_instance_t</span><span class="p">)</span> <span class="n">it</span><span class="p">;</span>
    <span class="n">AVS_LIST_FOREACH</span><span class="p">(</span><span class="n">it</span><span class="p">,</span> <span class="n">get_obj</span><span class="p">(</span><span class="n">obj_ptr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">instances</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">anjay_dm_emit</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">it</span><span class="o">-&gt;</span><span class="n">iid</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// ...</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="n">OBJ_DEF</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="p">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">list_instances</span> <span class="o">=</span> <span class="n">list_instances</span><span class="p">,</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>It is REQUIRED that the Object Instances are reported in strictly ascending
order with regard to the Instance ID, i.e. that the Instance ID passed to
each consecutive call to <code class="docutils literal notranslate"><span class="pre">anjay_dm_emit()</span></code> is higher than the one passed
to a previous call, if any (within any given call the the <code class="docutils literal notranslate"><span class="pre">list_instances</span></code>
handler).</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The new <code class="docutils literal notranslate"><span class="pre">anjay_dm_list_instances_SINGLE()</span></code> function can be used as a
generic implementation of the <code class="docutils literal notranslate"><span class="pre">list_instances</span></code> handler for Single-Instance
Objects, much like <code class="docutils literal notranslate"><span class="pre">anjay_dm_instance_it_SINGLE()</span></code> and
<code class="docutils literal notranslate"><span class="pre">anjay_dm_instance_present_SINGLE()</span></code> in Anjay 1.x.</p>
</div>
</div>
<div class="section" id="enumerating-resources">
<h3><a class="toc-backref" href="#id5"><span class="section-number">9.1.1.3.2. </span>Enumerating Resources</a><a class="headerlink" href="#enumerating-resources" title="Permalink to this headline">¶</a></h3>
<p>The following entities have been removed:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">resource_present</span></code> and <code class="docutils literal notranslate"><span class="pre">resource_operations</span></code> handlers in
<code class="docutils literal notranslate"><span class="pre">anjay_dm_handlers_t</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">anjay_dm_resource_present_t</span></code> and <code class="docutils literal notranslate"><span class="pre">anjay_dm_resource_operations_t</span></code>
function types associated with the above</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">supported_rids</span></code> field in <code class="docutils literal notranslate"><span class="pre">anjay_dm_object_def_t</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">anjay_dm_supported_rids_t</span></code> type and <code class="docutils literal notranslate"><span class="pre">ANJAY_DM_SUPPORTED_RIDS</span></code> macro,
associated with the above</p></li>
</ul>
<p>Both the “present” and “operations” handlers, as well as the “supported RIDs”
declaration, have been replaced by a single <code class="docutils literal notranslate"><span class="pre">list_resources</span></code> handler (and its
associated <code class="docutils literal notranslate"><span class="pre">anjay_dm_list_resources_t</span></code> function type).</p>
<p>That handler works in a way very similar to the “list instances” handler
described above. Due to the need to return additional metadata about the
Resources, <code class="docutils literal notranslate"><span class="pre">anjay_dm_emit_res()</span></code> is used to return information about supported
Resources.</p>
<p>Example of old code, taken from the Access Control Object implementation:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// NOTE: Code compatible with Anjay 1.16</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ac_resource_present</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                               <span class="n">obj_ptr_t</span> <span class="n">obj_ptr</span><span class="p">,</span>
                               <span class="n">anjay_iid_t</span> <span class="n">iid</span><span class="p">,</span>
                               <span class="n">anjay_rid_t</span> <span class="n">rid</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">anjay</span><span class="p">;</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">rid</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nl">ANJAY_DM_RID_ACCESS_CONTROL_OID</span><span class="p">:</span>
    <span class="k">case</span> <span class="nl">ANJAY_DM_RID_ACCESS_CONTROL_OIID</span><span class="p">:</span>
    <span class="k">case</span> <span class="nl">ANJAY_DM_RID_ACCESS_CONTROL_OWNER</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">ANJAY_DM_RID_ACCESS_CONTROL_ACL</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">access_control_instance_t</span> <span class="o">*</span><span class="n">inst</span> <span class="o">=</span>
                <span class="n">find_instance</span><span class="p">(</span><span class="n">_anjay_access_control_from_obj_ptr</span><span class="p">(</span><span class="n">obj_ptr</span><span class="p">),</span> <span class="n">iid</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">inst</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">has_acl</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">ANJAY_ERR_NOT_FOUND</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">default</span><span class="o">:</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ac_resource_operations</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                                  <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
                                  <span class="n">anjay_rid_t</span> <span class="n">rid</span><span class="p">,</span>
                                  <span class="n">anjay_dm_resource_op_mask_t</span> <span class="o">*</span><span class="n">out</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">anjay</span><span class="p">;</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">obj_ptr</span><span class="p">;</span>
    <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="n">ANJAY_DM_RESOURCE_OP_NONE</span><span class="p">;</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">rid</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nl">ANJAY_DM_RID_ACCESS_CONTROL_OID</span><span class="p">:</span>
    <span class="k">case</span> <span class="nl">ANJAY_DM_RID_ACCESS_CONTROL_OIID</span><span class="p">:</span>
        <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="n">ANJAY_DM_RESOURCE_OP_BIT_R</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="nl">ANJAY_DM_RID_ACCESS_CONTROL_ACL</span><span class="p">:</span>
    <span class="k">case</span> <span class="nl">ANJAY_DM_RID_ACCESS_CONTROL_OWNER</span><span class="p">:</span>
        <span class="o">*</span><span class="n">out</span> <span class="o">=</span> <span class="n">ANJAY_DM_RESOURCE_OP_BIT_R</span> <span class="o">|</span> <span class="n">ANJAY_DM_RESOURCE_OP_BIT_W</span><span class="p">;</span>
        <span class="k">break</span><span class="p">;</span>
    <span class="k">default</span><span class="o">:</span>
        <span class="k">return</span> <span class="n">ANJAY_ERR_NOT_FOUND</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// ...</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="n">ACCESS_CONTROL</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="p">.</span><span class="n">supported_rids</span> <span class="o">=</span>
            <span class="n">ANJAY_DM_SUPPORTED_RIDS</span><span class="p">(</span><span class="n">ANJAY_DM_RID_ACCESS_CONTROL_OID</span><span class="p">,</span>
                                    <span class="n">ANJAY_DM_RID_ACCESS_CONTROL_OIID</span><span class="p">,</span>
                                    <span class="n">ANJAY_DM_RID_ACCESS_CONTROL_ACL</span><span class="p">,</span>
                                    <span class="n">ANJAY_DM_RID_ACCESS_CONTROL_OWNER</span><span class="p">),</span>
    <span class="p">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="p">.</span><span class="n">resource_present</span> <span class="o">=</span> <span class="n">ac_resource_present</span><span class="p">,</span>
        <span class="p">.</span><span class="n">resource_operations</span> <span class="o">=</span> <span class="n">ac_resource_operations</span><span class="p">,</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Equivalent new code:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">ac_list_resources</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                             <span class="n">obj_ptr_t</span> <span class="n">obj_ptr</span><span class="p">,</span>
                             <span class="n">anjay_iid_t</span> <span class="n">iid</span><span class="p">,</span>
                             <span class="n">anjay_dm_resource_list_ctx_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">anjay</span><span class="p">;</span>
    <span class="n">access_control_instance_t</span> <span class="o">*</span><span class="n">inst</span> <span class="o">=</span>
            <span class="n">find_instance</span><span class="p">(</span><span class="n">_anjay_access_control_from_obj_ptr</span><span class="p">(</span><span class="n">obj_ptr</span><span class="p">),</span> <span class="n">iid</span><span class="p">);</span>

    <span class="n">anjay_dm_emit_res</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ANJAY_DM_RID_ACCESS_CONTROL_OID</span><span class="p">,</span> <span class="n">ANJAY_DM_RES_R</span><span class="p">,</span>
                      <span class="n">ANJAY_DM_RES_PRESENT</span><span class="p">);</span>
    <span class="n">anjay_dm_emit_res</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ANJAY_DM_RID_ACCESS_CONTROL_OIID</span><span class="p">,</span> <span class="n">ANJAY_DM_RES_R</span><span class="p">,</span>
                      <span class="n">ANJAY_DM_RES_PRESENT</span><span class="p">);</span>
    <span class="n">anjay_dm_emit_res</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ANJAY_DM_RID_ACCESS_CONTROL_ACL</span><span class="p">,</span> <span class="n">ANJAY_DM_RES_RWM</span><span class="p">,</span>
                      <span class="p">(</span><span class="n">inst</span> <span class="o">&amp;&amp;</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">has_acl</span><span class="p">)</span> <span class="o">?</span> <span class="nl">ANJAY_DM_RES_PRESENT</span>
                                              <span class="p">:</span> <span class="n">ANJAY_DM_RES_ABSENT</span><span class="p">);</span>
    <span class="n">anjay_dm_emit_res</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">ANJAY_DM_RID_ACCESS_CONTROL_OWNER</span><span class="p">,</span> <span class="n">ANJAY_DM_RES_RW</span><span class="p">,</span>
                      <span class="n">ANJAY_DM_RES_PRESENT</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// ...</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="n">ACCESS_CONTROL</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="p">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="p">.</span><span class="n">list_resources</span> <span class="o">=</span> <span class="n">ac_list_resources</span><span class="p">,</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>It is REQUIRED that the Resources are reported in strictly ascending order
with regard to the Resource ID, i.e. that the Resource ID passed to each
consecutive call to <code class="docutils literal notranslate"><span class="pre">anjay_dm_emit_res()</span></code> is higher than the one passed to
a previous call, if any (within any given call the the <code class="docutils literal notranslate"><span class="pre">list_resources</span></code>
handler).</p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The distinction between “supported” and “present” Resources is retained,
even though the notion of “supported Resources” is no longer directly used
in code.</p>
<ul class="simple">
<li><p><strong>Supported Resources</strong>, previously declared through the
<code class="docutils literal notranslate"><span class="pre">supported_rids</span></code> field, are now expressed as the set of Resources for
which <code class="docutils literal notranslate"><span class="pre">anjay_dm_emit_res()</span></code> is called with any arguments.</p></li>
<li><p><strong>Present Resources</strong>, previously reported using the <code class="docutils literal notranslate"><span class="pre">resource_present</span></code>
handler, are now expressed by passing either <code class="docutils literal notranslate"><span class="pre">ANJAY_DM_RES_PRESENT</span></code> or
<code class="docutils literal notranslate"><span class="pre">ANJAY_DM_RES_ABSENT</span></code> as the argument to <code class="docutils literal notranslate"><span class="pre">anjay_dm_emit_res()</span></code>.</p></li>
</ul>
<p>Write handler is guaranteed to be called only on <em>supported</em> Resources, but
can be called regardless of whether a given Resource is <em>present</em>. This is
the most important rationale behind those being separate concepts.</p>
</div>
<p class="rubric">Additional changes</p>
<p>The <code class="docutils literal notranslate"><span class="pre">anjay_dm_resource_present_TRUE()</span></code> function has been removed without any
replacement. To achieve the same effect, implement the <code class="docutils literal notranslate"><span class="pre">list_resources</span></code>
handler in a way that always passes <code class="docutils literal notranslate"><span class="pre">ANJAY_DM_RES_PRESENT</span></code> as argument to
<code class="docutils literal notranslate"><span class="pre">anjay_dm_emit_res()</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">anjay_dm_resource_op_bit_t</span></code> bit-masked type has been replaced by stricter
<code class="docutils literal notranslate"><span class="pre">anjay_dm_resource_kind_t</span></code> enumeration. Below is the table of equivalent
values:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 51%" />
<col style="width: 49%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p><code class="docutils literal notranslate"><span class="pre">anjay_dm_resource_op_bit_t</span></code> (Anjay 1.16)</p></th>
<th class="head"><p><code class="docutils literal notranslate"><span class="pre">anjay_dm_resource_kind_t</span></code> (Anjay 2.x)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ANJAY_DM_RESOURCE_OP_BIT_R</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ANJAY_DM_RES_R</span></code> (single-instance)</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">ANJAY_DM_RES_RM</span></code> (multiple-instance)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ANJAY_DM_RESOURCE_OP_BIT_W</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ANJAY_DM_RES_W</span></code> (single-instance)</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">ANJAY_DM_RES_WM</span></code> (multiple-instance)</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ANJAY_DM_RESOURCE_OP_BIT_R</span>
<span class="pre">|</span> <span class="pre">ANJAY_DM_RESOURCE_OP_BIT_W</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ANJAY_DM_RES_RW</span></code> (single-instance)</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">ANJAY_DM_RES_RWM</span></code> (multiple-instance)</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ANJAY_DM_RESOURCE_OP_BIT_E</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ANJAY_DM_RES_E</span></code></div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">0</span></code> (empty bit mask)</div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">ANJAY_DM_RES_BS_RW</span></code></div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is now required to pass some <code class="docutils literal notranslate"><span class="pre">anjay_dm_resource_kind_t</span></code> value, as it is
a required argument to <code class="docutils literal notranslate"><span class="pre">anjay_dm_emit_res()</span></code>. Please report appropriate
values for each Resource when migrating. You can consult the <a class="reference external" href="http://www.openmobilealliance.org/wp/OMNA/LwM2M/LwM2MRegistry.html">OMA LwM2M
Registry</a>
if the Object you are migrating is listed there.</p>
</div>
</div>
<div class="section" id="multiple-instance-resource-handling">
<h3><a class="toc-backref" href="#id6"><span class="section-number">9.1.1.3.3. </span>Multiple-instance Resource handling</a><a class="headerlink" href="#multiple-instance-resource-handling" title="Permalink to this headline">¶</a></h3>
<p>Due to the new requirements in LwM2M TS 1.1, Resource Instances are now
addressable individually in Anjay. For this reason, the following array-based
multiple-instance Resource handling functions have been removed:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">anjay_ret_array_start()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">anjay_ret_array_index()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">anjay_ret_array_finish()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">anjay_get_array()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">anjay_get_array_index()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ANJAY_GET_INDEX_END</span></code> macro related to the above</p></li>
</ul>
<p>Also removed is the <code class="docutils literal notranslate"><span class="pre">resource_dim</span></code> handler, as well as its associated
<code class="docutils literal notranslate"><span class="pre">anjay_dm_resource_dim_t</span></code> function type and <code class="docutils literal notranslate"><span class="pre">ANJAY_DM_DIM_INVALID</span></code> constant.</p>
<p>Instead, the following mechanisms have been introduced:</p>
<ul class="simple">
<li><p>New <code class="docutils literal notranslate"><span class="pre">list_resource_instances</span></code> handler (and its associated
<code class="docutils literal notranslate"><span class="pre">anjay_dm_list_resource_instances_t</span></code> function type), analogous to the
<code class="docutils literal notranslate"><span class="pre">list_instances</span></code> handler described above, has been introduced.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">resource_read</span></code> and <code class="docutils literal notranslate"><span class="pre">resource_write</span></code> handlers (associated function types:
<code class="docutils literal notranslate"><span class="pre">anjay_dm_resource_read_t</span></code>, <code class="docutils literal notranslate"><span class="pre">anjay_dm_resource_write_t</span></code>) now take an
additional <code class="docutils literal notranslate"><span class="pre">riid</span></code> argument and are now called separately for each Resource
Instance.</p></li>
<li><p>New <code class="docutils literal notranslate"><span class="pre">resource_reset</span></code> handler (and its associated
<code class="docutils literal notranslate"><span class="pre">anjay_dm_resource_reset_t</span></code> function type), somewhat analogous to the
<code class="docutils literal notranslate"><span class="pre">instance_reset</span></code> handler has been introduced. Its job is to remove all
Resource Instances from a multiple-instance Resource.</p></li>
</ul>
<p>Example of old code, taken from the Portfolio object implementation in the demo
application:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="c1">// NOTE: Code compatible with Anjay 1.16</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">resource_read</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                         <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
                         <span class="n">anjay_iid_t</span> <span class="n">iid</span><span class="p">,</span>
                         <span class="n">anjay_rid_t</span> <span class="n">rid</span><span class="p">,</span>
                         <span class="n">anjay_output_ctx_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">anjay</span><span class="p">;</span>

    <span class="n">portfolio_t</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">get_obj</span><span class="p">(</span><span class="n">obj_ptr</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
    <span class="n">portfolio_instance_t</span> <span class="o">*</span><span class="n">inst</span> <span class="o">=</span> <span class="n">find_instance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">iid</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">rid</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nl">RID_IDENTITY</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">anjay_output_ctx_t</span> <span class="o">*</span><span class="n">array</span> <span class="o">=</span> <span class="n">anjay_ret_array_start</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">array</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">ANJAY_ERR_INTERNAL</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="n">AVS_STATIC_ASSERT</span><span class="p">(</span><span class="n">_MAX_IDENTITY_TYPE</span> <span class="o">&lt;=</span> <span class="n">UINT16_MAX</span><span class="p">,</span>
                          <span class="n">identity_type_too_big</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_MAX_IDENTITY_TYPE</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">has_identity</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">((</span><span class="n">result</span> <span class="o">=</span> <span class="n">anjay_ret_array_index</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="p">(</span><span class="n">anjay_riid_t</span><span class="p">)</span> <span class="n">i</span><span class="p">))</span>
                    <span class="o">||</span> <span class="p">(</span><span class="n">result</span> <span class="o">=</span> <span class="n">anjay_ret_string</span><span class="p">(</span><span class="n">array</span><span class="p">,</span>
                                                  <span class="n">inst</span><span class="o">-&gt;</span><span class="n">identity_value</span><span class="p">[</span><span class="n">i</span><span class="p">])))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">anjay_ret_array_finish</span><span class="p">(</span><span class="n">array</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">default</span><span class="o">:</span>
        <span class="k">return</span> <span class="n">ANJAY_ERR_METHOD_NOT_ALLOWED</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">resource_write</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                          <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
                          <span class="n">anjay_iid_t</span> <span class="n">iid</span><span class="p">,</span>
                          <span class="n">anjay_rid_t</span> <span class="n">rid</span><span class="p">,</span>
                          <span class="n">anjay_input_ctx_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">anjay</span><span class="p">;</span>

    <span class="n">portfolio_t</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">get_obj</span><span class="p">(</span><span class="n">obj_ptr</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
    <span class="n">portfolio_instance_t</span> <span class="o">*</span><span class="n">inst</span> <span class="o">=</span> <span class="n">find_instance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">iid</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">rid</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nl">RID_IDENTITY</span><span class="p">:</span> <span class="p">{</span>
        <span class="n">anjay_input_ctx_t</span> <span class="o">*</span><span class="n">array</span> <span class="o">=</span> <span class="n">anjay_get_array</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">array</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">ANJAY_ERR_INTERNAL</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="n">anjay_riid_t</span> <span class="n">riid</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kt">char</span> <span class="n">value</span><span class="p">[</span><span class="n">MAX_IDENTITY_VALUE_SIZE</span><span class="p">];</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">has_identity</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">has_identity</span><span class="p">));</span>
        <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">result</span> <span class="o">=</span> <span class="n">anjay_get_array_index</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">riid</span><span class="p">)))</span> <span class="p">{</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">anjay_get_string</span><span class="p">(</span><span class="n">array</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">value</span><span class="p">));</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">riid</span> <span class="o">&gt;=</span> <span class="n">_MAX_IDENTITY_TYPE</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="n">ANJAY_ERR_BAD_REQUEST</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="n">inst</span><span class="o">-&gt;</span><span class="n">has_identity</span><span class="p">[</span><span class="n">riid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="n">strcpy</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">identity_value</span><span class="p">[</span><span class="n">riid</span><span class="p">],</span> <span class="n">value</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&amp;&amp;</span> <span class="n">result</span> <span class="o">!=</span> <span class="n">ANJAY_GET_INDEX_END</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">ANJAY_ERR_BAD_REQUEST</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">default</span><span class="o">:</span>
        <span class="k">return</span> <span class="n">ANJAY_ERR_METHOD_NOT_ALLOWED</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">resource_dim</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                        <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
                        <span class="n">anjay_iid_t</span> <span class="n">iid</span><span class="p">,</span>
                        <span class="n">anjay_rid_t</span> <span class="n">rid</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">anjay</span><span class="p">;</span>

    <span class="n">portfolio_t</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">get_obj</span><span class="p">(</span><span class="n">obj_ptr</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
    <span class="n">portfolio_instance_t</span> <span class="o">*</span><span class="n">inst</span> <span class="o">=</span> <span class="n">find_instance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">iid</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">rid</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nl">RID_IDENTITY</span><span class="p">:</span> <span class="p">{</span>
        <span class="kt">int</span> <span class="n">dim</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_MAX_IDENTITY_TYPE</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">dim</span> <span class="o">+=</span> <span class="o">!!</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">has_identity</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">dim</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">default</span><span class="o">:</span>
        <span class="k">return</span> <span class="n">ANJAY_DM_DIM_INVALID</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ...</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="n">OBJ_DEF</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="p">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="p">.</span><span class="n">resource_read</span> <span class="o">=</span> <span class="n">resource_read</span><span class="p">,</span>
        <span class="p">.</span><span class="n">resource_write</span> <span class="o">=</span> <span class="n">resource_write</span><span class="p">,</span>
        <span class="p">.</span><span class="n">resource_dim</span> <span class="o">=</span> <span class="n">resource_dim</span><span class="p">,</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Equivalent new code:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span> <span class="kt">int</span> <span class="nf">resource_read</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                         <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
                         <span class="n">anjay_iid_t</span> <span class="n">iid</span><span class="p">,</span>
                         <span class="n">anjay_rid_t</span> <span class="n">rid</span><span class="p">,</span>
                         <span class="n">anjay_riid_t</span> <span class="n">riid</span><span class="p">,</span>
                         <span class="n">anjay_output_ctx_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">anjay</span><span class="p">;</span>

    <span class="n">portfolio_t</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">get_obj</span><span class="p">(</span><span class="n">obj_ptr</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
    <span class="n">portfolio_instance_t</span> <span class="o">*</span><span class="n">inst</span> <span class="o">=</span> <span class="n">find_instance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">iid</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">rid</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nl">RID_IDENTITY</span><span class="p">:</span>
        <span class="n">assert</span><span class="p">(</span><span class="n">riid</span> <span class="o">&lt;</span> <span class="n">_MAX_IDENTITY_TYPE</span><span class="p">);</span>
        <span class="n">assert</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">has_identity</span><span class="p">[</span><span class="n">riid</span><span class="p">]);</span>
        <span class="k">return</span> <span class="n">anjay_ret_string</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">inst</span><span class="o">-&gt;</span><span class="n">identity_value</span><span class="p">[</span><span class="n">riid</span><span class="p">]);</span>
    <span class="k">default</span><span class="o">:</span>
        <span class="n">AVS_UNREACHABLE</span><span class="p">(</span><span class="s">&quot;Read called on unknown resource&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">ANJAY_ERR_METHOD_NOT_ALLOWED</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">resource_write</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                          <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
                          <span class="n">anjay_iid_t</span> <span class="n">iid</span><span class="p">,</span>
                          <span class="n">anjay_rid_t</span> <span class="n">rid</span><span class="p">,</span>
                          <span class="n">anjay_riid_t</span> <span class="n">riid</span><span class="p">,</span>
                          <span class="n">anjay_input_ctx_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">anjay</span><span class="p">;</span>

    <span class="n">portfolio_t</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">get_obj</span><span class="p">(</span><span class="n">obj_ptr</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
    <span class="n">portfolio_instance_t</span> <span class="o">*</span><span class="n">inst</span> <span class="o">=</span> <span class="n">find_instance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">iid</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">rid</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nl">RID_IDENTITY</span><span class="p">:</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">riid</span> <span class="o">&gt;=</span> <span class="n">_MAX_IDENTITY_TYPE</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="n">ANJAY_ERR_NOT_FOUND</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="kt">char</span> <span class="n">value</span><span class="p">[</span><span class="n">MAX_IDENTITY_VALUE_SIZE</span><span class="p">];</span>
        <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">anjay_get_string</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">value</span><span class="p">));</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">inst</span><span class="o">-&gt;</span><span class="n">has_identity</span><span class="p">[</span><span class="n">riid</span><span class="p">]</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
            <span class="n">strcpy</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">identity_value</span><span class="p">[</span><span class="n">riid</span><span class="p">],</span> <span class="n">value</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">default</span><span class="o">:</span>
        <span class="n">AVS_UNREACHABLE</span><span class="p">(</span><span class="s">&quot;Write called on unknown resource&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">ANJAY_ERR_METHOD_NOT_ALLOWED</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">resource_reset</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                          <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
                          <span class="n">anjay_iid_t</span> <span class="n">iid</span><span class="p">,</span>
                          <span class="n">anjay_rid_t</span> <span class="n">rid</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">anjay</span><span class="p">;</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">rid</span><span class="p">;</span>

    <span class="n">portfolio_t</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">get_obj</span><span class="p">(</span><span class="n">obj_ptr</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
    <span class="n">portfolio_instance_t</span> <span class="o">*</span><span class="n">inst</span> <span class="o">=</span> <span class="n">find_instance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">iid</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>

    <span class="n">assert</span><span class="p">(</span><span class="n">rid</span> <span class="o">==</span> <span class="n">RID_IDENTITY</span><span class="p">);</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">has_identity</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">has_identity</span><span class="p">));</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">list_resource_instances</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                                   <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
                                   <span class="n">anjay_iid_t</span> <span class="n">iid</span><span class="p">,</span>
                                   <span class="n">anjay_rid_t</span> <span class="n">rid</span><span class="p">,</span>
                                   <span class="n">anjay_dm_list_ctx_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">anjay</span><span class="p">;</span>

    <span class="n">portfolio_t</span> <span class="o">*</span><span class="n">obj</span> <span class="o">=</span> <span class="n">get_obj</span><span class="p">(</span><span class="n">obj_ptr</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
    <span class="n">portfolio_instance_t</span> <span class="o">*</span><span class="n">inst</span> <span class="o">=</span> <span class="n">find_instance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">iid</span><span class="p">);</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">inst</span><span class="p">);</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">rid</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nl">RID_IDENTITY</span><span class="p">:</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">anjay_riid_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_MAX_IDENTITY_TYPE</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">inst</span><span class="o">-&gt;</span><span class="n">has_identity</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
                <span class="n">anjay_dm_emit</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">default</span><span class="o">:</span>
        <span class="n">AVS_UNREACHABLE</span><span class="p">(</span>
                <span class="s">&quot;Attempted to list instances in a single-instance resource&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">ANJAY_ERR_INTERNAL</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// ...</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="n">OBJ_DEF</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="p">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="p">.</span><span class="n">resource_read</span> <span class="o">=</span> <span class="n">resource_read</span><span class="p">,</span>
        <span class="p">.</span><span class="n">resource_write</span> <span class="o">=</span> <span class="n">resource_write</span><span class="p">,</span>
        <span class="p">.</span><span class="n">resource_reset</span> <span class="o">=</span> <span class="n">resource_reset</span><span class="p">,</span>
        <span class="p">.</span><span class="n">list_resource_instances</span> <span class="o">=</span> <span class="n">list_resource_instances</span><span class="p">,</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
<span class="p">};</span>
</pre></div>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>It is REQUIRED that the Resource Instances are reported in strictly
ascending order with regard to the Resource Instance ID, i.e. that the
Resource Instance ID passed to each consecutive call to <code class="docutils literal notranslate"><span class="pre">anjay_dm_emit()</span></code>
is higher than the one passed to a previous call, if any (within any given
call the the <code class="docutils literal notranslate"><span class="pre">list_resource_instances</span></code> handler).</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In the example above, there is only one multiple-instance Resource in the
object. Please note that if there are single-instance Resources in the same
object as well, the same <code class="docutils literal notranslate"><span class="pre">resource_read</span></code> and <code class="docutils literal notranslate"><span class="pre">resource_write</span></code> handlers
are used for both single- and multiple-instance Resources.</p>
<p>When value of single-instance Resource is being read or written to, the
<code class="docutils literal notranslate"><span class="pre">riid</span></code> argument is passed <code class="docutils literal notranslate"><span class="pre">ANJAY_ID_INVALID</span></code> (65535).</p>
</div>
</div>
<div class="section" id="simplified-instance-create-handler">
<h3><a class="toc-backref" href="#id7"><span class="section-number">9.1.1.3.4. </span>Simplified Instance Create handler</a><a class="headerlink" href="#simplified-instance-create-handler" title="Permalink to this headline">¶</a></h3>
<p>The function type associated with the <code class="docutils literal notranslate"><span class="pre">instance_create</span></code> handler has previously
been declared as:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="kt">int</span>
<span class="nf">anjay_dm_instance_create_t</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                           <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
                           <span class="n">anjay_iid_t</span> <span class="o">*</span><span class="n">inout_iid</span><span class="p">,</span>
                           <span class="n">anjay_ssid_t</span> <span class="n">ssid</span><span class="p">);</span>
</pre></div>
</div>
<p>This has been simplified into:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="kt">int</span>
<span class="nf">anjay_dm_instance_create_t</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                           <span class="k">const</span> <span class="n">anjay_dm_object_def_t</span> <span class="o">*</span><span class="k">const</span> <span class="o">*</span><span class="n">obj_ptr</span><span class="p">,</span>
                           <span class="n">anjay_iid_t</span> <span class="n">iid</span><span class="p">);</span>
</pre></div>
</div>
<p>There are two important differences:</p>
<ul class="simple">
<li><p>The Instance ID is now always assigned either by the LwM2M Server or by Anjay;
the user code does not need to assign it any more, hence the <code class="docutils literal notranslate"><span class="pre">iid</span></code> parameter
is no longer an “inout pointer”.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">ssid</span></code> argument has been removed. It was introduced as a hack to make
implementing the Access Control object possible - the internal implementation
of the Access Control mechanism has been overhauled so that it is no longer
necessary.</p>
<ul>
<li><p>If you are writing your own implementation of the Access Control object, you
may assume the the creation has been initiated by the Bootstrap Server
(<code class="docutils literal notranslate"><span class="pre">ssid</span> <span class="pre">==</span> <span class="pre">ANJAY_SSID_BOOTSTRAP</span></code>).</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="refactored-execute-argument-value-getter">
<h3><a class="toc-backref" href="#id8"><span class="section-number">9.1.1.3.5. </span>Refactored execute argument value getter</a><a class="headerlink" href="#refactored-execute-argument-value-getter" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">anjay_execute_get_arg_value()</span></code> function has been refactored in connection
to <a class="reference internal" href="MigratingFromAnjay116Commons.html#ssize-t-removal-in-commons-116"><span class="std std-ref">Removal of ssize_t usages from avs_commons APIs</span></a>.</p>
<ul>
<li><p><strong>Old API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">ssize_t</span> <span class="nf">anjay_execute_get_arg_value</span><span class="p">(</span><span class="n">anjay_execute_ctx_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
                                    <span class="kt">char</span> <span class="o">*</span><span class="n">out_buf</span><span class="p">,</span>
                                    <span class="kt">size_t</span> <span class="n">buf_size</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p><strong>New API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="hll"> <span class="kt">int</span> <span class="nf">anjay_execute_get_arg_value</span><span class="p">(</span><span class="n">anjay_execute_ctx_t</span> <span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
</span><span class="hll">                                 <span class="kt">size_t</span> <span class="o">*</span><span class="n">out_bytes_read</span><span class="p">,</span>
</span>                                 <span class="kt">char</span> <span class="o">*</span><span class="n">out_buf</span><span class="p">,</span>
                                 <span class="kt">size_t</span> <span class="n">buf_size</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Return value semantics have been aligned with those of <code class="docutils literal notranslate"><span class="pre">anjay_get_string()</span></code>
- 0 is returned for success, negative value for error, or
<code class="docutils literal notranslate"><span class="pre">ANJAY_BUFFER_TOO_SHORT</span></code> (1) if the buffer was too small.</p>
<p>Length of the extracted data, which is equivalent to the old return value
semantics, can be retrieved using the new <code class="docutils literal notranslate"><span class="pre">out_bytes_read</span></code> argument, but it
can also be <code class="docutils literal notranslate"><span class="pre">NULL</span></code> if that is not necessary.</p>
</li>
</ul>
</div>
</div>
<div class="section" id="new-error-handling-scheme">
<h2><a class="toc-backref" href="#id9"><span class="section-number">9.1.1.4. </span>New error handling scheme</a><a class="headerlink" href="#new-error-handling-scheme" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>See also the chapter regarding <code class="docutils literal notranslate"><span class="pre">avs_commons</span></code>:
<a class="reference internal" href="MigratingFromAnjay116Commons.html#avs-commons-new-error-handling"><span class="std std-ref">New error handling scheme</span></a></p>
</div>
<p>List of functions and callback function types that changed return value from
<code class="docutils literal notranslate"><span class="pre">int</span></code> to <code class="docutils literal notranslate"><span class="pre">avs_error_t</span></code>, without any other signature changes:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">anjay_bootstrapper()</span></code> (available in commercial version only)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">anjay_access_control_persist()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">anjay_access_control_restore()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">anjay_attr_storage_persist()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">anjay_attr_storage_restore()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">anjay_download_next_block_handler_t</span></code> (callback passed as <code class="docutils literal notranslate"><span class="pre">on_next_block</span></code>
field in <code class="docutils literal notranslate"><span class="pre">anjay_download_config_t</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">anjay_security_persist()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">anjay_security_restore()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">anjay_server_persist()</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">anjay_server_restore()</span></code></p></li>
</ul>
<p>Additional changes related to error handling:</p>
<ul>
<li><p><strong>Scheduler runner</strong></p>
<ul>
<li><p><strong>Old API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">anjay_sched_run</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p><strong>New API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">anjay_sched_run</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>Errors are no longer reported, as their meaning and possible approaches to
error handling were extremely vague. Please treat <code class="docutils literal notranslate"><span class="pre">anjay_sched_run()</span></code> as
always succeeding.</p></li>
</ul>
</li>
<li><p><strong>Downloader function</strong></p>
<ul>
<li><p><strong>Old API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">anjay_download_handle_t</span> <span class="nf">anjay_download</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                                       <span class="k">const</span> <span class="n">anjay_download_config_t</span> <span class="o">*</span><span class="n">config</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p><strong>New API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">avs_error_t</span> <span class="nf">anjay_download</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                           <span class="k">const</span> <span class="n">anjay_download_config_t</span> <span class="o">*</span><span class="n">config</span><span class="p">,</span>
                           <span class="n">anjay_download_handle_t</span> <span class="o">*</span><span class="n">out_handle</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>The download handle is returned via an additional output argument. The
return value contains a detailed error code.</p></li>
</ul>
</li>
<li><p><strong>Download finished handler</strong></p>
<ul>
<li><p><strong>Old API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="kt">void</span>
<span class="nf">anjay_download_finished_handler_t</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span> <span class="kt">int</span> <span class="n">result</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">user_data</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p><strong>New API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="n">anjay_download_result_t</span> <span class="n">result</span><span class="p">;</span>

    <span class="k">union</span> <span class="p">{</span>
        <span class="cm">/**</span>
<span class="cm">         * Error code. Only valid if result is ANJAY_DOWNLOAD_ERR_FAILED.</span>
<span class="cm">         *</span>
<span class="cm">         * Possible values include (but are not limited to):</span>
<span class="cm">         *</span>
<span class="cm">         * - &lt;c&gt;avs_errno(AVS_EADDRNOTAVAIL)&lt;/c&gt; - DNS resolution failed</span>
<span class="cm">         * - &lt;c&gt;avs_errno(AVS_ECONNABORTED)&lt;/c&gt; - remote resource is no longer</span>
<span class="cm">         *   valid</span>
<span class="cm">         * - &lt;c&gt;avs_errno(AVS_ECONNREFUSED)&lt;/c&gt; - server responded with a reset</span>
<span class="cm">         *   message on the application layer (e.g. CoAP Reset)</span>
<span class="cm">         * - &lt;c&gt;avs_errno(AVS_ECONNRESET)&lt;/c&gt; - connection lost or reset</span>
<span class="cm">         * - &lt;c&gt;avs_errno(AVS_EINVAL)&lt;/c&gt; - could not parse response from the</span>
<span class="cm">         *   server</span>
<span class="cm">         * - &lt;c&gt;avs_errno(AVS_EIO)&lt;/c&gt; - internal error in the transfer code</span>
<span class="cm">         * - &lt;c&gt;avs_errno(AVS_EMSGSIZE)&lt;/c&gt; - could not send or receive datagram</span>
<span class="cm">         *   because it was too large</span>
<span class="cm">         * - &lt;c&gt;avs_errno(AVS_ENOMEM)&lt;/c&gt; - out of memory</span>
<span class="cm">         * - &lt;c&gt;avs_errno(AVS_ETIMEDOUT)&lt;/c&gt; - could not receive data from</span>
<span class="cm">         *   server in time</span>
<span class="cm">         */</span>
        <span class="n">avs_error_t</span> <span class="n">error</span><span class="p">;</span>

        <span class="cm">/**</span>
<span class="cm">         * Protocol-specific status code. Only valid if result is</span>
<span class="cm">         * ANJAY_DOWNLOAD_ERR_INVALID_RESPONSE.</span>
<span class="cm">         *</span>
<span class="cm">         * Currently it may be a HTTP status code (e.g. 404 or 501), or a CoAP</span>
<span class="cm">         * code (e.g. 132 or 161 - these examples are canonically interpreted as</span>
<span class="cm">         * 4.04 and 5.01, respectively). If any user log is to depend on status</span>
<span class="cm">         * codes, it is expected that it will be interpreted in line with the</span>
<span class="cm">         * URL originally passed to @ref anjay_download for the same download.</span>
<span class="cm">         */</span>
        <span class="kt">int</span> <span class="n">status_code</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">details</span><span class="p">;</span>
<span class="p">}</span> <span class="n">anjay_download_status_t</span><span class="p">;</span>
<span class="c1">// ...</span>
<span class="k">typedef</span> <span class="kt">void</span> <span class="nf">anjay_download_finished_handler_t</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                                               <span class="n">anjay_download_status_t</span> <span class="n">status</span><span class="p">,</span>
                                               <span class="kt">void</span> <span class="o">*</span><span class="n">user_data</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>The vague <code class="docutils literal notranslate"><span class="pre">int</span> <span class="pre">result</span></code> argument, that could be passed several different
kinds of values, has been replaced with a more descriptive and
better-defined <code class="docutils literal notranslate"><span class="pre">anjay_download_status_t</span></code> structure.</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="updated-security-configuration-for-downloads">
<h2><a class="toc-backref" href="#id10"><span class="section-number">9.1.1.5. </span>Updated security configuration for downloads</a><a class="headerlink" href="#updated-security-configuration-for-downloads" title="Permalink to this headline">¶</a></h2>
<p>A new type called <code class="docutils literal notranslate"><span class="pre">anjay_security_config_t</span></code> has been introduced, used in the
downloader component in places where Anjay 1.x used <code class="docutils literal notranslate"><span class="pre">avs_net_security_info_t</span></code>.
This has been done to enable configuration of (D)TLS ciphersuites in addition to
the values previously available.</p>
<p>The new type is declared as follows:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="cm">/**</span>
<span class="cm">     * DTLS keys or certificates.</span>
<span class="cm">     */</span>
    <span class="n">avs_net_security_info_t</span> <span class="n">security_info</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * Single DANE TLSA record to use for certificate verification, if</span>
<span class="cm">     * applicable.</span>
<span class="cm">     */</span>
    <span class="k">const</span> <span class="n">avs_net_socket_dane_tlsa_record_t</span> <span class="o">*</span><span class="n">dane_tlsa_record</span><span class="p">;</span>

    <span class="cm">/**</span>
<span class="cm">     * TLS ciphersuites to use.</span>
<span class="cm">     *</span>
<span class="cm">     * A value with &lt;c&gt;num_ids == 0&lt;/c&gt; (default) will cause defaults configured</span>
<span class="cm">     * through &lt;c&gt;anjay_configuration_t::default_tls_ciphersuites&lt;/c&gt;</span>
<span class="cm">     * to be used.</span>
<span class="cm">     */</span>
    <span class="n">avs_net_socket_tls_ciphersuites_t</span> <span class="n">tls_ciphersuites</span><span class="p">;</span>
<span class="p">}</span> <span class="n">anjay_security_config_t</span><span class="p">;</span>
</pre></div>
</div>
<p>As described in the documentation cited above, it is safe to only use the
<code class="docutils literal notranslate"><span class="pre">security_info</span></code> field and zero out the rest of the structure.</p>
<p>The following APIs are affected by the change:</p>
<ul>
<li><p><strong>Security-related field in</strong> <code class="docutils literal notranslate"><span class="pre">anjay_download_config_t</span></code></p>
<ul>
<li><p><strong>Old API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">anjay_download_config</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="cm">/**</span>
<span class="cm">     * DTLS keys or certificates. Required if coaps:// is used,</span>
<span class="cm">     * ignored for coap:// transfers.</span>
<span class="cm">     */</span>
    <span class="n">avs_net_security_info_t</span> <span class="n">security_info</span><span class="p">;</span>
    <span class="c1">// ...</span>
<span class="p">}</span> <span class="n">anjay_download_config_t</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p><strong>New API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="nc">anjay_download_config</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="cm">/**</span>
<span class="cm">     * DTLS security configuration. Required if coaps:// is used,</span>
<span class="cm">     * ignored for coap:// transfers.</span>
<span class="cm">     *</span>
<span class="cm">     * Contents of any data aggregated as pointers within is copied as needed,</span>
<span class="cm">     * so it is safe to free all related resources array after the call to</span>
<span class="cm">     * @ref anjay_download.</span>
<span class="cm">     */</span>
    <span class="n">anjay_security_config_t</span> <span class="n">security_config</span><span class="p">;</span>
    <span class="c1">// ...</span>
<span class="p">}</span> <span class="n">anjay_download_config_t</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p>Aside from updating the type, the field name has been changed to
<code class="docutils literal notranslate"><span class="pre">security_config</span></code>.</p></li>
</ul>
</li>
<li><p><strong>Security information getter field in</strong> <code class="docutils literal notranslate"><span class="pre">anjay_fw_update_handlers_t</span></code></p>
<ul>
<li><p><strong>Old API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="kt">int</span>
<span class="nf">anjay_fw_update_get_security_info_t</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">user_ptr</span><span class="p">,</span>
                                    <span class="n">avs_net_security_info_t</span> <span class="o">*</span><span class="n">out_security_info</span><span class="p">,</span>
                                    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">download_uri</span><span class="p">);</span>

<span class="c1">// ...</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="cm">/** Queries security information that shall be used for an encrypted</span>
<span class="cm">     * connection; @ref anjay_fw_update_get_security_info_t */</span>
    <span class="n">anjay_fw_update_get_security_info_t</span> <span class="o">*</span><span class="n">get_security_info</span><span class="p">;</span>
    <span class="c1">// ...</span>
<span class="p">}</span> <span class="n">anjay_fw_update_handlers_t</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p><strong>New API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="kt">int</span> <span class="nf">anjay_fw_update_get_security_config_t</span><span class="p">(</span>
        <span class="kt">void</span> <span class="o">*</span><span class="n">user_ptr</span><span class="p">,</span>
        <span class="n">anjay_security_config_t</span> <span class="o">*</span><span class="n">out_security_info</span><span class="p">,</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">download_uri</span><span class="p">);</span>

<span class="c1">// ...</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="c1">// ...</span>
    <span class="cm">/** Queries security configuration that shall be used for an encrypted</span>
<span class="cm">     * connection; @ref anjay_fw_update_get_security_config_t */</span>
    <span class="n">anjay_fw_update_get_security_config_t</span> <span class="o">*</span><span class="n">get_security_config</span><span class="p">;</span>
    <span class="c1">// ...</span>
<span class="p">}</span> <span class="n">anjay_fw_update_handlers_t</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p>Aside from updating the argument type, both the field and the getter
function type have been renamed to use the word <code class="docutils literal notranslate"><span class="pre">config</span></code> instead of
<code class="docutils literal notranslate"><span class="pre">info</span></code>.</p></li>
</ul>
</li>
<li><p><strong>Getter function for retrieving security information from data model</strong></p>
<ul>
<li><p><strong>Old API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">avs_net_security_info_t</span> <span class="o">*</span><span class="nf">anjay_fw_update_load_security_from_dm</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                                                               <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">uri</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p><strong>New API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span> <span class="nf">anjay_security_config_from_dm</span><span class="p">(</span><span class="n">anjay_t</span> <span class="o">*</span><span class="n">anjay</span><span class="p">,</span>
                                  <span class="n">anjay_security_config_t</span> <span class="o">*</span><span class="n">out_config</span><span class="p">,</span>
                                  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">uri</span><span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>The equivalent function is now declared in <code class="docutils literal notranslate"><span class="pre">anjay/core.h</span></code> instead of
<code class="docutils literal notranslate"><span class="pre">anjay/fw_update.h</span></code>, and has a different signature.</p>
<p>The security configuration is now returned through an output argument with
any necessary internal buffers cached inside the Anjay object instead of
using heap allocation. Please refer to the Doxygen-based documenation of
this function for details.</p>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="changes-to-cmake-option-variables">
<h2><a class="toc-backref" href="#id11"><span class="section-number">9.1.1.6. </span>Changes to CMake option variables</a><a class="headerlink" href="#changes-to-cmake-option-variables" title="Permalink to this headline">¶</a></h2>
<p>The following CMake options have been renamed or replaced with others with
similar semantics:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 49%" />
<col style="width: 51%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Old variable</p></th>
<th class="head"><p>New variable and notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">WITH_BLOCK_DOWNLOAD</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">WITH_COAP_DOWNLOAD</span></code></div>
<div class="line">Part of the new <code class="docutils literal notranslate"><span class="pre">avs_coap</span></code> component</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">WITH_BLOCK_RECEIVE</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">WITH_BLOCK_SEND</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">WITH_AVS_COAP_BLOCK</span></code> (for both directions)</div>
<div class="line">Part of the new <code class="docutils literal notranslate"><span class="pre">avs_coap</span></code> component</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">WITH_JSON</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">WITH_LWM2M_JSON</span></code></div>
<div class="line">Refers to the legacy LwM2M 1.0 JSON format only</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">WITH_REGISTRATION_AND_OBSERVE_PERSISTENCE</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">WITH_CORE_PERSISTENCE</span></code></div>
<div class="line">Available in commercial version only</div>
</div>
</td>
</tr>
</tbody>
</table>
<p>Additionally, the following variables have been removed:</p>
<blockquote>
<div><ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">MAX_FLOAT_STRING_SIZE</span></code> - <code class="docutils literal notranslate"><span class="pre">double</span></code> is now always used when stringifying</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MAX_OBSERVABLE_RESOURCE_SIZE</span></code> - no hard limit is imposed in the current
version</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">WITH_ATTR_STORAGE</span></code> - removed due to overlapping semantics with
<code class="docutils literal notranslate"><span class="pre">WITH_MODULE_attr_storage</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">WITH_AVS_COAP_MESSAGE_CACHE</span></code> - message cache is always enabled in the
current version</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="other-changes">
<h2><a class="toc-backref" href="#id12"><span class="section-number">9.1.1.7. </span>Other changes</a><a class="headerlink" href="#other-changes" title="Permalink to this headline">¶</a></h2>
<p>Declaration of <code class="docutils literal notranslate"><span class="pre">anjay_smsdrv_cleanup()</span></code> (only relevant for the commercial
version) has been moved from <code class="docutils literal notranslate"><span class="pre">anjay/core.h</span></code> to <code class="docutils literal notranslate"><span class="pre">anjay/sms.h</span></code>.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="MigratingFromAnjay116Coap.html" class="btn btn-neutral float-right" title="9.1.2. Replacement of CoAP implementation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="../MigratingFromAnjay116.html" class="btn btn-neutral float-left" title="9.1. Migrating from Anjay 1.16" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2017-2021, AVSystem.

    </p>
  </div> 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>