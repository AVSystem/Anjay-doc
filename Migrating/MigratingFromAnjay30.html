<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>11.9. Migrating from Anjay 3.0 &mdash; Anjay 3.11.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=8905d4f5"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="11.10. Migrating from Anjay 3.1 or 3.2" href="MigratingFromAnjay32.html" />
    <link rel="prev" title="11.8. Migrating from Anjay 2.15.x" href="MigratingFromAnjay215.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #ffd500" >

          
          
          <a href="../index.html">
            
              <img src="../_static/avsystem_header.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                3.11.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LwM2M.html">2. OMA LwM2M - Brief description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Compiling_client_applications.html">3. Compiling client applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../BasicClient.html">4. Basic client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../AdvancedTopics.html">5. Advanced topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FirmwareUpdateTutorial.html">6. Firmware Update Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LwM2MGateway.html">7. LwM2M Gateway</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Tools.html">8. Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../API_description.html">9. API description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PortingGuideForNonPOSIXPlatforms.html">10. Porting guide for non-POSIX platforms</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../Migrating.html">11. Migrating from older versions</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="MigratingFromAnjay225.html">11.1. Migrating from Anjay 2.2.5</a></li>
<li class="toctree-l2"><a class="reference internal" href="MigratingCustomEntropy.html">11.2. Migrating mbed TLS custom entropy initializers</a></li>
<li class="toctree-l2"><a class="reference internal" href="MigratingFromAnjay24.html">11.3. Migrating from Anjay 2.3.x or 2.4.x</a></li>
<li class="toctree-l2"><a class="reference internal" href="MigratingFromAnjay26.html">11.4. Migrating from Anjay 2.5.x or 2.6.x</a></li>
<li class="toctree-l2"><a class="reference internal" href="MigratingFromAnjay27.html">11.5. Migrating from Anjay 2.7.x</a></li>
<li class="toctree-l2"><a class="reference internal" href="MigratingFromAnjay28.html">11.6. Migrating from Anjay 2.8.x</a></li>
<li class="toctree-l2"><a class="reference internal" href="MigratingFromAnjay214.html">11.7. Migrating from Anjay 2.9.x-2.14.x</a></li>
<li class="toctree-l2"><a class="reference internal" href="MigratingFromAnjay215.html">11.8. Migrating from Anjay 2.15.x</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">11.9. Migrating from Anjay 3.0</a></li>
<li class="toctree-l2"><a class="reference internal" href="MigratingFromAnjay32.html">11.10. Migrating from Anjay 3.1 or 3.2</a></li>
<li class="toctree-l2"><a class="reference internal" href="MigratingFromAnjay33.html">11.11. Migrating from Anjay 3.3</a></li>
<li class="toctree-l2"><a class="reference internal" href="MigratingFromAnjay34.html">11.12. Migrating from Anjay 3.4</a></li>
<li class="toctree-l2"><a class="reference internal" href="MigratingFromAnjay37.html">11.13. Migrating from Anjay 3.7</a></li>
<li class="toctree-l2"><a class="reference internal" href="MigratingFromAnjay310.html">11.14. Migrating from Anjay 3.10</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../CommercialFeatures.html">12. Commercial features</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #ffd500" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Anjay</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../Migrating.html"><span class="section-number">11. </span>Migrating from older versions</a></li>
      <li class="breadcrumb-item active"><span class="section-number">11.9. </span>Migrating from Anjay 3.0</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="migrating-from-anjay-3-0">
<h1><span class="section-number">11.9. </span>Migrating from Anjay 3.0<a class="headerlink" href="#migrating-from-anjay-3-0" title="Link to this heading"></a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#introduction" id="id1">Introduction</a></p></li>
<li><p><a class="reference internal" href="#changes-in-anjay-proper" id="id2">Changes in Anjay proper</a></p>
<ul>
<li><p><a class="reference internal" href="#behavior-of-anjay-attr-storage-restore-upon-failure" id="id3">Behavior of anjay_attr_storage_restore() upon failure</a></p></li>
<li><p><a class="reference internal" href="#default-d-tls-version" id="id4">Default (D)TLS version</a></p></li>
<li><p><a class="reference internal" href="#persistence-of-disabled-servers" id="id5">Persistence of disabled servers</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#changes-in-avs-coap" id="id6">Changes in avs_coap</a></p>
<ul>
<li><p><a class="reference internal" href="#changed-flow-of-cancelling-observations-in-case-of-errors" id="id7">Changed flow of cancelling observations in case of errors</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#changes-in-avs-commons" id="id8">Changes in avs_commons</a></p>
<ul>
<li><p><a class="reference internal" href="#refactor-of-time-handling-in-avs-sched-and-avs-coap" id="id9">Refactor of time handling in avs_sched and avs_coap</a></p></li>
<li><p><a class="reference internal" href="#removal-of-avs-unit-memstream" id="id10">Removal of avs_unit_memstream</a></p></li>
</ul>
</li>
</ul>
</nav>
<section id="introduction">
<h2><a class="toc-backref" href="#id1" role="doc-backlink"><span class="section-number">11.9.1. </span>Introduction</a><a class="headerlink" href="#introduction" title="Link to this heading"></a></h2>
<p>Since Anjay 3.0, some minor changes to the API has been done. These change are
breaking in the strictest sense, but in practice should not require any changes
to user code in typical usage.</p>
</section>
<section id="changes-in-anjay-proper">
<h2><a class="toc-backref" href="#id2" role="doc-backlink"><span class="section-number">11.9.2. </span>Changes in Anjay proper</a><a class="headerlink" href="#changes-in-anjay-proper" title="Link to this heading"></a></h2>
<section id="behavior-of-anjay-attr-storage-restore-upon-failure">
<h3><a class="toc-backref" href="#id3" role="doc-backlink"><span class="section-number">11.9.2.1. </span>Behavior of anjay_attr_storage_restore() upon failure</a><a class="headerlink" href="#behavior-of-anjay-attr-storage-restore-upon-failure" title="Link to this heading"></a></h3>
<p>Deprecated behavior of <code class="docutils literal notranslate"><span class="pre">anjay_attr_storage_restore()</span></code> which did clear the
Attribute Storage if supplied source stream was invalid has been changed. From
now on, if this function fails, the Attribute Storage remains untouched.
This change is breaking for code which relied on the old behavior, although
such code is unlikely.</p>
</section>
<section id="default-d-tls-version">
<h3><a class="toc-backref" href="#id4" role="doc-backlink"><span class="section-number">11.9.2.2. </span>Default (D)TLS version</a><a class="headerlink" href="#default-d-tls-version" title="Link to this heading"></a></h3>
<p>When the <a class="reference external" href="../api/structanjay__configuration.html#ab32477e7370a36e02db5b7e7ccbdd89d">anjay_configuration_t::dtls_version</a>
field is set to <code class="docutils literal notranslate"><span class="pre">AVS_NET_SSL_VERSION_DEFAULT</span></code> (which includes the case of
zero-initialization), Anjay 3.0 and earlier automatically mapped this setting to
<code class="docutils literal notranslate"><span class="pre">AVS_NET_SSL_VERSION_TLSv1_2</span></code> to ensure that (D)TLS 1.2 is used as mandated by
the LwM2M specification.</p>
<p>This mapping has been removed in Anjay 3.1, which means that the default version
configuration of the underlying (D)TLS library will be used. This has been done
to automatically allow the use of newer protocols and deprecate old versions
when the backend library is updated, without the need to update Anjay code.
However, depending on the (D)TLS backend library used, this may lead to (D)TLS
1.1 or earlier being used if the server does not properly negotiate a higher
version. Please explicitly set <code class="docutils literal notranslate"><span class="pre">dtls_version</span></code> to
<code class="docutils literal notranslate"><span class="pre">AVS_NET_SSL_VERSION_TLSv1_2</span></code> if you want to disallow this.</p>
<p>Please note that Mbed TLS 3.0 has dropped support for TLS 1.1 and earlier, so
this change will not affect behavior with that library.</p>
</section>
<section id="persistence-of-disabled-servers">
<h3><a class="toc-backref" href="#id5" role="doc-backlink"><span class="section-number">11.9.2.3. </span>Persistence of disabled servers</a><a class="headerlink" href="#persistence-of-disabled-servers" title="Link to this heading"></a></h3>
<p>Core Persistence API (<code class="docutils literal notranslate"><span class="pre">anjay_new_from_core_persistence()</span></code>,
<code class="docutils literal notranslate"><span class="pre">anjay_delete_with_core_persistence()</span></code>) now also persists disabled servers
(either by execution of /1/x/4 or call to function from
<code class="docutils literal notranslate"><span class="pre">anjay_disable_server*()</span></code> family) and the time at which the client shall
reconnect them. Previously those disabled servers weren’t persisted at all and
freshly initialized client was automatically connecting to them without any
regard for specified timeout.</p>
</section>
</section>
<section id="changes-in-avs-coap">
<h2><a class="toc-backref" href="#id6" role="doc-backlink"><span class="section-number">11.9.3. </span>Changes in avs_coap</a><a class="headerlink" href="#changes-in-avs-coap" title="Link to this heading"></a></h2>
<section id="changed-flow-of-cancelling-observations-in-case-of-errors">
<h3><a class="toc-backref" href="#id7" role="doc-backlink"><span class="section-number">11.9.3.1. </span>Changed flow of cancelling observations in case of errors</a><a class="headerlink" href="#changed-flow-of-cancelling-observations-in-case-of-errors" title="Link to this heading"></a></h3>
<p>CoAP observations are implicitly cancelled if a notification bearing a 4.xx or
5.xx error code is delivered.</p>
<p>In Anjay 3.4.x and earlier, this cancellation (which involves calling the
<code class="docutils literal notranslate"><span class="pre">avs_coap_observe_cancel_handler_t</span></code> callback) was performed <em>before</em> calling
the <code class="docutils literal notranslate"><span class="pre">avs_coap_delivery_status_handler_t</span></code> callback for the specific
notification. Since Anjay 3.5.0, this order is reversed, so any code that relies
on this logic may break.</p>
<p>This change is only relevant if you are using <code class="docutils literal notranslate"><span class="pre">avs_coap</span></code> APIs directly (e.g.
when communicating over raw CoAP protocol) and in case of notifications intended
to be delivered as confirmable. The LwM2M Observe/Notify implementation in Anjay
has been updated accordingly.</p>
</section>
</section>
<section id="changes-in-avs-commons">
<h2><a class="toc-backref" href="#id8" role="doc-backlink"><span class="section-number">11.9.4. </span>Changes in avs_commons</a><a class="headerlink" href="#changes-in-avs-commons" title="Link to this heading"></a></h2>
<section id="refactor-of-time-handling-in-avs-sched-and-avs-coap">
<h3><a class="toc-backref" href="#id9" role="doc-backlink"><span class="section-number">11.9.4.1. </span>Refactor of time handling in avs_sched and avs_coap</a><a class="headerlink" href="#refactor-of-time-handling-in-avs-sched-and-avs-coap" title="Link to this heading"></a></h3>
<p>It is now enforced more strictly that time-based events shall happen when the
clock reaches <em>at least</em> the expected value. Previously, the tasks scheduled via
avs_sched were executed only when the clock reached a value <em>later</em> than the
scheduled job execution time.</p>
<p>This change will have no impact on your code if your platform has enough clock
resolution so that two subsequent calls to <code class="docutils literal notranslate"><span class="pre">avs_time_real_now()</span></code> or
<code class="docutils literal notranslate"><span class="pre">avs_time_monotonic_now()</span></code> will <em>always</em> return different values. As a rule of
thumb, this should be the case if your clock has a resolution no worse than
about 1-2 orders of magnitude smaller than the CPU clock. For example, for a
100 MHz CPU, a clock resolution of around 100-1000 ns (i.e., 1-10 MHz) should be
sufficient, depending on the specific architecture.</p>
<p>If your clock has a lower resolution, you may observe the following changes:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">anjay_sched_run()</span></code> is now properly guaranteed to execute at least one job
if the time reported by <code class="docutils literal notranslate"><span class="pre">anjay_sched_time_to_next()</span></code> passed. Previously this
could require waiting for another change of the numerical value of the clock,
which could cause undesirable active waiting in the event loop. This is the
motivating factor in introducing these changes.</p></li>
<li><p>Jobs scheduled using <code class="docutils literal notranslate"><span class="pre">AVS_SCHED_NOW()</span></code> during an execution of
<code class="docutils literal notranslate"><span class="pre">anjay_sched_run()</span></code> before the numerical value of the clock changes, <em>will</em>
be executed during the same run. The previous behavior more strictly enforced
the policy to not execute such jobs in the same run.</p></li>
</ul>
<p>If you are scheduling custom jobs through the avs_sched module, you may want or
need to modify their logic accordingly to accommodate for these changes. In most
typical use cases, no changes are expected to be necessary.</p>
</section>
<section id="removal-of-avs-unit-memstream">
<h3><a class="toc-backref" href="#id10" role="doc-backlink"><span class="section-number">11.9.4.2. </span>Removal of avs_unit_memstream</a><a class="headerlink" href="#removal-of-avs-unit-memstream" title="Link to this heading"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">avs_unit_memstream</span></code> was a specific implementation of <code class="docutils literal notranslate"><span class="pre">avs_stream_t</span></code> within
the avs_unit module that implemented a simple FIFO stream in a fixed-size memory
area.</p>
<p>This feature has been removed. Instead, you can use an
<code class="docutils literal notranslate"><span class="pre">avs_stream_inbuf</span></code>/<code class="docutils literal notranslate"><span class="pre">avs_stream_outbuf</span></code> pair, or an <code class="docutils literal notranslate"><span class="pre">avs_stream_membuf</span></code>
object.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="MigratingFromAnjay215.html" class="btn btn-neutral float-left" title="11.8. Migrating from Anjay 2.15.x" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="MigratingFromAnjay32.html" class="btn btn-neutral float-right" title="11.10. Migrating from Anjay 3.1 or 3.2" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017-2025, AVSystem.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>