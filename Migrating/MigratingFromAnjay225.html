<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>9.1. Migrating from Anjay 2.2.5 &mdash; Anjay 3.0.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="9.2. Migrating mbed TLS custom entropy initializers" href="MigratingCustomEntropy.html" />
    <link rel="prev" title="9. Migrating from older versions" href="../Migrating.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #ffd500" >
            <a href="../index.html">
            <img src="../_static/avsystem_header.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                3.0.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../LwM2M.html">2. OMA LwM2M - Brief description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Compiling_client_applications.html">3. Compiling client applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../BasicClient.html">4. Basic client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../AdvancedTopics.html">5. Advanced topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../FirmwareUpdateTutorial.html">6. Firmware Update Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Tools.html">7. Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../PortingGuideForNonPOSIXPlatforms.html">8. Porting guide for non-POSIX platforms</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../Migrating.html">9. Migrating from older versions</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">9.1. Migrating from Anjay 2.2.5</a></li>
<li class="toctree-l2"><a class="reference internal" href="MigratingCustomEntropy.html">9.2. Migrating mbed TLS custom entropy initializers</a></li>
<li class="toctree-l2"><a class="reference internal" href="MigratingFromAnjay24.html">9.3. Migrating from Anjay 2.3.x or 2.4.x</a></li>
<li class="toctree-l2"><a class="reference internal" href="MigratingFromAnjay26.html">9.4. Migrating from Anjay 2.5.x or 2.6.x</a></li>
<li class="toctree-l2"><a class="reference internal" href="MigratingFromAnjay27.html">9.5. Migrating from Anjay 2.7.x</a></li>
<li class="toctree-l2"><a class="reference internal" href="MigratingFromAnjay28.html">9.6. Migrating from Anjay 2.8.x</a></li>
<li class="toctree-l2"><a class="reference internal" href="MigratingFromAnjay214.html">9.7. Migrating from Anjay 2.9.x-2.14.x</a></li>
<li class="toctree-l2"><a class="reference internal" href="MigratingFromAnjay215.html">9.8. Migrating from Anjay 2.15.x</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../CommercialFeatures.html">10. Commercial features</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #ffd500" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Anjay</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../Migrating.html"><span class="section-number">9. </span>Migrating from older versions</a> &raquo;</li>
      <li><span class="section-number">9.1. </span>Migrating from Anjay 2.2.5</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="migrating-from-anjay-2-2-5">
<h1><span class="section-number">9.1. </span>Migrating from Anjay 2.2.5<a class="headerlink" href="#migrating-from-anjay-2-2-5" title="Permalink to this headline"></a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#introduction" id="id2">Introduction</a></p></li>
<li><p><a class="reference internal" href="#change-to-minimum-cmake-version" id="id3">Change to minimum CMake version</a></p></li>
<li><p><a class="reference internal" href="#changes-in-anjay-proper" id="id4">Changes in Anjay proper</a></p>
<ul>
<li><p><a class="reference internal" href="#removal-of-ssize-t-usages-from-anjay-apis" id="id5">Removal of ssize_t usages from Anjay APIs</a></p></li>
<li><p><a class="reference internal" href="#refactor-of-the-attribute-storage-module" id="id6">Refactor of the Attribute Storage module</a></p></li>
<li><p><a class="reference internal" href="#refactor-of-offline-mode-control-api" id="id7">Refactor of offline mode control API</a></p></li>
<li><p><a class="reference internal" href="#addition-of-the-con-attribute-to-public-api" id="id8">Addition of the con attribute to public API</a></p></li>
<li><p><a class="reference internal" href="#other-changes" id="id9">Other changes</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#changes-in-avs-coap" id="id10">Changes in avs_coap</a></p></li>
<li><p><a class="reference internal" href="#changes-in-avs-commons" id="id11">Changes in avs_commons</a></p>
<ul>
<li><p><a class="reference internal" href="#avs-commons-header-rename" id="id12">avs_commons header rename</a></p></li>
<li><p><a class="reference internal" href="#changes-to-avs-net-socket-api" id="id13">Changes to avs_net socket API</a></p>
<ul>
<li><p><a class="reference internal" href="#introduction-of-new-socket-option" id="id14">Introduction of new socket option</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#removal-of-ssize-t-usages-from-avs-commons-apis" id="id15">Removal of ssize_t usages from avs_commons APIs</a></p></li>
<li><p><a class="reference internal" href="#move-of-public-key-cryptography-apis-from-avs-net-to-avs-crypto" id="id16">Move of public-key cryptography APIs from avs_net to avs_crypto</a></p></li>
<li><p><a class="reference internal" href="#refactor-of-psk-credential-handling" id="id17">Refactor of PSK credential handling</a></p></li>
<li><p><a class="reference internal" href="#changes-to-public-configuration-macros" id="id18">Changes to public configuration macros</a></p></li>
<li><p><a class="reference internal" href="#refactor-of-avs-net-validate-ip-address-and-avs-net-local-address-for-target-host" id="id19">Refactor of avs_net_validate_ip_address() and avs_net_local_address_for_target_host()</a></p></li>
<li><p><a class="reference internal" href="#changes-in-component-dependencies" id="id20">Changes in component dependencies</a></p></li>
<li><p><a class="reference internal" href="#removal-of-the-legacy-coap-component" id="id21">Removal of the legacy CoAP component</a></p></li>
</ul>
</li>
</ul>
</div>
<section id="introduction">
<h2><a class="toc-backref" href="#id2"><span class="section-number">9.1.1. </span>Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline"></a></h2>
<p>Most changes since Anjay 2.2.5 are minor, so no major changes in code flow are
required when porting from Anjay 2.2. However, there has been a significant
refactor in project structure, so some changes may be breaking for some users.</p>
</section>
<section id="change-to-minimum-cmake-version">
<h2><a class="toc-backref" href="#id3"><span class="section-number">9.1.2. </span>Change to minimum CMake version</a><a class="headerlink" href="#change-to-minimum-cmake-version" title="Permalink to this headline"></a></h2>
<p>Declared minimum CMake version necessary for CMake-based compilation, as well as
for importing the installed library through <code class="docutils literal notranslate"><span class="pre">find_package()</span></code>, is now 3.6. If
you’re using some Linux distribution that only has an older version in its
repositories (notably, Ubuntu 16.04), we recommend using one of the following
install methods instead:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://apt.kitware.com/">Kitware APT Repository for Debian and Ubuntu</a></p></li>
<li><p><a class="reference external" href="https://snapcraft.io/cmake">Snap Store</a> (<code class="docutils literal notranslate"><span class="pre">snap</span> <span class="pre">install</span> <span class="pre">cmake</span></code>)</p></li>
<li><p><a class="reference external" href="https://pypi.org/project/cmake/">Python Package Index</a>
(<code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">cmake</span></code>)</p></li>
</ul>
<p>This change does not affect users who compile the library using some alternative
approach, without using the provided CMake scripts.</p>
</section>
<section id="changes-in-anjay-proper">
<h2><a class="toc-backref" href="#id4"><span class="section-number">9.1.3. </span>Changes in Anjay proper</a><a class="headerlink" href="#changes-in-anjay-proper" title="Permalink to this headline"></a></h2>
<section id="removal-of-ssize-t-usages-from-anjay-apis">
<h3><a class="toc-backref" href="#id5"><span class="section-number">9.1.3.1. </span>Removal of ssize_t usages from Anjay APIs</a><a class="headerlink" href="#removal-of-ssize-t-usages-from-anjay-apis" title="Permalink to this headline"></a></h3>
<p>Most changes in Anjay proper relate to the removal of usages of the
POSIX-specific <code class="docutils literal notranslate"><span class="pre">size_t</span></code> type in Anjay and all related projects. See also
<a class="reference internal" href="#ssize-t-removal-in-commons-225"><span class="std std-ref">Removal of ssize_t usages from avs_commons APIs</span></a>.</p>
<p>Here is a summary of the relevant API changes:</p>
<ul>
<li><p><strong>Execute argument value getter</strong></p>
<ul>
<li><p><strong>Old API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">ssize_t</span><span class="w"> </span><span class="nf">anjay_execute_get_arg_value</span><span class="p">(</span><span class="n">anjay_execute_ctx_t</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">out_buf</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">buf_size</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p><strong>New API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">anjay_execute_get_arg_value</span><span class="p">(</span><span class="n">anjay_execute_ctx_t</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">,</span><span class="w"></span>
</span><span class="hll"><span class="w">                                 </span><span class="kt">size_t</span><span class="w"> </span><span class="o">*</span><span class="n">out_bytes_read</span><span class="p">,</span><span class="w"></span>
</span><span class="w">                                 </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">out_buf</span><span class="p">,</span><span class="w"></span>
<span class="w">                                 </span><span class="kt">size_t</span><span class="w"> </span><span class="n">buf_size</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>Return value semantics have been aligned with those of
<code class="docutils literal notranslate"><span class="pre">anjay_get_string()</span></code> - 0 is returned for success, negative value for
error, or <code class="docutils literal notranslate"><span class="pre">ANJAY_BUFFER_TOO_SHORT</span></code> (1) if the buffer was too small.</p>
<p>Length of the extracted data, which is equivalent to the old return value
semantics, can be retrieved using the new <code class="docutils literal notranslate"><span class="pre">out_bytes_read</span></code> argument, but
it can also be <code class="docutils literal notranslate"><span class="pre">NULL</span></code> if that is not necessary.</p>
</li>
</ul>
</li>
<li><p><strong>NIDD driver receive callback</strong></p>
<ul>
<li><p><strong>Old API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="kt">ssize_t</span><span class="w"> </span><span class="nf">anjay_nidd_driver_recv_t</span><span class="p">(</span><span class="n">anjay_nidd_driver_t</span><span class="w"> </span><span class="o">*</span><span class="n">driver</span><span class="p">,</span><span class="w"></span>
<span class="w">                                         </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">out_message</span><span class="p">,</span><span class="w"></span>
<span class="w">                                         </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"></span>
<span class="w">                                         </span><span class="n">avs_time_monotonic_t</span><span class="w"> </span><span class="n">deadline</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p><strong>New API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="w"> </span><span class="k">typedef</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">anjay_nidd_driver_recv_t</span><span class="p">(</span><span class="n">anjay_nidd_driver_t</span><span class="w"> </span><span class="o">*</span><span class="n">driver</span><span class="p">,</span><span class="w"></span>
</span><span class="hll"><span class="w">                                      </span><span class="kt">size_t</span><span class="w"> </span><span class="o">*</span><span class="n">out_bytes_received</span><span class="p">,</span><span class="w"></span>
</span><span class="w">                                      </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">out_message</span><span class="p">,</span><span class="w"></span>
<span class="w">                                      </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"></span>
<span class="w">                                      </span><span class="n">avs_time_monotonic_t</span><span class="w"> </span><span class="n">deadline</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>The callback shall now return 0 for all success conditions (i.e., for all
the conditions when it previously returned a non-negative value).</p>
<p>Number of bytes received shall now be returned using the new
<code class="docutils literal notranslate"><span class="pre">out_bytes_received</span></code> argument.</p>
</li>
</ul>
</li>
<li><p><strong>Get line callback for the BG96 NIDD driver (as a commercial feature only)</strong></p>
<ul>
<li><p><strong>Old API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="kt">ssize_t</span><span class="w"> </span><span class="nf">anjay_bg96_nidd_getline_t</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">user_context</span><span class="p">,</span><span class="w"></span>
<span class="w">                                          </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">out_line_buffer</span><span class="p">,</span><span class="w"></span>
<span class="w">                                          </span><span class="kt">size_t</span><span class="w"> </span><span class="n">buffer_size</span><span class="p">,</span><span class="w"></span>
<span class="w">                                          </span><span class="n">avs_time_monotonic_t</span><span class="w"> </span><span class="n">deadline</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p><strong>New API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="w"> </span><span class="k">typedef</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">anjay_bg96_nidd_getline_t</span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">user_context</span><span class="p">,</span><span class="w"></span>
</span><span class="hll"><span class="w">                                       </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">out_line_buffer</span><span class="p">,</span><span class="w"></span>
</span><span class="w">                                       </span><span class="kt">size_t</span><span class="w"> </span><span class="n">buffer_size</span><span class="p">,</span><span class="w"></span>
<span class="w">                                       </span><span class="n">avs_time_monotonic_t</span><span class="w"> </span><span class="n">deadline</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>The callback shall now return 0 for all success conditions (i.e., for all
the conditions when it previously returned a non-negative value).</p>
<p>The length of returned data, which was the previous return value, is not
actually used as it is implicit due to the requirement for string
null-termination.</p>
</li>
</ul>
</li>
</ul>
</section>
<section id="refactor-of-the-attribute-storage-module">
<h3><a class="toc-backref" href="#id6"><span class="section-number">9.1.3.2. </span>Refactor of the Attribute Storage module</a><a class="headerlink" href="#refactor-of-the-attribute-storage-module" title="Permalink to this headline"></a></h3>
<p>The Attribute Storage feature is no longer a standalone module and has been
moved to the library core. From the user perspective, this has the following
consequences:</p>
<ul class="simple">
<li><p>Explicit installation of this module in runtime is no longer necessary. The
<code class="docutils literal notranslate"><span class="pre">anjay_attr_storage_install()</span></code> method has been removed.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">ANJAY_WITH_MODULE_ATTR_STORAGE</span></code> configuration macro in
<code class="docutils literal notranslate"><span class="pre">anjay_config.h</span></code> has been renamed to <code class="docutils literal notranslate"><span class="pre">ANJAY_WITH_ATTR_STORAGE</span></code>.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">WITH_MODULE_attr_storage</span></code> CMake option (equivalent to the macro
mentioned above) has been renamed to <code class="docutils literal notranslate"><span class="pre">WITH_ATTR_STORAGE</span></code>.</p></li>
</ul>
<p>Additionally, the behavior of <code class="docutils literal notranslate"><span class="pre">anjay_attr_storage_restore()</span></code> has been
changed - from now on, this function fails if supplied source stream is
empty. This change makes the function consistent with other
<code class="docutils literal notranslate"><span class="pre">anjay_*_restore()</span></code> APIs.</p>
</section>
<section id="refactor-of-offline-mode-control-api">
<h3><a class="toc-backref" href="#id7"><span class="section-number">9.1.3.3. </span>Refactor of offline mode control API</a><a class="headerlink" href="#refactor-of-offline-mode-control-api" title="Permalink to this headline"></a></h3>
<p>Since Anjay 2.4, offline mode is configurable independently per every
transport. Below is a list of removed functions and counterparts that should
be used:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 43%" />
<col style="width: 57%" />
</colgroup>
<tbody>
<tr class="row-odd"><td><p>Removed function</p></td>
<td><p>Counterpart</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">anjay_is_offline()</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">anjay_transport_is_offline()</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">anjay_enter_offline()</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">anjay_transport_enter_offline()</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">anjay_exit_offline()</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">anjay_transport_exit_offline()</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">anjay_schedule_reconnect()</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">anjay_transport_schedule_reconnect()</span></code></p></td>
</tr>
</tbody>
</table>
<p>New functions should be called with <code class="docutils literal notranslate"><span class="pre">transport_set</span></code> argument set to
<code class="docutils literal notranslate"><span class="pre">ANJAY_TRANSPORT_SET_ALL</span></code> to achieve the same behavior.</p>
</section>
<section id="addition-of-the-con-attribute-to-public-api">
<h3><a class="toc-backref" href="#id8"><span class="section-number">9.1.3.4. </span>Addition of the con attribute to public API</a><a class="headerlink" href="#addition-of-the-con-attribute-to-public-api" title="Permalink to this headline"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">con</span></code> attribute, enabled via the <code class="docutils literal notranslate"><span class="pre">WITH_CON_ATTR</span></code> CMake option, has been
previously supported as a custom extension. Since an identical flag has been
standardized as part of LwM2M TS 1.2, it has been included in the public API as
part of preparations to support the new protocol version.</p>
<p>If you initialize <code class="docutils literal notranslate"><span class="pre">anjay_dm_oi_attributes_t</span></code> or <code class="docutils literal notranslate"><span class="pre">anjay_dm_r_attributes_t</span></code>
objects manually, you may need to initialize the new <code class="docutils literal notranslate"><span class="pre">con</span></code> field as well,
since the empty <code class="docutils literal notranslate"><span class="pre">ANJAY_DM_CON_ATTR_NONE</span></code> value is <strong>NOT</strong> the default
zero-initialized value.</p>
<p>As more new attributes may be added in future versions of Anjay, it is
recommended to initialize such structures with <code class="docutils literal notranslate"><span class="pre">ANJAY_DM_OI_ATTRIBUTES_EMPTY</span></code>
or <code class="docutils literal notranslate"><span class="pre">ANJAY_DM_R_ATTRIBUTES_EMPTY</span></code> constants, and then fill in the attributes
you actually intend to set.</p>
</section>
<section id="other-changes">
<h3><a class="toc-backref" href="#id9"><span class="section-number">9.1.3.5. </span>Other changes</a><a class="headerlink" href="#other-changes" title="Permalink to this headline"></a></h3>
<ul>
<li><p>Declaration of <code class="docutils literal notranslate"><span class="pre">anjay_smsdrv_cleanup()</span></code> has been moved from <code class="docutils literal notranslate"><span class="pre">anjay/core.h</span></code>
to <code class="docutils literal notranslate"><span class="pre">anjay/sms.h</span></code> in versions that include the SMS commercial feature. It has
been removed altogether from versions that do not support SMS.</p></li>
<li><p>The following compile-time constants have been removed. None of them have been
actually used in Anjay 2.x:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">MAX_FLOAT_STRING_SIZE</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MAX_OBSERVABLE_RESOURCE_SIZE</span></code></p></li>
</ul>
</li>
<li><p><strong>Getter function for retrieving security information from data model</strong></p>
<ul>
<li><p><strong>Old API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">anjay_security_config_t</span><span class="w"> </span><span class="o">*</span><span class="nf">anjay_security_config_from_dm</span><span class="p">(</span><span class="n">anjay_t</span><span class="w"> </span><span class="o">*</span><span class="n">anjay</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                       </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">uri</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p><strong>New API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span><span class="w"> </span><span class="nf">anjay_security_config_from_dm</span><span class="p">(</span><span class="n">anjay_t</span><span class="w"> </span><span class="o">*</span><span class="n">anjay</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="n">anjay_security_config_t</span><span class="w"> </span><span class="o">*</span><span class="n">out_config</span><span class="p">,</span><span class="w"></span>
<span class="w">                                  </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">uri</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>The security configuration is now returned through an output argument with
any necessary internal buffers cached inside the Anjay object instead of
using heap allocation. Please refer to the Doxygen-based documentation of
this function for details.</p>
<p>Due to the change in lifetime requirements, no compatibility variant is
provided.</p>
</li>
</ul>
</li>
</ul>
<ul>
<li><p><strong>NIDD driver MTU callback (as a commercial feature only)</strong></p>
<ul>
<li><p><strong>Old API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">anjay_nidd_driver_mtu_t</span><span class="p">(</span><span class="n">anjay_nidd_driver_t</span><span class="w"> </span><span class="o">*</span><span class="n">driver</span><span class="p">,</span><span class="w"></span>
<span class="w">                                    </span><span class="kt">size_t</span><span class="w"> </span><span class="o">*</span><span class="n">out_mtu</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p><strong>New API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="w"> </span><span class="k">typedef</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">anjay_nidd_driver_outgoing_mtu_t</span><span class="p">(</span><span class="n">anjay_nidd_driver_t</span><span class="w"> </span><span class="o">*</span><span class="n">driver</span><span class="p">,</span><span class="w"></span>
</span><span class="w">                                              </span><span class="kt">size_t</span><span class="w"> </span><span class="o">*</span><span class="n">out_mtu</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p>The current name is more descriptive. The behavior did not change. This
handler was always designed for returning maximum number of bytes that can
be <strong>sent</strong> through NIDD.</p>
<p>An additional <code class="docutils literal notranslate"><span class="pre">incoming_mtu</span></code> callback can now also be specified. To retain
compatibility with versions 2.4-2.4.1, it is permitted to specify only one
of them and leave the other as <code class="docutils literal notranslate"><span class="pre">NULL</span></code> - in that case the returned value
will be used as both outgoing and incoming MTU.</p>
</li>
</ul>
</li>
</ul>
</section>
</section>
<section id="changes-in-avs-coap">
<h2><a class="toc-backref" href="#id10"><span class="section-number">9.1.4. </span>Changes in avs_coap</a><a class="headerlink" href="#changes-in-avs-coap" title="Permalink to this headline"></a></h2>
<p>If you are using <code class="docutils literal notranslate"><span class="pre">avs_coap</span></code> APIs directly (e.g. when communicating over raw
CoAP protocol), please note that following breaking changes in the <code class="docutils literal notranslate"><span class="pre">avs_coap</span></code>
component:</p>
<ul>
<li><p>In line with Anjay and <code class="docutils literal notranslate"><span class="pre">avs_commons</span></code>, to improve file name uniqueness, the
<code class="docutils literal notranslate"><span class="pre">avsystem/coap/config.h</span></code> file has been renamed to
<code class="docutils literal notranslate"><span class="pre">avsystem/coap/avs_coap_config.h</span></code>.</p></li>
<li><p>Moreover, context creation functions now take an explicit PRNG context
argument:</p>
<ul>
<li><p><strong>UDP context creation</strong></p>
<ul>
<li><p><strong>Old API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">avs_coap_ctx_t</span><span class="w"> </span><span class="o">*</span><span class="w"></span>
<span class="nf">avs_coap_udp_ctx_create</span><span class="p">(</span><span class="n">avs_sched_t</span><span class="w"> </span><span class="o">*</span><span class="n">sched</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="k">const</span><span class="w"> </span><span class="n">avs_coap_udp_tx_params_t</span><span class="w"> </span><span class="o">*</span><span class="n">udp_tx_params</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">avs_shared_buffer_t</span><span class="w"> </span><span class="o">*</span><span class="n">in_buffer</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">avs_shared_buffer_t</span><span class="w"> </span><span class="o">*</span><span class="n">out_buffer</span><span class="p">,</span><span class="w"></span>
<span class="w">                        </span><span class="n">avs_coap_udp_response_cache_t</span><span class="w"> </span><span class="o">*</span><span class="n">cache</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p><strong>New API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">avs_coap_ctx_t</span><span class="w"> </span><span class="o">*</span><span class="w"></span>
<span class="w">  </span><span class="nf">avs_coap_udp_ctx_create</span><span class="p">(</span><span class="n">avs_sched_t</span><span class="w"> </span><span class="o">*</span><span class="n">sched</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="k">const</span><span class="w"> </span><span class="n">avs_coap_udp_tx_params_t</span><span class="w"> </span><span class="o">*</span><span class="n">udp_tx_params</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="n">avs_shared_buffer_t</span><span class="w"> </span><span class="o">*</span><span class="n">in_buffer</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="n">avs_shared_buffer_t</span><span class="w"> </span><span class="o">*</span><span class="n">out_buffer</span><span class="p">,</span><span class="w"></span>
<span class="w">                          </span><span class="n">avs_coap_udp_response_cache_t</span><span class="w"> </span><span class="o">*</span><span class="n">cache</span><span class="p">,</span><span class="w"></span>
<span class="hll"><span class="w">                          </span><span class="n">avs_crypto_prng_ctx_t</span><span class="w"> </span><span class="o">*</span><span class="n">prng_ctx</span><span class="p">);</span><span class="w"></span>
</span></pre></div>
</div>
</li>
</ul>
</li>
<li><p><strong>TCP context creation</strong></p>
<ul>
<li><p><strong>Old API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">avs_coap_ctx_t</span><span class="w"> </span><span class="o">*</span><span class="nf">avs_coap_tcp_ctx_create</span><span class="p">(</span><span class="n">avs_sched_t</span><span class="w"> </span><span class="o">*</span><span class="n">sched</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="n">avs_shared_buffer_t</span><span class="w"> </span><span class="o">*</span><span class="n">in_buffer</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="n">avs_shared_buffer_t</span><span class="w"> </span><span class="o">*</span><span class="n">out_buffer</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">max_opts_size</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="n">avs_time_duration_t</span><span class="w"> </span><span class="n">request_timeout</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p><strong>New API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">avs_coap_ctx_t</span><span class="w"> </span><span class="o">*</span><span class="nf">avs_coap_tcp_ctx_create</span><span class="p">(</span><span class="n">avs_sched_t</span><span class="w"> </span><span class="o">*</span><span class="n">sched</span><span class="p">,</span><span class="w"></span>
<span class="w">                                          </span><span class="n">avs_shared_buffer_t</span><span class="w"> </span><span class="o">*</span><span class="n">in_buffer</span><span class="p">,</span><span class="w"></span>
<span class="w">                                          </span><span class="n">avs_shared_buffer_t</span><span class="w"> </span><span class="o">*</span><span class="n">out_buffer</span><span class="p">,</span><span class="w"></span>
<span class="w">                                          </span><span class="kt">size_t</span><span class="w"> </span><span class="n">max_opts_size</span><span class="p">,</span><span class="w"></span>
<span class="w">                                          </span><span class="n">avs_time_duration_t</span><span class="w"> </span><span class="n">request_timeout</span><span class="p">,</span><span class="w"></span>
<span class="hll"><span class="w">                                          </span><span class="n">avs_crypto_prng_ctx_t</span><span class="w"> </span><span class="o">*</span><span class="n">prng_ctx</span><span class="p">);</span><span class="w"></span>
</span></pre></div>
</div>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>It is now <strong>mandatory</strong> to pass a non-NULL value as the <code class="docutils literal notranslate"><span class="pre">prng_ctx</span></code>
argument to the functions above.</p>
</div>
</section>
<section id="changes-in-avs-commons">
<h2><a class="toc-backref" href="#id11"><span class="section-number">9.1.5. </span>Changes in avs_commons</a><a class="headerlink" href="#changes-in-avs-commons" title="Permalink to this headline"></a></h2>
<p><code class="docutils literal notranslate"><span class="pre">avs_commons</span></code> 4.1 and later contain a number of breaking changes compared to
version 4.0 used by Anjay 2.2. If you are using any of the <code class="docutils literal notranslate"><span class="pre">avs_commons</span></code> APIs
directly (which is especially likely for e.g. the logging API and querying
sockets in the event loop), you will need to adjust your code.</p>
<section id="avs-commons-header-rename">
<h3><a class="toc-backref" href="#id12"><span class="section-number">9.1.5.1. </span>avs_commons header rename</a><a class="headerlink" href="#avs-commons-header-rename" title="Permalink to this headline"></a></h3>
<p>All headers of the <code class="docutils literal notranslate"><span class="pre">avs_commons</span></code> component have been renamed to make their
names more unique. Please adjust your <code class="docutils literal notranslate"><span class="pre">#include</span></code> directives accordingly.</p>
<p>The general rename patterns are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/*.h</span></code> → <code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_*.h</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/stream/*.h</span></code>, <code class="docutils literal notranslate"><span class="pre">avsystem/commons/stream/stream_*.h</span></code> →
<code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_stream_*.h</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/unit/*.h</span></code> → <code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_unit_*.h</span></code></p></li>
</ul>
<p>Below is a detailed list of all renamed files:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 49%" />
<col style="width: 51%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Old header file</p></th>
<th class="head"><p>New header file</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/addrinfo.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_addrinfo.h</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/aead.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_aead.h</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/base64.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_base64.h</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/buffer.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_buffer.h</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/cleanup.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_cleanup.h</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/condvar.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_condvar.h</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/defs.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_defs.h</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/errno.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_errno.h</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/errno_map.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_errno_map.h</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/hkdf.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_hkdf.h</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/http.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_http.h</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/init_once.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_init_once.h</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/list.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_list.h</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/log.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_log.h</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/memory.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_memory.h</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/mutex.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_mutex.h</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/net.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_net.h</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/persistence.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_persistence.h</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/rbtree.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_rbtree.h</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/sched.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_sched.h</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/shared_buffer.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_shared_buffer.h</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/socket.h</span></code></p></td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_socket.h</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_crypto_pki.h</span></code> <a class="footnote-reference brackets" href="#pki" id="id1">1</a></div>
</div>
</td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/socket_v_table.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_socket_v_table.h</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/stream.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_stream.h</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/stream/stream_buffered.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_stream_buffered.h</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/stream/stream_file.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_stream_file.h</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/stream/stream_inbuf.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_stream_inbuf.h</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/stream/md5.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_stream_md5.h</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/stream/stream_membuf.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_stream_membuf.h</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/stream/stream_net.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_stream_net.h</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/stream/netbuf.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_stream_netbuf.h</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/stream/stream_outbuf.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_stream_outbuf.h</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/stream/stream_simple_io.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_stream_simple_io.h</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/stream_v_table.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_stream_v_table.h</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/time.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_time.h</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/unit/memstream.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_unit_memstream.h</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/unit/mock_helpers.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_unit_mock_helpers.h</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/unit/mocksock.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_unit_mocksock.h</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/unit/test.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_unit_test.h</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/url.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_url.h</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/utils.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_utils.h</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/vector.h</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_vector.h</span></code></p></td>
</tr>
</tbody>
</table>
<dl class="footnote brackets">
<dt class="label" id="pki"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>Some symbols related to public-key cryptography have been refactored
by moving from <code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_socket.h</span></code> to
<code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_crypto_pki.h</span></code>, with additional renames. For
details, see <a class="reference internal" href="#avs-commons-pki-move-225"><span class="std std-ref">Move of public-key cryptography APIs from avs_net to avs_crypto</span></a>.</p>
</dd>
</dl>
</section>
<section id="changes-to-avs-net-socket-api">
<h3><a class="toc-backref" href="#id13"><span class="section-number">9.1.5.2. </span>Changes to avs_net socket API</a><a class="headerlink" href="#changes-to-avs-net-socket-api" title="Permalink to this headline"></a></h3>
<p>Below is a reference of changes made to the <code class="docutils literal notranslate"><span class="pre">avs_net</span></code> socket API:</p>
<table class="colwidths-given docutils align-default">
<colgroup>
<col style="width: 25%" />
<col style="width: 25%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Old identifiers</p></th>
<th class="head"><p>New identifiers</p></th>
<th class="head"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">avs_net_socket_create()</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">avs_net_udp_socket_create()</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">avs_net_tcp_socket_create()</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">avs_net_dtls_socket_create()</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">avs_net_ssl_socket_create()</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">The <code class="docutils literal notranslate"><span class="pre">avs_net_socket_type_t</span></code> enum is no longer used for socket
creation. Separate functions are used instead, allowing for type-safe
passing of the configuration structures.</div>
</div>
</td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">avs_net_socket_decorate_in_place()</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">avs_net_dtls_socket_decorate_in_place()</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">avs_net_ssl_socket_decorate_in_place()</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line">This change is analogous to the one above.</div>
</div>
</td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><em>implicit</em></div>
</div>
</td>
<td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">prng_ctx</span></code> field in <code class="docutils literal notranslate"><span class="pre">avs_net_ssl_configuration_t</span></code></div>
</div>
</td>
<td><div class="line-block">
<div class="line"><strong>Note:</strong> It is now <strong>mandatory</strong> to fill this field when instantiating
a (D)TLS socket.</div>
</div>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>With the introduction of the <code class="docutils literal notranslate"><span class="pre">prng_ctx</span></code> field in
<code class="docutils literal notranslate"><span class="pre">avs_net_ssl_configuration_t</span></code>, the
<code class="docutils literal notranslate"><span class="pre">WITH_MBEDTLS_CUSTOM_ENTROPY_INITIALIZER</span></code> compile-time option and the
option to use a user-provided <code class="docutils literal notranslate"><span class="pre">avs_net_mbedtls_entropy_init()</span></code> function
have been <strong>removed</strong>. If you relied on those features in your non-POSIX
environment, please replace them with the new PRNG context mechanism.
See <a class="reference internal" href="MigratingCustomEntropy.html"><span class="doc">Migrating mbed TLS custom entropy initializers</span></a> for details.</p>
</div>
<section id="introduction-of-new-socket-option">
<h4><a class="toc-backref" href="#id14"><span class="section-number">9.1.5.2.1. </span>Introduction of new socket option</a><a class="headerlink" href="#introduction-of-new-socket-option" title="Permalink to this headline"></a></h4>
<p>avs_commons 4.10.1 bundled with Anjay 2.15.1 adds a new socket option key:
<code class="docutils literal notranslate"><span class="pre">AVS_NET_SOCKET_HAS_BUFFERED_DATA</span></code>. This is used to make sure that when
control is returned to the event loop, the <code class="docutils literal notranslate"><span class="pre">poll()</span></code> call will not stall
waiting for new data that in reality has been already buffered and could be
retrieved using the avs_commons APIs.</p>
<p>This is usually meaningful for (D)TLS connections, but for almost all simple
unencrypted socket implementations, this should always return <code class="docutils literal notranslate"><span class="pre">false</span></code>.</p>
<p>This was previously achieved by always trying to receive more packets with
timeout set to zero. However, it has been determined that such logic could lead
to heavy blocking of the event loop in case communication with the network stack
is relatively slow, e.g. on devices which implement TCP/IP sockets through modem
AT commands.</p>
<p>If you maintain your own socket integration layer or (D)TLS integration layer,
it is recommended that you add support for this option.</p>
</section>
</section>
<section id="removal-of-ssize-t-usages-from-avs-commons-apis">
<span id="ssize-t-removal-in-commons-225"></span><h3><a class="toc-backref" href="#id15"><span class="section-number">9.1.5.3. </span>Removal of ssize_t usages from avs_commons APIs</a><a class="headerlink" href="#removal-of-ssize-t-usages-from-avs-commons-apis" title="Permalink to this headline"></a></h3>
<p>All usages of the POSIX-specific <code class="docutils literal notranslate"><span class="pre">ssize_t</span></code> type in public APIs have been
removed. Instead of replacing it with some other signed integer type, additional
out-arguments have been introduced to functions that used it.</p>
<p>Below is a reference of related changes:</p>
<ul>
<li><p><strong>Base64 decode</strong></p>
<ul>
<li><p><strong>Old APIs:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">ssize_t</span><span class="w"> </span><span class="nf">avs_base64_decode_custom</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">out</span><span class="p">,</span><span class="w"></span>
<span class="w">                                 </span><span class="kt">size_t</span><span class="w"> </span><span class="n">out_length</span><span class="p">,</span><span class="w"></span>
<span class="w">                                 </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">input</span><span class="p">,</span><span class="w"></span>
<span class="w">                                 </span><span class="n">avs_base64_config_t</span><span class="w"> </span><span class="n">config</span><span class="p">);</span><span class="w"></span>
<span class="c1">// ...</span>
<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">ssize_t</span><span class="w"></span>
<span class="nf">avs_base64_decode_strict</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">out_length</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>
<span class="c1">// ...</span>
<span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">ssize_t</span><span class="w"></span>
<span class="nf">avs_base64_decode</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">out</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">out_length</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// ...</span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p><strong>New APIs:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">avs_base64_decode_custom</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="o">*</span><span class="n">out_bytes_decoded</span><span class="p">,</span><span class="w"></span>
</span><span class="w">                              </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">out</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="kt">size_t</span><span class="w"> </span><span class="n">out_length</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">input</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="n">avs_base64_config_t</span><span class="w"> </span><span class="n">config</span><span class="p">);</span><span class="w"></span>
<span class="w"> </span><span class="c1">// ...</span>
<span class="hll"><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">avs_base64_decode_strict</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="o">*</span><span class="n">out_bytes_decoded</span><span class="p">,</span><span class="w"></span>
</span><span class="w">                                            </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">out</span><span class="p">,</span><span class="w"></span>
<span class="w">                                            </span><span class="kt">size_t</span><span class="w"> </span><span class="n">out_length</span><span class="p">,</span><span class="w"></span>
<span class="w">                                            </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="c1">// ...</span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>
<span class="w"> </span><span class="c1">// ...</span>
<span class="hll"><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="kr">inline</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">avs_base64_decode</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="o">*</span><span class="n">out_bytes_decoded</span><span class="p">,</span><span class="w"></span>
</span><span class="w">                                     </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">out</span><span class="p">,</span><span class="w"></span>
<span class="w">                                     </span><span class="kt">size_t</span><span class="w"> </span><span class="n">out_length</span><span class="p">,</span><span class="w"></span>
<span class="w">                                     </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">     </span><span class="c1">// ...</span>
<span class="w"> </span><span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p><strong>Hexlify</strong></p>
<ul>
<li><p><strong>Old API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">ssize_t</span><span class="w"> </span><span class="nf">avs_hexlify</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">out_hex</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">out_size</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">input</span><span class="p">,</span><span class="w"></span>
<span class="w">                    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">input_size</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p><strong>New API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">avs_hexlify</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">out_hex</span><span class="p">,</span><span class="w"></span>
</span><span class="w">                 </span><span class="kt">size_t</span><span class="w"> </span><span class="n">out_size</span><span class="p">,</span><span class="w"></span>
<span class="hll"><span class="w">                 </span><span class="kt">size_t</span><span class="w"> </span><span class="o">*</span><span class="n">out_bytes_hexlified</span><span class="p">,</span><span class="w"></span>
</span><span class="w">                 </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">input</span><span class="p">,</span><span class="w"></span>
<span class="w">                 </span><span class="kt">size_t</span><span class="w"> </span><span class="n">input_size</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p><strong>Unhexlify</strong></p>
<ul>
<li><p><strong>Old API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">ssize_t</span><span class="w"> </span><span class="nf">avs_unhexlify</span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">output</span><span class="p">,</span><span class="w"></span>
<span class="w">                      </span><span class="kt">size_t</span><span class="w"> </span><span class="n">out_size</span><span class="p">,</span><span class="w"></span>
<span class="w">                      </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">input</span><span class="p">,</span><span class="w"></span>
<span class="w">                      </span><span class="kt">size_t</span><span class="w"> </span><span class="n">in_size</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p><strong>New API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">avs_unhexlify</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="o">*</span><span class="n">out_bytes_written</span><span class="p">,</span><span class="w"></span>
</span><span class="w">                   </span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">*</span><span class="n">output</span><span class="p">,</span><span class="w"></span>
<span class="w">                   </span><span class="kt">size_t</span><span class="w"> </span><span class="n">out_size</span><span class="p">,</span><span class="w"></span>
<span class="w">                   </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">input</span><span class="p">,</span><span class="w"></span>
<span class="w">                   </span><span class="kt">size_t</span><span class="w"> </span><span class="n">in_size</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The new functions return 0 in all cases in which the old versions returned
non-negative values. The value previously returned through the non-negative
return value can be retrieved using the additional out-arguments, which have
the same semantics. <code class="docutils literal notranslate"><span class="pre">NULL</span></code> can be passed to those out-arguments as well if
that value is not needed.</p>
<p>The seemingly irregular placement of the new out-argument in
<code class="docutils literal notranslate"><span class="pre">avs_hexlify()</span></code> is due to the fact that the semantics of that value is
related to the <code class="docutils literal notranslate"><span class="pre">input</span></code> argument (hence it directly precedes it), not to
the output buffer as is the case with the rest of these functions.</p>
</div>
</section>
<section id="move-of-public-key-cryptography-apis-from-avs-net-to-avs-crypto">
<span id="avs-commons-pki-move-225"></span><h3><a class="toc-backref" href="#id16"><span class="section-number">9.1.5.4. </span>Move of public-key cryptography APIs from avs_net to avs_crypto</a><a class="headerlink" href="#move-of-public-key-cryptography-apis-from-avs-net-to-avs-crypto" title="Permalink to this headline"></a></h3>
<p>Public key cryptography APIs, previously defined in
<code class="docutils literal notranslate"><span class="pre">avsystem/commons/socket.h</span></code>, have been moved into a new header called
<code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_crypto_pki.h</span></code>.</p>
<p>Additionally, client-side and server-side certificate info structures are no
longer separate, and both have been merged into a single type.</p>
<p>Here is a summary of renames:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 47%" />
<col style="width: 53%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Old symbol name</p></th>
<th class="head"><p>New symbol name</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">avs_net_trusted_cert_info_t</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">avs_net_client_cert_info_t</span></code></div>
</div>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">avs_crypto_certificate_chain_info_t</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">avs_net_client_key_info_t</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avs_crypto_private_key_info_t</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">avs_net_security_info_union_t</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avs_crypto_security_info_union_t</span></code></p></td>
</tr>
<tr class="row-odd"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">avs_net_trusted_cert_info_from_buffer()</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">avs_net_client_cert_info_from_buffer()</span></code></div>
</div>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">avs_crypto_certificate_chain_info_from_buffer()</span></code></p></td>
</tr>
<tr class="row-even"><td><div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">avs_net_trusted_cert_info_from_file()</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">avs_net_client_cert_info_from_file()</span></code></div>
</div>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">avs_crypto_certificate_chain_info_from_file()</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">avs_net_client_key_info_from_buffer()</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avs_crypto_private_key_info_from_buffer()</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">avs_net_client_key_info_from_file()</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avs_crypto_private_key_info_from_file()</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">avs_net_trusted_cert_info_from_path()</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">avs_crypto_certificate_chain_info_from_path()</span></code></p></td>
</tr>
</tbody>
</table>
</section>
<section id="refactor-of-psk-credential-handling">
<h3><a class="toc-backref" href="#id17"><span class="section-number">9.1.5.5. </span>Refactor of PSK credential handling</a><a class="headerlink" href="#refactor-of-psk-credential-handling" title="Permalink to this headline"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">avs_net_psk_info_t</span></code> structure has been changed to use new types based on
<code class="docutils literal notranslate"><span class="pre">avs_crypto_security_info_union_t</span></code> instead of raw buffers. This change also
affects <code class="docutils literal notranslate"><span class="pre">avs_net_security_info_t</span></code> structure which contains the former.</p>
<ul>
<li><p><strong>Old API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * A PSK/identity pair with borrowed pointers. avs_commons will never attempt</span>
<span class="cm"> * to modify these values.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">psk</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">psk_size</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">identity</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">identity_size</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">avs_net_psk_info_t</span><span class="p">;</span><span class="w"></span>

<span class="c1">// ...</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">avs_net_security_mode_t</span><span class="w"> </span><span class="n">mode</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">avs_net_psk_info_t</span><span class="w"> </span><span class="n">psk</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">avs_net_certificate_info_t</span><span class="w"> </span><span class="n">cert</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">data</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">avs_net_security_info_t</span><span class="p">;</span><span class="w"></span>

<span class="n">avs_net_security_info_t</span><span class="w"> </span><span class="nf">avs_net_security_info_from_psk</span><span class="p">(</span><span class="n">avs_net_psk_info_t</span><span class="w"> </span><span class="n">psk</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</li>
<li><p><strong>New API:</strong></p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">avs_crypto_security_info_union_t</span><span class="w"> </span><span class="n">desc</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">avs_crypto_psk_identity_info_t</span><span class="p">;</span><span class="w"></span>

<span class="c1">// ...</span>

<span class="n">avs_crypto_psk_identity_info_t</span><span class="w"></span>
<span class="nf">avs_crypto_psk_identity_info_from_buffer</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="p">,</span><span class="w"></span>
<span class="w">                                         </span><span class="kt">size_t</span><span class="w"> </span><span class="n">buffer_size</span><span class="p">);</span><span class="w"></span>

<span class="c1">// ...</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">avs_crypto_security_info_union_t</span><span class="w"> </span><span class="n">desc</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">avs_crypto_psk_key_info_t</span><span class="p">;</span><span class="w"></span>

<span class="c1">// ...</span>

<span class="n">avs_crypto_psk_key_info_t</span><span class="w"></span>
<span class="nf">avs_crypto_psk_key_info_from_buffer</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">buffer_size</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/**</span>
<span class="cm"> * A PSK/identity pair. avs_commons will never attempt to modify these values.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">avs_crypto_psk_key_info_t</span><span class="w"> </span><span class="n">key</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">avs_crypto_psk_identity_info_t</span><span class="w"> </span><span class="n">identity</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">avs_net_psk_info_t</span><span class="p">;</span><span class="w"></span>

<span class="c1">// ...</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">avs_net_security_mode_t</span><span class="w"> </span><span class="n">mode</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">avs_net_psk_info_t</span><span class="w"> </span><span class="n">psk</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">avs_net_certificate_info_t</span><span class="w"> </span><span class="n">cert</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">data</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">avs_net_security_info_t</span><span class="p">;</span><span class="w"></span>

<span class="n">avs_net_security_info_t</span><span class="w"></span>
<span class="nf">avs_net_security_info_from_psk</span><span class="p">(</span><span class="n">avs_net_psk_info_t</span><span class="w"> </span><span class="n">psk</span><span class="p">);</span><span class="w"></span>
</pre></div>
</div>
</li>
</ul>
<p>This change is breaking for code that accesses the <code class="docutils literal notranslate"><span class="pre">data.psk</span></code> field
of <code class="docutils literal notranslate"><span class="pre">avs_net_security_info_t</span></code> directly.</p>
</section>
<section id="changes-to-public-configuration-macros">
<h3><a class="toc-backref" href="#id18"><span class="section-number">9.1.5.6. </span>Changes to public configuration macros</a><a class="headerlink" href="#changes-to-public-configuration-macros" title="Permalink to this headline"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">avs_commons</span></code> 4.1 introduced a new header file,
<code class="docutils literal notranslate"><span class="pre">avsystem/commons/avs_commons_config.h</span></code>, that encapsulates all its
compile-time configuration, allowing compiling the library without the use of
CMake, among other improvements.</p>
<p>This file is included by all other <code class="docutils literal notranslate"><span class="pre">avs_commons</span></code> headers, so this is not a
breaking change in and of itself. However, some configuration macros that were
previously <code class="docutils literal notranslate"><span class="pre">#define</span></code>-d in <code class="docutils literal notranslate"><span class="pre">avsystem/commons/defs.h</span></code> have been renamed for
better namespace separation.</p>
<p>If your code checks for these macros using <code class="docutils literal notranslate"><span class="pre">#ifdef</span></code> etc., it will need
adjustments.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 61%" />
<col style="width: 39%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Old macro name</p></th>
<th class="head"><p>New macro name</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">WITH_IPV4</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">AVS_COMMONS_NET_WITH_IPV4</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">WITH_IPV6</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">AVS_COMMONS_NET_WITH_IPV6</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">WITH_X509</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">AVS_COMMONS_WITH_AVS_CRYPTO_PKI</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">WITH_AVS_MICRO_LOGS</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">AVS_COMMONS_WITH_MICRO_LOGS</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">HAVE_NET_IF_H</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">AVS_COMMONS_HAVE_NET_IF_H</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">AVS_SSIZE_T_DEFINED</span></code></p></td>
<td><p><em>removed completely</em></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">HAVE_SYS_TYPES_H</span></code></p></td>
<td><p><em>removed completely</em></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">AVS_COMMONS_WITH_MBEDTLS_CUSTOM_ENTROPY_INITIALIZER</span></code></p></td>
<td><p><em>removed completely</em></p></td>
</tr>
</tbody>
</table>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>In the case of <code class="docutils literal notranslate"><span class="pre">WITH_X509</span></code>, the corresponding CMake variable has also been
renamed to <code class="docutils literal notranslate"><span class="pre">WITH_PKI</span></code>. Attempting to use <code class="docutils literal notranslate"><span class="pre">WITH_X509</span></code> will trigger an
error.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Aside from the one variable mentioned above, and those removed completely,
the CMake variable names have not changed - the renames affect <strong>only</strong> the
C preprocessor.</p>
</div>
</section>
<section id="refactor-of-avs-net-validate-ip-address-and-avs-net-local-address-for-target-host">
<h3><a class="toc-backref" href="#id19"><span class="section-number">9.1.5.7. </span>Refactor of avs_net_validate_ip_address() and avs_net_local_address_for_target_host()</a><a class="headerlink" href="#refactor-of-avs-net-validate-ip-address-and-avs-net-local-address-for-target-host" title="Permalink to this headline"></a></h3>
<p><code class="docutils literal notranslate"><span class="pre">avs_net_validate_ip_address()</span></code> is now no longer used by Anjay or
<code class="docutils literal notranslate"><span class="pre">avs_commons</span></code>. It was previously necessary to implement it as part of the
socket implementation. This is no longer required. For compatibility, the
function has been reimplemented as a <code class="docutils literal notranslate"><span class="pre">static</span> <span class="pre">inline</span></code> function that wraps
<code class="docutils literal notranslate"><span class="pre">avs_net_addrinfo_*()</span></code> APIs. Please remove your version of
<code class="docutils literal notranslate"><span class="pre">avs_net_validate_ip_address()</span></code> from your socket implementation if you have
one, as having two alternative variants may lead to conflicts.</p>
<p>Since Anjay 2.9 and <code class="docutils literal notranslate"><span class="pre">avs_commons</span></code> 4.6,
<code class="docutils literal notranslate"><span class="pre">avs_net_local_address_for_target_host()</span></code> underwent a similar refactor. It was
previously a function to be optionally implemented as part of the socket
implementation, but now it is a <code class="docutils literal notranslate"><span class="pre">static</span> <span class="pre">inline</span></code> function that wraps
<code class="docutils literal notranslate"><span class="pre">avs_net_socket_*()</span></code> APIs. Please remove your version of
<code class="docutils literal notranslate"><span class="pre">avs_net_local_address_for_target_host()</span></code> from your socket implementation if
you have one, as having two alternative variants may lead to conflicts.</p>
</section>
<section id="changes-in-component-dependencies">
<h3><a class="toc-backref" href="#id20"><span class="section-number">9.1.5.8. </span>Changes in component dependencies</a><a class="headerlink" href="#changes-in-component-dependencies" title="Permalink to this headline"></a></h3>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">avs_net</span></code> now depends on <code class="docutils literal notranslate"><span class="pre">avs_crypto</span></code></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">avs_crypto</span></code> itself was previously only used for advanced features, only
used by the OSCORE commercial feature.</p></li>
<li><p>In the new version, <code class="docutils literal notranslate"><span class="pre">avs_crypto</span></code> also contains an abstraction over
cryptographically-safe PRNGs.</p></li>
<li><p>The functionality that comprised the “old” <code class="docutils literal notranslate"><span class="pre">avs_crypto</span></code> is now controlled
by the <code class="docutils literal notranslate"><span class="pre">AVS_COMMONS_WITH_AVS_CRYPTO_ADVANCED_FEATURES</span></code> compile-time
option.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">avs_vector</span></code> is no longer compiled by default when building Anjay</p></li>
<li><p>URL handling routines, previously a part of <code class="docutils literal notranslate"><span class="pre">avs_net</span></code>, are now a separate
component called <code class="docutils literal notranslate"><span class="pre">avs_url</span></code></p>
<ul>
<li><p>You may need to add <code class="docutils literal notranslate"><span class="pre">-lavs_url</span></code> to your link command if you’re not using
CMake to handle dependencies between your project and Anjay</p></li>
</ul>
</li>
</ul>
</section>
<section id="removal-of-the-legacy-coap-component">
<h3><a class="toc-backref" href="#id21"><span class="section-number">9.1.5.9. </span>Removal of the legacy CoAP component</a><a class="headerlink" href="#removal-of-the-legacy-coap-component" title="Permalink to this headline"></a></h3>
<p>While the new <code class="docutils literal notranslate"><span class="pre">avs_coap</span></code> has been used as the CoAP implementation in all
versions of Anjay 2.x, the old CoAP component of <code class="docutils literal notranslate"><span class="pre">avs_commons</span></code> remained in the
repository in the 4.0 branch of <code class="docutils literal notranslate"><span class="pre">avs_commons</span></code>.</p>
<p>This has been removed in <code class="docutils literal notranslate"><span class="pre">avs_commons</span></code> 4.1 and Anjay 2.3. If your code used
the raw CoAP APIs of that component, you will need to migrate to either the new
<code class="docutils literal notranslate"><span class="pre">avs_coap</span></code> library or an entirely different CoAP implementation.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The new <code class="docutils literal notranslate"><span class="pre">avs_coap</span></code> library has a higher-level API, designed to abstract
away the differences between e.g. UDP and TCP transports. Some of the
functionality of the legacy library, especially that related to parsing,
serializing, sending and receiving raw, isolated messages (as opposed to
proper, conformant CoAP exchanges), is not provided in the public API for
this reason.</p>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../Migrating.html" class="btn btn-neutral float-left" title="9. Migrating from older versions" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="MigratingCustomEntropy.html" class="btn btn-neutral float-right" title="9.2. Migrating mbed TLS custom entropy initializers" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017-2022, AVSystem.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>