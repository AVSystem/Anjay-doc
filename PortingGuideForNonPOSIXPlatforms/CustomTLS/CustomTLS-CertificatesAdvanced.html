<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>8.4.1.6. Advanced certificate support &mdash; Anjay 3.4.1 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="8.4.1.7. Support for TLS over TCP" href="CustomTLS-TCPSupport.html" />
    <link rel="prev" title="8.4.1.5. Basic certificate support" href="CustomTLS-CertificatesBasic.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #ffd500" >
            <a href="../../index.html">
            <img src="../../_static/avsystem_header.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                3.4.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../Introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LwM2M.html">2. OMA LwM2M - Brief description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Compiling_client_applications.html">3. Compiling client applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../BasicClient.html">4. Basic client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../AdvancedTopics.html">5. Advanced topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../FirmwareUpdateTutorial.html">6. Firmware Update Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tools.html">7. Tools</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../PortingGuideForNonPOSIXPlatforms.html">8. Porting guide for non-POSIX platforms</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../TimeAPI.html">8.1. Time API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ThreadingAPI.html">8.2. Threading API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../NetworkingAPI.html">8.3. Networking API</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../CustomTLS.html">8.4. Custom (D)TLS layers</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="CustomTLS-Stub.html">8.4.1.1. Introductory stub</a></li>
<li class="toctree-l3"><a class="reference internal" href="CustomTLS-Minimal.html">8.4.1.2. Minimal DTLS implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="CustomTLS-Resumption.html">8.4.1.3. Session resumption support</a></li>
<li class="toctree-l3"><a class="reference internal" href="CustomTLS-ConfigFeatures.html">8.4.1.4. Advanced configuration features</a></li>
<li class="toctree-l3"><a class="reference internal" href="CustomTLS-CertificatesBasic.html">8.4.1.5. Basic certificate support</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">8.4.1.6. Advanced certificate support</a></li>
<li class="toctree-l3"><a class="reference internal" href="CustomTLS-TCPSupport.html">8.4.1.7. Support for TLS over TCP</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../Migrating.html">9. Migrating from older versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CommercialFeatures.html">10. Commercial features</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #ffd500" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Anjay</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../PortingGuideForNonPOSIXPlatforms.html"><span class="section-number">8. </span>Porting guide for non-POSIX platforms</a> &raquo;</li>
          <li><a href="../CustomTLS.html"><span class="section-number">8.4. </span>Custom (D)TLS layers</a> &raquo;</li>
      <li><span class="section-number">8.4.1.6. </span>Advanced certificate support</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="advanced-certificate-support">
<h1><span class="section-number">8.4.1.6. </span>Advanced certificate support<a class="headerlink" href="#advanced-certificate-support" title="Permalink to this headline"></a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#introduction" id="id1">Introduction</a></p></li>
<li><p><a class="reference internal" href="#support-for-multiple-client-certificates" id="id2">Support for multiple client certificates</a></p></li>
<li><p><a class="reference internal" href="#dane-support" id="id3">DANE support</a></p>
<ul>
<li><p><a class="reference internal" href="#initialization" id="id4">Initialization</a></p></li>
<li><p><a class="reference internal" href="#populating-the-array" id="id5">Populating the array</a></p></li>
<li><p><a class="reference internal" href="#configuring-the-connection" id="id6">Configuring the connection</a></p></li>
<li><p><a class="reference internal" href="#minimum-viable-subset" id="id7">Minimum viable subset</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Code related to this tutorial can be found under
<a class="reference external" href="https://github.com/AVSystem/Anjay/tree/master/examples/custom-tls/certificates-advanced">examples/custom-tls/certificates-advanced</a>
in the Anjay source directory.</p>
</div>
<section id="introduction">
<h2><a class="toc-backref" href="#id1"><span class="section-number">8.4.1.6.1. </span>Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline"></a></h2>
<p>This tutorial builds up on <a class="reference internal" href="CustomTLS-CertificatesBasic.html"><span class="doc">the previous one</span></a>
and adds:</p>
<ul class="simple">
<li><p>Ability to load multiple certificates as the client certificate chain</p></li>
<li><p>Support for DANE; <strong>this will also add proper support for the Server Public
Key LwM2M resource</strong></p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In this tutorial, the <code class="docutils literal notranslate"><span class="pre">main.c</span></code> file is identical to the one from the
<a class="reference internal" href="../../AdvancedTopics/AT-Certificates.html"><span class="doc">DTLS connection using certificates</span></a> tutorial.</p>
<p>In fact, in the repository, it is a symbolic link to the file from that
tutorial.</p>
</div>
</section>
<section id="support-for-multiple-client-certificates">
<h2><a class="toc-backref" href="#id2"><span class="section-number">8.4.1.6.2. </span>Support for multiple client certificates</a><a class="headerlink" href="#support-for-multiple-client-certificates" title="Permalink to this headline"></a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Loading multiple client certificates is only possible by setting the
<code class="docutils literal notranslate"><span class="pre">public_cert</span></code> field in <code class="docutils literal notranslate"><span class="pre">anjay_security_instance_t</span></code>.</p>
<p>If you don’t intend to use that field there is no point in making this change.</p>
</div>
<p>Using multiple certificates in the client certificate chain is rarely used, but
it may be necessary to properly initiate a connection to some LwM2M servers.</p>
<p>To support this case, the <code class="docutils literal notranslate"><span class="pre">AVS_CRYPTO_DATA_SOURCE_ARRAY</span></code> and
<code class="docutils literal notranslate"><span class="pre">AVS_CRYPTO_DATA_SOURCE_LIST</span></code> cases need to be supported in the
<code class="docutils literal notranslate"><span class="pre">configure_client_cert()</span></code> function, much like is the case for
<code class="docutils literal notranslate"><span class="pre">configure_trusted_certs()</span></code>.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">avs_error_t</span>
<span class="hll"><span class="nf">configure_client_certs</span><span class="p">(</span><span class="n">SSL_CTX</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">,</span>
</span><span class="hll"><span class="w">                       </span><span class="k">const</span><span class="w"> </span><span class="n">avs_crypto_security_info_union_t</span><span class="w"> </span><span class="o">*</span><span class="n">client_certs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">client_certs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_EINVAL</span><span class="p">);</span>
</span><span class="hll"><span class="w">    </span><span class="p">}</span>
</span><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">client_certs</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="hll"><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">AVS_CRYPTO_DATA_SOURCE_EMPTY</span><span class="p">:</span>
</span><span class="hll"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">AVS_OK</span><span class="p">;</span>
</span><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">AVS_CRYPTO_DATA_SOURCE_BUFFER</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">client_certs</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">buffer</span><span class="p">;</span>
<span class="w">        </span><span class="n">X509</span><span class="w"> </span><span class="o">*</span><span class="n">cert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d2i_X509</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span>
<span class="w">                              </span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="n">client_certs</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cert</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_EPROTO</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="hll"><span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
</span><span class="hll"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">SSL_CTX_get0_certificate</span><span class="p">(</span><span class="n">ctx</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">            </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SSL_CTX_use_certificate</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">cert</span><span class="p">);</span>
</span><span class="hll"><span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">            </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SSL_CTX_add1_chain_cert</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">cert</span><span class="p">);</span>
</span><span class="hll"><span class="w">        </span><span class="p">}</span>
</span><span class="w">        </span><span class="n">X509_free</span><span class="p">(</span><span class="n">cert</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_EPROTO</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">AVS_OK</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="hll"><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">AVS_CRYPTO_DATA_SOURCE_ARRAY</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">        </span><span class="n">avs_error_t</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AVS_OK</span><span class="p">;</span>
</span><span class="hll"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span class="hll"><span class="w">             </span><span class="n">avs_is_ok</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">client_certs</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">array</span><span class="p">.</span><span class="n">element_count</span><span class="p">;</span>
</span><span class="hll"><span class="w">             </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">            </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configure_client_certs</span><span class="p">(</span>
</span><span class="hll"><span class="w">                    </span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">client_certs</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">array</span><span class="p">.</span><span class="n">array_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class="hll"><span class="w">        </span><span class="p">}</span>
</span><span class="hll"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span class="hll"><span class="w">    </span><span class="p">}</span>
</span><span class="hll"><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">AVS_CRYPTO_DATA_SOURCE_LIST</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">        </span><span class="n">avs_error_t</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AVS_OK</span><span class="p">;</span>
</span><span class="hll"><span class="w">        </span><span class="n">AVS_LIST</span><span class="p">(</span><span class="n">avs_crypto_security_info_union_t</span><span class="p">)</span><span class="w"> </span><span class="n">entry</span><span class="p">;</span>
</span><span class="hll"><span class="w">        </span><span class="n">AVS_LIST_FOREACH</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span><span class="w"> </span><span class="n">client_certs</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">list</span><span class="p">.</span><span class="n">list_head</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">avs_is_err</span><span class="p">((</span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configure_client_certs</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">))))</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">                </span><span class="k">break</span><span class="p">;</span>
</span><span class="hll"><span class="w">            </span><span class="p">}</span>
</span><span class="hll"><span class="w">        </span><span class="p">}</span>
</span><span class="hll"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">AVS_OK</span><span class="p">;</span>
</span><span class="hll"><span class="w">    </span><span class="p">}</span>
</span><span class="w">    </span><span class="k">default</span><span class="o">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_ENOTSUP</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The function has been slightly refactored to take
<code class="docutils literal notranslate"><span class="pre">avs_crypto_security_info_union_t</span></code> as an argument to make recursive calls
easier. <code class="docutils literal notranslate"><span class="pre">client_cert</span></code> in the function and argument names has also been
pluralized.</p>
<p>Aside from these trivial changes, the <code class="docutils literal notranslate"><span class="pre">AVS_CRYPTO_DATA_SOURCE_ARRAY</span></code> and
<code class="docutils literal notranslate"><span class="pre">AVS_CRYPTO_DATA_SOURCE_LIST</span></code> have been implemented in essentially the same
way as in <code class="docutils literal notranslate"><span class="pre">configure_trusted_certs()</span></code> and
<code class="docutils literal notranslate"><span class="pre">configure_cert_revocation_lists()</span></code>, and the <code class="docutils literal notranslate"><span class="pre">AVS_CRYPTO_DATA_SOURCE_BUFFER</span></code>
case has been updated so that <code class="docutils literal notranslate"><span class="pre">SSL_CTX_add1_chain_cert()</span></code> is used for the
second and all subsequent certificate entries. This means that the first loaded
certificate is always the actual client certificate, with any subsequent ones
forming the rest of the certification path up towards the root CA certificate.</p>
</section>
<section id="dane-support">
<span id="custom-tls-api-certificates-advanced-dane"></span><h2><a class="toc-backref" href="#id3"><span class="section-number">8.4.1.6.3. </span>DANE support</a><a class="headerlink" href="#dane-support" title="Permalink to this headline"></a></h2>
<p>Instead of the standard PKIX rules for certificate verification, from LwM2M 1.1
onwards, the server certificates are verified using a <a class="reference external" href="https://www.openmobilealliance.org/release/LightweightM2M/V1_1_1-20190617-A/HTML-Version/OMA-TS-LightweightM2M_Transport-V1_1_1-20190617-A.html#5-2-8-7-0-5287-Certificate-Usage-Field">custom mechanism</a>
that operates on concepts almost identical to those used by <a class="reference external" href="https://en.wikipedia.org/wiki/DNS-based_Authentication_of_Named_Entities">DANE</a>.</p>
<p>The LwM2M 1.0 semantics are mirrored by the default settings used in LwM2M 1.1,
which is to use the “domain-issued certificate” mode.</p>
<p>For the above reasons, server certificate validation in Anjay is largely
implemented in terms of DANE, which needs to be provided in the secure socket
implementation.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Standard PKIX certificate validation may also be used in conjunction with
DANE, particularly when certificate usage mode is set to “CA constraint” or
“service certificate constraint”, or when EST is used.</p>
</div>
<p>DANE is supported natively since OpenSSL 1.1, which makes it easy to implement
for the purpose of this tutorial.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>DANE is not widely supported in other TLS backend libraries or hardware
implementations.</p>
<p>Please look at the
<a class="reference internal" href="#custom-tls-api-certificates-advanced-dane-minimum-subset"><span class="std std-ref">Minimum viable subset</span></a> section if
implementing proper DANE support is impossible or infeasible in your case.</p>
</div>
<section id="initialization">
<h3><a class="toc-backref" href="#id4"><span class="section-number">8.4.1.6.3.1. </span>Initialization</a><a class="headerlink" href="#initialization" title="Permalink to this headline"></a></h3>
<p>It is necessary to store some additional state for DANE support, so the
<code class="docutils literal notranslate"><span class="pre">tls_socket_impl_t</span></code> structure is extended accordingly:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">avs_net_socket_v_table_t</span><span class="w"> </span><span class="o">*</span><span class="n">operations</span><span class="p">;</span>
<span class="w">    </span><span class="n">avs_net_socket_t</span><span class="w"> </span><span class="o">*</span><span class="n">backend_socket</span><span class="p">;</span>
<span class="w">    </span><span class="n">SSL_CTX</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
<span class="w">    </span><span class="n">SSL</span><span class="w"> </span><span class="o">*</span><span class="n">ssl</span><span class="p">;</span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">psk</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">psk_size</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">identity</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">identity_size</span><span class="p">;</span>

<span class="hll"><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">dane_enabled</span><span class="p">;</span>
</span><span class="hll"><span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">dane_tlsa_association_data_buf</span><span class="p">[</span><span class="mi">4096</span><span class="p">];</span>
</span><span class="hll"><span class="w">    </span><span class="n">avs_net_socket_dane_tlsa_record_t</span><span class="w"> </span><span class="n">dane_tlsa_array</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
</span><span class="hll"><span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">dane_tlsa_array_size</span><span class="p">;</span>
</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">session_resumption_buffer</span><span class="p">;</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">session_resumption_buffer_size</span><span class="p">;</span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">server_name_indication</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">dtls_hs_timeout_min_us</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">dtls_hs_timeout_max_us</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">tls_socket_impl_t</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">dane_enabled</span></code> field will store the information about whether DANE shall
be used for this connection.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dane_tlsa_array</span></code> will hold the DANE TLSA entries to be used for the
connection; maximum of 4 entries is supported in this implementation, while
<code class="docutils literal notranslate"><span class="pre">dane_tlsa_array_size</span></code> shall be the number of entries actually populated.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dane_tlsa_association_data_buf</span></code> will store the actual certificate data;
<code class="docutils literal notranslate"><span class="pre">dane_tlsa_array</span></code> entries will contain pointers into this buffer.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In actual LwM2M use, at most 1 DANE TLSA entry is ever used.</p>
<p>This tutorial provides an implementation that support multiple entries for
the sake of completeness, but support for only a single entry is sufficient
to cover all the cases used by Anjay.</p>
</div>
<p>In OpenSSL, DANE needs to be enabled both for <code class="docutils literal notranslate"><span class="pre">SSL_CTX</span></code> and <code class="docutils literal notranslate"><span class="pre">SSL</span></code> objects.
Enabling it for the <code class="docutils literal notranslate"><span class="pre">SSL_CTX</span></code> object needs to be done in the
<code class="docutils literal notranslate"><span class="pre">configure_certs()</span></code> function, in accordance to the <code class="docutils literal notranslate"><span class="pre">dane</span></code> field in
<code class="docutils literal notranslate"><span class="pre">avs_net_certificate_info_t</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">avs_error_t</span><span class="w"> </span><span class="nf">configure_certs</span><span class="p">(</span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="p">,</span>
<span class="w">                                   </span><span class="k">const</span><span class="w"> </span><span class="n">avs_net_certificate_info_t</span><span class="w"> </span><span class="o">*</span><span class="n">certs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">certs</span><span class="o">-&gt;</span><span class="n">server_cert_validation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">certs</span><span class="o">-&gt;</span><span class="n">ignore_system_trust_store</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">SSL_CTX_set_default_verify_paths</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">X509_STORE</span><span class="w"> </span><span class="o">*</span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SSL_CTX_get_cert_store</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">);</span>
<span class="w">        </span><span class="n">avs_error_t</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">avs_is_err</span><span class="p">((</span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configure_trusted_certs</span><span class="p">(</span>
<span class="w">                                </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">certs</span><span class="o">-&gt;</span><span class="n">trusted_certs</span><span class="p">.</span><span class="n">desc</span><span class="p">)))</span>
<span class="w">                </span><span class="o">||</span><span class="w"> </span><span class="n">avs_is_err</span><span class="p">((</span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configure_cert_revocation_lists</span><span class="p">(</span>
<span class="w">                                       </span><span class="n">store</span><span class="p">,</span>
<span class="w">                                       </span><span class="o">&amp;</span><span class="n">certs</span><span class="o">-&gt;</span><span class="n">cert_revocation_lists</span><span class="p">.</span><span class="n">desc</span><span class="p">))))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">SSL_CTX_set_verify</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">SSL_VERIFY_PEER</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">SSL_CTX_set_verify</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">SSL_VERIFY_NONE</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="hll"><span class="w">    </span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dane_enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">certs</span><span class="o">-&gt;</span><span class="n">dane</span><span class="p">;</span>
</span><span class="hll"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dane_enabled</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">        </span><span class="n">SSL_CTX_dane_enable</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">);</span>
</span><span class="hll"><span class="w">    </span><span class="p">}</span>
</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">certs</span><span class="o">-&gt;</span><span class="n">client_cert</span><span class="p">.</span><span class="n">desc</span><span class="p">.</span><span class="n">source</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">AVS_CRYPTO_DATA_SOURCE_EMPTY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">avs_error_t</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">avs_is_err</span><span class="p">((</span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configure_client_certs</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">,</span>
<span class="w">                                                     </span><span class="o">&amp;</span><span class="n">certs</span><span class="o">-&gt;</span><span class="n">client_cert</span><span class="p">.</span><span class="n">desc</span><span class="p">)))</span>
<span class="w">                </span><span class="o">||</span><span class="w"> </span><span class="n">avs_is_err</span><span class="p">(</span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configure_client_key</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">,</span>
<span class="w">                                                         </span><span class="o">&amp;</span><span class="n">certs</span><span class="o">-&gt;</span><span class="n">client_key</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">AVS_OK</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="populating-the-array">
<h3><a class="toc-backref" href="#id5"><span class="section-number">8.4.1.6.3.2. </span>Populating the array</a><a class="headerlink" href="#populating-the-array" title="Permalink to this headline"></a></h3>
<p>DANE TLSA entries are passed into the socket object through the <code class="docutils literal notranslate"><span class="pre">set_opt</span></code>
operation with the <code class="docutils literal notranslate"><span class="pre">AVS_NET_SOCKET_OPT_DANE_TLSA_ARRAY</span></code> key.</p>
<p>In OpenSSL, this information can only be provided after specifying the hostname
for the <code class="docutils literal notranslate"><span class="pre">SSL</span></code> object, which in our code only happens during the <code class="docutils literal notranslate"><span class="pre">connect</span></code>
operation. For this reason, we need to store the DANE TLSA entries in our
internal structures first.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">avs_error_t</span><span class="w"> </span><span class="nf">tls_set_opt</span><span class="p">(</span><span class="n">avs_net_socket_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock_</span><span class="p">,</span>
<span class="w">                               </span><span class="n">avs_net_socket_opt_key_t</span><span class="w"> </span><span class="n">option_key</span><span class="p">,</span>
<span class="w">                               </span><span class="n">avs_net_socket_opt_value_t</span><span class="w"> </span><span class="n">option_value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">sock_</span><span class="p">;</span>
<span class="hll"><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">option_key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">AVS_NET_SOCKET_OPT_DANE_TLSA_ARRAY</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">option_value</span><span class="p">.</span><span class="n">dane_tlsa_array</span><span class="p">.</span><span class="n">array_element_count</span>
</span><span class="hll"><span class="w">                </span><span class="o">&gt;</span><span class="w"> </span><span class="n">AVS_ARRAY_SIZE</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dane_tlsa_array</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_EINVAL</span><span class="p">);</span>
</span><span class="hll"><span class="w">        </span><span class="p">}</span>
</span><span class="hll"><span class="w">        </span><span class="n">avs_net_socket_dane_tlsa_record_t</span>
</span><span class="hll"><span class="w">                </span><span class="n">copied_array</span><span class="p">[</span><span class="n">AVS_ARRAY_SIZE</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dane_tlsa_array</span><span class="p">)];</span>
</span><span class="hll"><span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="n">copied_association_data</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span>
</span><span class="hll"><span class="w">                </span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dane_tlsa_association_data_buf</span><span class="p">)];</span>
</span><span class="hll"><span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">copied_association_data_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span class="hll"><span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">copied_array</span><span class="p">,</span><span class="w"> </span><span class="n">option_value</span><span class="p">.</span><span class="n">dane_tlsa_array</span><span class="p">.</span><span class="n">array_ptr</span><span class="p">,</span>
</span><span class="hll"><span class="w">               </span><span class="n">option_value</span><span class="p">.</span><span class="n">dane_tlsa_array</span><span class="p">.</span><span class="n">array_element_count</span>
</span><span class="hll"><span class="w">                       </span><span class="o">*</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">avs_net_socket_dane_tlsa_record_t</span><span class="p">));</span>
</span><span class="hll"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">option_value</span><span class="p">.</span><span class="n">dane_tlsa_array</span><span class="p">.</span><span class="n">array_element_count</span><span class="p">;</span>
</span><span class="hll"><span class="w">             </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">copied_association_data_offset</span>
</span><span class="hll"><span class="w">                            </span><span class="o">+</span><span class="w"> </span><span class="n">option_value</span><span class="p">.</span><span class="n">dane_tlsa_array</span><span class="p">.</span><span class="n">array_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span class="hll"><span class="w">                                      </span><span class="p">.</span><span class="n">association_data_size</span>
</span><span class="hll"><span class="w">                    </span><span class="o">&gt;</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">copied_association_data</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_EINVAL</span><span class="p">);</span>
</span><span class="hll"><span class="w">            </span><span class="p">}</span>
</span><span class="hll"><span class="w">            </span><span class="n">memcpy</span><span class="p">(</span><span class="n">copied_association_data</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">copied_association_data_offset</span><span class="p">,</span>
</span><span class="hll"><span class="w">                   </span><span class="n">option_value</span><span class="p">.</span><span class="n">dane_tlsa_array</span><span class="p">.</span><span class="n">array_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">association_data</span><span class="p">,</span>
</span><span class="hll"><span class="w">                   </span><span class="n">option_value</span><span class="p">.</span><span class="n">dane_tlsa_array</span><span class="p">.</span><span class="n">array_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span class="hll"><span class="w">                           </span><span class="p">.</span><span class="n">association_data_size</span><span class="p">);</span>
</span><span class="hll"><span class="w">            </span><span class="n">copied_array</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">association_data</span><span class="w"> </span><span class="o">=</span>
</span><span class="hll"><span class="w">                    </span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dane_tlsa_association_data_buf</span>
</span><span class="hll"><span class="w">                    </span><span class="o">+</span><span class="w"> </span><span class="n">copied_association_data_offset</span><span class="p">;</span>
</span><span class="hll"><span class="w">            </span><span class="n">copied_association_data_offset</span><span class="w"> </span><span class="o">+=</span>
</span><span class="hll"><span class="w">                    </span><span class="n">option_value</span><span class="p">.</span><span class="n">dane_tlsa_array</span><span class="p">.</span><span class="n">array_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span class="hll"><span class="w">                            </span><span class="p">.</span><span class="n">association_data_size</span><span class="p">;</span>
</span><span class="hll"><span class="w">        </span><span class="p">}</span>
</span><span class="hll"><span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dane_tlsa_association_data_buf</span><span class="p">,</span><span class="w"> </span><span class="n">copied_association_data</span><span class="p">,</span>
</span><span class="hll"><span class="w">               </span><span class="k">sizeof</span><span class="p">(</span><span class="n">copied_association_data</span><span class="p">));</span>
</span><span class="hll"><span class="w">        </span><span class="n">memcpy</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dane_tlsa_array</span><span class="p">,</span><span class="w"> </span><span class="n">copied_array</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">copied_array</span><span class="p">));</span>
</span><span class="hll"><span class="w">        </span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dane_tlsa_array_size</span><span class="w"> </span><span class="o">=</span>
</span><span class="hll"><span class="w">                </span><span class="n">option_value</span><span class="p">.</span><span class="n">dane_tlsa_array</span><span class="p">.</span><span class="n">array_element_count</span><span class="p">;</span>
</span><span class="hll"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">AVS_OK</span><span class="p">;</span>
</span><span class="hll"><span class="w">    </span><span class="p">}</span>
</span><span class="w">    </span><span class="k">default</span><span class="o">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">avs_net_socket_set_opt</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">backend_socket</span><span class="p">,</span><span class="w"> </span><span class="n">option_key</span><span class="p">,</span>
<span class="w">                                      </span><span class="n">option_value</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The above code essentially makes a deep copy of the data in
<code class="docutils literal notranslate"><span class="pre">option_value.dane_tlsa_array</span></code>. The buffers pointed to by the
<code class="docutils literal notranslate"><span class="pre">association_data</span></code> fields within array entries are copied into the
<code class="docutils literal notranslate"><span class="pre">sock-&gt;dane_tlsa_association_data_buf</span></code> field and pointers in the copied array
updated to point into that buffer as well.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Any pointers passed to the <code class="docutils literal notranslate"><span class="pre">set_opt</span></code> function with the
<code class="docutils literal notranslate"><span class="pre">AVS_NET_SOCKET_OPT_DANE_TLSA_ARRAY</span></code> options shall be treated as data that
will be invalidated after returning from the function.</p>
<p>This means that this data needs to be either immediately loaded into the
(D)TLS context, or a deep copy otherwise made.</p>
</div>
</section>
<section id="configuring-the-connection">
<h3><a class="toc-backref" href="#id6"><span class="section-number">8.4.1.6.3.3. </span>Configuring the connection</a><a class="headerlink" href="#configuring-the-connection" title="Permalink to this headline"></a></h3>
<p>Now with all the necessary information, we can configure the <code class="docutils literal notranslate"><span class="pre">SSL</span></code> object
during the <code class="docutils literal notranslate"><span class="pre">connect</span></code> operation.</p>
<p>All the DANE configuration essentially takes place of the
<code class="docutils literal notranslate"><span class="pre">SSL_set_tlsext_host_name()</span></code> call:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">avs_error_t</span><span class="w"> </span><span class="nf">perform_handshake</span><span class="p">(</span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="p">,</span>
<span class="w">                                     </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">host</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">union</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">sockaddr</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">sockaddr_storage</span><span class="w"> </span><span class="n">storage</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">peername</span><span class="p">;</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">fd_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">avs_net_socket_get_system</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">backend_socket</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">fd_ptr</span>
<span class="w">            </span><span class="o">||</span><span class="w"> </span><span class="n">getpeername</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">fd_ptr</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">peername</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span>
<span class="w">                           </span><span class="o">&amp;</span><span class="p">(</span><span class="kt">socklen_t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">peername</span><span class="p">)</span><span class="w"> </span><span class="p">}))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_EBADF</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SSL_new</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_ENOMEM</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">SSL_set_app_data</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="p">,</span><span class="w"> </span><span class="n">sock</span><span class="p">);</span>
<span class="hll"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dane_enabled</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">        </span><span class="c1">// NOTE: SSL_dane_enable() calls SSL_set_tlsext_host_name() internally</span>
</span><span class="hll"><span class="w">        </span><span class="n">SSL_dane_enable</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="p">,</span><span class="w"> </span><span class="n">host</span><span class="p">);</span>
</span><span class="hll"><span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">have_usable_tlsa_records</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
</span><span class="hll"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dane_tlsa_array_size</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">SSL_CTX_get_verify_mode</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SSL_VERIFY_NONE</span>
</span><span class="hll"><span class="w">                    </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dane_tlsa_array</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">certificate_usage</span>
</span><span class="hll"><span class="w">                                </span><span class="o">==</span><span class="w"> </span><span class="n">AVS_NET_SOCKET_DANE_CA_CONSTRAINT</span>
</span><span class="hll"><span class="w">                        </span><span class="o">||</span><span class="w"> </span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dane_tlsa_array</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">certificate_usage</span>
</span><span class="hll"><span class="w">                                   </span><span class="o">==</span><span class="w"> </span><span class="n">AVS_NET_SOCKET_DANE_SERVICE_CERTIFICATE_CONSTRAINT</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">                </span><span class="c1">// PKIX-TA and PKIX-EE constraints are unusable for</span>
</span><span class="hll"><span class="w">                </span><span class="c1">// opportunistic clients</span>
</span><span class="hll"><span class="w">                </span><span class="k">continue</span><span class="p">;</span>
</span><span class="hll"><span class="w">            </span><span class="p">}</span>
</span><span class="hll"><span class="w">            </span><span class="n">SSL_dane_tlsa_add</span><span class="p">(</span>
</span><span class="hll"><span class="w">                    </span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="p">,</span>
</span><span class="hll"><span class="w">                    </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dane_tlsa_array</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">certificate_usage</span><span class="p">,</span>
</span><span class="hll"><span class="w">                    </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dane_tlsa_array</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">selector</span><span class="p">,</span>
</span><span class="hll"><span class="w">                    </span><span class="p">(</span><span class="kt">uint8_t</span><span class="p">)</span><span class="w"> </span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dane_tlsa_array</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">matching_type</span><span class="p">,</span>
</span><span class="hll"><span class="w">                    </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dane_tlsa_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
</span><span class="hll"><span class="w">                            </span><span class="p">.</span><span class="n">association_data</span><span class="p">,</span>
</span><span class="hll"><span class="w">                    </span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dane_tlsa_array</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">association_data_size</span><span class="p">);</span>
</span><span class="hll"><span class="w">            </span><span class="n">have_usable_tlsa_records</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
</span><span class="hll"><span class="w">        </span><span class="p">}</span>
</span><span class="hll"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">SSL_CTX_get_verify_mode</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SSL_VERIFY_NONE</span>
</span><span class="hll"><span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">have_usable_tlsa_records</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">            </span><span class="n">SSL_set_verify</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="p">,</span><span class="w"> </span><span class="n">SSL_VERIFY_PEER</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
</span><span class="hll"><span class="w">        </span><span class="p">}</span>
</span><span class="hll"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">        </span><span class="n">SSL_set_tlsext_host_name</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="p">,</span><span class="w"> </span><span class="n">host</span><span class="p">);</span>
</span><span class="hll"><span class="w">    </span><span class="p">}</span>
</span><span class="w">    </span><span class="n">SSL_set1_host</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="p">,</span><span class="w"> </span><span class="n">host</span><span class="p">);</span>

<span class="w">    </span><span class="n">BIO</span><span class="w"> </span><span class="o">*</span><span class="n">bio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BIO_new_dgram</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">fd_ptr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">bio</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_ENOMEM</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">BIO_ctrl</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span><span class="w"> </span><span class="n">BIO_CTRL_DGRAM_SET_CONNECTED</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">peername</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
<span class="w">    </span><span class="n">SSL_set_bio</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="p">,</span><span class="w"> </span><span class="n">bio</span><span class="p">,</span><span class="w"> </span><span class="n">bio</span><span class="p">);</span>
<span class="w">    </span><span class="n">DTLS_set_timer_cb</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="p">,</span><span class="w"> </span><span class="n">dtls_timer_cb</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">session_resumption_buffer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">session_resumption_buffer</span><span class="p">;</span>
<span class="w">        </span><span class="n">SSL_SESSION</span><span class="w"> </span><span class="o">*</span><span class="n">session</span><span class="w"> </span><span class="o">=</span>
<span class="w">                </span><span class="n">d2i_SSL_SESSION</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span>
<span class="w">                                </span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">session_resumption_buffer_size</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">session</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">SSL_set_session</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="p">,</span><span class="w"> </span><span class="n">session</span><span class="p">);</span>
<span class="w">            </span><span class="n">SSL_SESSION_free</span><span class="p">(</span><span class="n">session</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">SSL_connect</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_EPROTO</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">AVS_OK</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note that <a class="reference external" href="https://datatracker.ietf.org/doc/html/rfc7671#section-4.1">“opportunistic DANE”</a> is mentioned and
supported in the code above. This means that even if server certificate
verification is not otherwise enabled, but DANE-TA or DANE-EE entries are
present, the client shall verify the server certificate against these entries.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Opportunistic DANE is not used by Anjay. An implementation is provided here
for the sake of completeness, but it is not necessary for LwM2M
communication.</p>
<p>If only LwM2M compliance is targeted, it is safe to remove the
<code class="docutils literal notranslate"><span class="pre">if</span> <span class="pre">(SSL_CTX_get_verify_mode(sock-&gt;ctx)</span> <span class="pre">==</span> <span class="pre">SSL_VERIFY_NONE</span> <span class="pre">&amp;&amp;</span> <span class="pre">...)</span></code>
clauses and the <code class="docutils literal notranslate"><span class="pre">have_usable_tlsa_records</span></code> variable from the code above
altogether.</p>
</div>
</section>
<section id="minimum-viable-subset">
<span id="custom-tls-api-certificates-advanced-dane-minimum-subset"></span><h3><a class="toc-backref" href="#id7"><span class="section-number">8.4.1.6.3.4. </span>Minimum viable subset</a><a class="headerlink" href="#minimum-viable-subset" title="Permalink to this headline"></a></h3>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The approach described in this section is not fully compliant with DANE nor
any version of LwM2M. It is intended <strong>only</strong> for use if implementing more
complete support is not possible.</p>
</div>
<p>Support for DANE is, unfortunately, very limited among (D)TLS implementations.
In fact, in the default Mbed TLS integration in avs_commons, it has been
implemented from scratch in a custom certificate verification callback, see the
<a class="reference external" href="https://github.com/AVSystem/avs_commons/blob/master/src/net/mbedtls/avs_mbedtls_socket.c#L535">verify_cert_cb() function</a>
there. In many cases, this approach might still be infeasible or even
impossible, especially if (D)TLS is handled in hardware.</p>
<p>It is possible to emulate the most common case using standard PKIX concepts,
which will allow LwM2M 1.0 (and 1.1 with typical configuration) to work, at
least with some servers.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>This implementation will <strong>only work with self-signed server certificates</strong>.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Code modified for this variant can be found under
<a class="reference external" href="https://github.com/AVSystem/Anjay/tree/master/examples/custom-tls/certificates-advanced-fake-dane">examples/custom-tls/certificates-advanced-fake-dane</a>
in the Anjay source directory.</p>
</div>
<p>This minimum implementation reverts the changed described earlier in the
<a class="reference internal" href="#custom-tls-api-certificates-advanced-dane"><span class="std std-ref">DANE support</span></a> section. Instead, the following
changes are made:</p>
<ul class="simple">
<li><p>The only information about DANE that needs to be kept in the socket state is
whether or not it is enabled.</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">avs_net_socket_v_table_t</span><span class="w"> </span><span class="o">*</span><span class="n">operations</span><span class="p">;</span>
<span class="w">    </span><span class="n">avs_net_socket_t</span><span class="w"> </span><span class="o">*</span><span class="n">backend_socket</span><span class="p">;</span>
<span class="w">    </span><span class="n">SSL_CTX</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
<span class="w">    </span><span class="n">SSL</span><span class="w"> </span><span class="o">*</span><span class="n">ssl</span><span class="p">;</span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">psk</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">psk_size</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">identity</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">identity_size</span><span class="p">;</span>

<span class="hll"><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">dane_enabled</span><span class="p">;</span>
</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">session_resumption_buffer</span><span class="p">;</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">session_resumption_buffer_size</span><span class="p">;</span>

<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">server_name_indication</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">dtls_hs_timeout_min_us</span><span class="p">;</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">dtls_hs_timeout_max_us</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">tls_socket_impl_t</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">avs_error_t</span><span class="w"> </span><span class="nf">configure_certs</span><span class="p">(</span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="p">,</span>
<span class="w">                                   </span><span class="k">const</span><span class="w"> </span><span class="n">avs_net_certificate_info_t</span><span class="w"> </span><span class="o">*</span><span class="n">certs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">certs</span><span class="o">-&gt;</span><span class="n">server_cert_validation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">certs</span><span class="o">-&gt;</span><span class="n">ignore_system_trust_store</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">SSL_CTX_set_default_verify_paths</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">X509_STORE</span><span class="w"> </span><span class="o">*</span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SSL_CTX_get_cert_store</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">);</span>
<span class="w">        </span><span class="n">avs_error_t</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">avs_is_err</span><span class="p">((</span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configure_trusted_certs</span><span class="p">(</span>
<span class="w">                                </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">certs</span><span class="o">-&gt;</span><span class="n">trusted_certs</span><span class="p">.</span><span class="n">desc</span><span class="p">)))</span>
<span class="w">                </span><span class="o">||</span><span class="w"> </span><span class="n">avs_is_err</span><span class="p">((</span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configure_cert_revocation_lists</span><span class="p">(</span>
<span class="w">                                       </span><span class="n">store</span><span class="p">,</span>
<span class="w">                                       </span><span class="o">&amp;</span><span class="n">certs</span><span class="o">-&gt;</span><span class="n">cert_revocation_lists</span><span class="p">.</span><span class="n">desc</span><span class="p">))))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">SSL_CTX_set_verify</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">SSL_VERIFY_PEER</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">SSL_CTX_set_verify</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">SSL_VERIFY_NONE</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="hll"><span class="w">    </span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dane_enabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">certs</span><span class="o">-&gt;</span><span class="n">dane</span><span class="p">;</span>
</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">certs</span><span class="o">-&gt;</span><span class="n">client_cert</span><span class="p">.</span><span class="n">desc</span><span class="p">.</span><span class="n">source</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">AVS_CRYPTO_DATA_SOURCE_EMPTY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">avs_error_t</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">avs_is_err</span><span class="p">((</span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configure_client_certs</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">,</span>
<span class="w">                                                     </span><span class="o">&amp;</span><span class="n">certs</span><span class="o">-&gt;</span><span class="n">client_cert</span><span class="p">.</span><span class="n">desc</span><span class="p">)))</span>
<span class="w">                </span><span class="o">||</span><span class="w"> </span><span class="n">avs_is_err</span><span class="p">(</span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configure_client_key</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">,</span>
<span class="w">                                                         </span><span class="o">&amp;</span><span class="n">certs</span><span class="o">-&gt;</span><span class="n">client_key</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">AVS_OK</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">tls_set_opt()</span></code> function is updated to put the server certificate into
the trust store.</p></li>
</ul>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">avs_error_t</span><span class="w"> </span><span class="nf">tls_set_opt</span><span class="p">(</span><span class="n">avs_net_socket_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock_</span><span class="p">,</span>
<span class="w">                               </span><span class="n">avs_net_socket_opt_key_t</span><span class="w"> </span><span class="n">option_key</span><span class="p">,</span>
<span class="w">                               </span><span class="n">avs_net_socket_opt_value_t</span><span class="w"> </span><span class="n">option_value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">sock_</span><span class="p">;</span>
<span class="hll"><span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">option_key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">AVS_NET_SOCKET_OPT_DANE_TLSA_ARRAY</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">option_value</span><span class="p">.</span><span class="n">dane_tlsa_array</span><span class="p">.</span><span class="n">array_element_count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_EINVAL</span><span class="p">);</span>
</span><span class="hll"><span class="w">        </span><span class="p">}</span>
</span><span class="hll"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">dane_enabled</span>
</span><span class="hll"><span class="w">                </span><span class="o">||</span><span class="w"> </span><span class="n">option_value</span><span class="p">.</span><span class="n">dane_tlsa_array</span><span class="p">.</span><span class="n">array_element_count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span>
</span><span class="hll"><span class="w">                </span><span class="o">||</span><span class="w"> </span><span class="n">option_value</span><span class="p">.</span><span class="n">dane_tlsa_array</span><span class="p">.</span><span class="n">array_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">certificate_usage</span>
</span><span class="hll"><span class="w">                               </span><span class="o">==</span><span class="w"> </span><span class="n">AVS_NET_SOCKET_DANE_CA_CONSTRAINT</span>
</span><span class="hll"><span class="w">                </span><span class="o">||</span><span class="w"> </span><span class="n">option_value</span><span class="p">.</span><span class="n">dane_tlsa_array</span><span class="p">.</span><span class="n">array_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">certificate_usage</span>
</span><span class="hll"><span class="w">                               </span><span class="o">==</span><span class="w"> </span><span class="n">AVS_NET_SOCKET_DANE_SERVICE_CERTIFICATE_CONSTRAINT</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">AVS_OK</span><span class="p">;</span>
</span><span class="hll"><span class="w">        </span><span class="p">}</span>
</span><span class="hll"><span class="w">        </span><span class="n">X509_STORE</span><span class="w"> </span><span class="o">*</span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SSL_CTX_get_cert_store</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">);</span>
</span><span class="hll"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">option_value</span><span class="p">.</span><span class="n">dane_tlsa_array</span><span class="p">.</span><span class="n">array_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">selector</span>
</span><span class="hll"><span class="w">                        </span><span class="o">!=</span><span class="w"> </span><span class="n">AVS_NET_SOCKET_DANE_CERTIFICATE</span>
</span><span class="hll"><span class="w">                </span><span class="o">||</span><span class="w"> </span><span class="n">option_value</span><span class="p">.</span><span class="n">dane_tlsa_array</span><span class="p">.</span><span class="n">array_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">matching_type</span>
</span><span class="hll"><span class="w">                               </span><span class="o">!=</span><span class="w"> </span><span class="n">AVS_NET_SOCKET_DANE_MATCH_FULL</span>
</span><span class="hll"><span class="w">                </span><span class="o">||</span><span class="w"> </span><span class="n">sk_X509_OBJECT_num</span><span class="p">(</span><span class="n">X509_STORE_get0_objects</span><span class="p">(</span><span class="n">store</span><span class="p">))</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_ENOTSUP</span><span class="p">);</span>
</span><span class="hll"><span class="w">        </span><span class="p">}</span>
</span><span class="hll"><span class="w">        </span><span class="n">avs_crypto_certificate_chain_info_t</span><span class="w"> </span><span class="n">chain</span><span class="w"> </span><span class="o">=</span>
</span><span class="hll"><span class="w">                </span><span class="n">avs_crypto_certificate_chain_info_from_buffer</span><span class="p">(</span>
</span><span class="hll"><span class="w">                        </span><span class="n">option_value</span><span class="p">.</span><span class="n">dane_tlsa_array</span><span class="p">.</span><span class="n">array_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class="hll"><span class="w">                                </span><span class="p">.</span><span class="n">association_data</span><span class="p">,</span>
</span><span class="hll"><span class="w">                        </span><span class="n">option_value</span><span class="p">.</span><span class="n">dane_tlsa_array</span><span class="p">.</span><span class="n">array_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span class="hll"><span class="w">                                </span><span class="p">.</span><span class="n">association_data_size</span><span class="p">);</span>
</span><span class="hll"><span class="w">        </span><span class="n">avs_error_t</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configure_trusted_certs</span><span class="p">(</span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">chain</span><span class="p">.</span><span class="n">desc</span><span class="p">);</span>
</span><span class="hll"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">avs_is_ok</span><span class="p">(</span><span class="n">err</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">            </span><span class="n">SSL_CTX_set_verify</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">SSL_VERIFY_PEER</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
</span><span class="hll"><span class="w">        </span><span class="p">}</span>
</span><span class="hll"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
</span><span class="hll"><span class="w">    </span><span class="p">}</span>
</span><span class="w">    </span><span class="k">default</span><span class="o">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">avs_net_socket_set_opt</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">backend_socket</span><span class="p">,</span><span class="w"> </span><span class="n">option_key</span><span class="p">,</span>
<span class="w">                                      </span><span class="n">option_value</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Due to <code class="docutils literal notranslate"><span class="pre">configure_trusted_certs()</span></code> being called in the code above, that
function’s declaration needs to be moved above <code class="docutils literal notranslate"><span class="pre">tls_set_opt()</span></code>, with no
other changes.</p></li>
</ul>
<p>In the code above, only the DANE-TA and DANE-EE mode (Certificate Usage modes 2
and 3) entries are taken into account, only full certificate matching is
supported, and the trust store needs to be empty at the time of calling this
function. If all those conditions are met, the passed certificate is just added
to the store - <code class="docutils literal notranslate"><span class="pre">configure_trusted_certs()</span></code> is called for that purpose as a
wrapper to the <code class="docutils literal notranslate"><span class="pre">d2i_X509()</span></code> and <code class="docutils literal notranslate"><span class="pre">X509_STORE_add_cert()</span></code> functions.</p>
<p>This is enough for the logic used by Anjay for LwM2M 1.0 (and 1.1 on default
settings) to work. However, as mentioned above, only self-signed server
certificates are supported. DANE-EE mode will not function properly, as
certificate verification will fail due to inability to find the CA certificate.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="CustomTLS-CertificatesBasic.html" class="btn btn-neutral float-left" title="8.4.1.5. Basic certificate support" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="CustomTLS-TCPSupport.html" class="btn btn-neutral float-right" title="8.4.1.7. Support for TLS over TCP" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017-2023, AVSystem.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>