<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>8.4.1.1. Introductory stub &mdash; Anjay 3.8.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../_static/theme_overrides.css?v=b9c2c5b9" />

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=948f11bf"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="8.4.1.2. Minimal DTLS implementation" href="CustomTLS-Minimal.html" />
    <link rel="prev" title="8.4. Custom (D)TLS layers" href="../CustomTLS.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #ffd500" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/avsystem_header.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                3.8.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../Introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LwM2M.html">2. OMA LwM2M - Brief description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Compiling_client_applications.html">3. Compiling client applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../BasicClient.html">4. Basic client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../AdvancedTopics.html">5. Advanced topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../FirmwareUpdateTutorial.html">6. Firmware Update Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tools.html">7. Tools</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../PortingGuideForNonPOSIXPlatforms.html">8. Porting guide for non-POSIX platforms</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../TimeAPI.html">8.1. Time API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ThreadingAPI.html">8.2. Threading API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../NetworkingAPI.html">8.3. Networking API</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../CustomTLS.html">8.4. Custom (D)TLS layers</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="#">8.4.1.1. Introductory stub</a></li>
<li class="toctree-l3"><a class="reference internal" href="CustomTLS-Minimal.html">8.4.1.2. Minimal DTLS implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="CustomTLS-Resumption.html">8.4.1.3. Session resumption support</a></li>
<li class="toctree-l3"><a class="reference internal" href="CustomTLS-ConfigFeatures.html">8.4.1.4. Advanced configuration features</a></li>
<li class="toctree-l3"><a class="reference internal" href="CustomTLS-CertificatesBasic.html">8.4.1.5. Basic certificate support</a></li>
<li class="toctree-l3"><a class="reference internal" href="CustomTLS-CertificatesAdvanced.html">8.4.1.6. Advanced certificate support</a></li>
<li class="toctree-l3"><a class="reference internal" href="CustomTLS-TCPSupport.html">8.4.1.7. Support for TLS over TCP</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../Migrating.html">9. Migrating from older versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CommercialFeatures.html">10. Commercial features</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #ffd500" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Anjay</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../PortingGuideForNonPOSIXPlatforms.html"><span class="section-number">8. </span>Porting guide for non-POSIX platforms</a></li>
          <li class="breadcrumb-item"><a href="../CustomTLS.html"><span class="section-number">8.4. </span>Custom (D)TLS layers</a></li>
      <li class="breadcrumb-item active"><span class="section-number">8.4.1.1. </span>Introductory stub</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="introductory-stub">
<h1><span class="section-number">8.4.1.1. </span>Introductory stub<a class="headerlink" href="#introductory-stub" title="Link to this heading"></a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#introduction" id="id1">Introduction</a></p></li>
<li><p><a class="reference internal" href="#adjustments-to-the-build-system" id="id2">Adjustments to the build system</a></p></li>
<li><p><a class="reference internal" href="#global-initialization" id="id3">Global initialization</a></p></li>
<li><p><a class="reference internal" href="#tls-socket-structure-stub" id="id4">TLS socket structure stub</a></p></li>
<li><p><a class="reference internal" href="#implementing-socket-methods" id="id5">Implementing socket methods</a></p>
<ul>
<li><p><a class="reference internal" href="#forwarded-functions" id="id6">Forwarded functions</a></p></li>
<li><p><a class="reference internal" href="#connect-method-stub" id="id7">Connect method stub</a></p></li>
<li><p><a class="reference internal" href="#send-method" id="id8">Send method</a></p></li>
<li><p><a class="reference internal" href="#receive-method" id="id9">Receive method</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#virtual-method-table-and-constructor-function-stubs" id="id10">Virtual method table and constructor function stubs</a></p></li>
</ul>
</nav>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Code related to this tutorial can be found under
<a class="reference external" href="https://github.com/AVSystem/Anjay/tree/master/examples/custom-tls/stub">examples/custom-tls/stub</a>
in the Anjay source directory.</p>
</div>
<section id="introduction">
<h2><a class="toc-backref" href="#id1" role="doc-backlink"><span class="section-number">8.4.1.1.1. </span>Introduction</a><a class="headerlink" href="#introduction" title="Link to this heading"></a></h2>
<p>This article describes a stub with no actual functionality, but contains the
necessary boilerplate that all the following tutorials will be based on.</p>
<p>The example code for this tutorial is an extension of the one built in the
<a class="reference internal" href="../NetworkingAPI/NetworkingAPI-IpStickiness.html"><span class="doc">IP address stickiness support</span></a> article. This has been chosen
as a base because it contains all the features of a custom networking layer. We
encourage you to familiarize yourself with the <a class="reference internal" href="../NetworkingAPI.html"><span class="doc">Networking API</span></a> tutorials
before implementing a custom TLS layer, but intricate knowledge of all the
features of the networking layer is not necessary.</p>
<p>Compared to the networking API tutorials, this one is intended to be used with a
version of Anjay that has been compiled without the default TLS layer
implementation, i.e. with this additional CMake flag:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span><span class="n">DDTLS_BACKEND</span><span class="o">=</span><span class="n">custom</span>
</pre></div>
</div>
<p>Additionally, support for HTTP downloads will be used in later tutorials. When
the examples are built as part of Anjay’s <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">examples</span></code> target, this feature
is enabled for all the <code class="docutils literal notranslate"><span class="pre">custom-tls</span></code> subprojects with yet another CMake flag:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span><span class="n">DWITH_HTTP_DOWNLOAD</span><span class="o">=</span><span class="n">ON</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This new custom network layer implementation will be based on OpenSSL 1.1.1.
This is not very useful in the real world, as there is a default
implementation provided for the OpenSSL library. However, this tutorial is
provided as a reference implementation simpler than the actual default one,
to make it easier to base your code on it.</p>
</div>
</section>
<section id="adjustments-to-the-build-system">
<h2><a class="toc-backref" href="#id2" role="doc-backlink"><span class="section-number">8.4.1.1.2. </span>Adjustments to the build system</a><a class="headerlink" href="#adjustments-to-the-build-system" title="Link to this heading"></a></h2>
<p>The <a class="reference external" href="https://github.com/AVSystem/Anjay/blob/master/examples/custom-tls/stub/CMakeLists.txt">CMakeLists.txt</a>
file has been modified to accommodate for this custom TLS implementation:</p>
<div class="highlight-cmake notranslate"><div class="highlight"><pre><span></span><span class="hll"><span class="nb">cmake_minimum_required</span><span class="p">(</span><span class="s">VERSION</span><span class="w"> </span><span class="s">3.4</span><span class="p">)</span>
</span><span class="nb">project</span><span class="p">(</span><span class="s">custom-tls-stub</span><span class="w"> </span><span class="s">C</span><span class="p">)</span>

<span class="nb">set</span><span class="p">(</span><span class="s">CMAKE_C_STANDARD</span><span class="w"> </span><span class="s">99</span><span class="p">)</span>

<span class="nb">find_package</span><span class="p">(</span><span class="s">anjay</span><span class="w"> </span><span class="s">REQUIRED</span><span class="p">)</span>
<span class="hll"><span class="nb">find_package</span><span class="p">(</span><span class="s">OpenSSL</span><span class="w"> </span><span class="s">REQUIRED</span><span class="p">)</span>
</span>
<span class="nb">add_executable</span><span class="p">(</span><span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span>
<span class="w">               </span><span class="s">src/main.c</span>
<span class="w">               </span><span class="s">src/net_impl.c</span>
<span class="hll"><span class="w">               </span><span class="s">src/tls_impl.c</span><span class="p">)</span>
</span><span class="hll"><span class="nb">target_link_libraries</span><span class="p">(</span><span class="o">${</span><span class="nv">PROJECT_NAME</span><span class="o">}</span><span class="w"> </span><span class="s">PRIVATE</span><span class="w"> </span><span class="s">anjay</span><span class="w"> </span><span class="s">OpenSSL::SSL</span><span class="p">)</span>
</span></pre></div>
</div>
<p>Some minor changes have been made here:</p>
<ul class="simple">
<li><p>The project is linked with the OpenSSL library by calling <code class="docutils literal notranslate"><span class="pre">find_package</span></code>
and adding <code class="docutils literal notranslate"><span class="pre">OpenSSL::SSL</span></code> to <code class="docutils literal notranslate"><span class="pre">target_link_libraries</span></code>.</p></li>
<li><p>Minimum required CMake version has been raised to 3.4 as that is the first
version in which the new-style <code class="docutils literal notranslate"><span class="pre">OpenSSL::SSL</span></code> target is provided.</p></li>
<li><p>The <a class="reference external" href="https://github.com/AVSystem/Anjay/blob/master/examples/custom-tls/stub/src/tls_impl.c">tls_impl.c</a>
file has been added to the executable target. Just like with the custom
network layer, the functions defined there will be called by Anjay or its
dependent libraries.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">main.c</span></code> and <code class="docutils literal notranslate"><span class="pre">net_impl.c</span></code> files are left completely unchanged
compared to the <a class="reference internal" href="../NetworkingAPI/NetworkingAPI-IpStickiness.html"><span class="doc">IP address stickiness support</span></a> version.
In fact, in the repository, they are symbolic links to the files from that
tutorial.</p>
<p>While we encourage you to familiarize yourself with the code in those files,
it is not really relevant to this article. It is an example code that
establishes a basic connection with a LwM2M server and implements a simple
but full-featured networking layer.</p>
</div>
</section>
<section id="global-initialization">
<h2><a class="toc-backref" href="#id3" role="doc-backlink"><span class="section-number">8.4.1.1.3. </span>Global initialization</a><a class="headerlink" href="#global-initialization" title="Link to this heading"></a></h2>
<p>Just like with the network layer, the APIs that need to be implemented are
private, so we also start with manually including the forward declarations, as
quoted in the <a class="reference internal" href="../CustomTLS.html"><span class="doc">previous article</span></a>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">avs_error_t</span><span class="w"> </span><span class="nf">_avs_net_initialize_global_ssl_state</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">_avs_net_cleanup_global_ssl_state</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="n">avs_error_t</span><span class="w"> </span><span class="nf">_avs_net_create_ssl_socket</span><span class="p">(</span><span class="n">avs_net_socket_t</span><span class="w"> </span><span class="o">**</span><span class="n">socket</span><span class="p">,</span>
<span class="w">                                       </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">socket_configuration</span><span class="p">);</span>
<span class="n">avs_error_t</span><span class="w"> </span><span class="nf">_avs_net_create_dtls_socket</span><span class="p">(</span><span class="n">avs_net_socket_t</span><span class="w"> </span><span class="o">**</span><span class="n">socket</span><span class="p">,</span>
<span class="w">                                        </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">socket_configuration</span><span class="p">);</span>
</pre></div>
</div>
<p>The OpenSSL library needs global initialization, so <code class="docutils literal notranslate"><span class="pre">OPENSSL_init_ssl</span></code>
function is called in <code class="docutils literal notranslate"><span class="pre">_avs_net_initialize_global_ssl_state()</span></code>. There is no
need for any explicit cleanup, so the <code class="docutils literal notranslate"><span class="pre">_avs_net_cleanup_global_ssl_state()</span></code>
function can be left empty:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">avs_error_t</span><span class="w"> </span><span class="nf">_avs_net_initialize_global_ssl_state</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">OPENSSL_init_ssl</span><span class="p">(</span><span class="n">OPENSSL_INIT_ADD_ALL_CIPHERS</span>
<span class="w">                                  </span><span class="o">|</span><span class="w"> </span><span class="n">OPENSSL_INIT_ADD_ALL_DIGESTS</span><span class="p">,</span>
<span class="w">                          </span><span class="nb">NULL</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_EPROTO</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">AVS_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">_avs_net_cleanup_global_ssl_state</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>
</pre></div>
</div>
</section>
<section id="tls-socket-structure-stub">
<h2><a class="toc-backref" href="#id4" role="doc-backlink"><span class="section-number">8.4.1.1.4. </span>TLS socket structure stub</a><a class="headerlink" href="#tls-socket-structure-stub" title="Link to this heading"></a></h2>
<p>In The TLS socket object, the following information will need to be kept:</p>
<ul class="simple">
<li><p>The “backend socket”, the underlying unencrypted socket. We will use the
previously implemented <code class="docutils literal notranslate"><span class="pre">avs_net</span></code> socket for that purpose, so that as many
features as possible can be simply forwarded.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">SSL_CTX</span></code> object that contains the state that OpenSSL intends to be
reused between similar connections.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">SSL</span></code> object that contains the per-connection OpenSSL state.</p></li>
</ul>
<p>The way TLS-related APIs are designed in Anjay makes it impossible to share an
<code class="docutils literal notranslate"><span class="pre">SSL_CTX</span></code> object between multiple connections, so both of the above need to be
present for each connection.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">avs_net_socket_v_table_t</span><span class="w"> </span><span class="o">*</span><span class="n">operations</span><span class="p">;</span>
<span class="w">    </span><span class="n">avs_net_socket_t</span><span class="w"> </span><span class="o">*</span><span class="n">backend_socket</span><span class="p">;</span>
<span class="w">    </span><span class="n">SSL_CTX</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">;</span>
<span class="w">    </span><span class="n">SSL</span><span class="w"> </span><span class="o">*</span><span class="n">ssl</span><span class="p">;</span>
<span class="p">}</span><span class="w"> </span><span class="n">tls_socket_impl_t</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="implementing-socket-methods">
<h2><a class="toc-backref" href="#id5" role="doc-backlink"><span class="section-number">8.4.1.1.5. </span>Implementing socket methods</a><a class="headerlink" href="#implementing-socket-methods" title="Link to this heading"></a></h2>
<section id="forwarded-functions">
<h3><a class="toc-backref" href="#id6" role="doc-backlink"><span class="section-number">8.4.1.1.5.1. </span>Forwarded functions</a><a class="headerlink" href="#forwarded-functions" title="Link to this heading"></a></h3>
<p>Most of the auxiliary functions not related to actual data transmission or
handshakes, can just forward the calls to the underlying backend socket:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">avs_error_t</span>
<span class="nf">tls_bind</span><span class="p">(</span><span class="n">avs_net_socket_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock_</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">port</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">sock_</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">avs_net_socket_bind</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">backend_socket</span><span class="p">,</span><span class="w"> </span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">avs_error_t</span><span class="w"> </span><span class="nf">tls_close</span><span class="p">(</span><span class="n">avs_net_socket_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">sock_</span><span class="p">;</span>
<span class="hll"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">        </span><span class="n">SSL_free</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="p">);</span>
</span><span class="hll"><span class="w">        </span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span class="hll"><span class="w">    </span><span class="p">}</span>
</span><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">avs_net_socket_close</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">backend_socket</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">avs_error_t</span><span class="w"> </span><span class="nf">tls_shutdown</span><span class="p">(</span><span class="n">avs_net_socket_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">sock_</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">avs_net_socket_shutdown</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">backend_socket</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">avs_error_t</span><span class="w"> </span><span class="nf">tls_cleanup</span><span class="p">(</span><span class="n">avs_net_socket_t</span><span class="w"> </span><span class="o">**</span><span class="n">sock_ptr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_ENOTSUP</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="nf">tls_system_socket</span><span class="p">(</span><span class="n">avs_net_socket_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">sock_</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">avs_net_socket_get_system</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">backend_socket</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">avs_error_t</span><span class="w"> </span><span class="nf">tls_remote_host</span><span class="p">(</span><span class="n">avs_net_socket_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock_</span><span class="p">,</span>
<span class="w">                                   </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">out_buffer</span><span class="p">,</span>
<span class="w">                                   </span><span class="kt">size_t</span><span class="w"> </span><span class="n">out_buffer_size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">sock_</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">avs_net_socket_get_remote_host</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">backend_socket</span><span class="p">,</span><span class="w"> </span><span class="n">out_buffer</span><span class="p">,</span>
<span class="w">                                          </span><span class="n">out_buffer_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">avs_error_t</span><span class="w"> </span><span class="nf">tls_remote_hostname</span><span class="p">(</span><span class="n">avs_net_socket_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock_</span><span class="p">,</span>
<span class="w">                                       </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">out_buffer</span><span class="p">,</span>
<span class="w">                                       </span><span class="kt">size_t</span><span class="w"> </span><span class="n">out_buffer_size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">sock_</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">avs_net_socket_get_remote_hostname</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">backend_socket</span><span class="p">,</span><span class="w"> </span><span class="n">out_buffer</span><span class="p">,</span>
<span class="w">                                              </span><span class="n">out_buffer_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">avs_error_t</span><span class="w"> </span><span class="nf">tls_remote_port</span><span class="p">(</span><span class="n">avs_net_socket_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock_</span><span class="p">,</span>
<span class="w">                                   </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">out_buffer</span><span class="p">,</span>
<span class="w">                                   </span><span class="kt">size_t</span><span class="w"> </span><span class="n">out_buffer_size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">sock_</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">avs_net_socket_get_remote_port</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">backend_socket</span><span class="p">,</span><span class="w"> </span><span class="n">out_buffer</span><span class="p">,</span>
<span class="w">                                          </span><span class="n">out_buffer_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">avs_error_t</span><span class="w"> </span><span class="nf">tls_local_port</span><span class="p">(</span><span class="n">avs_net_socket_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock_</span><span class="p">,</span>
<span class="w">                                  </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">out_buffer</span><span class="p">,</span>
<span class="w">                                  </span><span class="kt">size_t</span><span class="w"> </span><span class="n">out_buffer_size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">sock_</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">avs_net_socket_get_local_port</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">backend_socket</span><span class="p">,</span><span class="w"> </span><span class="n">out_buffer</span><span class="p">,</span>
<span class="w">                                         </span><span class="n">out_buffer_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">avs_error_t</span><span class="w"> </span><span class="nf">tls_get_opt</span><span class="p">(</span><span class="n">avs_net_socket_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock_</span><span class="p">,</span>
<span class="w">                               </span><span class="n">avs_net_socket_opt_key_t</span><span class="w"> </span><span class="n">option_key</span><span class="p">,</span>
<span class="w">                               </span><span class="n">avs_net_socket_opt_value_t</span><span class="w"> </span><span class="o">*</span><span class="n">out_option_value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">sock_</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">avs_net_socket_get_opt</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">backend_socket</span><span class="p">,</span><span class="w"> </span><span class="n">option_key</span><span class="p">,</span>
<span class="w">                                  </span><span class="n">out_option_value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">avs_error_t</span><span class="w"> </span><span class="nf">tls_set_opt</span><span class="p">(</span><span class="n">avs_net_socket_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock_</span><span class="p">,</span>
<span class="w">                               </span><span class="n">avs_net_socket_opt_key_t</span><span class="w"> </span><span class="n">option_key</span><span class="p">,</span>
<span class="w">                               </span><span class="n">avs_net_socket_opt_value_t</span><span class="w"> </span><span class="n">option_value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">sock_</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">avs_net_socket_set_opt</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">backend_socket</span><span class="p">,</span><span class="w"> </span><span class="n">option_key</span><span class="p">,</span>
<span class="w">                                  </span><span class="n">option_value</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">tls_close</span></code> function additionally frees the <code class="docutils literal notranslate"><span class="pre">SSL</span></code> object, as OpenSSL
documentation recommends creating new one for each connection - see
<a class="reference external" href="https://www.openssl.org/docs/man1.1.1/man3/SSL_clear.html">SSL_clear</a> for
details.</p>
</section>
<section id="connect-method-stub">
<h3><a class="toc-backref" href="#id7" role="doc-backlink"><span class="section-number">8.4.1.1.5.2. </span>Connect method stub</a><a class="headerlink" href="#connect-method-stub" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">connect</span></code> method is supposed to perform the TLS handshake, but this is
beyond the scope of this boilerplate stub. However, let’s extract a separate
function that will be used for this purpose:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">avs_error_t</span><span class="w"> </span><span class="nf">perform_handshake</span><span class="p">(</span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="p">,</span>
<span class="w">                                     </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">host</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_ENOTSUP</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span><span class="w"> </span><span class="n">avs_error_t</span>
<span class="nf">tls_connect</span><span class="p">(</span><span class="n">avs_net_socket_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock_</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">host</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">port</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">sock_</span><span class="p">;</span>
<span class="w">    </span><span class="n">avs_error_t</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">avs_is_err</span><span class="p">((</span>
<span class="w">                </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">avs_net_socket_connect</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">backend_socket</span><span class="p">,</span><span class="w"> </span><span class="n">host</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="p">)))</span>
<span class="w">            </span><span class="o">||</span><span class="w"> </span><span class="n">avs_is_err</span><span class="p">((</span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">perform_handshake</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span><span class="w"> </span><span class="n">host</span><span class="p">))))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">SSL_free</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="p">);</span>
<span class="w">            </span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">avs_net_socket_close</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">backend_socket</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="send-method">
<h3><a class="toc-backref" href="#id8" role="doc-backlink"><span class="section-number">8.4.1.1.5.3. </span>Send method</a><a class="headerlink" href="#send-method" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">send</span></code> method is very similar to the one in the unencrypted socket
implementation, but using <code class="docutils literal notranslate"><span class="pre">SSL_write</span></code> instead of <code class="docutils literal notranslate"><span class="pre">send</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">avs_error_t</span>
<span class="nf">tls_send</span><span class="p">(</span><span class="n">avs_net_socket_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock_</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">buffer_length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">sock_</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SSL_write</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="n">buffer_length</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">buffer_length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_EPROTO</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">AVS_OK</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="receive-method">
<h3><a class="toc-backref" href="#id9" role="doc-backlink"><span class="section-number">8.4.1.1.5.4. </span>Receive method</a><a class="headerlink" href="#receive-method" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">receive</span></code> method is also very similar to the one in the unencrypted socket
implementation. However, as we do not have direct access to the file descriptor
and the configured receive timeout, we need to extract them from the backend
socket before actually calling <code class="docutils literal notranslate"><span class="pre">poll()</span></code>.</p>
<p>These additional operations may be unnecessary if we implemented the TLS socket
so that OpenSSL would actually call the underlying unencrypted socket. However,
in this tutorial, the default BIO implementations from OpenSSL will be used for
simplicity.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">avs_error_t</span><span class="w"> </span><span class="nf">tls_receive</span><span class="p">(</span><span class="n">avs_net_socket_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock_</span><span class="p">,</span>
<span class="w">                               </span><span class="kt">size_t</span><span class="w"> </span><span class="o">*</span><span class="n">out_bytes_received</span><span class="p">,</span>
<span class="w">                               </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
<span class="w">                               </span><span class="kt">size_t</span><span class="w"> </span><span class="n">buffer_length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">sock_</span><span class="p">;</span>
<span class="hll"><span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">fd_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">avs_net_socket_get_system</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">backend_socket</span><span class="p">);</span>
</span><span class="hll"><span class="w">    </span><span class="n">avs_net_socket_opt_value_t</span><span class="w"> </span><span class="n">timeout</span><span class="p">;</span>
</span><span class="hll"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">fd_ptr</span>
</span><span class="hll"><span class="w">            </span><span class="o">||</span><span class="w"> </span><span class="n">avs_is_err</span><span class="p">(</span><span class="n">avs_net_socket_get_opt</span><span class="p">(</span>
</span><span class="hll"><span class="w">                       </span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">backend_socket</span><span class="p">,</span><span class="w"> </span><span class="n">AVS_NET_SOCKET_OPT_RECV_TIMEOUT</span><span class="p">,</span>
</span><span class="hll"><span class="w">                       </span><span class="o">&amp;</span><span class="n">timeout</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_EBADF</span><span class="p">);</span>
</span><span class="hll"><span class="w">    </span><span class="p">}</span>
</span><span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">pollfd</span><span class="w"> </span><span class="n">pfd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="p">.</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">fd_ptr</span><span class="p">,</span>
<span class="w">        </span><span class="p">.</span><span class="n">events</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">POLLIN</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="kt">int64_t</span><span class="w"> </span><span class="n">timeout_ms</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">avs_time_duration_to_scalar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timeout_ms</span><span class="p">,</span><span class="w"> </span><span class="n">AVS_TIME_MS</span><span class="p">,</span>
<span class="w">                                    </span><span class="n">timeout</span><span class="p">.</span><span class="n">recv_timeout</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">timeout_ms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">timeout_ms</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">timeout_ms</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">poll</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pfd</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="n">timeout_ms</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_ETIMEDOUT</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">bytes_received</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SSL_read</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="p">,</span><span class="w"> </span><span class="n">buffer</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="n">buffer_length</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bytes_received</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_EPROTO</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="o">*</span><span class="n">out_bytes_received</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="w"> </span><span class="n">bytes_received</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">buffer_length</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="p">)</span><span class="w"> </span><span class="n">bytes_received</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">buffer_length</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_EMSGSIZE</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">AVS_OK</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="virtual-method-table-and-constructor-function-stubs">
<h2><a class="toc-backref" href="#id10" role="doc-backlink"><span class="section-number">8.4.1.1.6. </span>Virtual method table and constructor function stubs</a><a class="headerlink" href="#virtual-method-table-and-constructor-function-stubs" title="Link to this heading"></a></h2>
<p>With all the methods implemented or stubbed, we are ready to declare the virtual
method table. However, actual socket creation will be described in the next
tutorial:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">avs_net_socket_v_table_t</span><span class="w"> </span><span class="n">TLS_SOCKET_VTABLE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">connect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tls_connect</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">send</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tls_send</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">receive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tls_receive</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">bind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tls_bind</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">close</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tls_close</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">shutdown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tls_shutdown</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">cleanup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tls_cleanup</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">get_system_socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tls_system_socket</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">get_remote_host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tls_remote_host</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">get_remote_hostname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tls_remote_hostname</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">get_remote_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tls_remote_port</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">get_local_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tls_local_port</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">get_opt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tls_get_opt</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">set_opt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tls_set_opt</span>
<span class="p">};</span>

<span class="n">avs_error_t</span><span class="w"> </span><span class="nf">_avs_net_create_dtls_socket</span><span class="p">(</span><span class="n">avs_net_socket_t</span><span class="w"> </span><span class="o">**</span><span class="n">socket_ptr</span><span class="p">,</span>
<span class="w">                                        </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">configuration</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_ENOTSUP</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">avs_error_t</span><span class="w"> </span><span class="nf">_avs_net_create_ssl_socket</span><span class="p">(</span><span class="n">avs_net_socket_t</span><span class="w"> </span><span class="o">**</span><span class="n">socket_ptr</span><span class="p">,</span>
<span class="w">                                       </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">configuration</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_ENOTSUP</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../CustomTLS.html" class="btn btn-neutral float-left" title="8.4. Custom (D)TLS layers" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="CustomTLS-Minimal.html" class="btn btn-neutral float-right" title="8.4.1.2. Minimal DTLS implementation" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017-2024, AVSystem.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>