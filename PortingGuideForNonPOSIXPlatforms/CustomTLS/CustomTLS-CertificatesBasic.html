<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>8.4.1.5. Basic certificate support &mdash; Anjay 2.14.1 documentation</title>
      <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="8.4.1.6. Advanced certificate support" href="CustomTLS-CertificatesAdvanced.html" />
    <link rel="prev" title="8.4.1.4. Advanced configuration features" href="CustomTLS-ConfigFeatures.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #ffd500" >
            <a href="../../index.html">
            <img src="../../_static/avsystem_header.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                2.14.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../Introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LwM2M.html">2. OMA LwM2M - Brief description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Compiling_client_applications.html">3. Compiling client applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../BasicClient.html">4. Basic client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../AdvancedTopics.html">5. Advanced topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../FirmwareUpdateTutorial.html">6. Firmware Update Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tools.html">7. Tools</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../PortingGuideForNonPOSIXPlatforms.html">8. Porting guide for non-POSIX platforms</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../TimeAPI.html">8.1. Time API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ThreadingAPI.html">8.2. Threading API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../NetworkingAPI.html">8.3. Networking API</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../CustomTLS.html">8.4. Custom (D)TLS layers</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="CustomTLS-Stub.html">8.4.1.1. Introductory stub</a></li>
<li class="toctree-l3"><a class="reference internal" href="CustomTLS-Minimal.html">8.4.1.2. Minimal DTLS implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="CustomTLS-Resumption.html">8.4.1.3. Session resumption support</a></li>
<li class="toctree-l3"><a class="reference internal" href="CustomTLS-ConfigFeatures.html">8.4.1.4. Advanced configuration features</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">8.4.1.5. Basic certificate support</a></li>
<li class="toctree-l3"><a class="reference internal" href="CustomTLS-CertificatesAdvanced.html">8.4.1.6. Advanced certificate support</a></li>
<li class="toctree-l3"><a class="reference internal" href="CustomTLS-TCPSupport.html">8.4.1.7. Support for TLS over TCP</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../Migrating.html">9. Migrating from older versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Commercial_support.html">10. Commercial support</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #ffd500" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Anjay</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../PortingGuideForNonPOSIXPlatforms.html"><span class="section-number">8. </span>Porting guide for non-POSIX platforms</a> &raquo;</li>
          <li><a href="../CustomTLS.html"><span class="section-number">8.4. </span>Custom (D)TLS layers</a> &raquo;</li>
      <li><span class="section-number">8.4.1.5. </span>Basic certificate support</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <div class="section" id="basic-certificate-support">
<h1><span class="section-number">8.4.1.5. </span>Basic certificate support<a class="headerlink" href="#basic-certificate-support" title="Permalink to this headline">¶</a></h1>
<div class="contents local topic" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#introduction" id="id1">Introduction</a></p></li>
<li><p><a class="reference internal" href="#adding-support-for-the-certificate-mode" id="id2">Adding support for the certificate mode</a></p></li>
<li><p><a class="reference internal" href="#the-avs-crypto-security-info-union-t-type" id="id3">The <code class="docutils literal notranslate"><span class="pre">avs_crypto_security_info_union_t</span></code> type</a></p></li>
<li><p><a class="reference internal" href="#loading-security-credentials" id="id4">Loading security credentials</a></p>
<ul>
<li><p><a class="reference internal" href="#loading-client-certificates" id="id5">Loading client certificates</a></p></li>
<li><p><a class="reference internal" href="#loading-client-private-keys" id="id6">Loading client private keys</a></p></li>
<li><p><a class="reference internal" href="#loading-trusted-certificates" id="id7">Loading trusted certificates</a></p></li>
<li><p><a class="reference internal" href="#loading-certificate-revocation-lists" id="id8">Loading certificate revocation lists</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#enabling-hostname-verification" id="id9">Enabling hostname verification</a></p></li>
<li><p><a class="reference internal" href="#limitations" id="id10">Limitations</a></p></li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Code related to this tutorial can be found under
<a class="reference external" href="https://github.com/AVSystem/Anjay/tree/master/examples/custom-tls/certificates-basic">examples/custom-tls/certificates-basic</a>
in the Anjay source directory.</p>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id1"><span class="section-number">8.4.1.5.1. </span>Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>This tutorials builds up on <a class="reference internal" href="CustomTLS-ConfigFeatures.html"><span class="doc">the previous one</span></a>
and adds basic support for the security mode based on certificates and public
key infrastructure.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In this tutorial, the <code class="docutils literal notranslate"><span class="pre">main.c</span></code> file has been replaced with a slightly
modified version of the one from the
<a class="reference internal" href="../../AdvancedTopics/AT-Certificates.html"><span class="doc">DTLS connection using certificates</span></a> tutorial.</p>
<p>This also means that for simplicity, the tutorial project now depends on
the <code class="docutils literal notranslate"><span class="pre">WITH_EVENT_LOOP</span></code> CMake option enabled in Anjay, and the
<a class="reference internal" href="../NetworkingAPI/NetworkingAPI-EventLoopSupport.html"><span class="doc">Event loop support</span></a> in the networking
layer.</p>
<p>Compared to the <code class="docutils literal notranslate"><span class="pre">main.c</span></code> file from the
<a class="reference internal" href="../../AdvancedTopics/AT-Certificates.html"><span class="doc">DTLS connection using certificates</span></a> tutorial, logic related to
loading the server certificate has been removed. This means that the
security information is now configured as follows:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">load_buffer_from_file</span><span class="p">(</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="n">security_instance</span><span class="p">.</span><span class="n">public_cert_or_psk_identity</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">security_instance</span><span class="p">.</span><span class="n">public_cert_or_psk_identity_size</span><span class="p">,</span><span class="w"></span>
<span class="w">            </span><span class="s">&quot;client_cert.der&quot;</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="o">||</span><span class="w"> </span><span class="n">load_buffer_from_file</span><span class="p">(</span><span class="w"></span>
<span class="w">                   </span><span class="p">(</span><span class="kt">uint8_t</span><span class="w"> </span><span class="o">**</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;</span><span class="n">security_instance</span><span class="p">.</span><span class="n">private_cert_or_psk_key</span><span class="p">,</span><span class="w"></span>
<span class="w">                   </span><span class="o">&amp;</span><span class="n">security_instance</span><span class="p">.</span><span class="n">private_cert_or_psk_key_size</span><span class="p">,</span><span class="w"></span>
<span class="w">                   </span><span class="s">&quot;client_key.der&quot;</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">goto</span><span class="w"> </span><span class="n">cleanup</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Verifying the server certificate, as specified in LwM2M, does not work with
the set of features implemented in this article. See the
<a class="reference internal" href="#custom-tls-api-certificates-basic-limitations"><span class="std std-ref">Limitations</span></a> section and the next
article for details.</p>
</div>
</div>
<div class="section" id="adding-support-for-the-certificate-mode">
<h2><a class="toc-backref" href="#id2"><span class="section-number">8.4.1.5.2. </span>Adding support for the certificate mode</a><a class="headerlink" href="#adding-support-for-the-certificate-mode" title="Permalink to this headline">¶</a></h2>
<p>In <code class="docutils literal notranslate"><span class="pre">avs_net</span></code>, the security mode of the socket - either PSK or certificates -
is configured by the <code class="docutils literal notranslate"><span class="pre">mode</span></code> field in the <code class="docutils literal notranslate"><span class="pre">avs_net_security_mode_t</span></code> structure
(which is a tagged union, with the <code class="docutils literal notranslate"><span class="pre">mode</span></code> field acting as the tag), which
itself is contained in the <code class="docutils literal notranslate"><span class="pre">security</span></code> field of
<code class="docutils literal notranslate"><span class="pre">avs_net_ssl_configuration_t</span></code>.</p>
<p><a class="reference internal" href="CustomTLS-Minimal.html#custom-tls-api-create"><span class="std std-ref">In the minimal implementation tutorial</span></a>, we have
written a <code class="docutils literal notranslate"><span class="pre">switch</span></code> over that field in <code class="docutils literal notranslate"><span class="pre">_avs_net_create_dtls_socket()</span></code>, even
though only the PSK mode was supported there. It is now time to add the second
case for the certificate mode:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">avs_error_t</span><span class="w"> </span><span class="nf">_avs_net_create_dtls_socket</span><span class="p">(</span><span class="n">avs_net_socket_t</span><span class="w"> </span><span class="o">**</span><span class="n">socket_ptr</span><span class="p">,</span><span class="w"></span>
<span class="w">                                        </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">configuration_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">socket_ptr</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="o">!*</span><span class="n">socket_ptr</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">assert</span><span class="p">(</span><span class="n">configuration_</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="n">avs_net_ssl_configuration_t</span><span class="w"> </span><span class="o">*</span><span class="n">configuration</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">avs_net_ssl_configuration_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">configuration_</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="n">socket</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">            </span><span class="p">(</span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">avs_calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">tls_socket_impl_t</span><span class="p">));</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">socket</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_ENOMEM</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="o">*</span><span class="n">socket_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">avs_net_socket_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">socket</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">operations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">TLS_SOCKET_VTABLE</span><span class="p">;</span><span class="w"></span>

<span class="w">    </span><span class="n">avs_error_t</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AVS_OK</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">avs_is_ok</span><span class="p">((</span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">avs_net_udp_socket_create</span><span class="p">(</span><span class="w"></span>
<span class="w">                           </span><span class="o">&amp;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">backend_socket</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="o">&amp;</span><span class="n">configuration</span><span class="o">-&gt;</span><span class="n">backend_configuration</span><span class="p">)))</span><span class="w"></span>
<span class="w">            </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="p">(</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SSL_CTX_new</span><span class="p">(</span><span class="n">DTLS_method</span><span class="p">())))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_ENOMEM</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">avs_is_ok</span><span class="p">(</span><span class="n">err</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configure_dtls_version</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="n">configuration</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">avs_is_ok</span><span class="p">(</span><span class="n">err</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">configuration</span><span class="o">-&gt;</span><span class="n">security</span><span class="p">.</span><span class="n">mode</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nl">AVS_NET_SECURITY_PSK</span><span class="p">:</span><span class="w"></span>
<span class="w">            </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configure_psk</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">configuration</span><span class="o">-&gt;</span><span class="n">security</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">psk</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="hll"><span class="w">        </span><span class="k">case</span><span class="w"> </span><span class="nl">AVS_NET_SECURITY_CERTIFICATE</span><span class="p">:</span><span class="w"></span>
</span><span class="hll"><span class="w">            </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configure_certs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">configuration</span><span class="o">-&gt;</span><span class="n">security</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">cert</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="w">            </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
</span><span class="w">        </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">            </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_ENOTSUP</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">avs_is_err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"></span>
<span class="w">            </span><span class="o">||</span><span class="w"> </span><span class="n">avs_is_err</span><span class="p">((</span><span class="w"></span>
<span class="w">                       </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configure_dtls_handshake_timeouts</span><span class="p">(</span><span class="w"></span>
<span class="w">                               </span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="n">configuration</span><span class="o">-&gt;</span><span class="n">dtls_handshake_timeouts</span><span class="p">)))</span><span class="w"></span>
<span class="w">            </span><span class="o">||</span><span class="w"> </span><span class="n">avs_is_err</span><span class="p">((</span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configure_ciphersuites</span><span class="p">(</span><span class="w"></span>
<span class="w">                                   </span><span class="n">socket</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">configuration</span><span class="o">-&gt;</span><span class="n">ciphersuites</span><span class="p">)))</span><span class="w"></span>
<span class="w">            </span><span class="o">||</span><span class="w"> </span><span class="n">avs_is_err</span><span class="p">((</span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configure_sni</span><span class="p">(</span><span class="w"></span>
<span class="w">                                   </span><span class="n">socket</span><span class="p">,</span><span class="w"></span>
<span class="w">                                   </span><span class="n">configuration</span><span class="o">-&gt;</span><span class="n">server_name_indication</span><span class="p">))))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">avs_net_socket_cleanup</span><span class="p">(</span><span class="n">socket_ptr</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">SSL_CTX_set_mode</span><span class="p">(</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">SSL_MODE_AUTO_RETRY</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">configuration</span><span class="o">-&gt;</span><span class="n">session_resumption_buffer_size</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">configuration</span><span class="o">-&gt;</span><span class="n">session_resumption_buffer</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">session_resumption_buffer</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">configuration</span><span class="o">-&gt;</span><span class="n">session_resumption_buffer</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">session_resumption_buffer_size</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">configuration</span><span class="o">-&gt;</span><span class="n">session_resumption_buffer_size</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">SSL_CTX_set_session_cache_mode</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="n">SSL_SESS_CACHE_CLIENT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">SSL_SESS_CACHE_NO_INTERNAL_STORE</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">SSL_CTX_sess_set_new_cb</span><span class="p">(</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">new_session_cb</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">AVS_OK</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">configure_certs()</span></code> function mentioned in the snippet above is an analog
of <code class="docutils literal notranslate"><span class="pre">configure_psk()</span></code>, that loads and configures all the necessary security
credentials:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">avs_error_t</span><span class="w"> </span><span class="nf">configure_certs</span><span class="p">(</span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="p">,</span><span class="w"></span>
<span class="w">                                   </span><span class="k">const</span><span class="w"> </span><span class="n">avs_net_certificate_info_t</span><span class="w"> </span><span class="o">*</span><span class="n">certs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">certs</span><span class="o">-&gt;</span><span class="n">server_cert_validation</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">certs</span><span class="o">-&gt;</span><span class="n">ignore_system_trust_store</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">SSL_CTX_set_default_verify_paths</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">X509_STORE</span><span class="w"> </span><span class="o">*</span><span class="n">store</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SSL_CTX_get_cert_store</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">avs_error_t</span><span class="w"> </span><span class="n">err</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">avs_is_err</span><span class="p">((</span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configure_trusted_certs</span><span class="p">(</span><span class="w"></span>
<span class="w">                                </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">certs</span><span class="o">-&gt;</span><span class="n">trusted_certs</span><span class="p">.</span><span class="n">desc</span><span class="p">)))</span><span class="w"></span>
<span class="w">                </span><span class="o">||</span><span class="w"> </span><span class="n">avs_is_err</span><span class="p">((</span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configure_cert_revocation_lists</span><span class="p">(</span><span class="w"></span>
<span class="w">                                       </span><span class="n">store</span><span class="p">,</span><span class="w"></span>
<span class="w">                                       </span><span class="o">&amp;</span><span class="n">certs</span><span class="o">-&gt;</span><span class="n">cert_revocation_lists</span><span class="p">.</span><span class="n">desc</span><span class="p">))))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="n">SSL_CTX_set_verify</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">SSL_VERIFY_PEER</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">SSL_CTX_set_verify</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">SSL_VERIFY_NONE</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">certs</span><span class="o">-&gt;</span><span class="n">client_cert</span><span class="p">.</span><span class="n">desc</span><span class="p">.</span><span class="n">source</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">AVS_CRYPTO_DATA_SOURCE_EMPTY</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">avs_error_t</span><span class="w"> </span><span class="n">err</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">avs_is_err</span><span class="p">((</span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configure_client_cert</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                    </span><span class="o">&amp;</span><span class="n">certs</span><span class="o">-&gt;</span><span class="n">client_cert</span><span class="p">)))</span><span class="w"></span>
<span class="w">                </span><span class="o">||</span><span class="w"> </span><span class="n">avs_is_err</span><span class="p">(</span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configure_client_key</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">,</span><span class="w"></span>
<span class="w">                                                         </span><span class="o">&amp;</span><span class="n">certs</span><span class="o">-&gt;</span><span class="n">client_key</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">AVS_OK</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">server_cert_validation</span></code> field acts as a master switch that controls
whether the peer certificate shall be verified at all. This controls the
verification mode set using <code class="docutils literal notranslate"><span class="pre">SSL_CTX_set_verify()</span></code>, but also all logic related
to loading the trust store is disabled if it is set to <code class="docutils literal notranslate"><span class="pre">false</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">ignore_system_trust_store</span></code> flag controls whether the default system trust
store shall be loaded for this socket. In Anjay, it is usually set to <code class="docutils literal notranslate"><span class="pre">true</span></code>.
It may only be <code class="docutils literal notranslate"><span class="pre">false</span></code> in the commercial version, if the
<code class="docutils literal notranslate"><span class="pre">use_system_trust_store</span></code> is enabled in <code class="docutils literal notranslate"><span class="pre">anjay_configuration_t</span></code>. If your
platform does not have a concept of a system trust store, it is safe to ignore
this setting altogether.</p>
<p>The rest of the code in this function calls auxiliary functions that load all
the security credential types: trusted certificates, certificate revocation
lists, the client certificate and the client private key.</p>
</div>
<div class="section" id="the-avs-crypto-security-info-union-t-type">
<h2><a class="toc-backref" href="#id3"><span class="section-number">8.4.1.5.3. </span>The <code class="docutils literal notranslate"><span class="pre">avs_crypto_security_info_union_t</span></code> type</a><a class="headerlink" href="#the-avs-crypto-security-info-union-t-type" title="Permalink to this headline">¶</a></h2>
<p>Loading of security credentials related to the public key infrastructure in
<code class="docutils literal notranslate"><span class="pre">avs_net</span></code> and <code class="docutils literal notranslate"><span class="pre">avs_crypto</span></code> is centered around the
<code class="docutils literal notranslate"><span class="pre">avs_crypto_security_info_union_t</span></code> type, declared as follows:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">AVS_CRYPTO_SECURITY_INFO_CERTIFICATE_CHAIN</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">AVS_CRYPTO_SECURITY_INFO_PRIVATE_KEY</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">AVS_CRYPTO_SECURITY_INFO_CERT_REVOCATION_LIST</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">avs_crypto_security_info_tag_t</span><span class="p">;</span><span class="w"></span>

<span class="k">typedef</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">AVS_CRYPTO_DATA_SOURCE_EMPTY</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">AVS_CRYPTO_DATA_SOURCE_FILE</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">AVS_CRYPTO_DATA_SOURCE_PATH</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">AVS_CRYPTO_DATA_SOURCE_BUFFER</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">AVS_CRYPTO_DATA_SOURCE_ARRAY</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="n">AVS_CRYPTO_DATA_SOURCE_LIST</span><span class="p">,</span><span class="w"></span>
<span class="cp">#ifdef AVS_COMMONS_WITH_AVS_CRYPTO_ENGINE</span>
<span class="w">    </span><span class="n">AVS_CRYPTO_DATA_SOURCE_ENGINE</span><span class="w"></span>
<span class="cp">#endif </span><span class="c1">// AVS_COMMONS_WITH_AVS_CRYPTO_ENGINE</span>
<span class="p">}</span><span class="w"> </span><span class="n">avs_crypto_data_source_t</span><span class="p">;</span><span class="w"></span>

<span class="cm">/**</span>
<span class="cm"> * This struct is for internal use only and should not be filled manually. One</span>
<span class="cm"> * should construct appropriate instances of:</span>
<span class="cm"> * - @ref avs_crypto_certificate_chain_info_t,</span>
<span class="cm"> * - @ref avs_crypto_private_key_info_t</span>
<span class="cm"> * - @ref avs_crypto_cert_revocation_list_info_t</span>
<span class="cm"> * using methods declared below.</span>
<span class="cm"> */</span><span class="w"></span>
<span class="k">struct</span> <span class="nc">avs_crypto_security_info_union_struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">avs_crypto_security_info_tag_t</span><span class="w"> </span><span class="n">type</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="n">avs_crypto_data_source_t</span><span class="w"> </span><span class="n">source</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">union</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">avs_crypto_security_info_union_internal_file_t</span><span class="w"> </span><span class="n">file</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">avs_crypto_security_info_union_internal_path_t</span><span class="w"> </span><span class="n">path</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">avs_crypto_security_info_union_internal_buffer_t</span><span class="w"> </span><span class="n">buffer</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">avs_crypto_security_info_union_internal_array_t</span><span class="w"> </span><span class="n">array</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">avs_crypto_security_info_union_internal_list_t</span><span class="w"> </span><span class="n">list</span><span class="p">;</span><span class="w"></span>
<span class="cp">#ifdef AVS_COMMONS_WITH_AVS_CRYPTO_ENGINE</span>
<span class="w">        </span><span class="n">avs_crypto_security_info_union_internal_engine_t</span><span class="w"> </span><span class="n">engine</span><span class="p">;</span><span class="w"></span>
<span class="cp">#endif </span><span class="c1">// AVS_COMMONS_WITH_AVS_CRYPTO_ENGINE</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">info</span><span class="p">;</span><span class="w"></span>
<span class="p">};</span><span class="w"></span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">source</span></code> fields acts as a tag to the <code class="docutils literal notranslate"><span class="pre">info</span></code> union, deciding from which
source the credential shall be loaded. There are a number of “simple” sources
supported:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">AVS_CRYPTO_DATA_SOURCE_EMPTY</span></code> - signifies that the object does not
represent any valid credential information</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AVS_CRYPTO_DATA_SOURCE_FILE</span></code> - the credential shall be loaded from a file,
specified as a file path (<code class="docutils literal notranslate"><span class="pre">info.file.filename</span></code>); in case of private keys,
an optional password for encrypted PEM keys can be specified
(<code class="docutils literal notranslate"><span class="pre">info.file.password</span></code>)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AVS_CRYPTO_DATA_SOURCE_PATH</span></code> - the credentials shall be loaded from a
directory, specified as a file system path (<code class="docutils literal notranslate"><span class="pre">info.path.path</span></code>); this
generally only makes sense for certificate chains</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AVS_CRYPTO_DATA_SOURCE_BUFFER</span></code> - the credentials shall be loaded from a
memory buffer (<code class="docutils literal notranslate"><span class="pre">info.buffer.buffer</span></code> of the size
<code class="docutils literal notranslate"><span class="pre">info.buffer.buffer_size</span></code>); in case of private keys, an optional password
for encrypted PEM keys can be specified (<code class="docutils literal notranslate"><span class="pre">info.buffer.password</span></code>); <strong>this is
the case that is almost exclusively used in Anjay</strong></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AVS_CRYPTO_DATA_SOURCE_ENGINE</span></code> - the object refers to a credential stored
in a hardware cryptography source, such as a secure element; information on
the credential is stored as a “query string” at <code class="docutils literal notranslate"><span class="pre">info.engine.query</span></code>; the
format of the query string is platform-specific and may be arbitrary; <strong>this
case is only supported in the commercial version of Anjay</strong></p></li>
</ul>
<p>In addition to the “simple” sources listed above, two additional “compound”
sources are supported:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">AVS_CRYPTO_DATA_SOURCE_ARRAY</span></code> - the object specifies multiple credentials,
stored as an array of other <code class="docutils literal notranslate"><span class="pre">avs_crypto_security_info_union_t</span></code> objects -
<code class="docutils literal notranslate"><span class="pre">info.array.element_count</span></code> structures stored at <code class="docutils literal notranslate"><span class="pre">info.array.array_ptr</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AVS_CRYPTO_DATA_SOURCE_LIST</span></code> - the object specifies multiple credentials,
stored as an <code class="docutils literal notranslate"><span class="pre">AVS_LIST</span></code> whose first element is <code class="docutils literal notranslate"><span class="pre">info.list.list_head</span></code>; the
<code class="docutils literal notranslate"><span class="pre">AVS_LIST</span></code> macro is not explicitly used in the declaration of the
<code class="docutils literal notranslate"><span class="pre">list_head</span></code> field for dependency management reasons, but that field shall
still be treated as such</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>“Compound” credential sources are most commonly used for trust store
information, i.e. trusted certificates and certificate revocation lists.</p>
<p>“Compound” credential sources are not used for private keys.</p>
<p>“Compound” credential sources MAY be used for client certificates, to
signify additional CA certificates that shall be sent to the server during
handshake. This is, however, only possible in the commercial version of
Anjay.</p>
<p>“Compound” credential sources, in general, MAY contain other “compound”
credential sources, forming a tree-like structure. Those SHOULD be loaded
recursively. However, the credentials provided by Anjay are expected to not
be formed in this way.</p>
</div>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>Anjay uses both <code class="docutils literal notranslate"><span class="pre">AVS_CRYPTO_DATA_SOURCE_ARRAY</span></code> and
<code class="docutils literal notranslate"><span class="pre">AVS_CRYPTO_DATA_SOURCE_LIST</span></code> for different purposes, so support for both
needs to be implemented.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">avs_crypto_security_info_union_t</span></code> structure additionally contains the
<code class="docutils literal notranslate"><span class="pre">type</span></code> field, which may be used for validating the credential type (i.e.,
whether the object represents a certificate chain, certificate revocation lists,
or a private key.</p>
<p>In typical usage, the type is conveyed by composing the
<code class="docutils literal notranslate"><span class="pre">avs_crypto_security_info_union_t</span></code> object into one of the wrapper objects:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span> <span class="nc">avs_crypto_certificate_chain_info_struct</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">avs_crypto_security_info_union_t</span><span class="w"> </span><span class="n">desc</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">avs_crypto_certificate_chain_info_t</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">avs_crypto_security_info_union_t</span><span class="w"> </span><span class="n">desc</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">avs_crypto_cert_revocation_list_info_t</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">typedef</span><span class="w"> </span><span class="k">struct</span> <span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="n">avs_crypto_security_info_union_t</span><span class="w"> </span><span class="n">desc</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"> </span><span class="n">avs_crypto_private_key_info_t</span><span class="p">;</span><span class="w"></span>
</pre></div>
</div>
<p>We will only implement support for the <code class="docutils literal notranslate"><span class="pre">AVS_CRYPTO_DATA_SOURCE_BUFFER</span></code> mode
for loading client certificates and private keys; for loading trusted
certificates and certificate revocation lists, we also need to handle the
<code class="docutils literal notranslate"><span class="pre">AVS_CRYPTO_DATA_SOURCE_ARRAY</span></code> and <code class="docutils literal notranslate"><span class="pre">AVS_CRYPTO_DATA_SOURCE_LIST</span></code> cases.</p>
</div>
<div class="section" id="loading-security-credentials">
<h2><a class="toc-backref" href="#id4"><span class="section-number">8.4.1.5.4. </span>Loading security credentials</a><a class="headerlink" href="#loading-security-credentials" title="Permalink to this headline">¶</a></h2>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>The security credential objects passed to the
<code class="docutils literal notranslate"><span class="pre">_avs_net_create_dtls_socket()</span></code> may be deleted after that call completes.
For this reason, the credential data needs to be actually copied.</p>
<p>Please carefully check whether credentials are passed by value or by
reference in the TLS backend you are integrating with.</p>
</div>
<div class="section" id="loading-client-certificates">
<h3><a class="toc-backref" href="#id5"><span class="section-number">8.4.1.5.4.1. </span>Loading client certificates</a><a class="headerlink" href="#loading-client-certificates" title="Permalink to this headline">¶</a></h3>
<p>Client certificates is the simplest case, as we only need to load a single
certificate, handling the <code class="docutils literal notranslate"><span class="pre">AVS_CRYPTO_DATA_SOURCE_BUFFER</span></code> case:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">avs_error_t</span><span class="w"></span>
<span class="nf">configure_client_cert</span><span class="p">(</span><span class="n">SSL_CTX</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">,</span><span class="w"></span>
<span class="w">                      </span><span class="k">const</span><span class="w"> </span><span class="n">avs_crypto_certificate_chain_info_t</span><span class="w"> </span><span class="o">*</span><span class="n">client_cert</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">client_cert</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">source</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nl">AVS_CRYPTO_DATA_SOURCE_BUFFER</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">client_cert</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">buffer</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">X509</span><span class="w"> </span><span class="o">*</span><span class="n">cert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d2i_X509</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="n">client_cert</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cert</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_EPROTO</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SSL_CTX_use_certificate</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">cert</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">X509_free</span><span class="p">(</span><span class="n">cert</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_EPROTO</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">AVS_OK</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_ENOTSUP</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In this tutorial, only DER-encoded credentials are supported. This is most
important and enough for compatibility with LwM2M. However, you may want to
also support the PEM format. If both formats are supported, they shall be
autodetected based on the contents of the file or buffer.</p>
</div>
</div>
<div class="section" id="loading-client-private-keys">
<h3><a class="toc-backref" href="#id6"><span class="section-number">8.4.1.5.4.2. </span>Loading client private keys</a><a class="headerlink" href="#loading-client-private-keys" title="Permalink to this headline">¶</a></h3>
<p>The code for loading client private keys is very similar, although we want to
make sure that the <code class="docutils literal notranslate"><span class="pre">password</span></code> field is not used.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">avs_error_t</span><span class="w"></span>
<span class="nf">configure_client_key</span><span class="p">(</span><span class="n">SSL_CTX</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">,</span><span class="w"></span>
<span class="w">                     </span><span class="k">const</span><span class="w"> </span><span class="n">avs_crypto_private_key_info_t</span><span class="w"> </span><span class="o">*</span><span class="n">client_key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">client_key</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">source</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nl">AVS_CRYPTO_DATA_SOURCE_BUFFER</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">client_key</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">password</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_ENOTSUP</span><span class="p">);</span><span class="w"></span>
</span><span class="hll"><span class="w">        </span><span class="p">}</span><span class="w"></span>
</span><span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">client_key</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">buffer</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">EVP_PKEY</span><span class="w"> </span><span class="o">*</span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d2i_AutoPrivateKey</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="n">client_key</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">info</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_EPROTO</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SSL_CTX_use_PrivateKey</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">EVP_PKEY_free</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_EPROTO</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">AVS_OK</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_ENOTSUP</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="loading-trusted-certificates">
<h3><a class="toc-backref" href="#id7"><span class="section-number">8.4.1.5.4.3. </span>Loading trusted certificates</a><a class="headerlink" href="#loading-trusted-certificates" title="Permalink to this headline">¶</a></h3>
<p>For the trusted certificates, we need to support the empty and compound sources
in addition to loading a simple single buffer:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;openssl/err.h&gt;</span><span class="cp"></span>

<span class="c1">// ...</span>

<span class="k">static</span><span class="w"> </span><span class="n">avs_error_t</span><span class="w"></span>
<span class="nf">configure_trusted_certs</span><span class="p">(</span><span class="n">X509_STORE</span><span class="w"> </span><span class="o">*</span><span class="n">store</span><span class="p">,</span><span class="w"></span>
<span class="hll"><span class="w">                        </span><span class="k">const</span><span class="w"> </span><span class="n">avs_crypto_security_info_union_t</span><span class="w"> </span><span class="o">*</span><span class="n">trusted_certs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">trusted_certs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_EINVAL</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">trusted_certs</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="hll"><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nl">AVS_CRYPTO_DATA_SOURCE_EMPTY</span><span class="p">:</span><span class="w"></span>
</span><span class="hll"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">AVS_OK</span><span class="p">;</span><span class="w"></span>
</span><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nl">AVS_CRYPTO_DATA_SOURCE_BUFFER</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">trusted_certs</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">buffer</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">X509</span><span class="w"> </span><span class="o">*</span><span class="n">cert</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d2i_X509</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span><span class="w"></span>
<span class="w">                              </span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="n">trusted_certs</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cert</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_EPROTO</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">ERR_clear_error</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">X509_STORE_add_cert</span><span class="p">(</span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">cert</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">X509_free</span><span class="p">(</span><span class="n">cert</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">result</span><span class="w"></span>
<span class="hll"><span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">ERR_GET_REASON</span><span class="p">(</span><span class="n">ERR_get_error</span><span class="p">())</span><span class="w"></span>
</span><span class="hll"><span class="w">                               </span><span class="o">!=</span><span class="w"> </span><span class="n">X509_R_CERT_ALREADY_IN_HASH_TABLE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_EPROTO</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">AVS_OK</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="hll"><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nl">AVS_CRYPTO_DATA_SOURCE_ARRAY</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="w">        </span><span class="n">avs_error_t</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AVS_OK</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="w">             </span><span class="n">avs_is_ok</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">trusted_certs</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">array</span><span class="p">.</span><span class="n">element_count</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="w">             </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="w">            </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configure_trusted_certs</span><span class="p">(</span><span class="w"></span>
</span><span class="hll"><span class="w">                    </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">trusted_certs</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">array</span><span class="p">.</span><span class="n">array_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
</span><span class="hll"><span class="w">        </span><span class="p">}</span><span class="w"></span>
</span><span class="hll"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span class="hll"><span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nl">AVS_CRYPTO_DATA_SOURCE_LIST</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="w">        </span><span class="n">avs_error_t</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AVS_OK</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="w">        </span><span class="n">AVS_LIST</span><span class="p">(</span><span class="n">avs_crypto_security_info_union_t</span><span class="p">)</span><span class="w"> </span><span class="n">entry</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="w">        </span><span class="n">AVS_LIST_FOREACH</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span><span class="w"> </span><span class="n">trusted_certs</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">list</span><span class="p">.</span><span class="n">list_head</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">avs_is_err</span><span class="p">((</span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configure_trusted_certs</span><span class="p">(</span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">))))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
</span><span class="hll"><span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="w">            </span><span class="p">}</span><span class="w"></span>
</span><span class="hll"><span class="w">        </span><span class="p">}</span><span class="w"></span>
</span><span class="hll"><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">AVS_OK</span><span class="p">;</span><span class="w"></span>
</span><span class="hll"><span class="w">    </span><span class="p">}</span><span class="w"></span>
</span><span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_ENOTSUP</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
<p>Please note the following additional alterations:</p>
<ul class="simple">
<li><p>This function takes an argument of type <code class="docutils literal notranslate"><span class="pre">avs_crypto_security_info_union_t</span></code>
instead of the <code class="docutils literal notranslate"><span class="pre">avs_crypto_certificate_chain_info_t</span></code> wrapper. This has been
done so that it can be more easily called recursively.</p></li>
<li><p>There is a special case for the <code class="docutils literal notranslate"><span class="pre">X509_R_CERT_ALREADY_IN_HASH_TABLE</span></code> error.
Loading the same certificate multiple times shall be permitted, in case e.g.
an explicitly specified certificate is already present in the system trust
store.</p></li>
</ul>
</div>
<div class="section" id="loading-certificate-revocation-lists">
<h3><a class="toc-backref" href="#id8"><span class="section-number">8.4.1.5.4.4. </span>Loading certificate revocation lists</a><a class="headerlink" href="#loading-certificate-revocation-lists" title="Permalink to this headline">¶</a></h3>
<p>The CRL loading function is actually almost identical to the certificate chain
loading one:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">avs_error_t</span><span class="w"> </span><span class="nf">configure_cert_revocation_lists</span><span class="p">(</span><span class="w"></span>
<span class="w">        </span><span class="n">X509_STORE</span><span class="w"> </span><span class="o">*</span><span class="n">store</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="n">avs_crypto_security_info_union_t</span><span class="w"> </span><span class="o">*</span><span class="n">cert_revocation_lists</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">cert_revocation_lists</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_EINVAL</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">cert_revocation_lists</span><span class="o">-&gt;</span><span class="n">source</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nl">AVS_CRYPTO_DATA_SOURCE_EMPTY</span><span class="p">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">AVS_OK</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nl">AVS_CRYPTO_DATA_SOURCE_BUFFER</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"></span>
<span class="w">                        </span><span class="n">cert_revocation_lists</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">buffer</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">X509_CRL</span><span class="w"> </span><span class="o">*</span><span class="n">crl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d2i_X509_CRL</span><span class="p">(</span><span class="w"></span>
<span class="w">                </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="w"> </span><span class="n">cert_revocation_lists</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">buffer</span><span class="p">.</span><span class="n">buffer_size</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">crl</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_EPROTO</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>

<span class="w">        </span><span class="n">ERR_clear_error</span><span class="p">();</span><span class="w"></span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">X509_STORE_add_crl</span><span class="p">(</span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">crl</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="n">X509_CRL_free</span><span class="p">(</span><span class="n">crl</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_EPROTO</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">AVS_OK</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nl">AVS_CRYPTO_DATA_SOURCE_ARRAY</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">avs_error_t</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AVS_OK</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"></span>
<span class="w">             </span><span class="n">avs_is_ok</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"></span>
<span class="w">             </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">cert_revocation_lists</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">array</span><span class="p">.</span><span class="n">element_count</span><span class="p">;</span><span class="w"></span>
<span class="w">             </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configure_cert_revocation_lists</span><span class="p">(</span><span class="w"></span>
<span class="w">                    </span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cert_revocation_lists</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">array</span><span class="p">.</span><span class="n">array_ptr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="nl">AVS_CRYPTO_DATA_SOURCE_LIST</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="n">avs_error_t</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AVS_OK</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">AVS_LIST</span><span class="p">(</span><span class="n">avs_crypto_security_info_union_t</span><span class="p">)</span><span class="w"> </span><span class="n">entry</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">AVS_LIST_FOREACH</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span><span class="w"> </span><span class="n">cert_revocation_lists</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">list</span><span class="p">.</span><span class="n">list_head</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">avs_is_err</span><span class="p">((</span><span class="w"></span>
<span class="w">                        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">configure_cert_revocation_lists</span><span class="p">(</span><span class="n">store</span><span class="p">,</span><span class="w"> </span><span class="n">entry</span><span class="p">))))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span><span class="w"></span>
<span class="w">            </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">AVS_OK</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_ENOTSUP</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="enabling-hostname-verification">
<h2><a class="toc-backref" href="#id9"><span class="section-number">8.4.1.5.5. </span>Enabling hostname verification</a><a class="headerlink" href="#enabling-hostname-verification" title="Permalink to this headline">¶</a></h2>
<p>Now that all the credentials are properly loaded, the only thing left is to
inform the TLS library of the hostname, so that the CN or SAN fields of the
server certificate can be properly verified. This can be done by calling
<code class="docutils literal notranslate"><span class="pre">SSL_set1_host()</span></code> just before the handshake:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">avs_error_t</span><span class="w"> </span><span class="nf">perform_handshake</span><span class="p">(</span><span class="n">tls_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="p">,</span><span class="w"></span>
<span class="w">                                     </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">host</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">    </span><span class="k">union</span> <span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">struct</span> <span class="nc">sockaddr</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="k">struct</span> <span class="nc">sockaddr_storage</span><span class="w"> </span><span class="n">storage</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">peername</span><span class="p">;</span><span class="w"></span>
<span class="w">    </span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">fd_ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">avs_net_socket_get_system</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">backend_socket</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">fd_ptr</span><span class="w"></span>
<span class="w">            </span><span class="o">||</span><span class="w"> </span><span class="n">getpeername</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">fd_ptr</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">peername</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span><span class="w"></span>
<span class="w">                           </span><span class="o">&amp;</span><span class="p">(</span><span class="kt">socklen_t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">peername</span><span class="p">)</span><span class="w"> </span><span class="p">}))</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_EBADF</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SSL_new</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ctx</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_ENOMEM</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="n">SSL_set_app_data</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="p">,</span><span class="w"> </span><span class="n">sock</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">SSL_set_tlsext_host_name</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="p">,</span><span class="w"> </span><span class="n">host</span><span class="p">);</span><span class="w"></span>
<span class="hll"><span class="w">    </span><span class="n">SSL_set1_host</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="p">,</span><span class="w"> </span><span class="n">host</span><span class="p">);</span><span class="w"></span>
</span>
<span class="w">    </span><span class="n">BIO</span><span class="w"> </span><span class="o">*</span><span class="n">bio</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BIO_new_dgram</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">fd_ptr</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">bio</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_ENOMEM</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="n">BIO_ctrl</span><span class="p">(</span><span class="n">bio</span><span class="p">,</span><span class="w"> </span><span class="n">BIO_CTRL_DGRAM_SET_CONNECTED</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">peername</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">SSL_set_bio</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="p">,</span><span class="w"> </span><span class="n">bio</span><span class="p">,</span><span class="w"> </span><span class="n">bio</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="n">DTLS_set_timer_cb</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="p">,</span><span class="w"> </span><span class="n">dtls_timer_cb</span><span class="p">);</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">session_resumption_buffer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">session_resumption_buffer</span><span class="p">;</span><span class="w"></span>
<span class="w">        </span><span class="n">SSL_SESSION</span><span class="w"> </span><span class="o">*</span><span class="n">session</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<span class="w">                </span><span class="n">d2i_SSL_SESSION</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span><span class="w"></span>
<span class="w">                                </span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">session_resumption_buffer_size</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">session</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">            </span><span class="n">SSL_set_session</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="p">,</span><span class="w"> </span><span class="n">session</span><span class="p">);</span><span class="w"></span>
<span class="w">            </span><span class="n">SSL_SESSION_free</span><span class="p">(</span><span class="n">session</span><span class="p">);</span><span class="w"></span>
<span class="w">        </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">SSL_connect</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">ssl</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_EPROTO</span><span class="p">);</span><span class="w"></span>
<span class="w">    </span><span class="p">}</span><span class="w"></span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">AVS_OK</span><span class="p">;</span><span class="w"></span>
<span class="p">}</span><span class="w"></span>
</pre></div>
</div>
</div>
<div class="section" id="limitations">
<span id="custom-tls-api-certificates-basic-limitations"></span><h2><a class="toc-backref" href="#id10"><span class="section-number">8.4.1.5.6. </span>Limitations</a><a class="headerlink" href="#limitations" title="Permalink to this headline">¶</a></h2>
<p>The implementation above is a complete basic integration with the private key
infrastructure, however it lacks a number of features that are supported by the
<code class="docutils literal notranslate"><span class="pre">avs_net</span></code> API:</p>
<ul>
<li><p>Lack of DANE support. <strong>This means that this the Server Public Key LwM2M
resource is not supported, and will cause a failure if used.</strong> This is
because LwM2M does not use standard certificate validation logic based on a
trust store, using a custom mechanism instead. However, that mechanism is
almost identical to the one used by <a class="reference external" href="https://en.wikipedia.org/wiki/DNS-based_Authentication_of_Named_Entities">DANE</a>,
so it is implemented in terms of that mechanism in Anjay and <code class="docutils literal notranslate"><span class="pre">avs_net</span></code>.</p>
<p>This feature will be discussed in the next tutorial.</p>
</li>
<li><p>Lack of support for loading chains of more than one certificate as the client
certificate chain. This is rarely used, but supported in the commercial
version of Anjay.</p></li>
<li><p>Lack of support for loading credential information from other sources than
memory buffers (e.g. files). This is generally only used in the commercial
version of Anjay, but may also be used e.g. for HTTPS downloads.</p></li>
<li><p>Lack of support for PEM encoding. This is not generally necessary for LwM2M
compliance, but may be important for other cases, for example loading
credentials from files, as mentioned above.</p></li>
<li><p>Lack of support for the <code class="docutils literal notranslate"><span class="pre">rebuild_client_cert_chain</span></code> flag in
<code class="docutils literal notranslate"><span class="pre">avs_net_certificate_info_t</span></code>. When that flag is supported and enabled, the
TLS implementation shall find appropriate CA certificates in the trust store,
to rebuild the full certification chain of the single certificate specified as
the client certificate, and send that complete chain to the server during the
handshake.</p>
<p>This feature may be required for communication with some servers. However, it
is complex to implement, usually requiring the use of advanced low-level APIs
of the TLS library. For this reason it will not be discussed further in the
tutorial.</p>
</li>
</ul>
</div>
</div>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="CustomTLS-ConfigFeatures.html" class="btn btn-neutral float-left" title="8.4.1.4. Advanced configuration features" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="CustomTLS-CertificatesAdvanced.html" class="btn btn-neutral float-right" title="8.4.1.6. Advanced certificate support" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017-2021, AVSystem.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>