<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>10.3.1.3. Bind operation &mdash; Anjay 3.10.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=86f27845" />
      <link rel="stylesheet" type="text/css" href="../../_static/theme_overrides.css?v=2238f999" />

  
  
        <script src="../../_static/jquery.js?v=8dae8fb0"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../_static/documentation_options.js?v=f8d09eac"></script>
        <script src="../../_static/doctools.js?v=888ff710"></script>
        <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="10.3.1.4. Remote hostname and shutdown operations" href="NetworkingAPI-ShutdownRemoteHostname.html" />
    <link rel="prev" title="10.3.1.2. Get remote host/port operations" href="NetworkingAPI-RemoteHostPort.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #ffd500" >

          
          
          <a href="../../index.html">
            
              <img src="../../_static/avsystem_header.png" class="logo" alt="Logo"/>
          </a>
              <div class="version">
                3.10.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../Introduction.html">1. Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LwM2M.html">2. OMA LwM2M - Brief description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Compiling_client_applications.html">3. Compiling client applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../BasicClient.html">4. Basic client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../AdvancedTopics.html">5. Advanced topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../FirmwareUpdateTutorial.html">6. Firmware Update Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LwM2MGateway.html">7. LwM2M Gateway</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Tools.html">8. Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../API_description.html">9. API description</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../PortingGuideForNonPOSIXPlatforms.html">10. Porting guide for non-POSIX platforms</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../TimeAPI.html">10.1. Time API</a></li>
<li class="toctree-l2"><a class="reference internal" href="../ThreadingAPI.html">10.2. Threading API</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../NetworkingAPI.html">10.3. Networking API</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="NetworkingAPI-Minimal.html">10.3.1.1. Minimal socket implementation</a></li>
<li class="toctree-l3"><a class="reference internal" href="NetworkingAPI-RemoteHostPort.html">10.3.1.2. Get remote host/port operations</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">10.3.1.3. Bind operation</a></li>
<li class="toctree-l3"><a class="reference internal" href="NetworkingAPI-ShutdownRemoteHostname.html">10.3.1.4. Remote hostname and shutdown operations</a></li>
<li class="toctree-l3"><a class="reference internal" href="NetworkingAPI-Stats.html">10.3.1.5. Statistics support</a></li>
<li class="toctree-l3"><a class="reference internal" href="NetworkingAPI-IpStickiness.html">10.3.1.6. IP address stickiness support</a></li>
<li class="toctree-l3"><a class="reference internal" href="NetworkingAPI-EventLoopSupport.html">10.3.1.7. Event loop support</a></li>
<li class="toctree-l3"><a class="reference internal" href="NetworkingAPI-OtherFeatures.html">10.3.1.8. Other features</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../CustomTLS.html">10.4. Custom (D)TLS layers</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../Migrating.html">11. Migrating from older versions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CommercialFeatures.html">12. Commercial features</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #ffd500" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Anjay</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../PortingGuideForNonPOSIXPlatforms.html"><span class="section-number">10. </span>Porting guide for non-POSIX platforms</a></li>
          <li class="breadcrumb-item"><a href="../NetworkingAPI.html"><span class="section-number">10.3. </span>Networking API</a></li>
      <li class="breadcrumb-item active"><span class="section-number">10.3.1.3. </span>Bind operation</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="bind-operation">
<h1><span class="section-number">10.3.1.3. </span>Bind operation<a class="headerlink" href="#bind-operation" title="Link to this heading"></a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#introduction" id="id2">Introduction</a></p></li>
<li><p><a class="reference internal" href="#bind-operation-itself" id="id3">Bind operation itself</a></p></li>
<li><p><a class="reference internal" href="#changes-to-net-get-opt" id="id4">Changes to net_get_opt()</a></p></li>
<li><p><a class="reference internal" href="#get-local-port-operation" id="id5">Get local port operation</a></p></li>
<li><p><a class="reference internal" href="#update-to-vtable" id="id6">Update to vtable</a></p></li>
</ul>
</nav>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Code related to this tutorial can be found under
<a class="reference external" href="https://github.com/AVSystem/Anjay/tree/master/examples/custom-network/bind">examples/custom-network/bind</a>
in the Anjay source directory.</p>
</div>
<section id="introduction">
<h2><a class="toc-backref" href="#id2" role="doc-backlink"><span class="section-number">10.3.1.3.1. </span>Introduction</a><a class="headerlink" href="#introduction" title="Link to this heading"></a></h2>
<p>This tutorial builds up on <a class="reference internal" href="NetworkingAPI-RemoteHostPort.html"><span class="doc">the previous one</span></a> and adds support for the bind operation.</p>
<p>This will allow use of the <a class="reference external" href="../../api/structanjay__configuration.html#acf74549a99ca3ad5aedb227c4b0258ca">anjay_configuration_t::udp_listen_port</a>
setting, which might be useful e.g. for the LwM2M 1.0-style Server-Initiated
Bootstrap.</p>
<p>We will also add support for the “get local port” operation, which will allow
even ephemeral listening port number to be retained between subsequent
connections to the same server.</p>
</section>
<section id="bind-operation-itself">
<h2><a class="toc-backref" href="#id3" role="doc-backlink"><span class="section-number">10.3.1.3.2. </span>Bind operation itself</a><a class="headerlink" href="#bind-operation-itself" title="Link to this heading"></a></h2>
<p>Implementation of the bind function is very similar to the previously
implemented <a class="reference internal" href="NetworkingAPI-Minimal.html#non-posix-networking-api-connect"><span class="std std-ref">Connect</span></a> one. Important changes are
highlighted.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">avs_error_t</span>
<span class="nf">net_bind</span><span class="p">(</span><span class="n">avs_net_socket_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock_</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">port</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">net_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">net_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">sock_</span><span class="p">;</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">addrinfo</span><span class="w"> </span><span class="n">hints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="hll"><span class="w">        </span><span class="p">.</span><span class="n">ai_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AI_PASSIVE</span><span class="p">,</span>
</span><span class="w">        </span><span class="p">.</span><span class="n">ai_socktype</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">socktype</span>
<span class="w">    </span><span class="p">};</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">getsockopt</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">SOL_SOCKET</span><span class="p">,</span><span class="w"> </span><span class="n">SO_DOMAIN</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">hints</span><span class="p">.</span><span class="n">ai_family</span><span class="p">,</span>
<span class="w">                   </span><span class="o">&amp;</span><span class="p">(</span><span class="kt">socklen_t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">hints</span><span class="p">.</span><span class="n">ai_family</span><span class="p">)</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">addrinfo</span><span class="w"> </span><span class="o">*</span><span class="n">addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="n">avs_error_t</span><span class="w"> </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AVS_OK</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getaddrinfo</span><span class="p">(</span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">hints</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_EADDRNOTAVAIL</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">((</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span>
<span class="w">                </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">socket</span><span class="p">(</span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">ai_family</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">ai_socktype</span><span class="p">,</span>
<span class="w">                                      </span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">ai_protocol</span><span class="p">))</span>
<span class="w">                           </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="hll"><span class="w">               </span><span class="o">||</span><span class="w"> </span><span class="n">setsockopt</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">SOL_SOCKET</span><span class="p">,</span><span class="w"> </span><span class="n">SO_REUSEADDR</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">},</span>
</span><span class="hll"><span class="w">                             </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
</span><span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_UNKNOWN_ERROR</span><span class="p">);</span>
<span class="hll"><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">ai_addr</span><span class="p">,</span><span class="w"> </span><span class="n">addr</span><span class="o">-&gt;</span><span class="n">ai_addrlen</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span class="w">        </span><span class="n">err</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_ECONNREFUSED</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="hll"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">avs_is_err</span><span class="p">(</span><span class="n">err</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">        </span><span class="n">close</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">);</span>
</span><span class="hll"><span class="w">        </span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
</span><span class="hll"><span class="w">    </span><span class="p">}</span>
</span><span class="w">    </span><span class="n">freeaddrinfo</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This time <code class="docutils literal notranslate"><span class="pre">getaddrinfo()</span></code> is called with <code class="docutils literal notranslate"><span class="pre">AI_PASSIVE</span></code> flag to allow wildcard
addresses (e.g. <code class="docutils literal notranslate"><span class="pre">0.0.0.0</span></code>) and to prevent DNS resolution for such local
addresses.</p>
<p>Of course, <code class="docutils literal notranslate"><span class="pre">bind()</span></code> is called instead of <code class="docutils literal notranslate"><span class="pre">connect()</span></code>. But before doing so,
<code class="docutils literal notranslate"><span class="pre">setsockopt()</span></code> is called to enable the <code class="docutils literal notranslate"><span class="pre">SO_REUSEADDR</span></code> flag. This is done
because Anjay may create multiple sockets bound to the same port, one for each
remote server connection. This shall not result in a conflict, as all those
sockets will be connected to different remote servers shortly after binding.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>More properly, <code class="docutils literal notranslate"><span class="pre">SO_REUSEADDR</span></code> should only be used if the <code class="docutils literal notranslate"><span class="pre">reuse_addr</span></code>
flag has been set in the <code class="docutils literal notranslate"><span class="pre">avs_net_socket_configuration_t</span></code> structure passed
at socket creation time.</p>
<p>However, Anjay always sets this flag to <code class="docutils literal notranslate"><span class="pre">true</span></code>, so it is alright to set it
unconditionally in such simplistic implementation.</p>
</div>
<p>Finally, in case of error, the underlying socket descriptor is closed. This is
to ensure that upon error, the socket will not end up in the “bound” state,
which will be evident in the modifications to <code class="docutils literal notranslate"><span class="pre">net_get_opt()</span></code> illustrated
below.</p>
</section>
<section id="changes-to-net-get-opt">
<h2><a class="toc-backref" href="#id4" role="doc-backlink"><span class="section-number">10.3.1.3.3. </span>Changes to net_get_opt()</a><a class="headerlink" href="#changes-to-net-get-opt" title="Link to this heading"></a></h2>
<p>Changes to this function are highlighted:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">avs_error_t</span><span class="w"> </span><span class="nf">net_get_opt</span><span class="p">(</span><span class="n">avs_net_socket_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock_</span><span class="p">,</span>
<span class="w">                               </span><span class="n">avs_net_socket_opt_key_t</span><span class="w"> </span><span class="n">option_key</span><span class="p">,</span>
<span class="w">                               </span><span class="n">avs_net_socket_opt_value_t</span><span class="w"> </span><span class="o">*</span><span class="n">out_option_value</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">net_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">net_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">sock_</span><span class="p">;</span>
<span class="w">    </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">option_key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">AVS_NET_SOCKET_OPT_RECV_TIMEOUT</span><span class="p">:</span>
<span class="w">        </span><span class="n">out_option_value</span><span class="o">-&gt;</span><span class="n">recv_timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">recv_timeout</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">AVS_OK</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">AVS_NET_SOCKET_OPT_STATE</span><span class="p">:</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">fd</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">out_option_value</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AVS_NET_SOCKET_STATE_CLOSED</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="hll"><span class="w">            </span><span class="n">sockaddr_union_t</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>
</span><span class="hll"><span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">getpeername</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">addr</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span>
</span><span class="hll"><span class="w">                             </span><span class="o">&amp;</span><span class="p">(</span><span class="kt">socklen_t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="p">})</span>
</span><span class="hll"><span class="w">                    </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">((</span><span class="n">addr</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">sin_family</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AF_INET</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">addr</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">sin_port</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
</span><span class="hll"><span class="w">                        </span><span class="o">||</span><span class="w"> </span><span class="p">(</span><span class="n">addr</span><span class="p">.</span><span class="n">in6</span><span class="p">.</span><span class="n">sin6_family</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">AF_INET6</span>
</span><span class="hll"><span class="w">                            </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">addr</span><span class="p">.</span><span class="n">in6</span><span class="p">.</span><span class="n">sin6_port</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)))</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">                </span><span class="n">out_option_value</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AVS_NET_SOCKET_STATE_CONNECTED</span><span class="p">;</span>
</span><span class="hll"><span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span class="hll"><span class="w">                </span><span class="n">out_option_value</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AVS_NET_SOCKET_STATE_BOUND</span><span class="p">;</span>
</span><span class="hll"><span class="w">            </span><span class="p">}</span>
</span><span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">AVS_OK</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">AVS_NET_SOCKET_OPT_INNER_MTU</span><span class="p">:</span>
<span class="w">        </span><span class="n">out_option_value</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1464</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">AVS_OK</span><span class="p">;</span>
<span class="w">    </span><span class="k">case</span><span class="w"> </span><span class="no">AVS_NET_SOCKET_HAS_BUFFERED_DATA</span><span class="p">:</span>
<span class="w">        </span><span class="n">out_option_value</span><span class="o">-&gt;</span><span class="n">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">AVS_OK</span><span class="p">;</span>
<span class="w">    </span><span class="k">default</span><span class="o">:</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_ENOTSUP</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The original variant assumed that if the socket descriptor was present, it is
connected. Here, we need to differentiate between the “connected” and “bound”
states - hence we use the <code class="docutils literal notranslate"><span class="pre">getpeername()</span></code> function to check if there is a
valid remote address.</p>
<p>Because <code class="docutils literal notranslate"><span class="pre">getpeername()</span></code> might return different kind of socket addresses, the
<code class="docutils literal notranslate"><span class="pre">sockaddr_union_t</span></code> type <a class="reference internal" href="NetworkingAPI-RemoteHostPort.html#non-posix-networking-api-get-remote-host"><span class="std std-ref">declared in the previous tutorial</span></a> is used.</p>
</section>
<section id="get-local-port-operation">
<h2><a class="toc-backref" href="#id5" role="doc-backlink"><span class="section-number">10.3.1.3.4. </span>Get local port operation</a><a class="headerlink" href="#get-local-port-operation" title="Link to this heading"></a></h2>
<p>The “get local port” operation may or may not be implemented. It is not
necessary for the bind operation to work, but if implemented, it will allow
Anjay to keep ephemeral listening port number consistent across subsequent
connections to the same server if <a class="reference external" href="../../api/structanjay__configuration.html#acf74549a99ca3ad5aedb227c4b0258ca">anjay_configuration_t::udp_listen_port</a>
is not set.</p>
<p>Its implementation mirrors the <a class="reference internal" href="NetworkingAPI-RemoteHostPort.html#non-posix-networking-api-get-remote-port"><span class="std std-ref">Get remote port operation</span></a>
from the previous tutorial, only with <code class="docutils literal notranslate"><span class="pre">getsockname()</span></code> used instead of
<code class="docutils literal notranslate"><span class="pre">getpeername()</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="n">avs_error_t</span><span class="w"> </span><span class="nf">net_local_port</span><span class="p">(</span><span class="n">avs_net_socket_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock_</span><span class="p">,</span>
<span class="w">                                  </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">out_buffer</span><span class="p">,</span>
<span class="w">                                  </span><span class="kt">size_t</span><span class="w"> </span><span class="n">out_buffer_size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">net_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="n">sock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">net_socket_impl_t</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="w"> </span><span class="n">sock_</span><span class="p">;</span>
<span class="w">    </span><span class="n">sockaddr_union_t</span><span class="w"> </span><span class="n">addr</span><span class="p">;</span>
<span class="hll"><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">getsockname</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">addr</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="kt">socklen_t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span><span class="w"> </span><span class="p">}))</span><span class="w"> </span><span class="p">{</span>
</span><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">avs_errno</span><span class="p">(</span><span class="n">AVS_UNKNOWN_ERROR</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">stringify_sockaddr_port</span><span class="p">(</span><span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span><span class="w"> </span><span class="n">out_buffer</span><span class="p">,</span><span class="w"> </span><span class="n">out_buffer_size</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="update-to-vtable">
<h2><a class="toc-backref" href="#id6" role="doc-backlink"><span class="section-number">10.3.1.3.5. </span>Update to vtable</a><a class="headerlink" href="#update-to-vtable" title="Link to this heading"></a></h2>
<p>Of course the newly implemented functions need to be referenced in the virtual
method table:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">avs_net_socket_v_table_t</span><span class="w"> </span><span class="n">NET_SOCKET_VTABLE</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="p">.</span><span class="n">connect</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">net_connect</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">send</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">net_send</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">receive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">net_receive</span><span class="p">,</span>
<span class="hll"><span class="w">    </span><span class="p">.</span><span class="n">bind</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">net_bind</span><span class="p">,</span>
</span><span class="w">    </span><span class="p">.</span><span class="n">close</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">net_close</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">cleanup</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">net_cleanup</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">get_system_socket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">net_system_socket</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">get_remote_host</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">net_remote_host</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">get_remote_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">net_remote_port</span><span class="p">,</span>
<span class="hll"><span class="w">    </span><span class="p">.</span><span class="n">get_local_port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">net_local_port</span><span class="p">,</span>
</span><span class="w">    </span><span class="p">.</span><span class="n">get_opt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">net_get_opt</span><span class="p">,</span>
<span class="w">    </span><span class="p">.</span><span class="n">set_opt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">net_set_opt</span>
<span class="p">};</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="NetworkingAPI-RemoteHostPort.html" class="btn btn-neutral float-left" title="10.3.1.2. Get remote host/port operations" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="NetworkingAPI-ShutdownRemoteHostname.html" class="btn btn-neutral float-right" title="10.3.1.4. Remote hostname and shutdown operations" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2017-2025, AVSystem.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>